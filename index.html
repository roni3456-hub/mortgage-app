<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck â€“ RE Calculator & Underwriting Tool</title>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;--text-color:#34495e;--border:#bdc3c7;
      --danger:#e74c3c;--danger-dark:#c0392b;--success:#2ecc71;--warning:#f1c40f;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;margin:0;padding:0;background-color:var(--page-bg-1);color:var(--text-color);min-height:100vh;display:flex;flex-direction:column;}
    .container{padding:20px;max-width:800px;margin:auto;}
    header{background-color:var(--brand);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    h1{margin:0;font-size:2rem;}
    .tagline{font-size:1rem;color:rgba(255,255,255,.8);}
    .card{background-color:var(--card-bg);border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-top:20px;padding:20px;}
    .form-group{margin-bottom:15px;}
    label{display:block;margin-bottom:5px;font-weight:700;}
    input[type=number],input[type=text]{width:100%;padding:10px;border:1px solid var(--border);border-radius:5px;box-sizing:border-box;font-size:1rem;}
    .input-group{display:flex;}
    .input-group span{padding:10px;background-color:#eee;border:1px solid var(--border);border-right:0;border-radius:5px 0 0 5px;}
    .input-group input{border-radius:0 5px 5px 0;}
    .btn{padding:10px 20px;font-size:1rem;border-radius:5px;cursor:pointer;text-decoration:none;display:inline-block;transition:background-color .3s ease;}
    .btn-primary{background-color:var(--brand);color:#fff;border:0;}
    .btn-primary:hover{background-color:var(--brand-dark);}
    .btn-secondary{background-color:var(--muted);color:#fff;border:0;}
    .btn-secondary:hover{background-color:#6c7a89;}
    .btn-danger{background-color:var(--danger);color:#fff;border:0;}
    .btn-danger:hover{background-color:var(--danger-dark);}
    .btn-small{padding:5px 10px;font-size:.8rem;}
    .results{margin-top:20px;border-top:2px dashed var(--border);padding-top:20px;text-align:center;}
    .metric{margin-bottom:10px;}
    .metric-value{font-size:2.5rem;font-weight:700;}
    .metric-label{font-size:.9rem;color:var(--muted);text-transform:uppercase;}
    .grid{display:grid;grid-template-columns:1fr;gap:20px;}
    @media(min-width:600px){.grid{grid-template-columns:1fr 1fr;}}
    .alert{padding:15px;border-radius:5px;margin-bottom:15px;}
    .alert-info{background-color:#ecf0f1;color:#34495e;border:1px solid var(--border);}
    .alert-warning{background-color:#fef5e7;color:#c69727;border:1px solid #f1c40f;}
    .alert-danger{background-color:#fdf4f4;color:#a83232;border:1px solid var(--danger);}
    .alert-success{background-color:#e9f7ef;color:#27ae60;border:1px solid var(--brand-dark);}
    .muted{color:var(--muted);}
    .login-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(45deg,var(--page-bg-1),var(--page-bg-2));color:#fff;}
    .login-box{background:rgba(255,255,255,.9);padding:40px;border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.2);text-align:center;color:#34495e;}
    .login-box h2{margin-top:0;font-size:2rem;}
    .g_id_signin{display:flex;justify-content:center;margin-top:20px;}
    .main-app{display:none;flex-direction:column;min-height:100vh;background:linear-gradient(45deg,var(--page-bg-1),var(--page-bg-2));}
    .main-content{flex-grow:1;}
    .nav-bar{background-color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:10px 0;}
    .nav-link{display:flex;flex-direction:column;align-items:center;color:var(--muted);text-decoration:none;font-size:.8rem;}
    .nav-link.active{color:var(--brand);font-weight:700;}
    .nav-link i{font-size:1.5rem;margin-bottom:5px;}
    .mobile-nav{position:fixed;bottom:0;left:0;right:0;background-color:#fff;box-shadow:0 -2px 4px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:10px 0;z-index:1000;}
    .mobile-nav-item{display:flex;flex-direction:column;align-items:center;color:var(--muted);text-decoration:none;font-size:.8rem;flex:1;text-align:center;padding:5px 0;}
    .mobile-nav-item.active{color:var(--brand);font-weight:700;}
    .mobile-nav-item i{font-size:1.5rem;margin-bottom:5px;}
    .page{display:none;}
    .page.active{display:block;}
    .header-bar{background-color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .user-area{display:none;align-items:center;}
    .user-avatar{width:30px;height:30px;border-radius:50%;margin-right:10px;}
    .tab-nav{display:flex;justify-content:space-around;margin-top:20px;border-bottom:1px solid var(--border);}
    .tab{padding:10px 0;text-align:center;cursor:pointer;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;transition:all .3s ease;}
    .tab.active{color:var(--brand);border-bottom:2px solid var(--brand);}
    .tab-content{display:none;padding-top:20px;}
    #overviewTab{display:block;}
    .comparison-table{width:100%;border-collapse:collapse;margin-top:20px;}
    .comparison-table th,.comparison-table td{padding:10px;text-align:left;border-bottom:1px solid var(--border);}
    .comparison-table th{background-color:#f9f9f9;font-weight:700;}
    .ad-container{margin-top:20px;text-align:center;}
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLpUePz2S6LpQf2yB/wR/b7t4eB5P8S2D+B0Q4/2A5v5v8U4G6p8A2+eB8G+" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

  <div class="login-container" id="loginScreen">
    <div class="login-box">
      <h2>PropCheck</h2>
      <p class="muted">Your all-in-one real estate underwriting tool.</p>
      <div id="g_button_target"></div>
      <p style="margin-top:10px;font-size:.9rem;">or</p>
      <button class="btn btn-secondary" id="guestButton">Continue as Guest</button>
      <p style="margin-top:15px;font-size:.8rem;color:var(--muted);">
        By signing in you agree to our <a href="#" style="color:var(--muted);">Terms</a>.
      </p>
    </div>
  </div>

  <div class="main-app" id="mainApp">
    <div class="header-bar">
      <h2>PropCheck</h2>
      <div class="user-area" id="userArea">
        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar" />
        <div class="user-info">
          <span id="userName"></span>
          <span id="userEmail" class="muted" style="font-size:.8em;"></span>
        </div>
        <button id="signOut" class="btn btn-secondary btn-small" style="margin-left:10px;">Sign out</button>
      </div>
    </div>

    <div class="container main-content">
      <div id="calculatorPage" class="page active">
        <div class="card">
          <h4>Property Calculator</h4>
          <div class="form-group">
            <label for="price">Purchase Price</label>
            <div class="input-group">
              <span>$</span>
              <input type="number" id="price" placeholder="500,000" />
            </div>
          </div>
          <div class="form-group">
            <label for="down">Down Payment (%)</label>
            <div class="input-group">
              <input type="number" id="down" placeholder="20" min="5" max="100" />
              <span>%</span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-check" style="display:flex;align-items:center;">
              <input class="form-check-input" type="checkbox" id="cmhcRequired" checked disabled style="margin-right:10px;">
              <label class="form-check-label" for="cmhcRequired" style="margin-bottom:0;font-weight:normal;">CMHC Required?</label>
            </div>
          </div>
          <div class="form-group">
            <label for="rate">Interest Rate (%)</label>
            <div class="input-group">
              <input type="number" id="rate" placeholder="5.50" step="0.01" />
              <span>%</span>
            </div>
          </div>
          <div class="form-group">
            <label for="term">Mortgage Term (Years)</label>
            <div class="input-group">
              <input type="number" id="term" placeholder="25" />
              <span>Years</span>
            </div>
          </div>
          <div class="form-group">
            <label for="rent">Monthly Rent</label>
            <div class="input-group">
              <span>$</span>
              <input type="number" id="rent" placeholder="2,500" />
            </div>
          </div>
          <div class="form-group">
            <label for="propertyTax">Annual Property Tax</label>
            <div class="input-group">
              <span>$</span>
              <input type="number" id="propertyTax" placeholder="3,000" />
            </div>
          </div>
          <div class="form-group">
            <label for="insurance">Annual Insurance</label>
            <div class="input-group">
              <span>$</span>
              <input type="number" id="insurance" placeholder="1,200" />
            </div>
          </div>
          <div class="form-group">
            <label for="management">Property Management (%)</label>
            <div class="input-group">
              <input type="number" id="management" placeholder="10" />
              <span>%</span>
            </div>
          </div>
          <div class="form-group">
            <label for="vacancy">Vacancy Rate (%)</label>
            <div class="input-group">
              <input type="number" id="vacancy" placeholder="5" />
              <span>%</span>
            </div>
          </div>
          <div class="form-group">
            <label for="otherExpenses">Other Monthly Expenses</label>
            <div class="input-group">
              <span>$</span>
              <input type="number" id="otherExpenses" placeholder="100" />
            </div>
          </div>
          <button class="btn btn-primary" id="calcButton" style="width:100%;">Calculate</button>
        </div>
        <div class="results" id="results" style="display:none;">
          <h4>Key Metrics</h4>
          <div class="grid grid-2">
            <div class="metric">
              <div class="metric-value" id="payment"></div>
              <div class="metric-label">Monthly Payment</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="cashflow"></div>
              <div class="metric-label">Net Cash Flow</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="caprate"></div>
              <div class="metric-label">Cap Rate</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="coc"></div>
              <div class="metric-label">Cash-on-Cash Return</div>
            </div>
          </div>
          <p style="margin-top:20px;">
            <span class="muted" style="font-size: .9em;">
              <strong>Initial Investment:</strong> <span id="totalInitial"></span> (Down Payment: <span id="downPaymentAmount"></span>, CMHC Insurance: <span id="cmhcAmount"></span>)
            </span>
            <br>
            <span class="muted" style="font-size: .9em;">
              <strong>Annual Income:</strong> <span id="grossRent"></span> (Net Operating Income: <span id="noi"></span>)
            </span>
            <br>
            <span class="muted" style="font-size: .9em;">
              <strong>Annual Expenses:</strong> <span id="totalExpenses"></span>
            </span>
          </p>
          <button class="btn btn-primary" id="saveProperty" style="margin-top:15px;">Save Property to Google Drive</button>
        </div>
        <div class="ad-container">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>
        <div class="card" style="margin-top:20px;">
          <h4 style="margin-top:0;">Install App</h4>
          <p>Get a faster experience and offline access by installing PropCheck as a PWA.</p>
          <button class="btn btn-secondary" id="homeInstallBtn" style="width:100%;">Install to Home Screen</button>
        </div>
      </div>

      <div id="comparePage" class="page">
        <div class="card">
          <h4>Property Comparison</h4>
          <div id="comparisonContainer">
            <div class="alert alert-warning">
              Add properties from the calculator to compare them side-by-side.
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:16px;">
            <button class="btn btn-secondary" id="addProperty" style="width:48%;">Add Property</button>
            <button class="btn btn-danger" id="clearComparison" style="width:48%;">Clear</button>
          </div>
        </div>
      </div>

      <div id="reportsPage" class="page">
        <div class="card">
          <h4>Reports & Analysis</h4>
          <div class="tab-nav">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="stress">Stress Test</div>
            <div class="tab" data-tab="rent">Rent Analysis</div>
            <div class="tab" data-tab="expenses">Expenses</div>
          </div>

          <div class="tab-content" id="overviewTab">
            <div id="propertiesList">
              <div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>
            </div>
            <div style="margin-top:20px;display:flex;gap:10px;">
              <button class="btn btn-primary" id="portfolioReport" style="flex:1;">View Portfolio Report</button>
              <button class="btn btn-secondary" id="generateSummary" style="flex:1;">Generate HTML Report</button>
            </div>
          </div>

          <div class="tab-content" id="stressTab">
            <div class="form-group">
              <label for="currentRate">Current Rate (%)</label>
              <div class="input-group">
                <input type="number" id="currentRate" placeholder="5.5" step="0.01" />
                <span>%</span>
              </div>
            </div>
            <div class="form-group">
              <label for="stressRate">Stress Test Rate (%)</label>
              <div class="input-group">
                <input type="number" id="stressRate" placeholder="7.5" step="0.01" />
                <span>%</span>
              </div>
            </div>
            <div class="form-group">
              <label for="renewalPeriod">Renewal Period (Years)</label>
              <input type="number" id="renewalPeriod" placeholder="5" />
            </div>
            <button class="btn btn-primary" id="runStressTest" style="width:100%;">Run Stress Test</button>
            <div class="results" id="stressResults" style="display:none;"></div>
          </div>

          <div class="tab-content" id="rentTab">
            <div class="form-group">
              <label for="rentIncrease">Annual Rent Increase (%)</label>
              <div class="input-group">
                <input type="number" id="rentIncrease" placeholder="2" step="0.1" />
                <span>%</span>
              </div>
            </div>
            <div class="form-group">
              <label for="projectionYears">Projection Years</label>
              <input type="number" id="projectionYears" placeholder="5" />
            </div>
            <button class="btn btn-primary" id="runRentAnalysis" style="width:100%;">Run Rent Analysis</button>
            <div class="results" id="rentResults" style="display:none;"></div>
          </div>

          <div class="tab-content" id="expensesTab">
            <div class="results" id="expenseBreakdown">
              <div class="alert alert-warning">Calculate a property first to see expense breakdown.</div>
            </div>
            <div class="form-group" style="margin-top:20px;">
              <label for="citySelect">Select City</label>
              <select id="citySelect" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:5px;">
                <option value="toronto">Toronto</option>
                <option value="vancouver">Vancouver</option>
                <option value="calgary">Calgary</option>
                <option value="montreal">Montreal</option>
              </select>
            </div>
            <div class="form-group">
              <label for="propertyType">Property Type</label>
              <select id="propertyType" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:5px;">
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="detached">Detached</option>
              </select>
            </div>
            <button class="btn btn-primary" id="loadMarketData" style="width:100%;">Load Market Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mobile-nav" id="mobileNav">
    <a href="#" class="mobile-nav-item active" data-page="calculator">
      <i class="fas fa-calculator"></i>
      <span>Calculator</span>
    </a>
    <a href="#" class="mobile-nav-item" data-page="compare">
      <i class="fas fa-balance-scale"></i>
      <span>Compare</span>
    </a>
    <a href="#" class="mobile-nav-item" data-page="reports">
      <i class="fas fa-chart-line"></i>
      <span>Reports</span>
    </a>
  </div>

  <script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCNEg2v7riXUZ_UdjqpkGT56wzMkw-gRxs';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let accessToken = null;
    let propCheckFolderId = null;

    // Global state variables
    let currentProperty = {};
    let savedProperties = [];
    let currentUser = null;

    // Functions from the original code (unchanged)
    function money(n){return '$'+Number(n).toLocaleString('en-CA', {minimumFractionDigits: 0, maximumFractionDigits: 0});}
    function pct(n){return Number(n).toFixed(2)+'%';}

    function calculateCMHC(price, downPercent) {
      if (downPercent >= 20) return 0;
      const loanAmount = price * (1 - downPercent/100);
      let rate;
      if (downPercent >= 15) rate = 0.028;
      else if (downPercent >= 10) rate = 0.031;
      else rate = 0.04;
      return loanAmount * rate;
    }

    // Google Drive Integration Functions
    function initDriveClient() {
      gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      }).then(() => {
        ensurePropCheckFolder();
      });
    }

    async function ensurePropCheckFolder() {
      try {
        const res = await gapi.client.drive.files.list({
          q: "mimeType='application/vnd.google-apps.folder' and name='Prop Check' and trashed=false",
          fields: "files(id, name)",
        });
        if (res.result.files.length > 0) {
          propCheckFolderId = res.result.files[0].id;
        } else {
          const folder = await gapi.client.drive.files.create({
            resource: { name: "Prop Check", mimeType: "application/vnd.google-apps.folder" },
            fields: "id",
          });
          propCheckFolderId = folder.result.id;
        }
      } catch(error) {
        console.error("Error creating/finding Prop Check folder:", error);
      }
    }

    async function uploadToDrive(name, blob, mimeType) {
      if (!accessToken || !propCheckFolderId) {
        alert("Please sign in with Google to use this feature.");
        return Promise.reject("Not signed in with Google.");
      }
      const fileMetadata = { name: name, parents: [propCheckFolderId] };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
      form.append('file', blob);

      try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });
        if (!response.ok) {
          throw new Error(`Upload failed with status: ${response.status}`);
        }
        return response.json();
      } catch(error) {
        console.error("Error uploading to Drive:", error);
        alert("Failed to save to Google Drive. Please try again.");
        return Promise.reject(error);
      }
    }

    function parseJwt(token){
      try{
        const base64Url=token.split('.')[1];
        const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
        const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }catch(e){return null;}
    }

    // Consolidated and Corrected handleCredentialResponse function
    function handleCredentialResponse(response){
      const payload = parseJwt(response.credential);
      if(!payload) return;

      currentUser = payload;
      loginScreen.style.display='none';
      mainApp.style.display='block';
      userArea.style.display='flex';
      userAvatar.src = payload.picture || '';
      userName.textContent = payload.name;
      userEmail.textContent = payload.email;
      gtag('event', 'login', {method: 'google'});

      // Request access token for Drive
      google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          gapi.load('client', initDriveClient);
        },
      }).requestAccessToken();
    }
    window.handleCredentialResponse = handleCredentialResponse;

    // Event listeners
    guestButton.onclick = () => {
      loginScreen.style.display='none';
      mainApp.style.display='block';
      gtag('event', 'login', {method: 'guest'});
    };

    document.getElementById('homeInstallBtn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          gtag('event', 'pwa_install', {source: 'homepage'});
        }
        deferredPrompt = null;
      } else {
        alert('To install this app:\n\niOS: Tap Share â†’ Add to Home Screen\nAndroid: Tap menu â†’ Add to Home Screen\nDesktop: Look for install icon in address bar');
      }
    };

    window.onload = function(){
      setTimeout(function() {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
          });
          google.accounts.id.renderButton(
            document.getElementById('g_button_target'),
            {
              theme: 'outline',
              size: 'large',
              width: 280,
              text: 'signin_with',
              shape: 'rectangular'
            }
          );
        } else {
          console.log('Google Sign-In library not loaded');
          document.getElementById('g_button_target').innerHTML = '<button class="btn btn-primary" style="width:100%;margin-top:10px;" onclick="alert(\'Google Sign-In not available\')">Sign in with Google (Loading...)</button>';
        }
      }, 500);
      (adsbygoogle = window.adsbygoogle || []).push({});
    }

    signOut.onclick=()=>{
      google.accounts.id.disableAutoSelect();
      userArea.style.display='none';
      loginScreen.style.display='flex';
      mainApp.style.display='none';
      currentUser = null;
      gtag('event', 'logout');
    };

    // Remaining functions for navigation, calculator, etc. (unchanged)
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.mobile-nav-item').forEach(l => l.classList.remove('active'));

      document.getElementById(pageId + 'Page').classList.add('active');
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      document.querySelector(`.mobile-nav-item[data-page="${pageId}"]`).classList.add('active');

      gtag('event', 'page_view', {page_title: pageId});
    }

    document.querySelectorAll('[data-page]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      };
    });

    calcButton.onclick = () => {
      const price = +document.getElementById('price').value || 0;
      const downPercent = +down.value || 20;
      const rate = (+document.getElementById('rate').value || 0) / 100 / 12;
      const term = (+document.getElementById('term').value || 25) * 12;
      const monthlyRent = +rent.value || 0;
      const annualTax = +propertyTax.value || 0;
      const annualInsurance = +insurance.value || 0;
      const managementPercent = +management.value || 0;
      const vacancyPercent = +vacancy.value || 0;
      const otherMonthly = +otherExpenses.value || 0;

      if (!price || !monthlyRent) {
        alert('Please enter at least the purchase price and monthly rent.');
        return;
      }

      const downPayment = price * downPercent / 100;
      const cmhcInsurance = calculateCMHC(price, downPercent);
      const loanAmount = price - downPayment + cmhcInsurance;

      let monthlyPayment = 0;
      if (rate === 0) {
        monthlyPayment = loanAmount / term;
      } else {
        monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
      }

      const monthlyTax = annualTax / 12;
      const monthlyInsurance = annualInsurance / 12;
      const managementFee = monthlyRent * managementPercent / 100;
      const vacancyLoss = monthlyRent * vacancyPercent / 100;

      const totalMonthlyExpenses = monthlyPayment + monthlyTax + monthlyInsurance + managementFee + vacancyLoss + otherMonthly;
      const effectiveRent = monthlyRent - vacancyLoss;
      const netCashFlow = effectiveRent - totalMonthlyExpenses;

      const grossAnnualRent = monthlyRent * 12;
      const effectiveAnnualRent = effectiveRent * 12;
      const annualExpenses = (monthlyTax + monthlyInsurance + managementFee + otherMonthly) * 12 + (monthlyRent * vacancyPercent / 100 * 12);
      const noi = effectiveAnnualRent - annualExpenses;
      const capRate = price ? (noi / price) * 100 : 0;
      const totalInitialInvestment = downPayment + cmhcInsurance;
      const cashOnCash = totalInitialInvestment ? (netCashFlow * 12 / totalInitialInvestment) * 100 : 0;

      currentProperty = {
        price, downPercent, rate: +document.getElementById('rate').value, term: +document.getElementById('term').value,
        monthlyRent, annualTax, annualInsurance, managementPercent, vacancyPercent, otherMonthly,
        monthlyPayment, netCashFlow, noi, capRate, cashOnCash, totalInitialInvestment,
        downPayment, cmhcInsurance, timestamp: new Date()
      };

      payment.textContent = money(monthlyPayment);
      cashflow.textContent = money(netCashFlow);
      document.getElementById('caprate').textContent = pct(capRate);
      document.getElementById('coc').textContent = pct(cashOnCash);

      document.getElementById('downPaymentAmount').textContent = money(downPayment);
      document.getElementById('cmhcAmount').textContent = money(cmhcInsurance);
      document.getElementById('totalInitial').textContent = money(totalInitialInvestment);
      document.getElementById('grossRent').textContent = money(grossAnnualRent);
      document.getElementById('totalExpenses').textContent = money(annualExpenses);
      document.getElementById('noi').textContent = money(noi);

      results.style.display = 'block';

      cashflow.style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';

      gtag('event', 'calculate_property', {
        value: price,
        currency: 'CAD'
      });
    };

    document.getElementById('cmhcRequired').onchange = function() {
      const downPercent = +down.value || 20;
      this.checked = downPercent < 20;
      if (downPercent >= 20) this.checked = false;
    };

    down.oninput = function() {
      const downPercent = +this.value || 20;
      document.getElementById('cmhcRequired').checked = downPercent < 20;
    };

    // Save property to Drive
    document.getElementById('saveProperty').onclick = async () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      if (!accessToken) {
        alert("Please sign in with Google to use this feature.");
        return;
      }

      const name = prompt('Enter a name for this property:', `Property ${savedProperties.length + 1}`);
      if (name) {
        try {
          const blob = new Blob([JSON.stringify(currentProperty, null, 2)], {type: 'application/json'});
          const file = await uploadToDrive(name + ".json", blob, "application/json");

          if (file && file.id) {
            currentProperty.name = name;
            savedProperties.push({...currentProperty});
            updateSavedPropertiesList();
            alert('Property saved successfully to Google Drive!');
            gtag('event', 'save_property');

            const link = document.createElement('a');
            link.href = `https://drive.google.com/file/d/${file.id}/view`;
            link.target = '_blank';
            link.textContent = 'ðŸ“‚ View in Drive';
            link.className = 'btn btn-primary';
            link.style.marginTop = '10px';
            document.getElementById('results').appendChild(link);
          }
        } catch (error) {
          console.error("Error saving property:", error);
        }
      }
    };

    function updateSavedPropertiesList() {
      const container = document.getElementById('propertiesList');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>';
        return;
      }

      container.innerHTML = savedProperties.map((prop, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;">
          <div>
            <strong>${prop.name}</strong><br>
            <span class="muted">${money(prop.price)} â€¢ ${pct(prop.capRate)} cap â€¢ ${money(prop.netCashFlow)}/mo cash flow</span>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn-secondary btn-small" onclick="loadProperty(${i})">Load</button>
            <button class="btn-danger btn-small" onclick="deleteProperty(${i})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function loadProperty(index) {
      const prop = savedProperties[index];
      price.value = prop.price;
      down.value = prop.downPercent;
      document.getElementById('rate').value = prop.rate;
      document.getElementById('term').value = prop.term;
      rent.value = prop.monthlyRent;
      propertyTax.value = prop.annualTax;
      insurance.value = prop.annualInsurance;
      management.value = prop.managementPercent;
      vacancy.value = prop.vacancyPercent;
      otherExpenses.value = prop.otherMonthly;

      showPage('calculator');
      calcButton.click();
    }

    function deleteProperty(index) {
      if (confirm('Are you sure you want to delete this property?')) {
        savedProperties.splice(index, 1);
        updateComparisonTable();
      }
    }

    document.getElementById('runStressTest').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      const currentRate = +document.getElementById('currentRate').value / 100 / 12;
      const stressRate = +document.getElementById('stressRate').value / 100 / 12;
      const renewalYears = +document.getElementById('renewalPeriod').value;
      const price = currentProperty.price;
      const downPayment = currentProperty.downPayment;
      const loanAmount = price - downPayment + currentProperty.cmhcInsurance;
      const term = currentProperty.term * 12;
      const currentPayment = loanAmount * (currentRate * Math.pow(1 + currentRate, term)) / (Math.pow(1 + currentRate, term) - 1);
      const stressPayment = loanAmount * (stressRate * Math.pow(1 + stressRate, term)) / (Math.pow(1 + stressRate, term) - 1);
      const paymentIncrease = stressPayment - currentPayment;
      const newCashFlow = currentProperty.netCashFlow - paymentIncrease;
      document.getElementById('stressResults').innerHTML = `
        <div class="grid grid-2">
          <div class="metric">
            <div class="metric-value">${money(currentPayment)}</div>
            <div class="metric-label">Current Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--danger)">${money(stressPayment)}</div>
            <div class="metric-label">Stress Test Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--warning)">${money(paymentIncrease)}</div>
            <div class="metric-label">Monthly Increase</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:${newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(newCashFlow)}</div>
            <div class="metric-label">New Cash Flow</div>
          </div>
        </div>
        <div class="alert ${newCashFlow >= 0 ? 'alert-success' : 'alert-danger'}" style="margin-top:16px;">
          <strong>âœ… Stress Test Passed:</strong> Property maintains positive cash flow even at higher rates.
        </div>
      `;
      document.getElementById('stressResults').style.display = 'block';
    };

    document.getElementById('runRentAnalysis').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      const annualIncrease = +document.getElementById('rentIncrease').value / 100;
      const years = +document.getElementById('projectionYears').value;
      const currentRent = currentProperty.monthlyRent;
      let projectionHTML = '<h4>Rent Growth Projection</h4><table class="comparison-table"><tr><th>Year</th><th>Monthly Rent</th><th>Annual Income</th><th>Cash Flow</th></tr>';
      for (let year = 0; year <= Math.min(years, 10); year++) {
        const projectedRent = currentRent * Math.pow(1 + annualIncrease, year);
        const annualIncome = projectedRent * 12;
        const projectedCashFlow = currentProperty.netCashFlow + (projectedRent - currentRent);
        projectionHTML += `<tr>
          <td>Year ${year}</td>
          <td>${money(projectedRent)}</td>
          <td>${money(annualIncome)}</td>
          <td style="color:${projectedCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(projectedCashFlow)}</td>
        </tr>`;
      }
      projectionHTML += '</table>';
      document.getElementById('rentResults').style.display = 'block';
      document.getElementById('rentResults').innerHTML = projectionHTML;
    };

    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
      };
    });

    document.getElementById('addProperty').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first, then come back to add it to comparison.');
        return;
      }
      showPage('calculator');
    };

    function updateComparisonTable() {
      const container = document.getElementById('comparisonContainer');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Add properties from the calculator to compare them side-by-side.</div>';
        return;
      }
      container.innerHTML = `
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Property</th>
              <th>Price</th>
              <th>Down Payment</th>
              <th>Monthly Rent</th>
              <th>Cash Flow</th>
              <th>Cap Rate</th>
              <th>Cash-on-Cash</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${savedProperties.map((prop, i) => `
              <tr>
                <td><strong>${prop.name}</strong></td>
                <td>${money(prop.price)}</td>
                <td>${money(prop.downPayment)}</td>
                <td>${money(prop.monthlyRent)}</td>
                <td style="color:${prop.netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(prop.netCashFlow)}</td>
                <td>${pct(prop.capRate)}</td>
                <td>${pct(prop.cashOnCash)}</td>
                <td>
                  <button class="btn-secondary btn-small" onclick="loadProperty(${i})">Edit</button>
                  <button class="btn-danger btn-small" onclick="deleteProperty(${i})">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    document.getElementById('clearComparison').onclick = () => {
      if (confirm('Clear all saved properties?')) {
        savedProperties = [];
        updateComparisonTable();
        updateSavedPropertiesList();
      }
    };

    // Generate and save report to Drive
    document.getElementById('generateSummary').onclick = async () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      if (!accessToken) {
        alert("Please sign in with Google to use this feature.");
        return;
      }

      try {
        const reportHTML = `<!DOCTYPE html><html><head><title>Property Report</title></head><body>${document.getElementById('results').innerHTML}</body></html>`;
        const blob = new Blob([reportHTML], {type: 'text/html'});
        const fileName = `${currentProperty.name || 'Property'}-Report.html`;

        const file = await uploadToDrive(fileName, blob, 'text/html');
        if (file && file.id) {
          alert('Report saved to Google Drive!');
          const link = document.createElement('a');
          link.href = `https://drive.google.com/file/d/${file.id}/view`;
          link.target = '_blank';
          link.textContent = 'ðŸ“‚ View Report in Drive';
          link.className = 'btn btn-primary';
          link.style.display = 'inline-block';
          link.style.marginTop = '10px';
          document.getElementById('reportsPage').appendChild(link);
        }
      } catch (error) {
        console.error("Error generating summary:", error);
      }
    };

    document.getElementById('portfolioReport').onclick = () => {
      if (savedProperties.length === 0) {
        alert('No saved properties to analyze. Save some properties first.');
        return;
      }
      const totalInvestment = savedProperties.reduce((sum, prop) => sum + prop.totalInitialInvestment, 0);
      const totalCashFlow = savedProperties.reduce((sum, prop) => sum + prop.netCashFlow, 0);
      const totalNOI = savedProperties.reduce((sum, prop) => sum + prop.noi, 0);
      const avgCapRate = savedProperties.reduce((sum, prop) => sum + prop.capRate, 0) / savedProperties.length;
      const portfolioCOC = totalInvestment ? (totalCashFlow * 12 / totalInvestment) * 100 : 0;
      alert(`Portfolio Summary:
Total Properties: ${savedProperties.length}
Total Investment: ${money(totalInvestment)}
Monthly Cash Flow: ${money(totalCashFlow)}
Annual NOI: ${money(totalNOI)}
Average Cap Rate: ${pct(avgCapRate)}
Portfolio Cash-on-Cash: ${pct(portfolioCOC)}`);
    };

    document.getElementById('loadMarketData').onclick = () => {
      const city = document.getElementById('citySelect').value;
      const propType = document.getElementById('propertyType').value;
      setTimeout(() => {
        alert(`Loading market data for ${city} ${propType} properties...`);
        gtag('event', 'load_market_data', {
          city: city,
          property_type: propType
        });
      }, 500);
    };

    function updateExpenseBreakdown() {
      if (!currentProperty.price) {
        document.getElementById('expenseBreakdown').innerHTML = '<div class="alert alert-warning">Calculate a property first to see expense breakdown.</div>';
        return;
      }
      const monthlyTax = (currentProperty.annualTax || 0) / 12;
      const monthlyInsurance = (currentProperty.annualInsurance || 0) / 12;
      const managementFee = currentProperty.monthlyRent * (currentProperty.managementPercent || 0) / 100;
      const vacancyLoss = currentProperty.monthlyRent * (currentProperty.vacancyPercent || 0) / 100;
      const otherMonthly = currentProperty.otherMonthly || 0;
      const expenses = [
        {name: 'Mortgage Payment', amount: currentProperty.monthlyPayment, percent: 0},
        {name: 'Property Tax', amount: monthlyTax, percent: 0},
        {name: 'Insurance', amount: monthlyInsurance, percent: 0},
        {name: 'Management Fee', amount: managementFee, percent: currentProperty.managementPercent},
        {name: 'Vacancy Loss', amount: vacancyLoss, percent: currentProperty.vacancyPercent},
        {name: 'Other Expenses', amount: otherMonthly, percent: 0}
      ];
      const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      document.getElementById('expenseBreakdown').innerHTML = `
        <h4>Monthly Expense Breakdown</h4>
        <table class="comparison-table">
          <tr><th>Expense Category</th><th>Amount</th><th>% of Rent</th></tr>
          ${expenses.map(exp => `
            <tr>
              <td>${exp.name}</td>
              <td>${money(exp.amount)}</td>
              <td>${exp.percent ? pct(exp.percent) : pct((exp.amount / currentProperty.monthlyRent) * 100)}</td>
            </tr>
          `).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:bold;">
            <td>Total Expenses</td>
            <td>${money(totalExpenses)}</td>
            <td>${pct((totalExpenses / currentProperty.monthlyRent) * 100)}</td>
          </tr>
        </table>
        <div class="alert ${(totalExpenses / currentProperty.monthlyRent) < 0.75 ? 'alert-success' : 'alert-warning'}">
          <strong>Expense Ratio Analysis:</strong>
          ${(totalExpenses / currentProperty.monthlyRent) < 0.75 ?
            'Your expense ratio is healthy at under 75% of rental income.' :
            'Consider reducing expenses - current ratio is above recommended 75% threshold.'}
        </div>
      `;
    }

    document.querySelector('[data-page="analysis"]').addEventListener('click', () => {
      setTimeout(updateExpenseBreakdown, 100);
    });

    document.querySelector('[data-page="compare"]').addEventListener('click', () => {
      setTimeout(updateComparisonTable, 100);
    });

    document.querySelector('[data-page="reports"]').addEventListener('click', () => {
      setTimeout(updateSavedPropertiesList, 100);
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });

    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display='none';
          gtag('event', 'pwa_install');
        }
        deferredPrompt = null;
      }
    };

    window.addEventListener('load', () => {
      (adsbygoogle = window.adsbygoogle || []).push({});
    });
  </script>
</body>
</html>
