<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>PropCheck ‚Äì RE Calculator & Underwriting Tool</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701" crossorigin="anonymous"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Prevent horizontal scroll on mobile */
    html, body {
      overflow-x: hidden;
      max-width: 100%;
    }
    
    /* Fix input zoom on iOS */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    /* Custom scrollbar for property list */
    .property-scroll::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .property-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .property-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    
    /* PWA install button animation */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold text-green-600 flex items-center gap-2">
        <span class="text-2xl">üè†</span>
        <span>PropCheck</span>
      </h1>
      <div id="userInfo" class="text-xs sm:text-sm text-gray-600 truncate max-w-[150px] sm:max-w-none"></div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-4 sm:py-6 max-w-6xl">
    <!-- Google Sign-In Section -->
    <section id="authSection" class="mb-6">
      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm">
        <div class="flex flex-col items-center space-y-4">
          <p class="text-gray-600 text-center">Sign in to save and sync your properties across devices</p>
          
          <!-- Google Sign-In Button Container -->
          <div id="g_button_container" class="w-full max-w-xs"></div>
          
          <!-- Hidden div for Google Sign-In -->
          <div id="g_id_onload"
               data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
               data-callback="handleCredentialResponse"
               data-auto_prompt="false"
               style="display: none;">
          </div>
          
          <button id="signOutBtn" class="hidden px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
            Sign Out
          </button>
        </div>
      </div>
    </section>

    <!-- Calculator Section -->
    <section class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mb-6">
      <h2 class="text-lg sm:text-xl font-semibold mb-4">Property Calculator</h2>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Purchase Price ($)</label>
          <input id="price" type="number" placeholder="e.g., 500000" 
                 class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm text-gray-600 mb-1">Monthly Rent ($)</label>
          <input id="rent" type="number" placeholder="e.g., 2500" 
                 class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm text-gray-600 mb-1">Down Payment (%)</label>
          <input id="downPayment" type="number" value="20" min="0" max="100" 
                 class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm text-gray-600 mb-1">Interest Rate (%)</label>
          <input id="interestRate" type="number" value="5.5" step="0.1" min="0" max="30" 
                 class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
      </div>
      
      <!-- Results Section -->
      <div id="results" class="hidden mt-6 p-4 bg-green-50 rounded-lg">
        <h3 class="font-semibold text-green-800 mb-3">Quick Analysis</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-600">Monthly Payment</p>
            <p id="monthlyPayment" class="text-lg font-bold text-gray-800">$0</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Cash Flow</p>
            <p id="cashFlow" class="text-lg font-bold">$0</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Cap Rate</p>
            <p id="capRate" class="text-lg font-bold text-gray-800">0%</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Cash on Cash</p>
            <p id="cashOnCash" class="text-lg font-bold text-gray-800">0%</p>
          </div>
        </div>
      </div>
      
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <button id="calcButton" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium w-full sm:w-auto">
          Calculate
        </button>
        <button id="saveProperty" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          üíæ Save Property
        </button>
      </div>
    </section>

    <!-- Saved Properties Section -->
    <section class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg sm:text-xl font-semibold">Saved Properties</h2>
        <button id="clearAll" class="text-sm text-red-600 hover:text-red-700 hidden">Clear All</button>
      </div>
      
      <div id="propertiesList" class="property-scroll max-h-96 overflow-y-auto space-y-3">
        <p class="text-gray-500 text-center py-8">No saved properties yet. Calculate and save your first property!</p>
      </div>
    </section>

    <!-- PWA Install Section -->
    <section id="installSection" class="hidden mb-6">
      <button id="installBtn" class="w-full px-6 py-4 bg-gradient-to-r from-green-600 to-green-500 text-white rounded-lg hover:from-green-700 hover:to-green-600 transition font-medium flex items-center justify-center gap-2 pulse-animation">
        <span class="text-xl">üì≤</span>
        <span>Install PropCheck App</span>
      </button>
    </section>

    <!-- Ad Section -->
    <section class="mb-6">
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6166342215834701"
             data-ad-slot="1234567890"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-12">
    <div class="container mx-auto px-4 py-4 text-center text-sm text-gray-600">
      <p>¬© 2024 PropCheck. Real Estate Investment Calculator</p>
    </div>
  </footer>

  <script>
    // State management
    let currentUser = null;
    let currentProperty = null;
    let savedProperties = [];
    let deferredPrompt = null;

    // Initialize Google Sign-In
    window.onload = function() {
      // Load saved properties from localStorage
      const stored = localStorage.getItem('propcheck_properties');
      if (stored) {
        savedProperties = JSON.parse(stored);
        updatePropertiesList();
      }

      // Initialize Google Sign-In after a delay
      setTimeout(() => {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
          google.accounts.id.initialize({
            client_id: '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com',
            callback: handleCredentialResponse
          });
          
          // Render the button
          google.accounts.id.renderButton(
            document.getElementById('g_button_container'),
            {
              theme: 'outline',
              size: 'large',
              width: 280,
              text: 'signin_with',
              shape: 'rectangular'
            }
          );
        }
      }, 100);
      
      // Initialize AdSense
      try {
        (adsbygoogle = window.adsbygoogle || []).push({});
      } catch (e) {
        console.log('AdSense initialization error:', e);
      }
    };

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }

    // PWA Install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installSection').classList.remove('hidden');
    });

    document.getElementById('installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('PWA installed');
        gtag('event', 'pwa_install', { method: 'button' });
      }
      
      deferredPrompt = null;
      document.getElementById('installSection').classList.add('hidden');
    });

    // Handle Google Sign-In
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    function handleCredentialResponse(response) {
      const userData = parseJwt(response.credential);
      if (!userData) return;
      
      currentUser = userData;
      document.getElementById('userInfo').textContent = userData.email;
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('signOutBtn').classList.remove('hidden');
      
      gtag('event', 'login', { method: 'google' });
    }

    // Make it globally accessible
    window.handleCredentialResponse = handleCredentialResponse;

    // Sign Out
    document.getElementById('signOutBtn').onclick = () => {
      google.accounts.id.disableAutoSelect();
      currentUser = null;
      document.getElementById('userInfo').textContent = '';
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('signOutBtn').classList.add('hidden');
      location.reload();
    };

    // Calculator Logic
    document.getElementById('calcButton').onclick = () => {
      const price = parseFloat(document.getElementById('price').value) || 0;
      const rent = parseFloat(document.getElementById('rent').value) || 0;
      const downPaymentPercent = parseFloat(document.getElementById('downPayment').value) || 20;
      const interestRate = parseFloat(document.getElementById('interestRate').value) || 5.5;
      
      if (!price || !rent) {
        alert('Please enter both purchase price and monthly rent');
        return;
      }
      
      // Calculate mortgage details
      const downPayment = price * (downPaymentPercent / 100);
      const loanAmount = price - downPayment;
      const monthlyRate = interestRate / 100 / 12;
      const numPayments = 30 * 12; // 30-year mortgage
      
      // Monthly payment calculation
      const monthlyPayment = monthlyRate > 0 
        ? loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
          (Math.pow(1 + monthlyRate, numPayments) - 1)
        : loanAmount / numPayments;
      
      // Simple cash flow (rent minus mortgage)
      const cashFlow = rent - monthlyPayment;
      
      // Cap rate (annual NOI / price)
      const annualNOI = rent * 12 * 0.7; // Assume 70% NOI for simplicity
      const capRate = (annualNOI / price) * 100;
      
      // Cash on cash return
      const annualCashFlow = cashFlow * 12;
      const cashOnCash = downPayment > 0 ? (annualCashFlow / downPayment) * 100 : 0;
      
      // Store current property
      currentProperty = {
        price,
        rent,
        downPayment: downPaymentPercent,
        interestRate,
        monthlyPayment,
        cashFlow,
        capRate,
        cashOnCash,
        timestamp: new Date().toISOString()
      };
      
      // Display results
      document.getElementById('results').classList.remove('hidden');
      document.getElementById('monthlyPayment').textContent = `$${monthlyPayment.toFixed(0).toLocaleString()}`;
      document.getElementById('cashFlow').textContent = `$${cashFlow.toFixed(0).toLocaleString()}`;
      document.getElementById('cashFlow').className = cashFlow >= 0 
        ? 'text-lg font-bold text-green-600' 
        : 'text-lg font-bold text-red-600';
      document.getElementById('capRate').textContent = `${capRate.toFixed(2)}%`;
      document.getElementById('cashOnCash').textContent = `${cashOnCash.toFixed(2)}%`;
      
      // Enable save button
      document.getElementById('saveProperty').disabled = false;
      
      gtag('event', 'calculate_property', {
        value: price,
        currency: 'USD'
      });
    };

    // Save Property
    document.getElementById('saveProperty').onclick = () => {
      if (!currentProperty) {
        alert('Please calculate a property first');
        return;
      }
      
      const name = prompt('Enter a name for this property:', `Property ${savedProperties.length + 1}`);
      if (!name) return;
      
      currentProperty.name = name;
      currentProperty.id = Date.now().toString();
      savedProperties.push({...currentProperty});
      
      // Save to localStorage
      localStorage.setItem('propcheck_properties', JSON.stringify(savedProperties));
      
      updatePropertiesList();
      
      // Reset save button
      document.getElementById('saveProperty').disabled = true;
      
      gtag('event', 'save_property');
    };

    // Update Properties List
    function updatePropertiesList() {
      const container = document.getElementById('propertiesList');
      
      if (savedProperties.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No saved properties yet. Calculate and save your first property!</p>';
        document.getElementById('clearAll').classList.add('hidden');
        return;
      }
      
      document.getElementById('clearAll').classList.remove('hidden');
      
      container.innerHTML = savedProperties.map(prop => `
        <div class="p-4 border rounded-lg hover:bg-gray-50 transition">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800">${prop.name}</h3>
              <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                <span class="text-gray-600">Price: <strong>$${prop.price.toLocaleString()}</strong></span>
                <span class="text-gray-600">Rent: <strong>$${prop.rent.toLocaleString()}</strong></span>
                <span class="text-gray-600">Payment: <strong>$${prop.monthlyPayment.toFixed(0)}</strong></span>
                <span class="${prop.cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}">
                  Cash Flow: <strong>$${prop.cashFlow.toFixed(0)}</strong>
                </span>
              </div>
            </div>
            <button onclick="deleteProperty('${prop.id}')" class="ml-4 text-red-500 hover:text-red-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Delete Property
    window.deleteProperty = (id) => {
      if (!confirm('Delete this property?')) return;
      
      savedProperties = savedProperties.filter(p => p.id !== id);
      localStorage.setItem('propcheck_properties', JSON.stringify(savedProperties));
      updatePropertiesList();
    };

    // Clear All Properties
    document.getElementById('clearAll').onclick = () => {
      if (!confirm('Delete all saved properties?')) return;
      
      savedProperties = [];
      localStorage.removeItem('propcheck_properties');
      updatePropertiesList();
    };

    // Prevent form submission on Enter key
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('calcButton').click();
        }
      });
    });
  </script>
</body>
</html>
