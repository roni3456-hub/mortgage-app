<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck ‚Äì RE Calculator</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <style>
    :root{--brand:#2ecc71;--text:#2c3e50;--border:#e1e8ed;}
    body{margin:0;font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
    .login-card{max-width:400px;margin:100px auto;background:#fff;padding:32px;border-radius:16px;text-align:center}
    .btn{padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--brand);color:#fff}
    #mainApp{display:none;max-width:800px;margin:20px auto;background:#fff;padding:24px;border-radius:12px}
    .form-group{margin:16px 0}
    .form-group input{width:100%;padding:8px;border:1px solid var(--border);border-radius:4px}
    .sync-status{position:fixed;top:20px;right:20px;background:#fff;padding:8px 16px;border-radius:20px;display:none}
    .sync-status.show{display:block}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen" class="login-card">
    <h1>üè† PropCheck</h1>
    <p>Property Calculator with Drive Sync</p>
    
    <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
    
    <div style="margin:20px 0">or</div>
    
    <div id="g_button_target"></div>
    
    <div id="g_id_onload"
         data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"
         style="display:none"></div>
  </div>

  <!-- Main App -->
  <div id="mainApp">
    <div class="sync-status" id="syncStatus">
      <span id="syncText">Syncing...</span>
    </div>
    
    <h2>Property Calculator</h2>
    <div id="userInfo" style="margin-bottom:20px"></div>
    
    <div class="form-group">
      <label>Purchase Price ($)</label>
      <input id="price" type="number" placeholder="750000">
    </div>
    
    <div class="form-group">
      <label>Monthly Rent ($)</label>
      <input id="rent" type="number" placeholder="3200">
    </div>
    
    <button id="calcButton" class="btn btn-primary">Calculate</button>
    
    <div id="results" style="margin-top:20px"></div>
    
    <button id="saveButton" class="btn btn-primary" style="display:none;margin-top:20px">Save to Drive</button>
    
    <div id="savedList" style="margin-top:20px"></div>
    
    <button id="signOut" class="btn" style="margin-top:20px">Sign Out</button>
  </div>

  <script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCNEg2v7riXUZ_UdjqpkGT56wzMkw-gRxs';
    let currentUser = null;
    let accessToken = null;
    let driveReady = false;
    let savedData = [];

    // Parse JWT
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      return JSON.parse(atob(base64));
    }

    // Handle Google Sign-in
    function handleCredentialResponse(response) {
      currentUser = parseJwt(response.credential);
      loginScreen.style.display = 'none';
      mainApp.style.display = 'block';
      userInfo.innerHTML = `Signed in as: ${currentUser.name}`;
      
      // Request Drive access
      setTimeout(initDrive, 500);
    }

    // Initialize Drive
    async function initDrive() {
      try {
        await gapi.load('client', async () => {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
          });
          
          // Request OAuth token for Drive
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file',
            callback: (tokenResponse) => {
              accessToken = tokenResponse.access_token;
              gapi.client.setToken({access_token: accessToken});
              driveReady = true;
              loadFromDrive();
            }
          });
          
          tokenClient.requestAccessToken();
        });
      } catch (error) {
        console.error('Drive init error:', error);
      }
    }

    // Save to Drive
    async function saveToDrive() {
      if (!driveReady) return;
      
      showSync('Saving...');
      
      try {
        // Find or create folder
        let folderId = await findOrCreateFolder();
        
        // Save data
        const fileContent = JSON.stringify(savedData, null, 2);
        const file = new Blob([fileContent], {type: 'application/json'});
        
        const metadata = {
          name: 'propcheck_data.json',
          parents: [folderId]
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);
        
        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
          body: form
        });
        
        showSync('Saved!');
      } catch (error) {
        console.error('Save error:', error);
        showSync('Save failed');
      }
    }

    // Find or create PropCheck folder
    async function findOrCreateFolder() {
      const response = await gapi.client.drive.files.list({
        q: "name='PropCheck' and mimeType='application/vnd.google-apps.folder'",
        fields: 'files(id)'
      });
      
      if (response.result.files.length > 0) {
        return response.result.files[0].id;
      }
      
      const folder = await gapi.client.drive.files.create({
        resource: {
          name: 'PropCheck',
          mimeType: 'application/vnd.google-apps.folder'
        }
      });
      
      return folder.result.id;
    }

    // Load from Drive
    async function loadFromDrive() {
      if (!driveReady) return;
      
      try {
        const folderId = await findOrCreateFolder();
        
        const response = await gapi.client.drive.files.list({
          q: `name='propcheck_data.json' and '${folderId}' in parents`,
          fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
          const file = await gapi.client.drive.files.get({
            fileId: response.result.files[0].id,
            alt: 'media'
          });
          
          savedData = JSON.parse(file.result);
          updateSavedList();
          showSync('Data loaded');
        }
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    // Show sync status
    function showSync(text) {
      syncText.textContent = text;
      syncStatus.classList.add('show');
      setTimeout(() => syncStatus.classList.remove('show'), 3000);
    }

    // Update saved list
    function updateSavedList() {
      savedList.innerHTML = '<h3>Saved Properties</h3>' + 
        savedData.map(p => `<div>${p.price} - ${p.rent}/mo</div>`).join('');
    }

    // Initialize Google Sign-in
    window.onload = function() {
      setTimeout(() => {
        if (google?.accounts?.id) {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
          });
          
          google.accounts.id.renderButton(
            document.getElementById('g_button_target'),
            {theme: 'outline', size: 'large'}
          );
        }
      }, 500);
    };

    // Make function available globally
    window.handleCredentialResponse = handleCredentialResponse;

    // Guest login
    guestButton.onclick = () => {
      loginScreen.style.display = 'none';
      mainApp.style.display = 'block';
      userInfo.innerHTML = 'Guest Mode (no Drive sync)';
    };

    // Calculate
    calcButton.onclick = () => {
      const price = +document.getElementById('price').value;
      const rent = +document.getElementById('rent').value;
      
      if (price && rent) {
        const capRate = ((rent * 12) / price * 100).toFixed(2);
        results.innerHTML = `Cap Rate: ${capRate}%`;
        
        if (currentUser) {
          saveButton.style.display = 'block';
        }
      }
    };

    // Save
    saveButton.onclick = () => {
      const price = +document.getElementById('price').value;
      const rent = +document.getElementById('rent').value;
      
      savedData.push({price, rent, date: new Date()});
      updateSavedList();
      
      if (driveReady) {
        saveToDrive();
      }
    };

    // Sign out
    signOut.onclick = () => {
      location.reload();
    };
  </script>
</body>
</html>