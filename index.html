<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck â€“ RE Calculator & Underwriting Tool</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <!-- Google Identity Services for Authentication & OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client for Drive Access -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;--page-bg-3:#1abc9c;
      --page-bg-4:#3498db;--page-bg-5:#9b59b6;
    }
    body, html { font-family: 'Inter', sans-serif; background-color: #f7f9fc; color: #2c3e50; margin:0; padding:0; height:100%;}
    a { text-decoration: none; color: var(--brand); }
    .page-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      z-index: 1000;
      border-bottom: 1px solid #eee;
    }
    .top-bar-left, .top-bar-right { display: flex; align-items: center; }
    .top-bar-left .logo { font-weight: bold; font-size: 1.25rem; color: #2c3e50; }
    .top-bar-right .profile { margin-right: 10px; }
    .nav {
      display: flex;
      justify-content: space-around;
      border-bottom: 2px solid #ecf0f1;
      margin-top: 10px;
      position: sticky;
      top: 60px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      z-index: 999;
    }
    .nav-link {
      padding: 15px 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      transition: color 0.2s, border-bottom 0.2s;
      border-bottom: 2px solid transparent;
      text-align: center;
      flex-grow: 1;
    }
    .nav-link.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }
    .page-content {
      flex-grow: 1;
      padding-top: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 80px; /* Space for the bottom bar */
    }
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 10px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    .bottom-bar-left {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .bottom-bar-right {
      display: flex;
      align-items: center;
    }
    .bottom-bar-right button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .add-btn {
      background-color: var(--brand);
      color: white;
      margin-left: 10px;
    }
    .add-btn:hover {
      background-color: var(--brand-dark);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      width: 90%;
      text-align: center;
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    .modal-content .close-btn {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    .modal-content h3 {
      margin-top: 0;
      color: #333;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-buttons .cancel-btn {
      background: #eee;
      color: #333;
    }
    .modal-buttons .save-btn {
      background: var(--brand);
      color: #fff;
    }
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: linear-gradient(135deg, var(--page-bg-1) 0%, var(--page-bg-2) 100%);
      color: #fff;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s, opacity 0.3s;
    }
    .login-container.hidden {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card h4 {
      margin-top: 0;
      color: var(--brand);
    }
    .card .value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .card .value.positive { color: #27ae60; }
    .card .value.negative { color: #c0392b; }
    .ad-slot {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .prop-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f7f9fc;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: background-color 0.2s;
    }
    .prop-list-item:hover {
      background: #ecf0f1;
    }
    .prop-list-item .prop-title {
      font-weight: bold;
    }
    .prop-list-item .prop-meta {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .prop-list-item .prop-actions button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 10px;
      color: var(--muted);
      transition: color 0.2s;
    }
    .prop-list-item .prop-actions button:hover {
      color: var(--brand);
    }
    .install-button {
      background: var(--brand);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: none;
      margin-top: 20px;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .install-button:hover {
      background-color: var(--brand-dark);
    }
  </style>
</head>
<body>

  <!-- Modal for form input and messages -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content" id="modal-content">
      <span class="close-btn" id="close-modal-btn">&times;</span>
      <h3 id="modal-title"></h3>
      <div id="modal-body"></div>
      <div class="modal-buttons" id="modal-buttons"></div>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="app-container">
    <div class="login-container" id="login-container">
      <h1>PropCheck</h1>
      <p>Your ultimate real estate investment calculator.</p>
      <div id="g_id_onload"
        data-client_id="YOUR_GOOGLE_CLIENT_ID"
        data-callback="handleCredentialResponse"
        data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
        data-type="standard"
        data-size="large"
        data-theme="outline"
        data-text="sign_in_with"
        data-shape="pill"
        data-logo_alignment="left">
      </div>
      <button id="install-btn" class="install-button">Install App</button>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="page-container hidden">
      <div class="top-bar">
        <div class="top-bar-left">
          <div class="logo">PropCheck</div>
        </div>
        <div class="top-bar-right">
          <img id="profile-picture" class="profile" style="width: 40px; height: 40px; border-radius: 50%; display: none;" />
          <div id="user-name" style="display: none;"></div>
        </div>
      </div>
      <div class="nav">
        <div class="nav-link active" data-page="home">Home</div>
        <div class="nav-link" data-page="analysis">Analysis</div>
        <div class="nav-link" data-page="compare">Compare</div>
        <div class="nav-link" data-page="reports">Reports</div>
      </div>
      <div class="page-content" id="page-content">
        <!-- Page content will be rendered here -->
      </div>
      <div class="bottom-bar">
        <div class="bottom-bar-left">Total Cash Flow</div>
        <div class="bottom-bar-right">
          <div id="total-cash-flow" class="value positive">$0</div>
          <button id="add-property-btn" class="add-btn">Add Property</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Configuration and Global Variables for Google API and App State ---
    const API_KEY = 'AIzaSyCNEg2v7riXUZ_UdjqpkGT56wzMkw-gRxs';
    // NOTE: Replace 'YOUR_GOOGLE_CLIENT_ID' in the HTML with your actual client ID.
    // This is required for both the GSI and gapi.client to work.
    const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const GSI_CLIENT_ID = document.querySelector('[data-client_id]').dataset.clientId;

    let accessToken;
    let authInitialized = false;
    let appData = JSON.parse(localStorage.getItem('properties')) || [];
    let activeProperty = null;
    let currentTheme = 'home';
    let isEditing = false;
    let driveFolderId = null;

    // --- DOM Elements ---
    const loginContainer = document.getElementById('login-container');
    const mainContent = document.getElementById('main-content');
    const pageContent = document.getElementById('page-content');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const addPropertyBtn = document.getElementById('add-property-btn');
    const installBtn = document.getElementById('install-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    const totalCashFlowEl = document.getElementById('total-cash-flow');

    // --- Core App Functions ---

    // Generic function to show a modal with a title and content.
    function showModal(title, bodyHtml, buttonsHtml) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = bodyHtml;
      document.getElementById('modal-buttons').innerHTML = buttonsHtml;
      modalOverlay.classList.add('active');
    }

    // Function to hide the modal.
    function hideModal() {
      modalOverlay.classList.remove('active');
    }

    // --- Google Drive Integration Functions ---

    // A function to handle the Google Identity Services callback.
    function handleCredentialResponse(response) {
      // The GSI library handles sign-in, but we still need to get an access token for Drive.
      // This is the modern way to get a token and avoid pop-ups.
      const client = google.accounts.oauth2.initTokenClient({
        client_id: GSI_CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            showModal('Authorization Error', `<p>Failed to get Google Drive permissions. Please try again.</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
          } else {
            accessToken = tokenResponse.access_token;
            gapi.client.setToken({ access_token: accessToken });
            loginContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            renderPage('home');
          }
        },
      });
      client.requestAccessToken();
    }
    
    // Function to load the Google Drive API and handle authorization.
    function handleClientLoad() {
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
        }).then(() => {
          authInitialized = true;
          // The GSI flow will handle the token, so we just set up the client here.
        }, (error) => {
          showModal('API Initialization Error', `<p>Failed to load Google Drive API. Check your API key and network connection.</p><p>Error: ${error.details}</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
        });
      });
    }

    // A function to find or create the "Prop Check" folder in Google Drive.
    async function getDriveFolderId() {
      if (driveFolderId) {
        return driveFolderId;
      }
      try {
        // Search for the folder
        const response = await gapi.client.drive.files.list({
          q: "name='Prop Check' and mimeType='application/vnd.google-apps.folder' and trashed=false",
          spaces: 'drive',
          fields: 'files(id)',
        });

        if (response.result.files && response.result.files.length > 0) {
          driveFolderId = response.result.files[0].id;
          return driveFolderId;
        } else {
          // Create the folder if it doesn't exist
          const folderMetadata = {
            'name': 'Prop Check',
            'mimeType': 'application/vnd.google-apps.folder',
          };
          const res = await gapi.client.drive.files.create({
            resource: folderMetadata,
            fields: 'id',
          });
          driveFolderId = res.result.id;
          return driveFolderId;
        }
      } catch (error) {
        console.error('Error getting or creating folder:', error);
        showModal('Google Drive Error', `<p>Could not access or create the "Prop Check" folder. Please check your permissions.</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
        return null;
      }
    }

    // Function to save the application data to a file in Google Drive.
    async function saveToDrive() {
      if (!accessToken) {
        showModal('Sign In Required', `<p>Please sign in with Google to save your data to Google Drive.</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
        return;
      }

      showModal('Saving...', `<p>Please wait while we save your data to Google Drive.</p>`, '');

      try {
        const parentFolderId = await getDriveFolderId();
        if (!parentFolderId) {
          return;
        }

        const appDataJson = JSON.stringify(appData, null, 2);
        const fileName = `PropCheck-Data-${new Date().toISOString().slice(0, 10)}.json`;

        // Search for an existing file to update it instead of creating a new one every time.
        const fileListRes = await gapi.client.drive.files.list({
          q: `'${parentFolderId}' in parents and name='${fileName}' and trashed=false`,
          spaces: 'drive',
          fields: 'files(id)',
        });
        const existingFile = fileListRes.result.files[0];

        const fileMetadata = {
          'name': fileName,
          'parents': [parentFolderId],
        };
        const media = {
          mimeType: 'application/json',
          body: appDataJson,
        };

        if (existingFile) {
          // Update the existing file
          await gapi.client.drive.files.update({
            fileId: existingFile.id,
            resource: fileMetadata,
            media: media,
          });
          showModal('Saved Successfully!', `<p>Your data has been successfully updated on Google Drive!</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
        } else {
          // Create a new file
          await gapi.client.drive.files.create({
            resource: fileMetadata,
            media: media,
            fields: 'id',
          });
          showModal('Saved Successfully!', `<p>A new file named "${fileName}" has been created in your "Prop Check" folder on Google Drive!</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
        }

      } catch (error) {
        console.error('Error saving to Drive:', error);
        showModal('Saving Failed', `<p>There was an error saving your data. Please check your network connection and permissions.</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
      }
    }

    // Load the Google API Client on window load
    window.addEventListener('load', handleClientLoad);

    // --- Page Rendering and Data Management ---

    function getAppData() {
      // Logic to get the data to save from local storage
      return JSON.parse(localStorage.getItem('properties')) || [];
    }
    
    function saveAppData() {
      localStorage.setItem('properties', JSON.stringify(appData));
      updateTotalCashFlow();
      renderPage(currentTheme);
    }

    function addProperty(property) {
      appData.push(property);
      saveAppData();
      isEditing = false;
      showModal('Success!', `<p>Property added successfully!</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
    }

    function updateProperty(index, updatedProperty) {
      appData[index] = updatedProperty;
      saveAppData();
      isEditing = false;
      showModal('Success!', `<p>Property updated successfully!</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
    }

    function deleteProperty(index) {
      appData.splice(index, 1);
      saveAppData();
      showModal('Success!', `<p>Property deleted successfully!</p>`, `<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>`);
    }

    function calculatePropertyMetrics(property) {
      const grossIncome = (property.rent + property.otherIncome) * 12;
      const totalExpenses = (property.insurance + property.propertyTax + property.managementFees + property.vacancy + property.repairs + property.capex + property.hoa + property.utilities) * 12;
      const netOperatingIncome = grossIncome - totalExpenses;
      const annualDebtService = (property.loanAmount * (property.interestRate / 100 / 12)) / (1 - Math.pow(1 + (property.interestRate / 100 / 12), -property.loanTerm * 12)) * 12;
      const cashFlow = netOperatingIncome - annualDebtService;
      const cashOnCash = (cashFlow / property.downPayment) * 100;
      const capRate = (netOperatingIncome / property.purchasePrice) * 100;
      return { grossIncome, netOperatingIncome, cashFlow, cashOnCash, capRate };
    }

    function updateTotalCashFlow() {
      const total = appData.reduce((sum, prop) => {
        const metrics = calculatePropertyMetrics(prop);
        return sum + metrics.cashFlow;
      }, 0);
      totalCashFlowEl.textContent = `$${total.toFixed(0)}`;
      totalCashFlowEl.className = `value ${total >= 0 ? 'positive' : 'negative'}`;
    }

    function renderPage(pageId) {
      currentTheme = pageId;
      let pageHtml = '';
      navLinks.forEach(link => link.classList.remove('active'));
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');

      switch (pageId) {
        case 'home':
          pageHtml = `
            <h2>Welcome to PropCheck</h2>
            <p>Quickly analyze investment properties and save your reports.</p>
            <div class="ad-slot"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6166342215834701" data-ad-slot="9876543210" data-ad-format="auto" data-full-width-responsive="true"></ins></div>
            <div class="card">
              <h4>Total Properties Analyzed</h4>
              <div class="value">${appData.length}</div>
            </div>
          `;
          break;
        case 'analysis':
          pageHtml = `
            <h2>Property Analysis</h2>
            <p>Explore a breakdown of your property's financials.</p>
            <div id="analysis-content"></div>
            <div class="card">
              <h4>Cash Flow Breakdown</h4>
              <div id="expense-breakdown"></div>
            </div>
            <div class="card">
              <h4>Key Metrics</h4>
              <div id="key-metrics"></div>
            </div>
          `;
          break;
        case 'compare':
          pageHtml = `
            <h2>Compare Properties</h2>
            <p>See how your properties stack up against each other.</p>
            <div id="compare-table-container"></div>
            <div class="ad-slot"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6166342215834701" data-ad-slot="9876543210" data-ad-format="auto" data-full-width-responsive="true"></ins></div>
          `;
          break;
        case 'reports':
          pageHtml = `
            <h2>Saved Properties</h2>
            <p>Review, edit, and export your saved properties.</p>
            <div id="saved-properties-list"></div>
            <div class="card">
              <button id="save-to-drive-btn" class="save-btn" style="width:100%;"><i class="fa fa-google-drive"></i> Save to Google Drive</button>
            </div>
          `;
          break;
      }
      pageContent.innerHTML = pageHtml;

      if (pageId === 'reports') {
        const saveBtn = document.getElementById('save-to-drive-btn');
        if (saveBtn) {
          saveBtn.addEventListener('click', saveToDrive);
        }
      }
    }

    function updateExpenseBreakdown() {
      if (!activeProperty) {
        document.getElementById('analysis-content').innerHTML = `<p>Select a property from the Home or Reports page to see its analysis.</p>`;
        document.getElementById('expense-breakdown').innerHTML = '';
        document.getElementById('key-metrics').innerHTML = '';
        return;
      }

      const metrics = calculatePropertyMetrics(activeProperty);
      const breakdownHtml = `
        <p>Annual Gross Income: $${metrics.grossIncome.toFixed(0)}</p>
        <p>Total Expenses: $${(metrics.grossIncome - metrics.netOperatingIncome).toFixed(0)}</p>
        <p>Annual Debt Service: $${(metrics.grossIncome - metrics.netOperatingIncome - metrics.cashFlow).toFixed(0)}</p>
        <p>Annual Cash Flow: $${metrics.cashFlow.toFixed(0)}</p>
      `;
      document.getElementById('expense-breakdown').innerHTML = breakdownHtml;

      const keyMetricsHtml = `
        <p>Net Operating Income (NOI): $${metrics.netOperatingIncome.toFixed(0)}</p>
        <p>Cash on Cash Return: ${metrics.cashOnCash.toFixed(2)}%</p>
        <p>Cap Rate: ${metrics.capRate.toFixed(2)}%</p>
      `;
      document.getElementById('key-metrics').innerHTML = keyMetricsHtml;
    }

    function updateComparisonTable() {
      if (appData.length < 2) {
        document.getElementById('compare-table-container').innerHTML = `<p>Add at least two properties to compare them.</p>`;
        return;
      }
      let tableHtml = `
        <table style="width:100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr style="border-bottom: 2px solid #ccc;">
              <th style="padding: 10px;">Property</th>
              <th style="padding: 10px;">NOI</th>
              <th style="padding: 10px;">Cash Flow</th>
              <th style="padding: 10px;">CoC %</th>
              <th style="padding: 10px;">Cap Rate %</th>
            </tr>
          </thead>
          <tbody>
      `;
      appData.forEach(prop => {
        const metrics = calculatePropertyMetrics(prop);
        tableHtml += `
          <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 10px;">${prop.name}</td>
            <td style="padding: 10px;">$${metrics.netOperatingIncome.toFixed(0)}</td>
            <td style="padding: 10px;">$${metrics.cashFlow.toFixed(0)}</td>
            <td style="padding: 10px;">${metrics.cashOnCash.toFixed(2)}%</td>
            <td style="padding: 10px;">${metrics.capRate.toFixed(2)}%</td>
          </tr>
        `;
      });
      tableHtml += `</tbody></table>`;
      document.getElementById('compare-table-container').innerHTML = tableHtml;
    }

    function updateSavedPropertiesList() {
      const listEl = document.getElementById('saved-properties-list');
      if (appData.length === 0) {
        listEl.innerHTML = `<p>No properties saved yet. Click 'Add Property' to get started!</p>`;
        return;
      }
      listEl.innerHTML = appData.map((prop, index) => {
        return `
          <div class="prop-list-item">
            <div>
              <div class="prop-title">${prop.name}</div>
              <div class="prop-meta">Purchase Price: $${prop.purchasePrice}</div>
            </div>
            <div class="prop-actions">
              <button onclick="viewProperty(${index})">View</button>
              <button onclick="editProperty(${index})">Edit</button>
              <button onclick="confirmDelete(${index})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function confirmDelete(index) {
      showModal(
        'Confirm Deletion',
        `<p>Are you sure you want to delete the property '${appData[index].name}'?</p>`,
        `
        <button class="modal-buttons cancel-btn" onclick="hideModal()">Cancel</button>
        <button class="modal-buttons save-btn" onclick="deleteProperty(${index})">Delete</button>
        `
      );
    }

    function viewProperty(index) {
      activeProperty = appData[index];
      renderPage('analysis');
      setTimeout(updateExpenseBreakdown, 100);
    }

    function editProperty(index) {
      isEditing = true;
      const prop = appData[index];
      activeProperty = { ...prop, index };
      showPropertyModal('Edit Property');
      document.getElementById('property-name').value = prop.name;
      document.getElementById('purchase-price').value = prop.purchasePrice;
      document.getElementById('down-payment').value = prop.downPayment;
      document.getElementById('loan-amount').value = prop.loanAmount;
      document.getElementById('interest-rate').value = prop.interestRate;
      document.getElementById('loan-term').value = prop.loanTerm;
      document.getElementById('rent').value = prop.rent;
      document.getElementById('other-income').value = prop.otherIncome;
      document.getElementById('insurance').value = prop.insurance;
      document.getElementById('property-tax').value = prop.propertyTax;
      document.getElementById('management-fees').value = prop.managementFees;
      document.getElementById('vacancy').value = prop.vacancy;
      document.getElementById('repairs').value = prop.repairs;
      document.getElementById('capex').value = prop.capex;
      document.getElementById('hoa').value = prop.hoa;
      document.getElementById('utilities').value = prop.utilities;
    }

    function showPropertyModal(title) {
      const formHtml = `
        <form id="property-form">
          <div class="form-group">
            <label for="property-name">Property Name</label>
            <input type="text" id="property-name" required>
          </div>
          <div class="form-group">
            <label for="purchase-price">Purchase Price ($)</label>
            <input type="number" id="purchase-price" required>
          </div>
          <div class="form-group">
            <label for="down-payment">Down Payment ($)</label>
            <input type="number" id="down-payment" required>
          </div>
          <div class="form-group">
            <label for="loan-amount">Loan Amount ($)</label>
            <input type="number" id="loan-amount" required>
          </div>
          <div class="form-group">
            <label for="interest-rate">Interest Rate (%)</label>
            <input type="number" step="0.01" id="interest-rate" required>
          </div>
          <div class="form-group">
            <label for="loan-term">Loan Term (years)</label>
            <input type="number" id="loan-term" required>
          </div>
          <h4>Monthly Income</h4>
          <div class="form-group">
            <label for="rent">Rent ($)</label>
            <input type="number" id="rent" required>
          </div>
          <div class="form-group">
            <label for="other-income">Other Income ($)</label>
            <input type="number" id="other-income" required>
          </div>
          <h4>Monthly Expenses</h4>
          <div class="form-group">
            <label for="insurance">Insurance ($)</label>
            <input type="number" id="insurance" required>
          </div>
          <div class="form-group">
            <label for="property-tax">Property Tax ($)</label>
            <input type="number" id="property-tax" required>
          </div>
          <div class="form-group">
            <label for="management-fees">Management Fees ($)</label>
            <input type="number" id="management-fees" required>
          </div>
          <div class="form-group">
            <label for="vacancy">Vacancy ($)</label>
            <input type="number" id="vacancy" required>
          </div>
          <div class="form-group">
            <label for="repairs">Repairs ($)</label>
            <input type="number" id="repairs" required>
          </div>
          <div class="form-group">
            <label for="capex">CapEx ($)</label>
            <input type="number" id="capex" required>
          </div>
          <div class="form-group">
            <label for="hoa">HOA ($)</label>
            <input type="number" id="hoa" required>
          </div>
          <div class="form-group">
            <label for="utilities">Utilities ($)</label>
            <input type="number" id="utilities" required>
          </div>
        </form>
      `;
      const buttonsHtml = `
        <button class="modal-buttons cancel-btn" onclick="hideModal()">Cancel</button>
        <button class="modal-buttons save-btn" id="save-property-btn">Save Property</button>
      `;
      showModal(title, formHtml, buttonsHtml);
      const saveBtn = document.getElementById('save-property-btn');
      saveBtn.onclick = (e) => {
        e.preventDefault();
        const form = document.getElementById('property-form');
        if (form.checkValidity()) {
          const newProperty = {
            name: document.getElementById('property-name').value,
            purchasePrice: parseFloat(document.getElementById('purchase-price').value),
            downPayment: parseFloat(document.getElementById('down-payment').value),
            loanAmount: parseFloat(document.getElementById('loan-amount').value),
            interestRate: parseFloat(document.getElementById('interest-rate').value),
            loanTerm: parseFloat(document.getElementById('loan-term').value),
            rent: parseFloat(document.getElementById('rent').value),
            otherIncome: parseFloat(document.getElementById('other-income').value),
            insurance: parseFloat(document.getElementById('insurance').value),
            propertyTax: parseFloat(document.getElementById('property-tax').value),
            managementFees: parseFloat(document.getElementById('management-fees').value),
            vacancy: parseFloat(document.getElementById('vacancy').value),
            repairs: parseFloat(document.getElementById('repairs').value),
            capex: parseFloat(document.getElementById('capex').value),
            hoa: parseFloat(document.getElementById('hoa').value),
            utilities: parseFloat(document.getElementById('utilities').value),
          };
          if (isEditing && activeProperty.index !== undefined) {
            updateProperty(activeProperty.index, newProperty);
          } else {
            addProperty(newProperty);
          }
          hideModal();
        } else {
          showModal('Invalid Input', '<p>Please fill out all fields with valid numbers.</p>', '<button class="modal-buttons save-btn" onclick="hideModal()">OK</button>');
        }
      };
    }

    // --- Event Listeners and Initializers ---

    closeModalBtn.addEventListener('click', hideModal);
    addPropertyBtn.addEventListener('click', () => {
      isEditing = false;
      activeProperty = null;
      showPropertyModal('Add New Property');
    });

    // PWA functionality
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    
    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display='none';
          gtag('event', 'pwa_install');
        }
        deferredPrompt = null;
      }
    };

    // Initialize AdSense ads on page load
    window.addEventListener('load', () => {
      (adsbygoogle = window.adsbygoogle || []).push({});
    });

    // Update expense breakdown when switching to analysis page
    document.querySelector('[data-page="analysis"]').addEventListener('click', () => {
      renderPage('analysis');
      setTimeout(updateExpenseBreakdown, 100);
    });

    // Update comparison table when switching to compare page  
    document.querySelector('[data-page="compare"]').addEventListener('click', () => {
      renderPage('compare');
      setTimeout(updateComparisonTable, 100);
    });

    // Update saved properties when switching to reports page
    document.querySelector('[data-page="reports"]').addEventListener('click', () => {
      renderPage('reports');
      setTimeout(updateSavedPropertiesList, 100);
    });

    // Handle initial login flow if the user is already authenticated.
    if (!localStorage.getItem('properties')) {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GSI_CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (!tokenResponse.error) {
            accessToken = tokenResponse.access_token;
            gapi.client.setToken({ access_token: accessToken });
            loginContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            renderPage('home');
            updateTotalCashFlow();
          } else {
            // User not signed in or denied permissions
            loginContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
          }
        },
      });
      tokenClient.requestAccessToken({prompt: 'none'});
    } else {
      loginContainer.classList.add('hidden');
      mainContent.classList.remove('hidden');
      renderPage('home');
      updateTotalCashFlow();
    }
  </script>
</body>
</html>
    });
  </script>
</body>
</html>
