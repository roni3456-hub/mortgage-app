<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck â€“ RE Calculator & Underwriting Tool</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --brand: #2ecc71;
      --brand-dark: #27ae60;
      --muted: #7f8c8d;
      --card-bg: #ffffff;
      --page-bg-1: #667eea;
      --page-bg-2: #764ba2;
      --text-color: #333;
      --heading-color: #2c3e50;
      --border-color: #e0e0e0;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --input-bg: #f8f8f8;
      --button-hover: #f1f1f1;
    }

    /* Dark Mode Variables */
    body[data-theme="dark"] {
      --card-bg: #2d3748;
      --page-bg-1: #1a202c;
      --page-bg-2: #2d3748;
      --text-color: #e2e8f0;
      --heading-color: #f7fafc;
      --border-color: #4a5568;
      --input-bg: #4a5568;
      --button-hover: #4a5568;
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(45deg, var(--page-bg-1), var(--page-bg-2));
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .app-container {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--box-shadow);
      margin: 20px;
      padding: 24px;
      width: 95%;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--heading-color);
      font-weight: 600;
    }

    nav {
      display: flex;
      gap: 16px;
    }

    .nav-button {
      background-color: transparent;
      border: none;
      color: var(--muted);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: color 0.2s ease, background-color 0.2s ease;
    }

    .nav-button:hover, .nav-button.active {
      color: var(--brand);
    }

    .nav-button.active {
      background-color: var(--brand);
      color: #fff;
    }

    .main-content {
      display: flex;
      flex-direction: column;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-top: 16px;
      border: 1px solid var(--border-color);
    }

    h2 {
      color: var(--heading-color);
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .input-group label {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .input-group input, .input-group select {
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    .button-container {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .button:active {
      transform: scale(0.98);
    }

    .button.primary {
      background-color: var(--brand);
      color: #fff;
    }

    .button.secondary {
      background-color: var(--muted);
      color: #fff;
    }

    .button.light {
      background-color: #f0f0f0;
      color: var(--text-color);
    }

    .button.light:hover {
      background-color: var(--button-hover);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .result-item {
      padding: 16px;
      background-color: var(--input-bg);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .result-item span:first-child {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .result-item span:last-child {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--heading-color);
    }

    .expense-breakdown-table, .comparison-table, .reports-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .expense-breakdown-table th, .expense-breakdown-table td,
    .comparison-table th, .comparison-table td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
    }

    .expense-breakdown-table th, .comparison-table th {
      background-color: var(--input-bg);
      color: var(--heading-color);
      font-weight: 600;
    }

    .stress-test-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 16px;
    }

    .stress-test-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background-color: var(--input-bg);
      border-radius: 8px;
    }

    .stress-test-item span {
      font-weight: 500;
    }

    .reports-list li {
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab-button {
      padding: 8px 16px;
      font-size: 1rem;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--muted);
      font-weight: 500;
      position: relative;
    }

    .tab-button.active {
      color: var(--brand);
      border-bottom: 2px solid var(--brand);
      margin-bottom: -1px;
    }

    .validation-message {
      color: red;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }
    
    .validation-message.active {
      display: block;
    }
    
    .pwa-install-button {
      background-color: var(--brand);
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      display: none; /* Initially hidden */
    }

    .save-message {
      color: var(--brand);
      font-size: 0.9rem;
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    
    .save-message.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 16px;
      }

      header {
        flex-direction: column;
        gap: 16px;
      }

      nav {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div id="g_id_onload"
       data-client_id="845244585117-91f86q131m5u6p67mks3038q9916q88o.apps.googleusercontent.com"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse">
  </div>
  <main class="app-container">
    <header>
      <div class="logo-container">
        <img class="logo" src="https://placehold.co/100x100/2ecc71/ffffff?text=PC" alt="PropCheck Logo">
        <h1>PropCheck</h1>
      </div>
      <nav>
        <button class="nav-button active" data-page="calculator">Calculator</button>
        <button class="nav-button" data-page="analysis">Analysis</button>
        <button class="nav-button" data-page="compare">Compare</button>
        <button class="nav-button" data-page="reports">Reports</button>
        <button class="nav-button" id="darkModeBtn">Dark Mode</button>
        <button class="pwa-install-button" id="pwaInstallBtn">Download App</button>
      </nav>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large"
           data-theme="outline"
           data-text="sign_in_with"
           data-shape="rectangular"
           data-logo_alignment="left"
           data-callback="handleCredentialResponse">
      </div>
    </header>
    <section class="main-content">
      <div id="calculator-page" class="page active">
        <div class="card">
          <h2>Property Details</h2>
          <div class="input-group">
            <label for="property-name">Property Name</label>
            <input type="text" id="property-name" placeholder="e.g., 123 Maple St">
          </div>
          <div class="input-group">
            <label for="purchase-price">Purchase Price ($)</label>
            <input type="number" id="purchase-price" placeholder="500000" />
            <span class="validation-message" id="price-validation">Purchase price is required.</span>
          </div>
          <div class="input-group">
            <label for="down-payment">Down Payment ($) or (%)</label>
            <input type="text" id="down-payment" placeholder="e.g., 100000 or 20%" />
            <span class="validation-message" id="down-payment-validation">Down payment must be a valid dollar amount or percentage.</span>
          </div>
          <div class="input-group">
            <label for="interest-rate">Interest Rate (%)</label>
            <input type="number" step="0.01" id="interest-rate" placeholder="5" />
          </div>
          <div class="input-group">
            <label for="amortization">Amortization (years)</label>
            <input type="number" id="amortization" placeholder="25" />
          </div>
          <div class="input-group">
            <label for="closing-costs">Closing Costs ($) or (%)</label>
            <input type="text" id="closing-costs" placeholder="e.g., 10000 or 2%" />
          </div>
          <div class="input-group">
            <label for="cmhc-insured">Is CMHC Insured?</label>
            <select id="cmhc-insured">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>
        <div class="card">
          <h2>Income & Expenses</h2>
          <div class="input-group">
            <label for="monthly-rent">Monthly Rent ($)</label>
            <input type="number" id="monthly-rent" placeholder="2500" />
            <span class="validation-message" id="rent-validation">Monthly rent is required.</span>
          </div>
          <div class="input-group">
            <label for="property-tax">Property Tax ($/yr)</label>
            <input type="number" id="property-tax" placeholder="3000" />
          </div>
          <div class="input-group">
            <label for="insurance">Insurance ($/yr)</label>
            <input type="number" id="insurance" placeholder="1200" />
          </div>
          <div class="input-group">
            <label for="strata-fees">Strata Fees ($/mo)</label>
            <input type="number" id="strata-fees" placeholder="350" />
          </div>
          <div class="input-group">
            <label for="utility-costs">Utility Costs ($/mo)</label>
            <input type="number" id="utility-costs" placeholder="150" />
          </div>
          <div class="input-group">
            <label for="maintenance-costs">Maintenance Costs (%)</label>
            <input type="number" id="maintenance-costs" placeholder="10" />
          </div>
          <div class="input-group">
            <label for="vacancy-rate">Vacancy Rate (%)</label>
            <input type="number" id="vacancy-rate" placeholder="5" />
          </div>
          <div class="input-group">
            <label for="capex-budget">CapEx Budget ($/yr)</label>
            <input type="number" id="capex-budget" placeholder="1000" />
          </div>
          <div class="input-group">
            <label for="property-photos">Property Photos</label>
            <input type="file" id="property-photos" accept="image/*" multiple>
            <div id="photo-preview-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
          </div>
        </div>
        <div class="button-container">
          <button class="button primary" id="calculate-btn">Calculate</button>
          <button class="button light" id="save-btn">Save Property</button>
          <div id="save-message" class="save-message"></div>
        </div>
      </div>
      <div id="analysis-page" class="page">
        <div class="card">
          <div class="tabs">
            <button class="tab-button active" data-tab="summary">Summary</button>
            <button class="tab-button" data-tab="breakdown">Breakdown</button>
            <button class="tab-button" data-tab="stress-test">Stress Test</button>
            <button class="tab-button" data-tab="proforma">Pro Forma</button>
            <button class="tab-button" data-tab="sensitivity">Sensitivity Analysis</button>
          </div>
          <div id="summary-tab" class="tab-content active">
            <h2>Summary</h2>
            <div id="summary-content" class="results-grid"></div>
          </div>
          <div id="breakdown-tab" class="tab-content">
            <h2>Monthly Expense Breakdown</h2>
            <table class="expense-breakdown-table">
              <thead>
                <tr>
                  <th>Expense</th>
                  <th>Amount ($)</th>
                </tr>
              </thead>
              <tbody id="expense-breakdown-body"></tbody>
            </table>
          </div>
          <div id="stress-test-tab" class="tab-content">
            <h2>Stress Test</h2>
            <div class="input-group">
              <label for="stress-test-rate">Stress Interest Rate (%)</label>
              <input type="number" step="0.1" id="stress-test-rate" placeholder="6.5" />
            </div>
            <div id="stress-test-results" class="stress-test-container"></div>
          </div>
          <div id="proforma-tab" class="tab-content">
            <h2>10-Year Pro Forma</h2>
            <div class="input-group">
              <label for="rent-growth">Annual Rent Growth (%)</label>
              <input type="number" step="0.1" id="rent-growth" placeholder="2.5">
            </div>
            <div class="input-group">
              <label for="expense-inflation">Annual Expense Inflation (%)</label>
              <input type="number" step="0.1" id="expense-inflation" placeholder="2">
            </div>
            <div class="input-group">
              <label for="appreciation-rate">Annual Appreciation Rate (%)</label>
              <input type="number" step="0.1" id="appreciation-rate" placeholder="3">
            </div>
            <div id="proforma-table-container" style="overflow-x:auto;">
              <table class="expense-breakdown-table" id="proforma-table">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Gross Income</th>
                    <th>Total Expenses</th>
                    <th>NOI</th>
                    <th>Cash Flow</th>
                    <th>Property Value</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="sensitivity-tab" class="tab-content">
            <h2>Sensitivity Analysis</h2>
            <canvas id="sensitivity-chart"></canvas>
          </div>
        </div>
      </div>
      <div id="compare-page" class="page">
        <div class="card">
          <h2>Compare Saved Properties</h2>
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Property</th>
                <th>Cap Rate</th>
                <th>CoC ROI</th>
                <th>Total Cash Flow</th>
                <th>NOI</th>
                <th>Price/SqFt</th>
              </tr>
            </thead>
            <tbody id="comparison-table-body"></tbody>
          </table>
        </div>
      </div>
      <div id="reports-page" class="page">
        <div class="card">
          <h2>Saved Properties</h2>
          <ul id="saved-properties-list" class="reports-list"></ul>
        </div>
      </div>
    </section>
  </main>
  <div style="text-align: center; margin-top: 20px;">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-6166342215834701"
         data-ad-slot="9876543210"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
  </div>

  <script>
    window.jsPDF = window.jspdf.jsPDF;
    const CMHC_RATES = {
      95: 4.0, 90: 3.1, 85: 2.8, 80: 0
    };
    let currentProperty = {};
    let savedProperties = [];
    let sensitivityChart;
    let uploadedPhotos = [];
    let deferredPrompt;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize theme based on local storage
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);

      document.querySelectorAll('.nav-button').forEach(button => {
        button.addEventListener('click', (event) => {
          document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
          event.target.classList.add('active');
          document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
          const pageId = event.target.getAttribute('data-page') + '-page';
          document.getElementById(pageId).classList.add('active');
          if (pageId === 'analysis-page') {
            document.querySelector('.tab-button.active')?.click();
          }
        });
      });

      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (event) => {
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          event.target.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          const tabId = event.target.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
          if (tabId === 'breakdown-tab') updateExpenseBreakdown();
          if (tabId === 'proforma-tab') updateProFormaTable();
          if (tabId === 'sensitivity-tab') createSensitivityChart();
        });
      });

      document.getElementById('calculate-btn').addEventListener('click', calculateFinancials);
      document.getElementById('save-btn').addEventListener('click', saveProperty);
      document.getElementById('stress-test-rate').addEventListener('input', updateStressTest);
      document.getElementById('darkModeBtn').addEventListener('click', toggleDarkMode);
      document.getElementById('property-photos').addEventListener('change', handlePhotoUpload);

      // PWA functionality
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service worker registered.', reg))
          .catch(err => console.log('Service worker registration failed.', err));
      }
      
      const pwaInstallBtn = document.getElementById('pwaInstallBtn');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        pwaInstallBtn.style.display = 'inline-block';
      });

      pwaInstallBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            console.log('User accepted the install prompt.');
            gtag('event', 'pwa_install');
          } else {
            console.log('User dismissed the install prompt.');
          }
          deferredPrompt = null;
          pwaInstallBtn.style.display = 'none';
        }
      });
      
      window.addEventListener('appinstalled', (e) => {
        pwaInstallBtn.style.display = 'none';
      });

      // Initialize AdSense ads on page load
      window.addEventListener('load', () => {
        (adsbygoogle = window.adsbygoogle || []).push({});
      });
    });

    function toggleDarkMode() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function handlePhotoUpload(event) {
      const files = event.target.files;
      const previewContainer = document.getElementById('photo-preview-container');
      previewContainer.innerHTML = '';
      uploadedPhotos = [];

      for (const file of files) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedPhotos.push(e.target.result);
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      }
    }

    function calculateFinancials() {
      const purchasePrice = parseFloat(document.getElementById('purchase-price').value);
      const monthlyRent = parseFloat(document.getElementById('monthly-rent').value);
      const propertyName = document.getElementById('property-name').value || 'New Property';
      const downPaymentInput = document.getElementById('down-payment').value;
      const interestRate = parseFloat(document.getElementById('interest-rate').value) / 100;
      const amortization = parseFloat(document.getElementById('amortization').value) * 12;
      const cmhcInsured = document.getElementById('cmhc-insured').value === 'true';
      const propertyTax = parseFloat(document.getElementById('property-tax').value);
      const insurance = parseFloat(document.getElementById('insurance').value);
      const strataFees = parseFloat(document.getElementById('strata-fees').value);
      const utilityCosts = parseFloat(document.getElementById('utility-costs').value);
      const maintenanceCosts = parseFloat(document.getElementById('maintenance-costs').value) / 100;
      const vacancyRate = parseFloat(document.getElementById('vacancy-rate').value) / 100;
      const capexBudget = parseFloat(document.getElementById('capex-budget').value);
      const closingCostsInput = document.getElementById('closing-costs').value;

      document.getElementById('price-validation').classList.remove('active');
      document.getElementById('rent-validation').classList.remove('active');
      document.getElementById('down-payment-validation').classList.remove('active');

      if (isNaN(purchasePrice) || purchasePrice <= 0) {
        document.getElementById('price-validation').classList.add('active');
        return;
      }
      if (isNaN(monthlyRent) || monthlyRent <= 0) {
        document.getElementById('rent-validation').classList.add('active');
        return;
      }

      let downPayment;
      if (downPaymentInput.includes('%')) {
        downPayment = purchasePrice * (parseFloat(downPaymentInput) / 100);
      } else {
        downPayment = parseFloat(downPaymentInput);
      }

      if (isNaN(downPayment) || downPayment < purchasePrice * 0.05) {
        document.getElementById('down-payment-validation').textContent = 'Down payment must be at least 5% of the purchase price.';
        document.getElementById('down-payment-validation').classList.add('active');
        return;
      }
      
      let closingCosts;
      if (closingCostsInput.includes('%')) {
        closingCosts = purchasePrice * (parseFloat(closingCostsInput) / 100);
      } else {
        closingCosts = parseFloat(closingCostsInput) || 0;
      }

      const mortgageAmount = purchasePrice - downPayment;
      const cmhcRate = cmhcInsured ? (CMHC_RATES[Math.round((downPayment / purchasePrice) * 100)] || 0) / 100 : 0;
      const cmhcFee = mortgageAmount * cmhcRate;
      const totalLoanAmount = mortgageAmount + cmhcFee;
      const monthlyInterestRate = interestRate / 12;
      const mortgagePayment = totalLoanAmount * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, amortization)) / (Math.pow(1 + monthlyInterestRate, amortization) - 1);
      
      const monthlyExpenses = (propertyTax / 12) + (insurance / 12) + (maintenanceCosts * monthlyRent) + strataFees + utilityCosts + (capexBudget / 12);
      const totalMonthlyExpenses = monthlyExpenses + mortgagePayment;
      const grossMonthlyIncome = monthlyRent;
      const netOperatingIncome = (grossMonthlyIncome * 12) - (propertyTax + insurance + (maintenanceCosts * monthlyRent * 12) + (strataFees * 12) + (utilityCosts * 12) + capexBudget);
      const annualCashFlow = (grossMonthlyIncome * 12) - (totalMonthlyExpenses * 12) - (grossMonthlyIncome * 12 * vacancyRate);
      const capRate = (netOperatingIncome / purchasePrice) * 100;
      const totalInvestment = downPayment + closingCosts;
      const cocRoi = (annualCashFlow / totalInvestment) * 100;
      
      currentProperty = {
        name: propertyName,
        purchasePrice,
        downPayment,
        interestRate: interestRate * 100,
        amortization: amortization / 12,
        monthlyRent,
        propertyTax,
        insurance,
        strataFees,
        utilityCosts,
        maintenanceCosts: maintenanceCosts * 100,
        vacancyRate: vacancyRate * 100,
        capexBudget,
        closingCosts,
        cmhcFee,
        mortgagePayment,
        totalMonthlyExpenses,
        grossMonthlyIncome: grossMonthlyIncome,
        netOperatingIncome,
        annualCashFlow,
        capRate,
        totalInvestment,
        cocRoi,
        uploadedPhotos
      };
      
      updateSummary();
      updateStressTest();
      document.querySelector('.nav-button[data-page="analysis"]').click();
    }

    function updateSummary() {
      const resultsGrid = document.getElementById('summary-content');
      resultsGrid.innerHTML = `
        <div class="result-item">
          <span>Cap Rate</span>
          <span>${currentProperty.capRate.toFixed(2)}%</span>
        </div>
        <div class="result-item">
          <span>CoC ROI</span>
          <span>${currentProperty.cocRoi.toFixed(2)}%</span>
        </div>
        <div class="result-item">
          <span>Annual Cash Flow</span>
          <span>$${currentProperty.annualCashFlow.toFixed(2)}</span>
        </div>
        <div class="result-item">
          <span>Net Operating Income</span>
          <span>$${currentProperty.netOperatingIncome.toFixed(2)}</span>
        </div>
        <div class="result-item">
          <span>Total Monthly Pmt</span>
          <span>$${currentProperty.totalMonthlyExpenses.toFixed(2)}</span>
        </div>
        <div class="result-item">
          <span>Total Investment</span>
          <span>$${currentProperty.totalInvestment.toFixed(2)}</span>
        </div>
      `;
    }

    function updateExpenseBreakdown() {
      const breakdownBody = document.getElementById('expense-breakdown-body');
      const p = currentProperty;
      breakdownBody.innerHTML = `
        <tr><td>Mortgage Payment</td><td>$${p.mortgagePayment.toFixed(2)}</td></tr>
        <tr><td>Property Tax (Monthly)</td><td>$${(p.propertyTax / 12).toFixed(2)}</td></tr>
        <tr><td>Insurance (Monthly)</td><td>$${(p.insurance / 12).toFixed(2)}</td></tr>
        <tr><td>Strata Fees</td><td>$${p.strataFees.toFixed(2)}</td></tr>
        <tr><td>Utility Costs</td><td>$${p.utilityCosts.toFixed(2)}</td></tr>
        <tr><td>Maintenance (Est.)</td><td>$${(p.monthlyRent * p.maintenanceCosts / 100).toFixed(2)}</td></tr>
        <tr><td>CapEx Budget (Monthly)</td><td>$${(p.capexBudget / 12).toFixed(2)}</td></tr>
        <tr><th>Total Monthly Expenses</th><th>$${p.totalMonthlyExpenses.toFixed(2)}</th></tr>
        <tr><td>Vacancy (Est.)</td><td>$${(p.monthlyRent * p.vacancyRate / 100).toFixed(2)}</td></tr>
      `;
    }

    function updateStressTest() {
      const stressRateInput = document.getElementById('stress-test-rate');
      const stressRate = parseFloat(stressRateInput.value) / 100;
      const resultsContainer = document.getElementById('stress-test-results');
      if (isNaN(stressRate) || !currentProperty.purchasePrice) {
        resultsContainer.innerHTML = 'Enter an interest rate to run a stress test.';
        return;
      }
      
      const p = currentProperty;
      const mortgageAmount = p.purchasePrice - p.downPayment;
      const cmhcFee = (p.cmhcFee > 0) ? (mortgageAmount * (p.cmhcFee / p.purchasePrice)) : 0;
      const totalLoanAmount = mortgageAmount + cmhcFee;
      const monthlyInterestRate = stressRate / 12;
      const newMortgagePayment = totalLoanAmount * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, p.amortization * 12)) / (Math.pow(1 + monthlyInterestRate, p.amortization * 12) - 1);
      
      const newTotalMonthlyExpenses = p.totalMonthlyExpenses - p.mortgagePayment + newMortgagePayment;
      const newAnnualCashFlow = (p.grossMonthlyIncome * 12) - (newTotalMonthlyExpenses * 12) - (p.grossMonthlyIncome * 12 * (p.vacancyRate / 100));

      resultsContainer.innerHTML = `
        <div class="stress-test-item">
          <span>New Mortgage Payment</span>
          <span>$${newMortgagePayment.toFixed(2)}</span>
        </div>
        <div class="stress-test-item">
          <span>New Total Monthly Pmt</span>
          <span>$${newTotalMonthlyExpenses.toFixed(2)}</span>
        </div>
        <div class="stress-test-item">
          <span>New Annual Cash Flow</span>
          <span>$${newAnnualCashFlow.toFixed(2)}</span>
        </div>
      `;
    }

    function updateProFormaTable() {
      const p = currentProperty;
      const rentGrowth = parseFloat(document.getElementById('rent-growth').value) / 100 || 0;
      const expenseInflation = parseFloat(document.getElementById('expense-inflation').value) / 100 || 0;
      const appreciationRate = parseFloat(document.getElementById('appreciation-rate').value) / 100 || 0;
      
      const tableBody = document.querySelector('#proforma-table tbody');
      tableBody.innerHTML = '';

      let grossIncome = p.grossMonthlyIncome * 12;
      let expenses = p.totalMonthlyExpenses * 12 - p.mortgagePayment;
      let propertyValue = p.purchasePrice;
      const mortgagePayment = p.mortgagePayment;

      for (let year = 1; year <= 10; year++) {
        let netOperatingIncome = grossIncome - expenses;
        let cashFlow = netOperatingIncome - (mortgagePayment * 12) - (grossIncome * p.vacancyRate / 100);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${year}</td>
          <td>$${grossIncome.toFixed(2)}</td>
          <td>$${expenses.toFixed(2)}</td>
          <td>$${netOperatingIncome.toFixed(2)}</td>
          <td>$${cashFlow.toFixed(2)}</td>
          <td>$${propertyValue.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);

        grossIncome *= (1 + rentGrowth);
        expenses *= (1 + expenseInflation);
        propertyValue *= (1 + appreciationRate);
      }
    }

    function createSensitivityChart() {
      const ctx = document.getElementById('sensitivity-chart').getContext('2d');
      if (sensitivityChart) {
        sensitivityChart.destroy();
      }

      const rates = [3, 4, 5, 6, 7, 8];
      const cashFlows = rates.map(rate => {
        const p = currentProperty;
        const mortgageAmount = p.purchasePrice - p.downPayment;
        const cmhcFee = (p.cmhcFee > 0) ? (mortgageAmount * (p.cmhcFee / p.purchasePrice)) : 0;
        const totalLoanAmount = mortgageAmount + cmhcFee;
        const monthlyInterestRate = (rate / 100) / 12;
        const newMortgagePayment = totalLoanAmount * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, p.amortization * 12)) / (Math.pow(1 + monthlyInterestRate, p.amortization * 12) - 1);
        const newTotalMonthlyExpenses = p.totalMonthlyExpenses - p.mortgagePayment + newMortgagePayment;
        return ((p.grossMonthlyIncome * 12) - (newTotalMonthlyExpenses * 12) - (p.grossMonthlyIncome * 12 * (p.vacancyRate / 100))).toFixed(2);
      });

      sensitivityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: rates.map(r => `${r}%`),
          datasets: [{
            label: 'Annual Cash Flow vs. Interest Rate',
            data: cashFlows,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              title: {
                display: true,
                text: 'Annual Cash Flow ($)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Interest Rate'
              }
            }
          }
        }
      });
    }

    function saveProperty() {
      if (Object.keys(currentProperty).length === 0) {
        return;
      }
      
      const newProperty = { ...currentProperty, id: Date.now() };
      savedProperties.push(newProperty);
      updateSavedPropertiesList();
      
      // Show save confirmation message
      const saveMessage = document.getElementById('save-message');
      saveMessage.textContent = 'Property saved successfully!';
      saveMessage.classList.add('show');
      setTimeout(() => {
        saveMessage.classList.remove('show');
      }, 3000);
    }

    function updateSavedPropertiesList() {
      const list = document.getElementById('saved-properties-list');
      list.innerHTML = '';
      savedProperties.forEach(prop => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${prop.name} - Cap Rate: ${prop.capRate.toFixed(2)}%, CoC ROI: ${prop.cocRoi.toFixed(2)}%</span>
          <div>
            <button class="button light" onclick="generateReport(${prop.id})">Report</button>
            <button class="button light" onclick="removeProperty(${prop.id})">Remove</button>
          </div>
        `;
        list.appendChild(li);
      });
      updateComparisonTable();
    }
    
    function removeProperty(id) {
      savedProperties = savedProperties.filter(p => p.id !== id);
      updateSavedPropertiesList();
    }

    function updateComparisonTable() {
      const tableBody = document.getElementById('comparison-table-body');
      tableBody.innerHTML = '';
      savedProperties.forEach(prop => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${prop.name}</td>
          <td>${prop.capRate.toFixed(2)}%</td>
          <td>${prop.cocRoi.toFixed(2)}%</td>
          <td>$${prop.annualCashFlow.toFixed(2)}</td>
          <td>$${prop.netOperatingIncome.toFixed(2)}</td>
          <td>$${(prop.purchasePrice / 1000).toFixed(2)}/k sqft</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function generateReport(id) {
      const prop = savedProperties.find(p => p.id === id);
      if (!prop) {
        console.error('Property not found.');
        return;
      }

      const doc = new jsPDF();
      let y = 20;

      doc.setFontSize(16);
      doc.text("Property Underwriting Report", 14, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Property Name: ${prop.name}`, 14, y);
      y += 10;
      doc.text(`Purchase Price: $${prop.purchasePrice.toLocaleString()}`, 14, y);
      y += 10;

      // Add photos
      if (prop.uploadedPhotos && prop.uploadedPhotos.length > 0) {
        doc.text("Property Photos:", 14, y);
        y += 5;
        let x = 14;
        prop.uploadedPhotos.forEach(photoDataUrl => {
          doc.addImage(photoDataUrl, 'JPEG', x, y, 50, 50);
          x += 60;
          if (x > 180) { // New row for photos
            x = 14;
            y += 60;
          }
        });
        y += 60;
      }

      doc.autoTable({
        startY: y,
        head: [['Metric', 'Value']],
        body: [
          ['Total Investment', `$${prop.totalInvestment.toLocaleString()}`],
          ['Annual Cash Flow', `$${prop.annualCashFlow.toFixed(2)}`],
          ['Net Operating Income', `$${prop.netOperatingIncome.toFixed(2)}`],
          ['Cap Rate', `${prop.capRate.toFixed(2)}%`],
          ['CoC ROI', `${prop.cocRoi.toFixed(2)}%`]
        ],
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [46, 204, 113] }
      });

      y = doc.autoTable.previous.finalY + 10;
      doc.text("10-Year Pro Forma", 14, y);
      
      const proformaData = getProFormaDataForPdf(prop);
      doc.autoTable({
        startY: y + 5,
        head: [['Year', 'Gross Income', 'Total Expenses', 'NOI', 'Cash Flow', 'Property Value']],
        body: proformaData,
        theme: 'striped',
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [46, 204, 113] }
      });

      doc.save(`PropCheck_Report_${prop.name}.pdf`);
    }

    function getProFormaDataForPdf(prop) {
      const data = [];
      const rentGrowth = 0.025; // Default for report
      const expenseInflation = 0.02; // Default for report
      const appreciationRate = 0.03; // Default for report
      
      let grossIncome = prop.grossMonthlyIncome * 12;
      let expenses = (prop.totalMonthlyExpenses * 12) - prop.mortgagePayment;
      let propertyValue = prop.purchasePrice;
      const mortgagePayment = prop.mortgagePayment;

      for (let year = 1; year <= 10; year++) {
        let netOperatingIncome = grossIncome - expenses;
        let cashFlow = netOperatingIncome - (mortgagePayment * 12) - (grossIncome * prop.vacancyRate / 100);
        
        data.push([
          year,
          `$${grossIncome.toFixed(0)}`,
          `$${expenses.toFixed(0)}`,
          `$${netOperatingIncome.toFixed(0)}`,
          `$${cashFlow.toFixed(0)}`,
          `$${propertyValue.toFixed(0)}`
        ]);

        grossIncome *= (1 + rentGrowth);
        expenses *= (1 + expenseInflation);
        propertyValue *= (1 + appreciationRate);
      }
      return data;
    }
  </script>
</body>
</html>

