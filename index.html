<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck Pro ‚Äî Advanced RE Calculator & Underwriting Tool</title>

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;--max-w:1400px;--danger:#e74c3c;
      --warning:#f39c12;--info:#3498db;--success:#2ecc71;--text:#2c3e50;
      --border:#e1e8ed;--shadow:0 6px 20px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
         background:linear-gradient(135deg,var(--page-bg-1) 0%,var(--page-bg-2) 100%);
         color:var(--text);min-height:100vh;}
    
    /* Login Styles */
    .center-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:100%;max-width:420px;background:var(--card-bg);border-radius:16px;padding:32px;
                box-shadow:0 18px 40px rgba(2,6,23,0.25);text-align:center}
    .login-card h1{color:var(--brand);margin:0 0 8px 0;font-size:2.2rem}
    .subtitle{color:var(--muted);margin-bottom:24px;font-size:1.1rem}
    
    /* Mode Toggle */
    .mode-toggle{background:#f8f9fa;padding:4px;border-radius:30px;display:inline-flex;position:relative;
                 box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);margin:0 20px}
    .mode-toggle input{display:none}
    .mode-slider{display:flex;gap:4px;position:relative}
    .mode-label{padding:8px 16px;border-radius:26px;cursor:pointer;transition:all 0.3s;
                font-weight:500;color:var(--muted);font-size:14px;user-select:none}
    .mode-label.active{background:var(--brand);color:#fff;box-shadow:0 2px 8px rgba(46,204,113,0.3)}
    
    /* Navigation */
    .nav{background:#fff;padding:0;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .nav-container{max-width:var(--max-w);margin:0 auto;padding:0 20px;display:flex;
                   justify-content:space-between;align-items:center;height:70px;flex-wrap:wrap}
    .logo{color:var(--brand);font-size:1.8rem;font-weight:700;text-decoration:none}
    .nav-links{display:flex;gap:0;align-items:center}
    .nav-link{padding:12px 20px;text-decoration:none;color:var(--text);font-weight:500;
              border-radius:8px;transition:all 0.2s}
    .nav-link:hover,.nav-link.active{background:var(--brand);color:#fff}
    .user-menu{display:flex;gap:12px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    
    /* Main Content */
    .main{max-width:var(--max-w);margin:0 auto;padding:24px 20px;min-height:calc(100vh - 70px)}
    .page{display:none}.page.active{display:block}
    
    /* Components */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;
         border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:15px;transition:all 0.2s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-dark)}
    .btn-secondary{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-small{padding:8px 16px;font-size:14px}
    
    .card{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 20px 0;color:var(--text);font-size:1.3rem}
    
    .grid{display:grid;gap:16px}.grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}
    .full{grid-column:1/-1}
    
    .form-group{margin-bottom:16px}
    .form-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--text)}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border-radius:8px;
                                        border:1px solid var(--border);font-size:15px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--brand)}
    .form-group small{display:block;color:var(--muted);margin-top:4px;font-size:13px}
    
    .result-card{background:linear-gradient(135deg,#e8f8f5 0%,#d5efdb 100%);
                 padding:20px;border-radius:12px;margin-top:20px}
    .metric{text-align:center;padding:16px}
    .metric-value{font-size:1.8rem;font-weight:700;color:var(--brand)}
    .metric-label{color:var(--muted);font-size:0.9rem;margin-top:4px}
    .metric-sublabel{color:var(--muted);font-size:0.8rem;margin-top:2px;opacity:0.8}
    
    .alert{padding:16px;border-radius:8px;margin-bottom:20px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
    .alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460}
    
    .tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:24px;overflow-x:auto}
    .tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;
         font-weight:500;color:var(--muted);white-space:nowrap}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    
    .comparison-table{width:100%;border-collapse:collapse;margin-top:20px;overflow-x:auto;display:block}
    .comparison-table th,.comparison-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
    .comparison-table th{background:#f8f9fa;font-weight:600;position:sticky;top:0}
    
    /* Qualification Indicators */
    .qualification-status{padding:12px;border-radius:8px;margin:16px 0;display:flex;align-items:center;gap:12px}
    .qualification-status.qualified{background:#d4edda;border:1px solid #c3e6cb}
    .qualification-status.warning{background:#fff3cd;border:1px solid #ffeaa7}
    .qualification-status.failed{background:#f8d7da;border:1px solid #f5c6cb}
    .qualification-icon{font-size:24px}
    
    /* Debt Service Ratios */
    .ratio-bar{height:30px;background:#f0f0f0;border-radius:15px;position:relative;overflow:hidden;margin:8px 0}
    .ratio-fill{height:100%;transition:width 0.3s;display:flex;align-items:center;padding:0 12px;color:#fff;font-weight:600}
    .ratio-fill.good{background:var(--success)}
    .ratio-fill.warning{background:var(--warning)}
    .ratio-fill.danger{background:var(--danger)}
    
    /* Advanced Fields Section */
    .advanced-section{margin-top:24px;padding-top:24px;border-top:2px solid var(--border)}
    .section-toggle{cursor:pointer;user-select:none;display:flex;align-items:center;gap:8px;margin-bottom:16px}
    .section-toggle:before{content:'‚ñ∂';transition:transform 0.2s}
    .section-toggle.open:before{transform:rotate(90deg)}
    .collapsible{max-height:0;overflow:hidden;transition:max-height 0.3s}
    .collapsible.open{max-height:2000px}
    
    /* Score Badge */
    .score-badge{display:inline-flex;align-items:center;justify-content:center;width:60px;height:60px;
                 border-radius:50%;font-size:24px;font-weight:700;color:#fff;margin:8px}
    .score-badge.excellent{background:var(--success)}
    .score-badge.good{background:var(--info)}
    .score-badge.fair{background:var(--warning)}
    .score-badge.poor{background:var(--danger)}
    
    /* Charts Container */
    .chart-container{position:relative;height:300px;margin:20px 0}
    
    @media(max-width:768px){
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
      .nav-links{display:none}
      .nav-container{padding:0 16px}
      .main{padding:16px}
      .card{padding:20px}
      .comparison-table{font-size:14px}
      .mode-toggle{margin:10px 0;width:100%}
    }
    
    /* Mobile Menu */
    .mobile-menu{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;
                 box-shadow:0 -2px 10px rgba(0,0,0,0.1);padding:12px;z-index:1000}
    .mobile-nav{display:flex;justify-content:space-around}
    .mobile-nav-item{text-align:center;padding:8px;border-radius:8px;cursor:pointer;
                     color:var(--muted);font-size:12px;min-width:60px}
    .mobile-nav-item.active{color:var(--brand);background:#f0f9ff}
    
    @media(max-width:768px){
      .mobile-menu{display:block}
      .main{padding-bottom:80px}
    }

    /* Hide elements based on mode */
    .buyer-mode .investor-only{display:none !important}
    .investor-mode .buyer-only{display:none !important}
    
    /* Print Styles */
    @media print{
      .nav,.mobile-menu,.btn{display:none !important}
      .card{box-shadow:none;border:1px solid #ddd}
      body{background:white}
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <main id="loginScreen" class="center-screen">
    <div class="login-card">
      <h1>üè† PropCheck Pro</h1>
      <div class="subtitle">Advanced Canadian RE underwriting & investment analysis</div>
      
      <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
    </div>
  </main>

  <!-- MAIN APP -->
  <div id="mainApp" style="display:none;">
    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-container">
        <a href="#" class="logo">üè† PropCheck Pro</a>
        
        <!-- Mode Toggle -->
        <div class="mode-toggle">
          <div class="mode-slider">
            <div class="mode-label active" data-mode="buyer">üè° First-Time Buyer</div>
            <div class="mode-label" data-mode="investor">üìä Investor</div>
          </div>
        </div>
        
        <div class="nav-links">
          <a href="#" class="nav-link active" data-page="calculator">Calculator</a>
          <a href="#" class="nav-link" data-page="qualification">Qualification</a>
          <a href="#" class="nav-link investor-only" data-page="analysis">Analysis</a>
          <a href="#" class="nav-link" data-page="compare">Compare</a>
          <a href="#" class="nav-link investor-only" data-page="portfolio">Portfolio</a>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main">
      
      <!-- CALCULATOR PAGE -->
      <div id="calculatorPage" class="page active">
        <div class="card">
          <h3>üè† Property Calculator</h3>
          
          <!-- Basic Information -->
          <div class="grid grid-3">
            <div class="form-group">
              <label>Province</label>
              <select id="province">
                <option value="ON">Ontario</option>
                <option value="BC">British Columbia</option>
                <option value="AB">Alberta</option>
                <option value="QC">Quebec</option>
                <option value="MB">Manitoba</option>
                <option value="SK">Saskatchewan</option>
                <option value="NS">Nova Scotia</option>
                <option value="NB">New Brunswick</option>
                <option value="NL">Newfoundland</option>
                <option value="PE">PEI</option>
              </select>
            </div>
            <div class="form-group">
              <label>Property Type</label>
              <select id="propertyTypeCalc">
                <option value="detached">Detached House</option>
                <option value="condo">Condominium</option>
                <option value="townhouse">Townhouse</option>
                <option value="duplex">Duplex</option>
                <option value="triplex">Triplex</option>
                <option value="fourplex">Fourplex</option>
              </select>
            </div>
            <div class="form-group buyer-only">
              <label>
                <input type="checkbox" id="firstTimeBuyer" style="width:auto;margin-right:8px;">
                First-Time Home Buyer
              </label>
              <small>Eligible for rebates and incentives</small>
            </div>
          </div>
          
          <!-- Purchase Information -->
          <h4 style="margin-top:24px;color:var(--text)">Purchase Details</h4>
          <div class="grid grid-2">
            <div class="form-group">
              <label>Purchase Price ($)</label>
              <input id="price" type="number" placeholder="e.g. 750000">
              <small>Total purchase price of the property</small>
            </div>
            <div class="form-group">
              <label>Down Payment (%)</label>
              <input id="down" type="number" value="20" min="5" max="100">
              <small id="downPaymentHelper">Minimum 5% for owner-occupied</small>
            </div>
            <div class="form-group">
              <label>Interest Rate (%)</label>
              <input id="rate" type="number" value="5.5" step="0.1">
              <small>Current mortgage rate</small>
            </div>
            <div class="form-group">
              <label>Amortization (years)</label>
              <select id="term">
                <option value="25">25 years</option>
                <option value="30">30 years</option>
                <option value="20">20 years</option>
                <option value="15">15 years</option>
              </select>
              <small>Maximum 30 years with 20%+ down</small>
            </div>
          </div>
          
          <!-- Rental Income (Investor) -->
          <div class="investor-only">
            <h4 style="margin-top:24px;color:var(--text)">Rental Income</h4>
            <div class="grid grid-3">
              <div class="form-group">
                <label>Monthly Rent ($)</label>
                <input id="rent" type="number" placeholder="e.g. 3200">
              </div>
              <div class="form-group">
                <label>Additional Income ($)</label>
                <input id="additionalIncome" type="number" placeholder="e.g. 200">
                <small>Parking, storage, laundry, etc.</small>
              </div>
              <div class="form-group">
                <label>Vacancy Rate (%)</label>
                <input id="vacancy" type="number" value="5" step="0.1">
                <small>Typical: 5-10%</small>
              </div>
            </div>
          </div>
          
          <!-- Operating Expenses -->
          <h4 style="margin-top:24px;color:var(--text)">Operating Expenses</h4>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Property Tax (annual $)</label>
              <input id="propertyTax" type="number" placeholder="e.g. 8500">
              <small>Check municipal website</small>
            </div>
            <div class="form-group">
              <label>Insurance (annual $)</label>
              <input id="insurance" type="number" placeholder="e.g. 1200">
            </div>
            <div class="form-group">
              <label>Condo Fees (monthly $)</label>
              <input id="condoFees" type="number" placeholder="e.g. 450" value="0">
            </div>
            <div class="form-group">
              <label>Utilities (monthly $)</label>
              <input id="utilities" type="number" placeholder="e.g. 250">
              <small class="buyer-only">Hydro, gas, water</small>
              <small class="investor-only">If owner pays</small>
            </div>
            <div class="form-group investor-only">
              <label>Management Fee (%)</label>
              <input id="management" type="number" value="0" step="0.1">
              <small>Typical: 8-10% of rent</small>
            </div>
            <div class="form-group">
              <label>Maintenance (monthly $)</label>
              <input id="maintenance" type="number" placeholder="e.g. 200">
              <small>1% of property value/year typical</small>
            </div>
          </div>
          
          <!-- Advanced Section -->
          <div class="advanced-section investor-only">
            <div class="section-toggle" onclick="toggleSection('advancedFields')">
              <span>Advanced Options</span>
            </div>
            <div id="advancedFields" class="collapsible">
              <div class="grid grid-3">
                <div class="form-group">
                  <label>Capital Expense Reserve (%)</label>
                  <input id="capex" type="number" value="5" step="0.1">
                  <small>% of rent for major repairs</small>
                </div>
                <div class="form-group">
                  <label>Annual Rent Increase (%)</label>
                  <input id="rentIncrease" type="number" value="2.5" step="0.1">
                  <small>Provincial guideline rate</small>
                </div>
                <div class="form-group">
                  <label>Annual Appreciation (%)</label>
                  <input id="appreciation" type="number" value="3" step="0.1">
                  <small>Historical average</small>
                </div>
                <div class="form-group">
                  <label>Renovation Budget ($)</label>
                  <input id="renovationBudget" type="number" placeholder="e.g. 50000">
                  <small>Initial improvements</small>
                </div>
                <div class="form-group">
                  <label>After Repair Value ($)</label>
                  <input id="arv" type="number" placeholder="e.g. 850000">
                  <small>Value after renovations</small>
                </div>
                <div class="form-group">
                  <label>Holding Period (years)</label>
                  <input id="holdingPeriod" type="number" value="5" min="1" max="30">
                  <small>Investment timeline</small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Closing Costs Section -->
          <div class="advanced-section">
            <div class="section-toggle" onclick="toggleSection('closingCosts')">
              <span>Closing Costs Calculator</span>
            </div>
            <div id="closingCosts" class="collapsible">
              <div class="grid grid-3">
                <div class="form-group">
                  <label>Legal Fees ($)</label>
                  <input id="legalFees" type="number" value="1500">
                </div>
                <div class="form-group">
                  <label>Home Inspection ($)</label>
                  <input id="inspectionFee" type="number" value="500">
                </div>
                <div class="form-group">
                  <label>Appraisal Fee ($)</label>
                  <input id="appraisalFee" type="number" value="400">
                </div>
                <div class="form-group">
                  <label>Moving Costs ($)</label>
                  <input id="movingCosts" type="number" value="2000">
                </div>
                <div class="form-group">
                  <label>Title Insurance ($)</label>
                  <input id="titleInsurance" type="number" value="300">
                </div>
                <div class="form-group">
                  <label>Other Closing Costs ($)</label>
                  <input id="otherClosing" type="number" value="0">
                </div>
              </div>
            </div>
          </div>
          
          <button id="calcButton" class="btn btn-primary" style="margin-top:20px;">Calculate Investment</button>
          <button id="resetButton" class="btn btn-secondary" style="margin-top:20px;margin-left:8px;">Reset</button>
          
          <!-- Results -->
          <div id="results" class="result-card" style="display:none;">
            <!-- Key Metrics -->
            <div class="grid grid-4">
              <div class="metric buyer-only">
                <div class="metric-value" id="monthlyPaymentTotal">$0</div>
                <div class="metric-label">Total Monthly Cost</div>
                <div class="metric-sublabel">All expenses included</div>
              </div>
              <div class="metric buyer-only">
                <div class="metric-value" id="minIncome">$0</div>
                <div class="metric-label">Min. Income Required</div>
                <div class="metric-sublabel">To qualify (32% GDS)</div>
              </div>
              <div class="metric investor-only">
                <div class="metric-value" id="payment">$0</div>
                <div class="metric-label">Mortgage Payment</div>
              </div>
              <div class="metric investor-only">
                <div class="metric-value" id="cashflow">$0</div>
                <div class="metric-label">Net Cash Flow</div>
              </div>
              <div class="metric investor-only">
                <div class="metric-value" id="caprate">0%</div>
                <div class="metric-label">Cap Rate</div>
                <div class="metric-sublabel">NOI / Purchase Price</div>
              </div>
              <div class="metric investor-only">
                <div class="metric-value" id="coc">0%</div>
                <div class="metric-label">Cash-on-Cash</div>
                <div class="metric-sublabel">Annual CF / Initial Inv</div>
              </div>
            </div>
            
            <!-- Investment Rules (Investor Only) -->
            <div class="investor-only" style="margin-top:24px;">
              <h4>Investment Rules Check</h4>
              <div class="grid grid-3">
                <div class="metric">
                  <div class="metric-value" id="onePercentRule">0%</div>
                  <div class="metric-label">1% Rule</div>
                  <div class="metric-sublabel" id="onePercentStatus">Target: ‚â•1%</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="dscr">0</div>
                  <div class="metric-label">DSCR</div>
                  <div class="metric-sublabel" id="dscrStatus">Target: ‚â•1.2</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="grm">0</div>
                  <div class="metric-label">GRM</div>
                  <div class="metric-sublabel">Years to pay off</div>
                </div>
              </div>
            </div>
            
            <!-- Financial Summary -->
            <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
              <h4>Financial Summary</h4>
              <div class="grid grid-2">
                <div>
                  <strong>Initial Investment:</strong><br>
                  Down Payment: <span id="downPaymentAmount">$0</span><br>
                  <span id="cmhcLine">CMHC Insurance: <span id="cmhcAmount">$0</span><br></span>
                  Land Transfer Tax: <span id="landTransferTax">$0</span><br>
                  Closing Costs: <span id="totalClosingCosts">$0</span><br>
                  <span class="investor-only">Renovation: <span id="renovationDisplay">$0</span><br></span>
                  <strong>Total Cash Needed: <span id="totalInitial">$0</span></strong>
                </div>
                <div class="investor-only">
                  <strong>Annual Performance:</strong><br>
                  Gross Rent: <span id="grossRent">$0</span><br>
                  Effective Rent: <span id="effectiveRent">$0</span><br>
                  Operating Expenses: <span id="opex">$0</span><br>
                  Net Operating Income: <span id="noi">$0</span><br>
                  Debt Service: <span id="debtService">$0</span><br>
                  <strong>Annual Cash Flow: <span id="annualCashFlow">$0</span></strong>
                </div>
                <div class="buyer-only">
                  <strong>Monthly Breakdown:</strong><br>
                  Principal & Interest: <span id="buyerPI">$0</span><br>
                  Property Tax: <span id="buyerTax">$0</span><br>
                  Insurance: <span id="buyerInsurance">$0</span><br>
                  Utilities: <span id="buyerUtilities">$0</span><br>
                  Condo Fees: <span id="buyerCondo">$0</span><br>
                  Maintenance: <span id="buyerMaint">$0</span><br>
                  <strong>Total Monthly: <span id="buyerTotal">$0</span></strong>
                </div>
              </div>
            </div>
            
            <!-- 5-Year Projection (Investor) -->
            <div class="investor-only" style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
              <h4>5-Year Investment Projection</h4>
              <div id="projectionTable"></div>
            </div>
            
            <!-- Investment Score -->
            <div style="margin-top:24px;text-align:center;">
              <h4 class="investor-only">Investment Score</h4>
              <h4 class="buyer-only">Affordability Score</h4>
              <div id="investmentScore"></div>
            </div>
            
            <div style="margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;">
              <button id="saveProperty" class="btn btn-secondary">üíæ Save Property</button>
              <button id="printReport" class="btn btn-secondary">üñ®Ô∏è Print Report</button>
              <button id="exportExcel" class="btn btn-secondary">üìä Export to Excel</button>
              <button id="shareLink" class="btn btn-secondary">üîó Share Link</button>
            </div>
          </div>
        </div>
      </div>

      <!-- QUALIFICATION PAGE -->
      <div id="qualificationPage" class="page">
        <div class="card">
          <h3>üè¶ Mortgage Qualification Analysis</h3>
          
          <div class="alert alert-info">
            This calculator uses Canadian mortgage qualification rules including stress testing and debt service ratios.
          </div>
          
          <!-- Income Information -->
          <h4>Income Information</h4>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Annual Employment Income ($)</label>
              <input id="employmentIncome" type="number" placeholder="e.g. 120000">
              <small>T4 Box 14 amount</small>
            </div>
            <div class="form-group">
              <label>Other Income ($)</label>
              <input id="otherIncome" type="number" placeholder="e.g. 10000">
              <small>Rental, investment, etc.</small>
            </div>
            <div class="form-group">
              <label>Co-borrower Income ($)</label>
              <input id="coborrowIncome" type="number" placeholder="e.g. 80000">
              <small>Spouse/partner income</small>
            </div>
          </div>
          
          <!-- Debt Obligations -->
          <h4 style="margin-top:24px">Monthly Debt Obligations</h4>
          <div class="alert alert-warning">
            <strong>Important:</strong> For HELOCs over $50,000, lenders calculate 3% of the limit as monthly payment regardless of balance.
          </div>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Car Loan/Lease ($)</label>
              <input id="carPayment" type="number" placeholder="e.g. 450">
            </div>
            <div class="form-group">
              <label>Credit Card Min. Payments ($)</label>
              <input id="creditCardPayment" type="number" placeholder="e.g. 200">
              <small>3% of total balances</small>
            </div>
            <div class="form-group">
              <label>Student Loan ($)</label>
              <input id="studentLoan" type="number" placeholder="e.g. 300">
            </div>
            <div class="form-group">
              <label>Other Loan Payments ($)</label>
              <input id="otherLoans" type="number" placeholder="e.g. 0">
            </div>
            <div class="form-group">
              <label>Line of Credit Limit ($)</label>
              <input id="locLimit" type="number" placeholder="e.g. 75000">
              <small>Total limit, not balance</small>
            </div>
            <div class="form-group">
              <label>HELOC Limit ($)</label>
              <input id="helocLimit" type="number" placeholder="e.g. 100000">
              <small>Home equity line of credit</small>
            </div>
          </div>
          
          <!-- Property Being Qualified -->
          <h4 style="margin-top:24px">Property Details</h4>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Property Price ($)</label>
              <input id="qualPrice" type="number" placeholder="e.g. 750000">
            </div>
            <div class="form-group">
              <label>Down Payment ($)</label>
              <input id="qualDown" type="number" placeholder="e.g. 150000">
            </div>
            <div class="form-group">
              <label>Interest Rate (%)</label>
              <input id="qualRate" type="number" value="5.5" step="0.1">
            </div>
            <div class="form-group">
              <label>Property Tax (annual $)</label>
              <input id="qualTax" type="number" placeholder="e.g. 8500">
            </div>
            <div class="form-group">
              <label>Heating Costs (monthly $)</label>
              <input id="qualHeat" type="number" value="150">
            </div>
            <div class="form-group">
              <label>Condo Fees (monthly $)</label>
              <input id="qualCondo" type="number" value="0">
            </div>
          </div>
          
          <button id="qualifyButton" class="btn btn-primary">Analyze Qualification</button>
          
          <!-- Qualification Results -->
          <div id="qualificationResults" style="display:none;margin-top:24px;">
            <div class="qualification-status" id="qualStatus">
              <div class="qualification-icon" id="qualIcon">‚úì</div>
              <div>
                <strong id="qualMessage">Qualification Status</strong>
                <div id="qualDetails" style="font-size:14px;margin-top:4px;"></div>
              </div>
            </div>
            
            <!-- Debt Service Ratios -->
            <h4 style="margin-top:24px">Debt Service Ratios</h4>
            
            <div style="margin-bottom:20px;">
              <strong>GDS (Gross Debt Service)</strong> - Housing costs only
              <div class="ratio-bar">
                <div class="ratio-fill" id="gdsBar" style="width:0%">
                  <span id="gdsValue">0%</span>
                </div>
              </div>
              <small>Maximum allowed: 39% (32% preferred)</small>
            </div>
            
            <div style="margin-bottom:20px;">
              <strong>TDS (Total Debt Service)</strong> - All debt payments
              <div class="ratio-bar">
                <div class="ratio-fill" id="tdsBar" style="width:0%">
                  <span id="tdsValue">0%</span>
                </div>
              </div>
              <small>Maximum allowed: 44%</small>
            </div>
            
            <!-- Stress Test -->
            <div class="alert alert-info" style="margin-top:20px;">
              <strong>Stress Test Applied:</strong> Qualification calculated at the higher of your rate + 2% or 5.25%
              <br>Stress test rate used: <span id="stressTestRate">0%</span>
            </div>
            
            <!-- Maximum Affordability -->
            <div class="card" style="margin-top:20px;">
              <h4>Maximum Affordability</h4>
              <div class="grid grid-3">
                <div class="metric">
                  <div class="metric-value" id="maxPurchase">$0</div>
                  <div class="metric-label">Max Purchase Price</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="maxMortgage">$0</div>
                  <div class="metric-label">Max Mortgage</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="requiredIncome">$0</div>
                  <div class="metric-label">Income Needed</div>
                </div>
              </div>
            </div>
            
            <!-- Recommendations -->
            <div id="qualRecommendations" style="margin-top:20px;"></div>
          </div>
        </div>
      </div>

      <!-- ANALYSIS PAGE (Investor Only) -->
      <div id="analysisPage" class="page">
        <div class="card">
          <h3>üìä Advanced Investment Analysis</h3>
          
          <div class="tabs">
            <div class="tab active" data-tab="cashflow">Cash Flow</div>
            <div class="tab" data-tab="roi">ROI Analysis</div>
            <div class="tab" data-tab="sensitivity">Sensitivity</div>
            <div class="tab" data-tab="brrrr">BRRRR Strategy</div>
            <div class="tab" data-tab="tax">Tax Impact</div>
          </div>
          
          <!-- Cash Flow Analysis -->
          <div id="cashflowTab" class="tab-content">
            <div id="cashflowChart" class="chart-container"></div>
            <div id="cashflowBreakdown" style="margin-top:20px;"></div>
          </div>
          
          <!-- ROI Analysis -->
          <div id="roiTab" class="tab-content" style="display:none;">
            <div class="grid grid-2">
              <div class="metric">
                <div class="metric-value" id="totalRoi">0%</div>
                <div class="metric-label">Total ROI (5 years)</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="irr">0%</div>
                <div class="metric-label">IRR</div>
              </div>
            </div>
            <div id="roiBreakdown" style="margin-top:20px;"></div>
          </div>
          
          <!-- Sensitivity Analysis -->
          <div id="sensitivityTab" class="tab-content" style="display:none;">
            <h4>How changes affect your cash flow:</h4>
            <div id="sensitivityMatrix"></div>
          </div>
          
          <!-- BRRRR Strategy -->
          <div id="brrrrTab" class="tab-content" style="display:none;">
            <div class="grid grid-2">
              <div class="form-group">
                <label>Purchase Price ($)</label>
                <input id="brrrrPurchase" type="number" placeholder="e.g. 500000">
              </div>
              <div class="form-group">
                <label>Renovation Cost ($)</label>
                <input id="brrrrReno" type="number" placeholder="e.g. 75000">
              </div>
              <div class="form-group">
                <label>After Repair Value ($)</label>
                <input id="brrrrArv" type="number" placeholder="e.g. 700000">
              </div>
              <div class="form-group">
                <label>Refinance LTV (%)</label>
                <input id="brrrrLtv" type="number" value="80">
              </div>
            </div>
            <button id="analyzeBrrrr" class="btn btn-primary">Analyze BRRRR</button>
            <div id="brrrrResults" style="margin-top:20px;"></div>
          </div>
          
          <!-- Tax Impact -->
          <div id="taxTab" class="tab-content" style="display:none;">
            <div class="grid grid-2">
              <div class="form-group">
                <label>Marginal Tax Rate (%)</label>
                <input id="taxRate" type="number" value="43" step="0.1">
              </div>
              <div class="form-group">
                <label>CCA Class</label>
                <select id="ccaClass">
                  <option value="1">Class 1 - Building (4%)</option>
                  <option value="8">Class 8 - Equipment (20%)</option>
                  <option value="43">Class 43 - Manufacturing (30%)</option>
                </select>
              </div>
            </div>
            <button id="calculateTax" class="btn btn-primary">Calculate Tax Impact</button>
            <div id="taxResults" style="margin-top:20px;"></div>
          </div>
        </div>
      </div>

      <!-- COMPARE PAGE -->
      <div id="comparePage" class="page">
        <div class="card">
          <h3>‚öñÔ∏è Property Comparison</h3>
          <div style="margin-bottom:20px;">
            <button id="addToCompare" class="btn btn-primary">+ Add Current Property</button>
            <button id="clearComparison" class="btn btn-secondary">Clear All</button>
          </div>
          
          <div id="comparisonContainer">
            <div class="alert alert-warning">
              Calculate properties and add them here to compare side-by-side.
            </div>
          </div>
        </div>
      </div>

      <!-- PORTFOLIO PAGE (Investor Only) -->
      <div id="portfolioPage" class="page">
        <div class="card">
          <h3>üíº Portfolio Analysis</h3>
          
          <div id="portfolioSummary" style="margin-bottom:24px;">
            <div class="grid grid-4">
              <div class="metric">
                <div class="metric-value" id="portfolioValue">$0</div>
                <div class="metric-label">Total Value</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="portfolioEquity">$0</div>
                <div class="metric-label">Total Equity</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="portfolioCashflow">$0</div>
                <div class="metric-label">Monthly Cash Flow</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="portfolioROI">0%</div>
                <div class="metric-label">Portfolio ROI</div>
              </div>
            </div>
          </div>
          
          <div id="portfolioProperties"></div>
          
          <div class="card" style="margin-top:24px;">
            <h4>Portfolio Optimization</h4>
            <div id="portfolioRecommendations"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-menu">
      <div class="mobile-nav">
        <div class="mobile-nav-item active" data-page="calculator">
          <div>üè†</div>
          <div>Calc</div>
        </div>
        <div class="mobile-nav-item" data-page="qualification">
          <div>‚úì</div>
          <div>Qualify</div>
        </div>
        <div class="mobile-nav-item investor-only" data-page="analysis">
          <div>üìä</div>
          <div>Analysis</div>
        </div>
        <div class="mobile-nav-item" data-page="compare">
          <div>‚öñÔ∏è</div>
          <div>Compare</div>
        </div>
        <div class="mobile-nav-item investor-only" data-page="portfolio">
          <div>üíº</div>
          <div>Portfolio</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentMode = 'buyer';
    let currentProperty = {};
    let savedProperties = [];
    let comparisonProperties = [];

    // Utility functions
    function money(n) {
      return ' + Number(n).toLocaleString('en-CA', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }
    
    function pct(n) {
      return Number(n).toFixed(2) + '%';
    }

    // Login
    document.getElementById('guestButton').onclick = () => {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadFromLocalStorage();
    };

    // Mode switching
    document.querySelectorAll('.mode-label').forEach(label => {
      label.onclick = () => {
        document.querySelectorAll('.mode-label').forEach(l => l.classList.remove('active'));
        label.classList.add('active');
        currentMode = label.dataset.mode;
        document.body.className = currentMode + '-mode';
        
        // Update UI based on mode
        if (currentMode === 'buyer') {
          document.getElementById('rent').value = 0;
          document.getElementById('management').value = 0;
          document.getElementById('vacancy').value = 0;
        }
        
        saveToLocalStorage();
      };
    });

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.mobile-nav-item').forEach(l => l.classList.remove('active'));
      
      document.getElementById(pageId + 'Page').classList.add('active');
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      const mobileItem = document.querySelector(`.mobile-nav-item[data-page="${pageId}"]`);
      if (mobileItem) mobileItem.classList.add('active');
    }

    document.querySelectorAll('[data-page]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      };
    });

    // Section toggles
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = section.previousElementSibling;
      section.classList.toggle('open');
      toggle.classList.toggle('open');
    }

    // Land Transfer Tax Calculator
    function calculateLandTransferTax(price, province, firstTimeBuyer) {
      let tax = 0;
      
      if (province === 'ON') {
        // Ontario rates
        if (price <= 55000) {
          tax = price * 0.005;
        } else if (price <= 250000) {
          tax = 275 + (price - 55000) * 0.01;
        } else if (price <= 400000) {
          tax = 2225 + (price - 250000) * 0.015;
        } else if (price <= 2000000) {
          tax = 4475 + (price - 400000) * 0.02;
        } else {
          tax = 36475 + (price - 2000000) * 0.025;
        }
        
        // Toronto tax (if applicable)
        if (document.getElementById('citySelect')?.value === 'toronto') {
          let torontoTax = 0;
          if (price <= 55000) {
            torontoTax = price * 0.005;
          } else if (price <= 400000) {
            torontoTax = 275 + (price - 55000) * 0.01;
          } else if (price <= 2000000) {
            torontoTax = 3725 + (price - 400000) * 0.015;
          } else {
            torontoTax = 27725 + (price - 2000000) * 0.02;
          }
          tax += torontoTax;
        }
        
        // First-time buyer rebate (up to $4,000)
        if (firstTimeBuyer && price <= 368333) {
          tax = Math.max(0, tax - 4000);
        }
      } else if (province === 'BC') {
        // BC rates
        if (price <= 200000) {
          tax = price * 0.01;
        } else if (price <= 2000000) {
          tax = 2000 + (price - 200000) * 0.02;
        } else if (price <= 3000000) {
          tax = 38000 + (price - 2000000) * 0.03;
        } else {
          tax = 68000 + (price - 3000000) * 0.05;
        }
        
        // First-time buyer exemption (up to $500,000)
        if (firstTimeBuyer && price <= 500000) {
          tax = 0;
        } else if (firstTimeBuyer && price <= 525000) {
          tax = tax * ((price - 500000) / 25000);
        }
      }
      // Add other provinces as needed
      
      return tax;
    }

    // CMHC Insurance Calculator
    function calculateCMHC(price, downPercent) {
      if (downPercent >= 20) return 0;
      
      const loanAmount = price * (1 - downPercent/100);
      let rate;
      
      if (downPercent >= 15) {
        rate = 0.028;
      } else if (downPercent >= 10) {
        rate = 0.031;
      } else {
        rate = 0.04;
      }
      
      return loanAmount * rate;
    }

    // Main Calculator
    document.getElementById('calcButton').onclick = () => {
      const price = +document.getElementById('price').value || 0;
      const downPercent = +document.getElementById('down').value || 20;
      const rate = (+document.getElementById('rate').value || 0) / 100 / 12;
      const term = (+document.getElementById('term').value || 25) * 12;
      const monthlyRent = +document.getElementById('rent').value || 0;
      const additionalIncome = +document.getElementById('additionalIncome').value || 0;
      const annualTax = +document.getElementById('propertyTax').value || 0;
      const annualInsurance = +document.getElementById('insurance').value || 0;
      const condoFees = +document.getElementById('condoFees').value || 0;
      const utilities = +document.getElementById('utilities').value || 0;
      const managementPercent = +document.getElementById('management').value || 0;
      const vacancyPercent = +document.getElementById('vacancy').value || 0;
      const maintenance = +document.getElementById('maintenance').value || 0;
      const province = document.getElementById('province').value;
      const firstTimeBuyer = document.getElementById('firstTimeBuyer').checked;
      const propertyType = document.getElementById('propertyTypeCalc').value;
      
      // Advanced fields
      const capexPercent = +document.getElementById('capex').value || 0;
      const rentIncreaseRate = +document.getElementById('rentIncrease').value || 0;
      const appreciationRate = +document.getElementById('appreciation').value || 0;
      const renovationBudget = +document.getElementById('renovationBudget').value || 0;
      const arv = +document.getElementById('arv').value || price;
      const holdingPeriod = +document.getElementById('holdingPeriod').value || 5;
      
      // Closing costs
      const legalFees = +document.getElementById('legalFees').value || 1500;
      const inspectionFee = +document.getElementById('inspectionFee').value || 500;
      const appraisalFee = +document.getElementById('appraisalFee').value || 400;
      const movingCosts = +document.getElementById('movingCosts').value || 2000;
      const titleInsurance = +document.getElementById('titleInsurance').value || 300;
      const otherClosing = +document.getElementById('otherClosing').value || 0;
      
      if (!price) {
        alert('Please enter a purchase price.');
        return;
      }
      
      // Calculate mortgage details
      const downPayment = price * downPercent / 100;
      const cmhcInsurance = calculateCMHC(price, downPercent);
      const loanAmount = price - downPayment + cmhcInsurance;
      const landTransferTax = calculateLandTransferTax(price, province, firstTimeBuyer);
      const totalClosingCosts = legalFees + inspectionFee + appraisalFee + movingCosts + titleInsurance + otherClosing;
      const totalInitialInvestment = downPayment + cmhcInsurance + landTransferTax + totalClosingCosts + renovationBudget;
      
      // Monthly payment calculation
      let monthlyPayment = 0;
      if (rate === 0) {
        monthlyPayment = loanAmount / term;
      } else {
        monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
      }
      
      // Monthly expenses
      const monthlyTax = annualTax / 12;
      const monthlyInsurance = annualInsurance / 12;
      const totalMonthlyRent = monthlyRent + additionalIncome;
      const managementFee = totalMonthlyRent * managementPercent / 100;
      const vacancyLoss = totalMonthlyRent * vacancyPercent / 100;
      const capexReserve = totalMonthlyRent * capexPercent / 100;
      
      // Calculate cash flow
      const effectiveRent = totalMonthlyRent - vacancyLoss;
      const operatingExpenses = monthlyTax + monthlyInsurance + condoFees + utilities + managementFee + maintenance + capexReserve;
      const noi = (effectiveRent - operatingExpenses) * 12;
      const monthlyDebtService = monthlyPayment;
      const netCashFlow = effectiveRent - operatingExpenses - monthlyDebtService;
      
      // Investment metrics
      const capRate = price ? (noi / price) * 100 : 0;
      const cashOnCash = totalInitialInvestment ? (netCashFlow * 12 / totalInitialInvestment) * 100 : 0;
      const onePercent = price ? (totalMonthlyRent / price) * 100 : 0;
      const dscr = monthlyDebtService ? noi / (monthlyDebtService * 12) : 0;
      const grm = totalMonthlyRent ? price / (totalMonthlyRent * 12) : 0;
      
      // Store current property
      currentProperty = {
        price, downPercent, rate: +document.getElementById('rate').value, term: +document.getElementById('term').value,
        monthlyRent, additionalIncome, annualTax, annualInsurance, condoFees, utilities,
        managementPercent, vacancyPercent, maintenance, capexPercent,
        province, firstTimeBuyer, propertyType,
        rentIncreaseRate, appreciationRate, renovationBudget, arv, holdingPeriod,
        monthlyPayment, netCashFlow, noi, capRate, cashOnCash, onePercent, dscr, grm,
        totalInitialInvestment, downPayment, cmhcInsurance, landTransferTax, totalClosingCosts,
        effectiveRent, operatingExpenses,
        timestamp: new Date()
      };
      
      // Display results based on mode
      if (currentMode === 'buyer') {
        const totalMonthlyCost = monthlyPayment + monthlyTax + monthlyInsurance + condoFees + utilities + maintenance;
        const minIncomeRequired = totalMonthlyCost * 12 / 0.32; // 32% GDS ratio
        
        document.getElementById('monthlyPaymentTotal').textContent = money(totalMonthlyCost);
        document.getElementById('minIncome').textContent = money(minIncomeRequired);
        
        // Buyer breakdown
        document.getElementById('buyerPI').textContent = money(monthlyPayment);
        document.getElementById('buyerTax').textContent = money(monthlyTax);
        document.getElementById('buyerInsurance').textContent = money(monthlyInsurance);
        document.getElementById('buyerUtilities').textContent = money(utilities);
        document.getElementById('buyerCondo').textContent = money(condoFees);
        document.getElementById('buyerMaint').textContent = money(maintenance);
        document.getElementById('buyerTotal').textContent = money(totalMonthlyCost);
        
        // Affordability score
        const affordabilityScore = calculateAffordabilityScore(totalMonthlyCost, minIncomeRequired, downPercent);
        displayScore(affordabilityScore, 'Affordability');
      } else {
        // Investor metrics
        document.getElementById('payment').textContent = money(monthlyPayment);
        document.getElementById('cashflow').textContent = money(netCashFlow);
        document.getElementById('cashflow').style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('caprate').textContent = pct(capRate);
        document.getElementById('coc').textContent = pct(cashOnCash);
        
        // Investment rules
        document.getElementById('onePercentRule').textContent = pct(onePercent);
        document.getElementById('onePercentStatus').textContent = onePercent >= 1 ? '‚úì Pass' : '‚úó Fail';
        document.getElementById('onePercentStatus').style.color = onePercent >= 1 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('dscr').textContent = dscr.toFixed(2);
        document.getElementById('dscrStatus').textContent = dscr >= 1.2 ? '‚úì Good' : dscr >= 1 ? '‚ö† Fair' : '‚úó Poor';
        document.getElementById('dscrStatus').style.color = dscr >= 1.2 ? 'var(--success)' : dscr >= 1 ? 'var(--warning)' : 'var(--danger)';
        
        document.getElementById('grm').textContent = grm.toFixed(1);
        
        // Annual performance
        document.getElementById('grossRent').textContent = money(totalMonthlyRent * 12);
        document.getElementById('effectiveRent').textContent = money(effectiveRent * 12);
        document.getElementById('opex').textContent = money(operatingExpenses * 12);
        document.getElementById('noi').textContent = money(noi);
        document.getElementById('debtService').textContent = money(monthlyDebtService * 12);
        document.getElementById('annualCashFlow').textContent = money(netCashFlow * 12);
        
        // 5-Year projection
        displayProjection(currentProperty);
        
        // Investment score
        const investmentScore = calculateInvestmentScore(capRate, cashOnCash, dscr, onePercent);
        displayScore(investmentScore, 'Investment');
      }
      
      // Common fields
      document.getElementById('downPaymentAmount').textContent = money(downPayment);
      document.getElementById('cmhcAmount').textContent = money(cmhcInsurance);
      document.getElementById('cmhcLine').style.display = cmhcInsurance > 0 ? 'block' : 'none';
      document.getElementById('landTransferTax').textContent = money(landTransferTax);
      document.getElementById('totalClosingCosts').textContent = money(totalClosingCosts);
      document.getElementById('renovationDisplay').textContent = money(renovationBudget);
      document.getElementById('totalInitial').textContent = money(totalInitialInvestment);
      
      document.getElementById('results').style.display = 'block';
    };

    // Calculate scores
    function calculateInvestmentScore(capRate, coc, dscr, onePercent) {
      let score = 0;
      
      // Cap rate scoring (25 points max)
      if (capRate >= 8) score += 25;
      else if (capRate >= 6) score += 20;
      else if (capRate >= 4) score += 15;
      else if (capRate >= 2) score += 10;
      else score += 5;
      
      // Cash-on-cash scoring (25 points max)
      if (coc >= 12) score += 25;
      else if (coc >= 8) score += 20;
      else if (coc >= 4) score += 15;
      else if (coc >= 0) score += 10;
      else score += 0;
      
      // DSCR scoring (25 points max)
      if (dscr >= 1.5) score += 25;
      else if (dscr >= 1.2) score += 20;
      else if (dscr >= 1.0) score += 15;
      else if (dscr >= 0.8) score += 10;
      else score += 5;
      
      // 1% rule scoring (25 points max)
      if (onePercent >= 1.0) score += 25;
      else if (onePercent >= 0.8) score += 20;
      else if (onePercent >= 0.6) score += 15;
      else if (onePercent >= 0.4) score += 10;
      else score += 5;
      
      return score;
    }
    
    function calculateAffordabilityScore(monthlyCost, incomeRequired, downPercent) {
      let score = 0;
      
      // Down payment scoring (40 points max)
      if (downPercent >= 20) score += 40;
      else if (downPercent >= 15) score += 30;
      else if (downPercent >= 10) score += 20;
      else score += 10;
      
      // Monthly cost as % of typical income (60 points max)
      const typicalIncome = 100000; // Canadian median household income
      const costRatio = (monthlyCost * 12) / typicalIncome;
      if (costRatio <= 0.25) score += 60;
      else if (costRatio <= 0.32) score += 45;
      else if (costRatio <= 0.40) score += 30;
      else if (costRatio <= 0.50) score += 15;
      else score += 0;
      
      return score;
    }
    
    function displayScore(score, type) {
      const container = document.getElementById('investmentScore');
      let grade, className, message;
      
      if (score >= 80) {
        grade = 'A';
        className = 'excellent';
        message = type === 'Investment' ? 'Excellent investment opportunity!' : 'Very affordable for your situation!';
      } else if (score >= 60) {
        grade = 'B';
        className = 'good';
        message = type === 'Investment' ? 'Good investment with solid returns.' : 'Affordable with proper budgeting.';
      } else if (score >= 40) {
        grade = 'C';
        className = 'fair';
        message = type === 'Investment' ? 'Fair investment, consider improvements.' : 'Stretching affordability limits.';
      } else {
        grade = 'D';
        className = 'poor';
        message = type === 'Investment' ? 'Poor investment metrics, reconsider.' : 'May be unaffordable, consider alternatives.';
      }
      
      container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;gap:20px;">
          <div class="score-badge ${className}">${grade}</div>
          <div>
            <div style="font-size:18px;font-weight:600;">${type} Grade: ${grade}</div>
            <div style="color:var(--muted);margin-top:4px;">${message}</div>
            <div style="font-size:14px;margin-top:8px;">Score: ${score}/100</div>
          </div>
        </div>
      `;
    }
    
    function displayProjection(property) {
      const container = document.getElementById('projectionTable');
      const years = property.holdingPeriod || 5;
      let projectionHTML = '<table class="comparison-table"><tr><th>Year</th><th>Property Value</th><th>Mortgage Balance</th><th>Equity</th><th>Annual Rent</th><th>Annual Cash Flow</th><th>Cumulative CF</th><th>Total ROI</th></tr>';
      
      let propertyValue = property.arv || property.price;
      let mortgageBalance = property.price - property.downPayment + property.cmhcInsurance;
      let currentRent = (property.monthlyRent + property.additionalIncome) * 12;
      let cumulativeCashFlow = 0;
      const monthlyPayment = property.monthlyPayment;
      const principalPerMonth = mortgageBalance / (property.term * 12);
      
      for (let year = 1; year <= Math.min(years, 10); year++) {
        // Appreciation
        propertyValue *= (1 + (property.appreciationRate || 3) / 100);
        
        // Mortgage paydown (simplified)
        mortgageBalance -= principalPerMonth * 12;
        
        // Equity
        const equity = propertyValue - mortgageBalance;
        
        // Rent increase
        currentRent *= (1 + (property.rentIncreaseRate || 2.5) / 100);
        
        // Cash flow (simplified - assuming expenses increase at inflation)
        const annualCashFlow = property.netCashFlow * 12 * Math.pow(1 + (property.rentIncreaseRate || 2.5) / 100, year - 1);
        cumulativeCashFlow += annualCashFlow;
        
        // Total ROI
        const totalReturn = equity - property.totalInitialInvestment + cumulativeCashFlow;
        const roi = (totalReturn / property.totalInitialInvestment) * 100;
        
        projectionHTML += `<tr>
          <td>Year ${year}</td>
          <td>${money(propertyValue)}</td>
          <td>${money(Math.max(0, mortgageBalance))}</td>
          <td>${money(equity)}</td>
          <td>${money(currentRent)}</td>
          <td style="color:${annualCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(annualCashFlow)}</td>
          <td>${money(cumulativeCashFlow)}</td>
          <td style="font-weight:600;">${pct(roi)}</td>
        </tr>`;
      }
      
      projectionHTML += '</table>';
      container.innerHTML = projectionHTML;
    }

    // Qualification Calculator
    document.getElementById('qualifyButton').onclick = () => {
      // Get income
      const employmentIncome = +document.getElementById('employmentIncome').value || 0;
      const otherIncome = +document.getElementById('otherIncome').value || 0;
      const coborrowIncome = +document.getElementById('coborrowIncome').value || 0;
      const totalIncome = employmentIncome + otherIncome + coborrowIncome;
      
      // Get debts
      const carPayment = +document.getElementById('carPayment').value || 0;
      const creditCardPayment = +document.getElementById('creditCardPayment').value || 0;
      const studentLoan = +document.getElementById('studentLoan').value || 0;
      const otherLoans = +document.getElementById('otherLoans').value || 0;
      
      // Line of Credit calculations following Canadian lending rules
      const locLimit = +document.getElementById('locLimit').value || 0;
      const locBalance = +document.getElementById('locBalance').value || 0;
      const helocLimit = +document.getElementById('helocLimit').value || 0;
      const helocBalance = +document.getElementById('helocBalance').value || 0;
      const otherSecuredLoc = +document.getElementById('otherSecuredLoc').value || 0;
      
      let locPayment = 0;
      let helocPayment = 0;
      let otherSecuredPayment = 0;
      
      // Unsecured LOC treatment
      if (locLimit < 50000) {
        // Under $50k: Use actual balance
        locPayment = locBalance * 0.03;
      } else {
        // $50k and over: Use full limit
        locPayment = locLimit * 0.03;
      }
      
      // HELOC treatment (secured, so always use full limit)
      if (helocLimit > 0) {
        helocPayment = helocLimit * 0.03;
      }
      
      // Other secured LOC (always use full limit)
      if (otherSecuredLoc > 0) {
        otherSecuredPayment = otherSecuredLoc * 0.03;
      }
      
      const totalDebtPayments = carPayment + creditCardPayment + studentLoan + otherLoans + 
                                locPayment + helocPayment + otherSecuredPayment;
      
      // Get property details
      const qualPrice = +document.getElementById('qualPrice').value || 0;
      const qualDown = +document.getElementById('qualDown').value || 0;
      const qualRate = +document.getElementById('qualRate').value || 5.5;
      const qualTax = +document.getElementById('qualTax').value || 0;
      const qualHeat = +document.getElementById('qualHeat').value || 150;
      const qualCondo = +document.getElementById('qualCondo').value || 0;
      
      if (!totalIncome || !qualPrice) {
        alert('Please enter income and property details.');
        return;
      }
      
      // Calculate stress test rate (higher of rate + 2% or 5.25%)
      const stressTestRate = Math.max(qualRate + 2, 5.25);
      const monthlyStressRate = stressTestRate / 100 / 12;
      
      // Calculate mortgage payment at stress test rate
      const mortgageAmount = qualPrice - qualDown;
      const term = 25 * 12; // 25-year amortization for qualification
      const stressPayment = mortgageAmount * (monthlyStressRate * Math.pow(1 + monthlyStressRate, term)) / (Math.pow(1 + monthlyStressRate, term) - 1);
      
      // Housing costs
      const monthlyTax = qualTax / 12;
      const totalHousingCosts = stressPayment + monthlyTax + qualHeat + qualCondo;
      
      // Calculate ratios
      const monthlyIncome = totalIncome / 12;
      const gds = (totalHousingCosts / monthlyIncome) * 100;
      const tds = ((totalHousingCosts + totalDebtPayments) / monthlyIncome) * 100;
      
      // Determine qualification status
      let qualified = false;
      let status = '';
      let message = '';
      let details = '';
      
      if (gds <= 32 && tds <= 40) {
        qualified = true;
        status = 'qualified';
        message = '‚úì Fully Qualified';
        details = 'You meet all standard qualification criteria with room to spare.';
      } else if (gds <= 39 && tds <= 44) {
        qualified = true;
        status = 'warning';
        message = '‚ö† Qualified with Conditions';
        details = 'You qualify but are at the upper limits. Strong credit and employment history required.';
      } else {
        qualified = false;
        status = 'failed';
        message = '‚úó Does Not Qualify';
        details = `GDS: ${gds.toFixed(1)}% (max 39%), TDS: ${tds.toFixed(1)}% (max 44%)`;
      }
      
      // Update UI
      const qualStatus = document.getElementById('qualStatus');
      qualStatus.className = 'qualification-status ' + status;
      document.getElementById('qualIcon').textContent = qualified ? '‚úì' : '‚úó';
      document.getElementById('qualMessage').textContent = message;
      document.getElementById('qualDetails').textContent = details;
      
      // Update ratio bars
      const gdsBar = document.getElementById('gdsBar');
      gdsBar.style.width = Math.min(gds, 100) + '%';
      gdsBar.className = 'ratio-fill ' + (gds <= 32 ? 'good' : gds <= 39 ? 'warning' : 'danger');
      document.getElementById('gdsValue').textContent = gds.toFixed(1) + '%';
      
      const tdsBar = document.getElementById('tdsBar');
      tdsBar.style.width = Math.min(tds, 100) + '%';
      tdsBar.className = 'ratio-fill ' + (tds <= 40 ? 'good' : tds <= 44 ? 'warning' : 'danger');
      document.getElementById('tdsValue').textContent = tds.toFixed(1) + '%';
      
      // Show stress test rate
      document.getElementById('stressTestRate').textContent = stressTestRate.toFixed(2) + '%';
      
      // Calculate maximum affordability
      const maxGDS = 0.39; // 39% max GDS
      const maxTDS = 0.44; // 44% max TDS
      
      const maxHousingFromGDS = (monthlyIncome * maxGDS);
      const maxHousingFromTDS = (monthlyIncome * maxTDS) - totalDebtPayments;
      const maxHousing = Math.min(maxHousingFromGDS, maxHousingFromTDS);
      
      const maxMortgagePayment = maxHousing - monthlyTax - qualHeat - qualCondo;
      
      // Calculate max mortgage amount
      let maxMortgage = 0;
      if (monthlyStressRate > 0) {
        maxMortgage = maxMortgagePayment * (Math.pow(1 + monthlyStressRate, term) - 1) / (monthlyStressRate * Math.pow(1 + monthlyStressRate, term));
      }
      
      const maxPurchase = maxMortgage + qualDown;
      const requiredIncome = totalHousingCosts / maxGDS * 12;
      
      document.getElementById('maxPurchase').textContent = money(maxPurchase);
      document.getElementById('maxMortgage').textContent = money(maxMortgage);
      document.getElementById('requiredIncome').textContent = money(requiredIncome);
      
      // Recommendations with specific LOC details
      let recommendations = '<h4>Recommendations:</h4><ul>';
      
      if (!qualified) {
        const incomeShortfall = requiredIncome - totalIncome;
        if (incomeShortfall > 0) {
          recommendations += `<li>Increase income by ${money(incomeShortfall)}/year</li>`;
        }
        
        if (totalDebtPayments > monthlyIncome * 0.10) {
          recommendations += `<li>Reduce monthly debt payments by ${money(totalDebtPayments - monthlyIncome * 0.10)}</li>`;
        }
        
        const suggestedDown = qualPrice * 0.20;
        if (qualDown < suggestedDown) {
          recommendations += `<li>Increase down payment to ${money(suggestedDown)} (20%) to avoid CMHC insurance</li>`;
        }
        
        recommendations += `<li>Consider a less expensive property under ${money(maxPurchase)}</li>`;
      } else if (status === 'warning') {
        recommendations += '<li>Maintain excellent credit score (680+)</li>';
        recommendations += '<li>Ensure stable employment history (2+ years)</li>';
        recommendations += '<li>Consider paying down existing debts</li>';
        recommendations += '<li>Keep all financial documents organized</li>';
      } else {
        recommendations += '<li>You have strong qualification metrics</li>';
        recommendations += '<li>Consider shopping for best mortgage rates</li>';
        recommendations += '<li>You may qualify for better terms with multiple lenders</li>';
      }
      
      // Detailed LOC impact explanation
      if (locLimit > 0 || helocLimit > 0 || otherSecuredLoc > 0) {
        recommendations += '<li><strong>Line of Credit Impact on Qualification:</strong><ul>';
        
        if (locLimit > 0) {
          if (locLimit < 50000) {
            recommendations += `<li>Unsecured LOC (${money(locLimit)} limit): Using actual balance of ${money(locBalance)} = ${money(locPayment)}/month</li>`;
          } else {
            recommendations += `<li>Unsecured LOC (${money(locLimit)} limit): Using full limit = ${money(locPayment)}/month (regardless of ${money(locBalance)} balance)</li>`;
          }
        }
        
        if (helocLimit > 0) {
          recommendations += `<li>HELOC (${money(helocLimit)} limit): Using full limit = ${money(helocPayment)}/month (secured LOC always uses limit)</li>`;
        }
        
        if (otherSecuredLoc > 0) {
          recommendations += `<li>Other Secured LOC (${money(otherSecuredLoc)} limit): Using full limit = ${money(otherSecuredPayment)}/month</li>`;
        }
        
        recommendations += '</ul></li>';
        
        // Advice on improving qualification with LOCs
        if (locLimit >= 50000 && locBalance < locLimit * 0.5) {
          recommendations += `<li>üí° Consider reducing your unsecured LOC limit to under $50,000 if you don't need the full ${money(locLimit)}. This could save ${money((locLimit - 49000) * 0.03)}/month in qualification calculations.</li>`;
        }
      }
      
      recommendations += '</ul>';
      document.getElementById('qualRecommendations').innerHTML = recommendations;
      
      document.getElementById('qualificationResults').style.display = 'block';
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const parent = tab.parentElement;
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabContent = tab.closest('.card').querySelectorAll('.tab-content');
        tabContent.forEach(content => content.style.display = 'none');
        
        const targetTab = document.getElementById(tab.dataset.tab + 'Tab');
        if (targetTab) targetTab.style.display = 'block';
      };
    });

    // Save/Load functionality
    function saveToLocalStorage() {
      const data = {
        savedProperties,
        comparisonProperties,
        currentMode,
        lastCalculation: currentProperty
      };
      localStorage.setItem('propcheck_data', JSON.stringify(data));
    }
    
    function loadFromLocalStorage() {
      try {
        const data = JSON.parse(localStorage.getItem('propcheck_data') || '{}');
        if (data.savedProperties) savedProperties = data.savedProperties;
        if (data.comparisonProperties) comparisonProperties = data.comparisonProperties;
        if (data.currentMode) {
          currentMode = data.currentMode;
          document.body.className = currentMode + '-mode';
          document.querySelectorAll('.mode-label').forEach(l => l.classList.remove('active'));
          document.querySelector(`.mode-label[data-mode="${currentMode}"]`).classList.add('active');
        }
        updatePortfolio();
        updateComparisonTable();
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }

    // Save property
    document.getElementById('saveProperty').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const name = prompt('Enter a name for this property:', `Property ${savedProperties.length + 1}`);
      if (name) {
        currentProperty.name = name;
        currentProperty.id = Date.now();
        savedProperties.push({...currentProperty});
        saveToLocalStorage();
        alert('Property saved successfully!');
        updatePortfolio();
      }
    };

    // Add to comparison
    document.getElementById('addToCompare').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        showPage('calculator');
        return;
      }
      
      const name = prompt('Enter a name for comparison:', `Property ${comparisonProperties.length + 1}`);
      if (name) {
        currentProperty.name = name;
        currentProperty.id = Date.now();
        comparisonProperties.push({...currentProperty});
        updateComparisonTable();
        saveToLocalStorage();
      }
    };

    // Update comparison table
    function updateComparisonTable() {
      const container = document.getElementById('comparisonContainer');
      
      if (comparisonProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Calculate properties and add them here to compare side-by-side.</div>';
        return;
      }
      
      // Create comparison table with scoring
      let html = '<div style="overflow-x:auto;"><table class="comparison-table"><thead><tr><th>Metric</th>';
      comparisonProperties.forEach(prop => {
        html += `<th>${prop.name}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      // Comparison metrics
      const metrics = [
        {label: 'Purchase Price', key: 'price', format: 'money'},
        {label: 'Total Investment', key: 'totalInitialInvestment', format: 'money'},
        {label: 'Monthly Cash Flow', key: 'netCashFlow', format: 'money', highlight: true},
        {label: 'Cap Rate', key: 'capRate', format: 'pct', highlight: true},
        {label: 'Cash-on-Cash', key: 'cashOnCash', format: 'pct', highlight: true},
        {label: '1% Rule', key: 'onePercent', format: 'pct'},
        {label: 'DSCR', key: 'dscr', format: 'number'},
        {label: 'GRM', key: 'grm', format: 'number'},
        {label: 'NOI', key: 'noi', format: 'money'}
      ];
      
      metrics.forEach(metric => {
        html += `<tr><td><strong>${metric.label}</strong></td>`;
        
        // Find best value for highlighting
        let bestValue = metric.format === 'money' && metric.key === 'netCashFlow' ? 
          Math.max(...comparisonProperties.map(p => p[metric.key])) :
          metric.format === 'pct' || metric.key === 'dscr' ?
          Math.max(...comparisonProperties.map(p => p[metric.key])) :
          metric.key === 'grm' ?
          Math.min(...comparisonProperties.map(p => p[metric.key])) :
          null;
        
        comparisonProperties.forEach(prop => {
          const value = prop[metric.key];
          const isBest = metric.highlight && (
            (metric.key === 'grm' && value === bestValue) ||
            (metric.key !== 'grm' && value === bestValue)
          );
          
          let formatted = '';
          if (metric.format === 'money') formatted = money(value);
          else if (metric.format === 'pct') formatted = pct(value);
          else formatted = Number(value).toFixed(2);
          
          let color = '';
          if (metric.key === 'netCashFlow') color = value >= 0 ? 'var(--success)' : 'var(--danger)';
          
          html += `<td style="${color ? `color:${color};` : ''}${isBest ? 'font-weight:bold;background:#f0f9f0;' : ''}">${formatted}</td>`;
        });
        html += '</tr>';
      });
      
      // Add score row
      html += '<tr style="border-top:2px solid var(--border);"><td><strong>Investment Score</strong></td>';
      comparisonProperties.forEach(prop => {
        const score = calculateInvestmentScore(prop.capRate, prop.cashOnCash, prop.dscr, prop.onePercent);
        let grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
        let color = score >= 80 ? 'var(--success)' : score >= 60 ? 'var(--info)' : score >= 40 ? 'var(--warning)' : 'var(--danger)';
        html += `<td style="font-weight:bold;color:${color};font-size:18px;">${grade} (${score})</td>`;
      });
      html += '</tr>';
      
      // Add remove buttons
      html += '<tr><td></td>';
      comparisonProperties.forEach((prop, index) => {
        html += `<td><button class="btn btn-danger btn-small" onclick="removeFromComparison(${index})">Remove</button></td>`;
      });
      html += '</tr>';
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // Remove from comparison
    window.removeFromComparison = (index) => {
      comparisonProperties.splice(index, 1);
      updateComparisonTable();
      saveToLocalStorage();
    };

    // Clear comparison
    document.getElementById('clearComparison').onclick = () => {
      if (confirm('Clear all properties from comparison?')) {
        comparisonProperties = [];
        updateComparisonTable();
        saveToLocalStorage();
      }
    };

    // Portfolio functions
    function updatePortfolio() {
      if (savedProperties.length === 0) {
        document.getElementById('portfolioProperties').innerHTML = '<div class="alert alert-warning">No saved properties yet.</div>';
        return;
      }
      
      // Calculate portfolio metrics
      const totalValue = savedProperties.reduce((sum, p) => sum + (p.arv || p.price), 0);
      const totalEquity = savedProperties.reduce((sum, p) => sum + p.downPayment, 0);
      const totalCashflow = savedProperties.reduce((sum, p) => sum + p.netCashFlow, 0);
      const avgROI = savedProperties.reduce((sum, p) => sum + p.cashOnCash, 0) / savedProperties.length;
      
      document.getElementById('portfolioValue').textContent = money(totalValue);
      document.getElementById('portfolioEquity').textContent = money(totalEquity);
      document.getElementById('portfolioCashflow').textContent = money(totalCashflow);
      document.getElementById('portfolioROI').textContent = pct(avgROI);
      
      // List properties
      let html = '<h4>Properties in Portfolio</h4>';
      html += '<div class="grid grid-2">';
      savedProperties.forEach((prop, index) => {
        const score = calculateInvestmentScore(prop.capRate, prop.cashOnCash, prop.dscr, prop.onePercent);
        const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
        
        html += `
          <div class="card">
            <h5>${prop.name}</h5>
            <div style="display:flex;justify-content:space-between;margin:12px 0;">
              <span>Value:</span><strong>${money(prop.price)}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;margin:12px 0;">
              <span>Cash Flow:</span><strong style="color:${prop.netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(prop.netCashFlow)}/mo</strong>
            </div>
            <div style="display:flex;justify-content:space-between;margin:12px 0;">
              <span>Cap Rate:</span><strong>${pct(prop.capRate)}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;margin:12px 0;">
              <span>Grade:</span><strong>${grade}</strong>
            </div>
            <button class="btn btn-danger btn-small" onclick="removeFromPortfolio(${index})">Remove</button>
          </div>
        `;
      });
      html += '</div>';
      
      document.getElementById('portfolioProperties').innerHTML = html;
      
      // Recommendations
      let recommendations = '<ul>';
      if (totalCashflow < 0) {
        recommendations += '<li>‚ö†Ô∏è Portfolio has negative cash flow. Consider selling underperforming properties.</li>';
      }
      if (avgROI < 8) {
        recommendations += '<li>üìä Average ROI below 8%. Look for higher-yielding opportunities.</li>';
      }
      const avgCapRate = savedProperties.reduce((sum, p) => sum + p.capRate, 0) / savedProperties.length;
      if (avgCapRate < 5) {
        recommendations += '<li>üìâ Low average cap rate. Consider markets with better yields.</li>';
      }
      if (savedProperties.length < 3) {
        recommendations += '<li>üéØ Build portfolio to 3+ properties for better diversification.</li>';
      }
      recommendations += '</ul>';
      
      document.getElementById('portfolioRecommendations').innerHTML = recommendations;
    }

    window.removeFromPortfolio = (index) => {
      if (confirm('Remove this property from your portfolio?')) {
        savedProperties.splice(index, 1);
        updatePortfolio();
        saveToLocalStorage();
      }
    };

    // BRRRR Analysis
    document.getElementById('analyzeBrrrr').onclick = () => {
      const purchase = +document.getElementById('brrrrPurchase').value || 0;
      const reno = +document.getElementById('brrrrReno').value || 0;
      const arv = +document.getElementById('brrrrArv').value || 0;
      const ltv = +document.getElementById('brrrrLtv').value || 80;
      
      if (!purchase || !reno || !arv) {
        alert('Please enter all BRRRR values.');
        return;
      }
      
      const totalInvested = purchase + reno;
      const refinanceAmount = arv * (ltv / 100);
      const cashOut = refinanceAmount - totalInvested;
      const cashLeft = totalInvested - refinanceAmount;
      const equity = arv - refinanceAmount;
      
      let html = '<div class="result-card">';
      html += '<h4>BRRRR Analysis Results</h4>';
      html += '<div class="grid grid-2">';
      html += `<div>Total Invested: ${money(totalInvested)}</div>`;
      html += `<div>After Repair Value: ${money(arv)}</div>`;
      html += `<div>Refinance Amount (${ltv}%): ${money(refinanceAmount)}</div>`;
      
      if (cashOut > 0) {
        html += `<div style="color:var(--success);font-weight:bold;">Cash Out: ${money(cashOut)}</div>`;
      } else {
        html += `<div style="color:var(--danger);font-weight:bold;">Cash Left In: ${money(Math.abs(cashLeft))}</div>`;
      }
      
      html += `<div>Equity Created: ${money(equity)}</div>`;
      html += `<div>ROI: ${pct((equity / totalInvested) * 100)}</div>`;
      html += '</div>';
      
      if (cashOut > 0) {
        html += '<div class="alert alert-success" style="margin-top:16px;">‚úì Excellent BRRRR opportunity - you can pull out all capital plus profit!</div>';
      } else if (cashLeft < totalInvested * 0.25) {
        html += '<div class="alert alert-warning" style="margin-top:16px;">‚ö†Ô∏è Good BRRRR deal - most capital recovered</div>';
      } else {
        html += '<div class="alert alert-danger" style="margin-top:16px;">‚úó Poor BRRRR metrics - significant capital remains locked</div>';
      }
      
      html += '</div>';
      document.getElementById('brrrrResults').innerHTML = html;
    };

    // Reset calculator
    document.getElementById('resetButton').onclick = () => {
      document.querySelectorAll('input[type="number"]').forEach(input => {
        if (input.id !== 'down' && input.id !== 'rate' && input.id !== 'vacancy' && input.id !== 'qualRate') {
          input.value = '';
        }
      });
      document.getElementById('results').style.display = 'none';
      currentProperty = {};
    };

    // Print report
    document.getElementById('printReport').onclick = () => {
      window.print();
    };

    // Export to Excel (simplified CSV export)
    document.getElementById('exportExcel').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      let csv = 'Metric,Value\n';
      csv += `Purchase Price,${currentProperty.price}\n`;
      csv += `Down Payment,${currentProperty.downPayment}\n`;
      csv += `Total Investment,${currentProperty.totalInitialInvestment}\n`;
      csv += `Monthly Cash Flow,${currentProperty.netCashFlow}\n`;
      csv += `Cap Rate,${currentProperty.capRate}%\n`;
      csv += `Cash-on-Cash,${currentProperty.cashOnCash}%\n`;
      csv += `DSCR,${currentProperty.dscr}\n`;
      csv += `1% Rule,${currentProperty.onePercent}%\n`;
      csv += `NOI,${currentProperty.noi}\n`;
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `property_analysis_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Share link (create shareable URL with parameters)
    document.getElementById('shareLink').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const params = new URLSearchParams({
        price: currentProperty.price,
        down: currentProperty.downPercent,
        rate: currentProperty.rate,
        term: currentProperty.term,
        rent: currentProperty.monthlyRent,
        tax: currentProperty.annualTax,
        insurance: currentProperty.annualInsurance,
        province: currentProperty.province
      });
      
      const shareUrl = window.location.origin + window.location.pathname + '?' + params.toString();
      
      // Copy to clipboard
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('Share link copied to clipboard!');
      }).catch(() => {
        prompt('Copy this link to share:', shareUrl);
      });
    };

    // Load from URL parameters on page load
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('price')) {
        document.getElementById('price').value = params.get('price');
        document.getElementById('down').value = params.get('down') || 20;
        document.getElementById('rate').value = params.get('rate') || 5.5;
        document.getElementById('term').value = params.get('term') || 25;
        document.getElementById('rent').value = params.get('rent') || 0;
        document.getElementById('propertyTax').value = params.get('tax') || 0;
        document.getElementById('insurance').value = params.get('insurance') || 0;
        document.getElementById('province').value = params.get('province') || 'ON';
        
        // Auto-calculate if data loaded from URL
        setTimeout(() => {
          document.getElementById('calcButton').click();
        }, 100);
      }
    });

    // Tax Impact Calculator
    document.getElementById('calculateTax').onclick = () => {
      const taxRate = +document.getElementById('taxRate').value || 0;
      const ccaClass = document.getElementById('ccaClass').value;
      
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      // CCA rates
      const ccaRates = {
        '1': 0.04,  // Building
        '8': 0.20,  // Equipment
        '43': 0.30  // Manufacturing
      };
      
      const ccaRate = ccaRates[ccaClass] || 0.04;
      const buildingValue = currentProperty.price * 0.75; // Assume 75% is building, 25% is land
      const annualCCA = buildingValue * ccaRate;
      
      const rentalIncome = (currentProperty.monthlyRent + (currentProperty.additionalIncome || 0)) * 12;
      const expenses = currentProperty.operatingExpenses * 12;
      const mortgageInterest = currentProperty.monthlyPayment * 12 * 0.8; // Rough estimate of interest portion
      
      const taxableIncome = rentalIncome - expenses - mortgageInterest - annualCCA;
      const taxPayable = taxableIncome * (taxRate / 100);
      const afterTaxCashFlow = (currentProperty.netCashFlow * 12) - taxPayable;
      
      let html = '<div class="result-card">';
      html += '<h4>Tax Impact Analysis</h4>';
      html += '<table class="comparison-table">';
      html += `<tr><td>Rental Income</td><td>${money(rentalIncome)}</td></tr>`;
      html += `<tr><td>Operating Expenses</td><td>-${money(expenses)}</td></tr>`;
      html += `<tr><td>Mortgage Interest</td><td>-${money(mortgageInterest)}</td></tr>`;
      html += `<tr><td>CCA Deduction</td><td>-${money(annualCCA)}</td></tr>`;
      html += `<tr style="border-top:2px solid var(--border);"><td><strong>Taxable Income</strong></td><td><strong>${money(taxableIncome)}</strong></td></tr>`;
      html += `<tr><td>Tax Payable (${taxRate}%)</td><td style="color:var(--danger);">-${money(taxPayable)}</td></tr>`;
      html += `<tr style="border-top:2px solid var(--border);"><td><strong>After-Tax Cash Flow</strong></td><td><strong style="color:${afterTaxCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(afterTaxCashFlow)}</strong></td></tr>`;
      html += '</table>';
      
      html += '<div class="alert alert-info" style="margin-top:16px;">';
      html += '<strong>Note:</strong> This is a simplified tax calculation. ';
      html += 'CCA creates a deferred tax liability when you sell. ';
      html += 'Consult a tax professional for accurate planning.';
      html += '</div>';
      
      html += '</div>';
      document.getElementById('taxResults').innerHTML = html;
    };

    // Sensitivity Analysis
    function generateSensitivityMatrix() {
      if (!currentProperty.price) {
        document.getElementById('sensitivityMatrix').innerHTML = '<div class="alert alert-warning">Calculate a property first.</div>';
        return;
      }
      
      const baseRent = currentProperty.monthlyRent;
      const baseRate = currentProperty.rate;
      const baseCashFlow = currentProperty.netCashFlow;
      
      let html = '<table class="comparison-table">';
      html += '<thead><tr><th>Scenario</th><th>-20%</th><th>-10%</th><th>Base</th><th>+10%</th><th>+20%</th></tr></thead>';
      html += '<tbody>';
      
      // Rent sensitivity
      html += '<tr><td><strong>Rent Change</strong></td>';
      [-0.2, -0.1, 0, 0.1, 0.2].forEach(change => {
        const newRent = baseRent * (1 + change);
        const rentDiff = newRent - baseRent;
        const newCashFlow = baseCashFlow + rentDiff;
        const color = newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<td style="color:${color}">${money(newCashFlow)}</td>`;
      });
      html += '</tr>';
      
      // Interest rate sensitivity
      html += '<tr><td><strong>Rate Change</strong></td>';
      [-0.2, -0.1, 0, 0.1, 0.2].forEach(change => {
        const newRate = baseRate * (1 + change);
        const rateDiff = newRate - baseRate;
        const paymentChange = (currentProperty.price - currentProperty.downPayment) * (rateDiff / 100 / 12) * 0.5; // Simplified
        const newCashFlow = baseCashFlow - paymentChange;
        const color = newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<td style="color:${color}">${money(newCashFlow)}</td>`;
      });
      html += '</tr>';
      
      // Vacancy sensitivity
      html += '<tr><td><strong>Vacancy Rate</strong></td>';
      [3, 5, currentProperty.vacancyPercent || 5, 10, 15].forEach(vacancy => {
        const vacancyLoss = baseRent * (vacancy / 100);
        const newCashFlow = baseCashFlow + (currentProperty.monthlyRent * currentProperty.vacancyPercent / 100) - vacancyLoss;
        const color = newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<td style="color:${color}">${money(newCashFlow)}<br><small>${vacancy}%</small></td>`;
      });
      html += '</tr>';
      
      html += '</tbody></table>';
      
      html += '<div class="alert alert-info" style="margin-top:16px;">This matrix shows how your monthly cash flow changes with different scenarios.</div>';
      
      document.getElementById('sensitivityMatrix').innerHTML = html;
    }

    // Generate sensitivity matrix when tab is clicked
    document.querySelector('[data-tab="sensitivity"]').onclick = function() {
      this.click(); // Handle tab switching
      setTimeout(generateSensitivityMatrix, 100);
    };

    // Cash flow breakdown
    function generateCashFlowBreakdown() {
      if (!currentProperty.price) {
        document.getElementById('cashflowBreakdown').innerHTML = '<div class="alert alert-warning">Calculate a property first.</div>';
        return;
      }
      
      const income = [
        {name: 'Rent', amount: currentProperty.monthlyRent},
        {name: 'Additional Income', amount: currentProperty.additionalIncome || 0}
      ];
      
      const expenses = [
        {name: 'Mortgage Payment', amount: currentProperty.monthlyPayment},
        {name: 'Property Tax', amount: currentProperty.annualTax / 12},
        {name: 'Insurance', amount: currentProperty.annualInsurance / 12},
        {name: 'Condo Fees', amount: currentProperty.condoFees || 0},
        {name: 'Utilities', amount: currentProperty.utilities || 0},
        {name: 'Management', amount: currentProperty.monthlyRent * (currentProperty.managementPercent || 0) / 100},
        {name: 'Vacancy', amount: currentProperty.monthlyRent * (currentProperty.vacancyPercent || 0) / 100},
        {name: 'Maintenance', amount: currentProperty.maintenance || 0},
        {name: 'CapEx Reserve', amount: currentProperty.monthlyRent * (currentProperty.capexPercent || 0) / 100}
      ];
      
      const totalIncome = income.reduce((sum, item) => sum + item.amount, 0);
      const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
      
      let html = '<div class="grid grid-2">';
      
      // Income breakdown
      html += '<div class="card"><h4>Monthly Income</h4>';
      income.forEach(item => {
        if (item.amount > 0) {
          html += `<div style="display:flex;justify-content:space-between;margin:8px 0;">`;
          html += `<span>${item.name}:</span><strong>${money(item.amount)}</strong></div>`;
        }
      });
      html += `<div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">`;
      html += `<div style="display:flex;justify-content:space-between;">`;
      html += `<strong>Total Income:</strong><strong style="color:var(--success)">${money(totalIncome)}</strong></div></div>`;
      html += '</div>';
      
      // Expense breakdown
      html += '<div class="card"><h4>Monthly Expenses</h4>';
      expenses.forEach(item => {
        if (item.amount > 0) {
          const pctOfRent = currentProperty.monthlyRent ? (item.amount / currentProperty.monthlyRent * 100).toFixed(1) : 0;
          html += `<div style="display:flex;justify-content:space-between;margin:8px 0;">`;
          html += `<span>${item.name}:</span><strong>${money(item.amount)} <small>(${pctOfRent}%)</small></strong></div>`;
        }
      });
      html += `<div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">`;
      html += `<div style="display:flex;justify-content:space-between;">`;
      html += `<strong>Total Expenses:</strong><strong style="color:var(--danger)">${money(totalExpenses)}</strong></div></div>`;
      html += '</div>';
      
      html += '</div>';
      
      // Net cash flow summary
      const netCashFlow = totalIncome - totalExpenses;
      html += `<div class="alert ${netCashFlow >= 0 ? 'alert-success' : 'alert-danger'}" style="margin-top:16px;">`;
      html += `<strong>Net Monthly Cash Flow: ${money(netCashFlow)}</strong><br>`;
      html += `Annual Cash Flow: ${money(netCashFlow * 12)}`;
      html += '</div>';
      
      document.getElementById('cashflowBreakdown').innerHTML = html;
    }

    // Generate cash flow breakdown when tab is clicked
    document.querySelector('[data-tab="cashflow"]').onclick = function() {
      this.click(); // Handle tab switching
      setTimeout(generateCashFlowBreakdown, 100);
    };

    // ROI Analysis
    function generateROIAnalysis() {
      if (!currentProperty.price) {
        document.getElementById('roiBreakdown').innerHTML = '<div class="alert alert-warning">Calculate a property first.</div>';
        return;
      }
      
      const years = 5;
      const initialInvestment = currentProperty.totalInitialInvestment;
      const annualCashFlow = currentProperty.netCashFlow * 12;
      const appreciationRate = currentProperty.appreciationRate || 3;
      const rentIncreaseRate = currentProperty.rentIncreaseRate || 2.5;
      
      let totalCashFlow = 0;
      let propertyValue = currentProperty.price;
      
      for (let i = 1; i <= years; i++) {
        propertyValue *= (1 + appreciationRate / 100);
        const yearCashFlow = annualCashFlow * Math.pow(1 + rentIncreaseRate / 100, i - 1);
        totalCashFlow += yearCashFlow;
      }
      
      const totalAppreciation = propertyValue - currentProperty.price;
      const mortgagePaydown = currentProperty.monthlyPayment * 12 * years * 0.3; // Rough estimate of principal portion
      const totalReturn = totalCashFlow + totalAppreciation + mortgagePaydown;
      const totalROI = (totalReturn / initialInvestment) * 100;
      
      // Simple IRR calculation (approximation)
      const avgAnnualReturn = totalReturn / years;
      const irr = (Math.pow((initialInvestment + totalReturn) / initialInvestment, 1/years) - 1) * 100;
      
      document.getElementById('totalRoi').textContent = pct(totalROI);
      document.getElementById('irr').textContent = pct(irr);
      
      let html = '<div class="card">';
      html += `<h4>${years}-Year Return Breakdown</h4>`;
      html += '<table class="comparison-table">';
      html += `<tr><td>Initial Investment</td><td>${money(initialInvestment)}</td></tr>`;
      html += `<tr><td>Total Cash Flow</td><td>${money(totalCashFlow)}</td></tr>`;
      html += `<tr><td>Property Appreciation</td><td>${money(totalAppreciation)}</td></tr>`;
      html += `<tr><td>Mortgage Paydown</td><td>${money(mortgagePaydown)}</td></tr>`;
      html += `<tr style="border-top:2px solid var(--border);"><td><strong>Total Return</strong></td><td><strong>${money(totalReturn)}</strong></td></tr>`;
      html += `<tr><td><strong>Total ROI</strong></td><td><strong>${pct(totalROI)}</strong></td></tr>`;
      html += `<tr><td><strong>Annualized Return (IRR)</strong></td><td><strong>${pct(irr)}</strong></td></tr>`;
      html += '</table>';
      html += '</div>';
      
      document.getElementById('roiBreakdown').innerHTML = html;
    }

    // Generate ROI analysis when tab is clicked
    document.querySelector('[data-tab="roi"]').onclick = function() {
      this.click(); // Handle tab switching
      setTimeout(generateROIAnalysis, 100);
    };

    // Initialize on page load
    document.body.className = currentMode + '-mode';
    
    // Service Worker for PWA (optional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {
        // Service worker registration failed, app still works without it
      });
    }
  </script>
</body>
</html>
