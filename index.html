<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck ‚Äî RE Calculator & Underwriting Tool</title>

  <script src="https://apis.google.com/js/api.js" async defer></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <!-- Google Identity Services - Script loads and automatically calls onGoogleLibraryLoad when ready -->
  <script src="https://accounts.google.com/gsi/client" async onload="onGoogleLibraryLoad()"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;--max-w:1200px;--danger:#e74c3c;
      --warning:#f39c12;--info:#3498db;--success:#2ecc71;--text:#2c3e50;
      --border:#e1e8ed;--shadow:0 6px 20px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
         background:linear-gradient(135deg,var(--page-bg-1) 0%,var(--page-bg-2) 100%);
         color:var(--text);min-height:100vh;}
    
    /* Login Styles */
    .center-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:100%;max-width:420px;background:var(--card-bg);border-radius:16px;padding:32px;
                box-shadow:0 18px 40px rgba(2,6,23,0.25);text-align:center}
    .login-card h1{color:var(--brand);margin:0 0 8px 0;font-size:2.2rem}
    .subtitle{color:var(--muted);margin-bottom:24px;font-size:1.1rem}
    
    /* Navigation */
    .nav{background:#fff;padding:0;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .nav-container{max-width:var(--max-w);margin:0 auto;padding:0 20px;display:flex;
                   justify-content:space-between;align-items:center;height:70px}
    .logo{color:var(--brand);font-size:1.8rem;font-weight:700;text-decoration:none}
    .nav-links{display:flex;gap:0;align-items:center}
    .nav-link{padding:12px 20px;text-decoration:none;color:var(--text);font-weight:500;
              border-radius:8px;transition:all 0.2s}
    .nav-link:hover,.nav-link.active{background:var(--brand);color:#fff}
    .user-menu{display:flex;gap:12px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    
    /* Main Content */
    .main{max-width:var(--max-w);margin:0 auto;padding:24px 20px;min-height:calc(100vh - 70px)}
    .page{display:none}.page.active{display:block}
    
    /* Components */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;
         border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:15px;transition:all 0.2s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-dark)}
    .btn-secondary{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-small{padding:8px 16px;font-size:14px}
    
    .card{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 20px 0;color:var(--text);font-size:1.3rem}
    .card h4{margin:20px 0 16px 0;color:var(--text);font-size:1.1rem}
    
    .grid{display:grid;gap:16px}.grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}
    .full{grid-column:1/-1}
    
    .form-group{margin-bottom:16px}
    .form-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--text)}
    .form-group input,.form-group select{width:100%;padding:12px;border-radius:8px;
                                        border:1px solid var(--border);font-size:15px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--brand)}
    .form-group small{display:block;color:var(--muted);margin-top:4px;font-size:13px}
    
    .result-card{background:linear-gradient(135deg,#e8f8f5 0%,#d5efdb 100%);
                 padding:20px;border-radius:12px;margin-top:20px}
    .metric{text-align:center;padding:16px}
    .metric-value{font-size:1.8rem;font-weight:700;color:var(--brand)}
    .metric-label{color:var(--muted);font-size:0.9rem;margin-top:4px}
    
    .alert{padding:16px;border-radius:8px;margin-bottom:20px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
    .alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460}
    
    .tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:24px}
    .tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;
         font-weight:500;color:var(--muted)}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    
    .comparison-table{width:100%;border-collapse:collapse;margin-top:20px}
    .comparison-table th,.comparison-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    .comparison-table th{background:#f8f9fa;font-weight:600}
    
    /* Qualification Status */
    .qualification-status{padding:12px;border-radius:8px;margin:16px 0;display:flex;align-items:center;gap:12px}
    .qualification-status.qualified{background:#d4edda;border:1px solid #c3e6cb}
    .qualification-status.warning{background:#fff3cd;border:1px solid #ffeaa7}
    .qualification-status.failed{background:#f8d7da;border:1px solid #f5c6cb}
    .qualification-icon{font-size:24px}
    
    /* Ratio Bars */
    .ratio-bar{height:30px;background:#f0f0f0;border-radius:15px;position:relative;overflow:hidden;margin:8px 0}
    .ratio-fill{height:100%;transition:width 0.3s;display:flex;align-items:center;padding:0 12px;
                color:#fff;font-weight:600}
    .ratio-fill.good{background:var(--success)}
    .ratio-fill.warning{background:var(--warning)}
    .ratio-fill.danger{background:var(--danger)}
    
    @media(max-width:768px){
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
      .nav-links{display:none}
      .nav-container{padding:0 16px}
      .main{padding:16px}
      .card{padding:20px}
    }
    
    /* Mobile Menu */
    .mobile-menu{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;
                 box-shadow:0 -2px 10px rgba(0,0,0,0.1);padding:12px;z-index:1000}
    .mobile-nav{display:flex;justify-content:space-around}
    .mobile-nav-item{text-align:center;padding:8px;border-radius:8px;cursor:pointer;
                     color:var(--muted);font-size:12px;min-width:60px}
    .mobile-nav-item.active{color:var(--brand);background:#f0f9ff}
    
    @media(max-width:768px){
      .mobile-menu{display:block}
      .main{padding-bottom:80px}
    }
  </style>
</head>
<body>
<!-- LOGIN SCREEN -->
  <main id="loginScreen" class="center-screen">
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
      <div class="login-card">
        <h1>üè† PropCheck</h1>
        <div class="subtitle">Fast Canadian property underwriting for real estate investors</div>
        
        <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
        
        <div style="margin:16px 0;color:var(--muted);font-size:14px;">or</div>
        
        <!-- Google Sign-In Button Container -->
        <div id="g_button_target" style="margin-top:10px;min-height:44px;"></div>
        
        <!-- Hidden elements for Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"
             data-itp_support="true"
             style="display:none;"></div>
      </div>
      
      <!-- PWA Install Button Below White Box -->
      <div style="margin-top:32px;text-align:center;">
        <button id="homeInstallBtn" class="btn btn-primary" style="font-size:18px;padding:16px 32px;background:var(--brand);border:none;box-shadow:0 4px 12px rgba(46,204,113,0.3);">
          üì± Download App
        </button>
        <div style="color:rgba(255,255,255,0.8);margin-top:8px;font-size:14px;">
          Install PropCheck for offline access
        </div>
      </div>
    </div>
  </main>

  <!-- MAIN APP -->
  <div id="mainApp" style="display:none;">
    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-container">
        <a href="#" class="logo">üè† PropCheck</a>
        <div class="nav-links">
          <a href="#" class="nav-link active" data-page="calculator">Calculator</a>
          <a href="#" class="nav-link" data-page="analysis">Analysis</a>
          <a href="#" class="nav-link" data-page="compare">Compare</a>
          <a href="#" class="nav-link" data-page="reports">Reports</a>
          <a href="#" class="nav-link" data-page="market">Market Data</a>
          <a href="#" class="nav-link" data-page="qualification">Qualification</a>
        </div>
        <div class="user-menu">
          <button id="installBtn" class="btn-secondary btn-small" style="display:none;">‚ûï Install</button>
          <div id="userArea" class="user-menu" style="display:none;">
            <img id="userAvatar" class="avatar" alt="">
            <div style="margin-right:12px;">
              <div id="userName" style="font-weight:600;font-size:14px;"></div>
              <div id="userEmail" style="color:var(--muted);font-size:12px;"></div>
            </div>
            <button id="signOut" class="btn-secondary btn-small">Sign out</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main">
      
      <!-- CALCULATOR PAGE -->
      <div id="calculatorPage" class="page active">
        <div class="card">
          <h3>üè† Property Calculator</h3>
          <div class="grid grid-2">
            <div class="form-group">
              <label>Purchase Price ($)</label>
              <input id="price" type="number" placeholder="e.g. 750000">
            </div>
            <div class="form-group">
              <label>Down Payment (%)</label>
              <input id="down" type="number" value="20" min="5" max="100">
            </div>
            <div class="form-group">
              <label>Interest Rate (%)</label>
              <input id="rate" type="number" value="5.5" step="0.1">
            </div>
            <div class="form-group">
              <label>Amortization (years)</label>
              <select id="term">
                <option value="25">25 years</option>
                <option value="30">30 years</option>
                <option value="20">20 years</option>
                <option value="15">15 years</option>
              </select>
            </div>
            <div class="form-group">
              <label>Monthly Rent ($)</label>
              <input id="rent" type="number" placeholder="e.g. 3200">
            </div>
            <div class="form-group">
              <label>Property Taxes (annual $)</label>
              <input id="propertyTax" type="number" placeholder="e.g. 8500">
            </div>
            <div class="form-group">
              <label>Insurance (annual $)</label>
              <input id="insurance" type="number" placeholder="e.g. 1200">
            </div>
            <div class="form-group">
              <label>Management Fee (%)</label>
              <input id="management" type="number" value="8" step="0.1">
            </div>
            <div class="form-group">
              <label>Vacancy Rate (%)</label>
              <input id="vacancy" type="number" value="5" step="0.1">
            </div>
            <div class="form-group">
              <label>Other Monthly Expenses ($)</label>
              <input id="otherExpenses" type="number" placeholder="e.g. 200">
            </div>
          </div>
          
          <div class="form-group" style="margin-top:20px;">
            <label>
              <input type="checkbox" id="cmhcRequired" style="width:auto;margin-right:8px;">
              CMHC Insurance Required (down payment < 20%)
            </label>
          </div>
          
          <button id="calcButton" class="btn btn-primary">Calculate Investment</button>
          
          <div id="results" class="result-card" style="display:none;">
            <div class="grid grid-4">
              <div class="metric">
                <div class="metric-value" id="payment">$0</div>
                <div class="metric-label">Monthly Payment</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="cashflow">$0</div>
                <div class="metric-label">Net Cash Flow</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="caprate">0%</div>
                <div class="metric-label">Cap Rate</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="coc">0%</div>
                <div class="metric-label">Cash-on-Cash</div>
              </div>
            </div>
            
            <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
              <h4>Investment Summary</h4>
              <div class="grid grid-2">
                <div>
                  <strong>Initial Investment:</strong><br>
                  Down Payment: <span id="downPaymentAmount">$0</span><br>
                  CMHC Insurance: <span id="cmhcAmount">$0</span><br>
                  <strong>Total: <span id="totalInitial">$0</span></strong>
                </div>
                <div>
                  <strong>Annual Numbers:</strong><br>
                  Gross Rent: <span id="grossRent">$0</span><br>
                  Total Expenses: <span id="totalExpenses">$0</span><br>
                  Net Operating Income: <span id="noi">$0</span>
                </div>
              </div>
            </div>
            
            <button id="saveProperty" class="btn btn-secondary" style="margin-top:16px;">
              üíæ Save Property
            </button>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>
      </div>

      <!-- QUALIFICATION PAGE (NEW) -->
      <div id="qualificationPage" class="page">
        <div class="card">
          <h3>üè¶ Mortgage Qualification Analysis</h3>
          
          <div class="alert alert-info">
            This calculator uses Canadian mortgage qualification rules including stress testing and proper treatment of lines of credit.
          </div>
          
          <!-- Income Section -->
          <h4>Income Information</h4>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Annual Employment Income ($)</label>
              <input id="employmentIncome" type="number" placeholder="e.g. 120000">
            </div>
            <div class="form-group">
              <label>Other Income ($)</label>
              <input id="otherIncome" type="number" placeholder="e.g. 10000">
            </div>
            <div class="form-group">
              <label>Co-borrower Income ($)</label>
              <input id="coborrowIncome" type="number" placeholder="e.g. 80000">
            </div>
          </div>
          
          <!-- Debts Section -->
          <h4>Monthly Debt Obligations</h4>
          <div class="alert alert-warning">
            <strong>Line of Credit Rules:</strong><br>
            ‚Ä¢ <strong>Unsecured LOC under $50,000:</strong> 3% of actual balance<br>
            ‚Ä¢ <strong>Unsecured LOC $50,000+:</strong> 3% of full limit<br>
            ‚Ä¢ <strong>Secured HELOC:</strong> 3% of full limit (regardless of balance)
          </div>
          
          <div class="grid grid-3">
            <div class="form-group">
              <label>Car Payment ($)</label>
              <input id="carPayment" type="number" placeholder="e.g. 450">
            </div>
            <div class="form-group">
              <label>Credit Cards Min ($)</label>
              <input id="creditCardPayment" type="number" placeholder="e.g. 200">
            </div>
            <div class="form-group">
              <label>Student Loan ($)</label>
              <input id="studentLoan" type="number" placeholder="e.g. 300">
            </div>
            <div class="form-group">
              <label>Unsecured LOC Limit ($)</label>
              <input id="locLimit" type="number" placeholder="e.g. 30000">
            </div>
            <div class="form-group">
              <label>Unsecured LOC Balance ($)</label>
              <input id="locBalance" type="number" placeholder="e.g. 5000">
            </div>
            <div class="form-group">
              <label>HELOC Limit ($)</label>
              <input id="helocLimit" type="number" placeholder="e.g. 100000">
            </div>
          </div>
          
          <!-- Property Details -->
          <h4>Property Being Qualified</h4>
          <div class="grid grid-3">
            <div class="form-group">
              <label>Purchase Price ($)</label>
              <input id="qualPrice" type="number" placeholder="e.g. 750000">
            </div>
            <div class="form-group">
              <label>Down Payment ($)</label>
              <input id="qualDown" type="number" placeholder="e.g. 150000">
            </div>
            <div class="form-group">
              <label>Interest Rate (%)</label>
              <input id="qualRate" type="number" value="5.5" step="0.1">
            </div>
            <div class="form-group">
              <label>Property Tax (annual $)</label>
              <input id="qualTax" type="number" placeholder="e.g. 8500">
            </div>
            <div class="form-group">
              <label>Heating (monthly $)</label>
              <input id="qualHeat" type="number" value="150">
            </div>
            <div class="form-group">
              <label>Condo Fees (monthly $)</label>
              <input id="qualCondo" type="number" value="0">
            </div>
          </div>
          
          <button id="qualifyButton" class="btn btn-primary">Analyze Qualification</button>
          
          <!-- Qualification Results -->
          <div id="qualificationResults" style="display:none;margin-top:24px;">
            <div class="qualification-status" id="qualStatus">
              <div class="qualification-icon" id="qualIcon">‚úì</div>
              <div>
                <strong id="qualMessage">Qualification Status</strong>
                <div id="qualDetails" style="font-size:14px;margin-top:4px;"></div>
              </div>
            </div>
            
            <!-- Debt Service Ratios -->
            <h4 style="margin-top:24px">Debt Service Ratios</h4>
            
            <div style="margin-bottom:20px;">
              <strong>GDS (Gross Debt Service)</strong> - Housing costs only
              <div class="ratio-bar">
                <div class="ratio-fill" id="gdsBar" style="width:0%">
                  <span id="gdsValue">0%</span>
                </div>
              </div>
              <small>Maximum allowed: 39% (32% preferred)</small>
            </div>
            
            <div style="margin-bottom:20px;">
              <strong>TDS (Total Debt Service)</strong> - All debt payments
              <div class="ratio-bar">
                <div class="ratio-fill" id="tdsBar" style="width:0%">
                  <span id="tdsValue">0%</span>
                </div>
              </div>
              <small>Maximum allowed: 44%</small>
            </div>
            
            <div class="alert alert-info" style="margin-top:20px;">
              <strong>Stress Test Rate:</strong> <span id="stressTestRate">0%</span><br>
              Qualification uses the higher of your rate + 2% or 5.25%
            </div>
            
            <!-- Maximum Affordability -->
            <div class="card" style="margin-top:20px;">
              <h4>Maximum Affordability</h4>
              <div class="grid grid-3">
                <div class="metric">
                  <div class="metric-value" id="maxPurchase">$0</div>
                  <div class="metric-label">Max Purchase Price</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="maxMortgage">$0</div>
                  <div class="metric-label">Max Mortgage</div>
                </div>
                <div class="metric">
                  <div class="metric-value" id="requiredIncome">$0</div>
                  <div class="metric-label">Income Needed</div>
                </div>
              </div>
            </div>
            
            <div id="qualRecommendations" style="margin-top:20px;"></div>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>
 <!-- ANALYSIS PAGE -->
      <div id="analysisPage" class="page">
        <div class="card">
          <h3>üìä Stress Testing & Scenarios</h3>
          
          <div class="tabs">
            <div class="tab active" data-tab="rates">Interest Rates</div>
            <div class="tab" data-tab="rent">Rent Changes</div>
            <div class="tab" data-tab="expenses">Expense Impact</div>
          </div>
          
          <!-- Interest Rate Analysis -->
          <div id="ratesTab" class="tab-content">
            <p>Analyze how interest rate changes affect your investment:</p>
            <div class="grid grid-3">
              <div class="form-group">
                <label>Current Rate (%)</label>
                <input id="currentRate" type="number" value="5.5" step="0.1">
              </div>
              <div class="form-group">
                <label>Stress Test Rate (%)</label>
                <input id="stressRate" type="number" value="7.5" step="0.1">
              </div>
              <div class="form-group">
                <label>Renewal Period (years)</label>
                <select id="renewalPeriod">
                  <option value="1">1 year</option>
                  <option value="2">2 years</option>
                  <option value="3">3 years</option>
                  <option value="5" selected>5 years</option>
                </select>
              </div>
            </div>
            <button id="runStressTest" class="btn btn-primary">Run Stress Test</button>
            <div id="stressResults" style="display:none;margin-top:20px;"></div>
          </div>
          
          <!-- Rent Analysis -->
          <div id="rentTab" class="tab-content" style="display:none;">
            <p>Model different rental scenarios:</p>
            <div class="grid grid-2">
              <div class="form-group">
                <label>Annual Rent Increase (%)</label>
                <input id="rentIncrease" type="number" value="3" step="0.1">
              </div>
              <div class="form-group">
                <label>Projection Period (years)</label>
                <input id="projectionYears" type="number" value="10" min="1" max="30">
              </div>
            </div>
            <button id="runRentAnalysis" class="btn btn-primary">Analyze Rent Growth</button>
            <div id="rentResults" style="display:none;margin-top:20px;"></div>
          </div>
          
          <!-- Expense Analysis -->
          <div id="expenseTab" class="tab-content" style="display:none;">
            <p>Break down and optimize your expenses:</p>
            <div id="expenseBreakdown" style="margin-top:20px;"></div>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>

      <!-- COMPARE PAGE -->
      <div id="comparePage" class="page">
        <div class="card">
          <h3>‚öñÔ∏è Property Comparison</h3>
          <div style="margin-bottom:20px;">
            <button id="addProperty" class="btn btn-primary">+ Add Property</button>
            <button id="clearComparison" class="btn btn-secondary">Clear All</button>
          </div>
          
          <div id="comparisonContainer">
            <div class="alert alert-warning">
              Add properties from the calculator to compare them side-by-side.
            </div>
          </div>
        </div>
      </div>

      <!-- REPORTS PAGE -->
      <div id="reportsPage" class="page">
        <div class="card">
          <h3>üìã Investment Reports</h3>
          
          <div class="grid grid-2">
            <div class="card" style="margin:0;">
              <h4>Property Summary Report</h4>
              <p class="muted">Generate a comprehensive analysis report for lenders or partners.</p>
              <button id="generateSummary" class="btn btn-primary">Generate PDF</button>
            </div>
            <div class="card" style="margin:0;">
              <h4>Portfolio Analysis</h4>
              <p class="muted">Analyze all your saved properties together.</p>
              <button id="portfolioReport" class="btn btn-primary">View Portfolio</button>
            </div>
          </div>
          
          <div id="savedProperties" class="card">
            <h4>Saved Properties</h4>
            <div id="propertiesList">
              <div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>
            </div>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>

      <!-- MARKET DATA PAGE -->
      <div id="marketPage" class="page">
        <div class="card">
          <h3>üèôÔ∏è Market Intelligence</h3>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label>City/Region</label>
              <select id="citySelect">
                <option value="toronto">Toronto, ON</option>
                <option value="vancouver">Vancouver, BC</option>
                <option value="montreal">Montreal, QC</option>
                <option value="calgary">Calgary, AB</option>
                <option value="ottawa">Ottawa, ON</option>
                <option value="mississauga">Mississauga, ON</option>
                <option value="hamilton">Hamilton, ON</option>
              </select>
            </div>
            <div class="form-group">
              <label>Property Type</label>
              <select id="propertyType">
                <option value="condo">Condominium</option>
                <option value="detached">Detached House</option>
                <option value="townhouse">Townhouse</option>
                <option value="duplex">Duplex</option>
              </select>
            </div>
          </div>
          
          <button id="loadMarketData" class="btn btn-primary">Load Market Data</button>
          
          <div id="marketResults" style="margin-top:24px;">
            <div class="grid grid-3">
              <div class="metric">
                <div class="metric-value">$750K</div>
                <div class="metric-label">Avg. Sale Price</div>
              </div>
              <div class="metric">
                <div class="metric-value">$2,800</div>
                <div class="metric-label">Avg. Rent/Month</div>
              </div>
              <div class="metric">
                <div class="metric-value">4.5%</div>
                <div class="metric-label">Market Cap Rate</div>
              </div>
            </div>
            
            <div class="alert alert-success" style="margin-top:20px;">
              <strong>Market Insight:</strong> Current market conditions in Mississauga show strong rental demand with average cap rates around 4.5%. Consider properties priced below $700K for better cash flow potential.
            </div>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-menu">
      <div class="mobile-nav">
        <div class="mobile-nav-item active" data-page="calculator">
          <div>üè†</div>
          <div>Calc</div>
        </div>
        <div class="mobile-nav-item" data-page="analysis">
          <div>üìä</div>
          <div>Analysis</div>
        </div>
        <div class="mobile-nav-item" data-page="compare">
          <div>‚öñÔ∏è</div>
          <div>Compare</div>
        </div>
        <div class="mobile-nav-item" data-page="reports">
          <div>üìã</div>
          <div>Reports</div>
        </div>
        <div class="mobile-nav-item" data-page="market">
          <div>üèôÔ∏è</div>
          <div>Market</div>
        </div>
      </div>
    </div>
  </div>
<script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    
    

// === Google Drive minimal helpers (incremental auth; uses existing sign-in) ===
const API_KEY = 'AIzaSyCNEg2v7riXUZ_UdjqpkGT56wzMkw-gRxs';
const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

let gapiLoaded = false;
let tokenClient = null;
let driveAccessToken = null;

async function ensureGapi() {
  if (gapiLoaded) return;
  await new Promise(res => gapi.load('client', res));
  await gapi.client.init({ apiKey: API_KEY });
  gapiLoaded = true;
}

function ensureTokenClient() {
  if (tokenClient) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: DRIVE_SCOPES,
    prompt: '',
    callback: (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        gapi.client.setToken({ access_token: driveAccessToken });
      }
    }
  });
}

async function ensureDriveAuth() {
  ensureTokenClient();
  if (!driveAccessToken) {
    await new Promise((resolve) => {
      tokenClient.requestAccessToken({ prompt: '' });
      const wait = () => {
        if (driveAccessToken) return resolve();
        setTimeout(wait, 100);
      };
      wait();
    });
  }
  await ensureGapi();
}

async function driveFindOrCreateFolder(name, parentId = 'root') {
  const q = [
    `name = '${String(name).replaceAll("'","\\'")}'`,
    `mimeType = 'application/vnd.google-apps.folder'`,
    `'${parentId}' in parents`,
    'trashed = false'
  ].join(' and ');
  const res = await gapi.client.drive.files.list({ q, fields: 'files(id,name)' });
  if (res.result.files && res.result.files.length) return res.result.files[0].id;

  const created = await gapi.client.drive.files.create({
    resource: { name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] },
    fields: 'id'
  });
  return created.result.id;
}

function toMultipartBody(metadata, blob) {
  const boundary = '-------propcheck_' + Math.random().toString(36).slice(2);
  const delimiter = `\r\n--${boundary}\r\n`;
  const closeDelim = `\r\n--${boundary}--`;
  const meta = new Blob([ 'Content-Type: application/json; charset=UTF-8\r\n\r\n', JSON.stringify(metadata) ]);
  const body = new Blob([
    delimiter, meta, '\r\n',
    delimiter, `Content-Type: ${blob.type || 'application/octet-stream'}\r\n\r\n`, blob,
    closeDelim
  ], { type: `multipart/related; boundary=${boundary}` });
  return { type: body.type, body };
}

function defaultDealFilename(prop) {
  const base = (prop.name || 'Property').toString().trim().slice(0, 80);
  const date = new Date().toISOString().slice(0,10);
  return `${base} - ${date}.json`;
}

async function savePropertyJsonToDrive(prop) {
  if (!currentUser) throw new Error('Not signed in with Google.');

  await ensureDriveAuth();

  const rootId = await driveFindOrCreateFolder('PropCheck', 'root');
  const dealsId = await driveFindOrCreateFolder('Deals', rootId);

  const toSave = { ...prop, savedBy: { name: currentUser.name, email: currentUser.email }, savedAt: new Date().toISOString() };
  const blob = new Blob([ JSON.stringify(toSave, null, 2) ], { type: 'application/json' });

  const metadata = { name: defaultDealFilename(prop), mimeType: 'application/json', parents: [dealsId] };
  const mp = toMultipartBody(metadata, blob);

  const upload = await gapi.client.request({
    path: '/upload/drive/v3/files',
    method: 'POST',
    params: { uploadType: 'multipart' },
    headers: { 'Content-Type': mp.type },
    body: mp.body
  });

  const meta = await gapi.client.drive.files.get({ fileId: upload.result.id, fields: 'id,name,webViewLink' });
  return meta.result;
}

// Global state
    let currentProperty = {};
    let savedProperties = [];
    let currentUser = null;

    // Login functionality - EXACT FROM YOUR ORIGINAL
    guestButton.onclick = () => { 
      loginScreen.style.display='none'; 
      mainApp.style.display='block';
      gtag('event', 'login', {method: 'guest'});
    };

    // Homepage PWA install button - EXACT FROM YOUR ORIGINAL
    document.getElementById('homeInstallBtn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          gtag('event', 'pwa_install', {source: 'homepage'});
        }
        deferredPrompt = null;
      } else {
        alert('To install this app:\n\niOS: Tap Share ‚Üí Add to Home Screen\nAndroid: Tap menu ‚Üí Add to Home Screen\nDesktop: Look for install icon in address bar');
      }
    };

    function parseJwt(token){
      try{
        const base64Url=token.split('.')[1];
        const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
        const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }catch(e){return null;}
    }

    function handleCredentialResponse(response){
      const payload = parseJwt(response.credential);
      if(!payload) return;
      
      currentUser = payload;
      loginScreen.style.display='none';
      mainApp.style.display='block';
      userArea.style.display='flex';
      userAvatar.src = payload.picture || '';
      userName.textContent = payload.name;
      userEmail.textContent = payload.email;
      gtag('event', 'login', {method: 'google'});
    }

    // Make handleCredentialResponse available globally for Google to call
    window.handleCredentialResponse = handleCredentialResponse;

    // Google Sign-in initialization - FIXED VERSION
    window.onGoogleLibraryLoad = function() {
      if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleCredentialResponse
        });
        
        google.accounts.id.renderButton(
          document.getElementById('g_button_target'),
          {
            theme: 'outline',
            size: 'large',
            width: 280,
            text: 'signin_with',
            shape: 'rectangular'
          }
        );
        console.log('Google Sign-In button rendered successfully');
      } else {
        console.error('Google library loaded but google.accounts.id not available');
      }
    }

    window.onload = function(){
      // Initialize AdSense
      (adsbygoogle = window.adsbygoogle || []).push({});
      
      // Also check if Google library already loaded
      if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
        onGoogleLibraryLoad();
      }
    }

    signOut.onclick=()=>{
      google.accounts.id.disableAutoSelect();
      userArea.style.display='none';
      loginScreen.style.display='flex';
      mainApp.style.display='none';
      currentUser = null;
      gtag('event', 'logout');
    };

    // Navigation - ORIGINAL
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.mobile-nav-item').forEach(l => l.classList.remove('active'));
      
      const page = document.getElementById(pageId + 'Page');
      if (page) page.classList.add('active');
      
      const navLink = document.querySelector(`[data-page="${pageId}"]`);
      if (navLink) navLink.classList.add('active');
      
      const mobileLink = document.querySelector(`.mobile-nav-item[data-page="${pageId}"]`);
      if (mobileLink) mobileLink.classList.add('active');
      
      gtag('event', 'page_view', {page_title: pageId});
    }

    document.querySelectorAll('[data-page]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      };
    });

    // Calculator functions - ORIGINAL
    function money(n){return '$'+Number(n).toLocaleString('en-CA', {minimumFractionDigits: 0, maximumFractionDigits: 0});}
    function pct(n){return Number(n).toFixed(2)+'%';}

    function calculateCMHC(price, downPercent) {
      if (downPercent >= 20) return 0;
      const loanAmount = price * (1 - downPercent/100);
      let rate;
      if (downPercent >= 15) rate = 0.028;
      else if (downPercent >= 10) rate = 0.031;
      else rate = 0.04;
      return loanAmount * rate;
    }

    calcButton.onclick = () => {
      const price = +document.getElementById('price').value || 0;
      const downPercent = +down.value || 20;
      const rate = (+document.getElementById('rate').value || 0) / 100 / 12;
      const term = (+document.getElementById('term').value || 25) * 12;
      const monthlyRent = +rent.value || 0;
      const annualTax = +propertyTax.value || 0;
      const annualInsurance = +insurance.value || 0;
      const managementPercent = +management.value || 0;
      const vacancyPercent = +vacancy.value || 0;
      const otherMonthly = +otherExpenses.value || 0;
      
      if (!price || !monthlyRent) {
        alert('Please enter at least the purchase price and monthly rent.');
        return;
      }
      
      // Calculations
      const downPayment = price * downPercent / 100;
      const cmhcInsurance = calculateCMHC(price, downPercent);
      const loanAmount = price - downPayment + cmhcInsurance;
      
      let monthlyPayment = 0;
      if (rate === 0) {
        monthlyPayment = loanAmount / term;
      } else {
        monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
      }
      
      // Monthly expenses
      const monthlyTax = annualTax / 12;
      const monthlyInsurance = annualInsurance / 12;
      const managementFee = monthlyRent * managementPercent / 100;
      const vacancyLoss = monthlyRent * vacancyPercent / 100;
      
      const totalMonthlyExpenses = monthlyPayment + monthlyTax + monthlyInsurance + managementFee + vacancyLoss + otherMonthly;
      const effectiveRent = monthlyRent - vacancyLoss;
      const netCashFlow = effectiveRent - totalMonthlyExpenses;
      
      // Annual calculations
      const grossAnnualRent = monthlyRent * 12;
      const effectiveAnnualRent = effectiveRent * 12;
      const annualExpenses = (monthlyTax + monthlyInsurance + managementFee + otherMonthly) * 12 + (monthlyRent * vacancyPercent / 100 * 12);
      const noi = effectiveAnnualRent - annualExpenses;
      const capRate = price ? (noi / price) * 100 : 0;
      const totalInitialInvestment = downPayment + cmhcInsurance;
      const cashOnCash = totalInitialInvestment ? (netCashFlow * 12 / totalInitialInvestment) * 100 : 0;
      
      // Store current calculation
      currentProperty = {
        price, downPercent, rate: +document.getElementById('rate').value, term: +document.getElementById('term').value,
        monthlyRent, annualTax, annualInsurance, managementPercent, vacancyPercent, otherMonthly,
        monthlyPayment, netCashFlow, noi, capRate, cashOnCash, totalInitialInvestment,
        downPayment, cmhcInsurance, timestamp: new Date()
      };
      
      // Display results
      payment.textContent = money(monthlyPayment);
      cashflow.textContent = money(netCashFlow);
      document.getElementById('caprate').textContent = pct(capRate);
      document.getElementById('coc').textContent = pct(cashOnCash);
      
      document.getElementById('downPaymentAmount').textContent = money(downPayment);
      document.getElementById('cmhcAmount').textContent = money(cmhcInsurance);
      document.getElementById('totalInitial').textContent = money(totalInitialInvestment);
      document.getElementById('grossRent').textContent = money(grossAnnualRent);
      document.getElementById('totalExpenses').textContent = money(annualExpenses);
      document.getElementById('noi').textContent = money(noi);
      
      results.style.display = 'block';
      
      // Color coding for cash flow
      cashflow.style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
      
      gtag('event', 'calculate_property', {
        value: price,
        currency: 'CAD'
      });
    };

    // CMHC checkbox handler - ORIGINAL
    document.getElementById('cmhcRequired').onchange = function() {
      const downPercent = +down.value || 20;
      this.checked = downPercent < 20;
      if (downPercent >= 20) this.checked = false;
    };

    down.oninput = function() {
      const downPercent = +this.value || 20;
      document.getElementById('cmhcRequired').checked = downPercent < 20;
    };

    // Save property functionality - ORIGINAL
    document.getElementById('saveProperty').onclick = async () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const name = prompt('Enter a name for this property:', `Property ${savedProperties.length + 1}`);
      if (!name) return;

      currentProperty.name = name;
      savedProperties.push({...currentProperty});
      updateSavedPropertiesList();

      if (currentUser) {
        try {
          const driveRes = await savePropertyJsonToDrive(currentProperty);
          alert(`Property saved successfully!\n\nAlso uploaded to Drive:\n${driveRes.name}`);
        } catch (e) {
          console.warn('Drive upload failed:', e);
          alert('Property saved locally. (Drive upload failed ‚Äî you can try again after signing in.)');
        }
      } else {
        alert('Property saved successfully! (Sign in with Google to also save to Drive.)');
      }
      gtag('event', 'save_property');
    };

    function updateSavedPropertiesList() {
      const container = document.getElementById('propertiesList');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>';
        return;
      }
      
      container.innerHTML = savedProperties.map((prop, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;">
          <div>
            <strong>${prop.name}</strong><br>
            <span class="muted">${money(prop.price)} ‚Ä¢ ${pct(prop.capRate)} cap ‚Ä¢ ${money(prop.netCashFlow)}/mo cash flow</span>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn-secondary btn-small" onclick="loadProperty(${i})">Load</button>
            <button class="btn-danger btn-small" onclick="deleteProperty(${i})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function loadProperty(index) {
      const prop = savedProperties[index];
      price.value = prop.price;
      down.value = prop.downPercent;
      document.getElementById('rate').value = prop.rate;
      document.getElementById('term').value = prop.term;
      rent.value = prop.monthlyRent;
      propertyTax.value = prop.annualTax;
      insurance.value = prop.annualInsurance;
      management.value = prop.managementPercent;
      vacancy.value = prop.vacancyPercent;
      otherExpenses.value = prop.otherMonthly;
      
      showPage('calculator');
      calcButton.click();
    }

    function deleteProperty(index) {
      if (confirm('Are you sure you want to delete this property?')) {
        savedProperties.splice(index, 1);
        updateSavedPropertiesList();
        updateComparisonTable();
      }
    }

    // Qualification Calculator - NEW WITH PROPER LOC RULES
    document.getElementById('qualifyButton').onclick = () => {
      const employmentIncome = +document.getElementById('employmentIncome').value || 0;
      const otherIncome = +document.getElementById('otherIncome').value || 0;
      const coborrowIncome = +document.getElementById('coborrowIncome').value || 0;
      const totalIncome = employmentIncome + otherIncome + coborrowIncome;
      
      const carPayment = +document.getElementById('carPayment').value || 0;
      const creditCardPayment = +document.getElementById('creditCardPayment').value || 0;
      const studentLoan = +document.getElementById('studentLoan').value || 0;
      
      // Line of Credit calculations with proper Canadian rules
      const locLimit = +document.getElementById('locLimit').value || 0;
      const locBalance = +document.getElementById('locBalance').value || 0;
      const helocLimit = +document.getElementById('helocLimit').value || 0;
      
      let locPayment = 0;
      let helocPayment = 0;
      
      // Unsecured LOC treatment
      if (locLimit < 50000) {
        // Under $50k: Use actual balance
        locPayment = locBalance * 0.03;
      } else {
        // $50k and over: Use full limit
        locPayment = locLimit * 0.03;
      }
      
      // HELOC treatment (secured, always use full limit)
      if (helocLimit > 0) {
        helocPayment = helocLimit * 0.03;
      }
      
      const totalDebtPayments = carPayment + creditCardPayment + studentLoan + locPayment + helocPayment;
      
      // Property details
      const qualPrice = +document.getElementById('qualPrice').value || 0;
      const qualDown = +document.getElementById('qualDown').value || 0;
      const qualRate = +document.getElementById('qualRate').value || 5.5;
      const qualTax = +document.getElementById('qualTax').value || 0;
      const qualHeat = +document.getElementById('qualHeat').value || 150;
      const qualCondo = +document.getElementById('qualCondo').value || 0;
      
      if (!totalIncome || !qualPrice) {
        alert('Please enter income and property details.');
        return;
      }
      
      // Calculate stress test rate
      const stressTestRate = Math.max(qualRate + 2, 5.25);
      const monthlyStressRate = stressTestRate / 100 / 12;
      
      // Calculate mortgage payment at stress test rate
      const mortgageAmount = qualPrice - qualDown;
      const term = 25 * 12;
      const stressPayment = mortgageAmount * (monthlyStressRate * Math.pow(1 + monthlyStressRate, term)) / (Math.pow(1 + monthlyStressRate, term) - 1);
      
      // Housing costs
      const monthlyTax = qualTax / 12;
      const totalHousingCosts = stressPayment + monthlyTax + qualHeat + qualCondo;
      
      // Calculate ratios
      const monthlyIncome = totalIncome / 12;
      const gds = (totalHousingCosts / monthlyIncome) * 100;
      const tds = ((totalHousingCosts + totalDebtPayments) / monthlyIncome) * 100;
      
      // Determine qualification status
      let qualified = false;
      let status = '';
      let message = '';
      let details = '';
      
      if (gds <= 32 && tds <= 40) {
        qualified = true;
        status = 'qualified';
        message = '‚úì Fully Qualified';
        details = 'You meet all standard qualification criteria with room to spare.';
      } else if (gds <= 39 && tds <= 44) {
        qualified = true;
        status = 'warning';
        message = '‚ö† Qualified with Conditions';
        details = 'You qualify but are at the upper limits. Strong credit and employment history required.';
      } else {
        qualified = false;
        status = 'failed';
        message = '‚úó Does Not Qualify';
        details = `GDS: ${gds.toFixed(1)}% (max 39%), TDS: ${tds.toFixed(1)}% (max 44%)`;
      }
      
      // Update UI
      const qualStatus = document.getElementById('qualStatus');
      qualStatus.className = 'qualification-status ' + status;
      document.getElementById('qualIcon').textContent = qualified ? '‚úì' : '‚úó';
      document.getElementById('qualMessage').textContent = message;
      document.getElementById('qualDetails').textContent = details;
      
      // Update ratio bars
      const gdsBar = document.getElementById('gdsBar');
      gdsBar.style.width = Math.min(gds, 100) + '%';
      gdsBar.className = 'ratio-fill ' + (gds <= 32 ? 'good' : gds <= 39 ? 'warning' : 'danger');
      document.getElementById('gdsValue').textContent = gds.toFixed(1) + '%';
      
      const tdsBar = document.getElementById('tdsBar');
      tdsBar.style.width = Math.min(tds, 100) + '%';
      tdsBar.className = 'ratio-fill ' + (tds <= 40 ? 'good' : tds <= 44 ? 'warning' : 'danger');
      document.getElementById('tdsValue').textContent = tds.toFixed(1) + '%';
      
      document.getElementById('stressTestRate').textContent = stressTestRate.toFixed(2) + '%';
      
      // Calculate maximum affordability
      const maxGDS = 0.39;
      const maxTDS = 0.44;
      
      const maxHousingFromGDS = (monthlyIncome * maxGDS);
      const maxHousingFromTDS = (monthlyIncome * maxTDS) - totalDebtPayments;
      const maxHousing = Math.min(maxHousingFromGDS, maxHousingFromTDS);
      
      const maxMortgagePayment = maxHousing - monthlyTax - qualHeat - qualCondo;
      
      let maxMortgage = 0;
      if (monthlyStressRate > 0) {
        maxMortgage = maxMortgagePayment * (Math.pow(1 + monthlyStressRate, term) - 1) / (monthlyStressRate * Math.pow(1 + monthlyStressRate, term));
      }
      
      const maxPurchase = maxMortgage + qualDown;
      const requiredIncome = totalHousingCosts / maxGDS * 12;
      
      document.getElementById('maxPurchase').textContent = money(maxPurchase);
      document.getElementById('maxMortgage').textContent = money(maxMortgage);
      document.getElementById('requiredIncome').textContent = money(requiredIncome);
      
      // Recommendations with LOC details
      let recommendations = '<h4>Recommendations:</h4><ul>';
      
      if (!qualified) {
        const incomeShortfall = requiredIncome - totalIncome;
        if (incomeShortfall > 0) {
          recommendations += `<li>Increase income by ${money(incomeShortfall)}/year</li>`;
        }
        if (totalDebtPayments > monthlyIncome * 0.10) {
          recommendations += `<li>Reduce monthly debt payments by ${money(totalDebtPayments - monthlyIncome * 0.10)}</li>`;
        }
        recommendations += `<li>Consider a less expensive property under ${money(maxPurchase)}</li>`;
      } else if (status === 'warning') {
        recommendations += '<li>Maintain excellent credit score (680+)</li>';
        recommendations += '<li>Ensure stable employment history (2+ years)</li>';
      }
      
      // LOC impact explanation
      if (locLimit > 0 || helocLimit > 0) {
        recommendations += '<li><strong>Line of Credit Impact:</strong><ul>';
        
        if (locLimit > 0) {
          if (locLimit < 50000) {
            recommendations += `<li>Unsecured LOC (${money(locLimit)} limit): Using balance of ${money(locBalance)} = ${money(locPayment)}/month</li>`;
          } else {
            recommendations += `<li>Unsecured LOC (${money(locLimit)} limit): Using full limit = ${money(locPayment)}/month (regardless of ${money(locBalance)} balance)</li>`;
            if (locBalance < locLimit * 0.5) {
              recommendations += `<li>üí° Consider reducing LOC limit to under $50,000 to save ${money((locLimit - 49000) * 0.03)}/month in qualification</li>`;
            }
          }
        }
        
        if (helocLimit > 0) {
          recommendations += `<li>HELOC (${money(helocLimit)} limit): Using full limit = ${money(helocPayment)}/month</li>`;
        }
        
        recommendations += '</ul></li>';
      }
      
      recommendations += '</ul>';
      document.getElementById('qualRecommendations').innerHTML = recommendations;
      
      document.getElementById('qualificationResults').style.display = 'block';
      
      gtag('event', 'qualification_analysis', {
        qualified: qualified,
        gds: gds,
        tds: tds
      });
    };

    // Stress Testing - ORIGINAL
    document.getElementById('runStressTest').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const currentRate = +document.getElementById('currentRate').value / 100 / 12;
      const stressRate = +document.getElementById('stressRate').value / 100 / 12;
      const renewalYears = +document.getElementById('renewalPeriod').value;
      
      const price = currentProperty.price;
      const downPayment = currentProperty.downPayment;
      const loanAmount = price - downPayment + currentProperty.cmhcInsurance;
      const term = currentProperty.term * 12;
      
      // Calculate payments at different rates
      const currentPayment = loanAmount * (currentRate * Math.pow(1 + currentRate, term)) / (Math.pow(1 + currentRate, term) - 1);
      const stressPayment = loanAmount * (stressRate * Math.pow(1 + stressRate, term)) / (Math.pow(1 + stressRate, term) - 1);
      
      const paymentIncrease = stressPayment - currentPayment;
      const newCashFlow = currentProperty.netCashFlow - paymentIncrease;
      
      document.getElementById('stressResults').innerHTML = `
        <div class="grid grid-2">
          <div class="metric">
            <div class="metric-value">${money(currentPayment)}</div>
            <div class="metric-label">Current Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--danger)">${money(stressPayment)}</div>
            <div class="metric-label">Stress Test Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--warning)">${money(paymentIncrease)}</div>
            <div class="metric-label">Monthly Increase</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:${newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(newCashFlow)}</div>
            <div class="metric-label">New Cash Flow</div>
          </div>
        </div>
        <div class="alert ${newCashFlow >= 0 ? 'alert-success' : 'alert-danger'}" style="margin-top:16px;">
          ${newCashFlow >= 0 ? 
            '<strong>‚úÖ Stress Test Passed:</strong> Property maintains positive cash flow even at higher rates.' :
            '<strong>‚ö†Ô∏è Stress Test Failed:</strong> Property would have negative cash flow at higher interest rates.'}
        </div>
      `;
      document.getElementById('stressResults').style.display = 'block';
    };

    // Rent Analysis - ORIGINAL
    document.getElementById('runRentAnalysis').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const annualIncrease = +document.getElementById('rentIncrease').value / 100;
      const years = +document.getElementById('projectionYears').value;
      const currentRent = currentProperty.monthlyRent;
      
      let projectionHTML = '<h4>Rent Growth Projection</h4><table class="comparison-table"><tr><th>Year</th><th>Monthly Rent</th><th>Annual Income</th><th>Cash Flow</th></tr>';
      
      for (let year = 0; year <= Math.min(years, 10); year++) {
        const projectedRent = currentRent * Math.pow(1 + annualIncrease, year);
        const annualIncome = projectedRent * 12;
        const projectedCashFlow = currentProperty.netCashFlow + (projectedRent - currentRent);
        
        projectionHTML += `<tr>
          <td>Year ${year}</td>
          <td>${money(projectedRent)}</td>
          <td>${money(annualIncome)}</td>
          <td style="color:${projectedCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(projectedCashFlow)}</td>
        </tr>`;
      }
      projectionHTML += '</table>';
      
      document.getElementById('rentResults').innerHTML = projectionHTML;
      document.getElementById('rentResults').style.display = 'block';
    };

    // Tab functionality - ORIGINAL
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
      };
    });

    // Comparison functionality - ORIGINAL
    document.getElementById('addProperty').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first, then come back to add it to comparison.');
        return;
      }
      showPage('calculator');
    };

    function updateComparisonTable() {
      const container = document.getElementById('comparisonContainer');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Add properties from the calculator to compare them side-by-side.</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Property</th>
              <th>Price</th>
              <th>Down Payment</th>
              <th>Monthly Rent</th>
              <th>Cash Flow</th>
              <th>Cap Rate</th>
              <th>Cash-on-Cash</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${savedProperties.map((prop, i) => `
              <tr>
                <td><strong>${prop.name}</strong></td>
                <td>${money(prop.price)}</td>
                <td>${money(prop.downPayment)}</td>
                <td>${money(prop.monthlyRent)}</td>
                <td style="color:${prop.netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(prop.netCashFlow)}</td>
                <td>${pct(prop.capRate)}</td>
                <td>${pct(prop.cashOnCash)}</td>
                <td>
                  <button class="btn-secondary btn-small" onclick="loadProperty(${i})">Edit</button>
                  <button class="btn-danger btn-small" onclick="deleteProperty(${i})">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    document.getElementById('clearComparison').onclick = () => {
      if (confirm('Clear all saved properties?')) {
        savedProperties = [];
        updateComparisonTable();
        updateSavedPropertiesList();
      }
    };

    // Reports functionality - ORIGINAL
    document.getElementById('generateSummary').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(`
        <html>
        <head>
          <title>Property Investment Report - ${currentProperty.name || 'Property Analysis'}</title>

  <script src="https://apis.google.com/js/api.js" async defer></script>
          <style>
            body{font-family:Arial,sans-serif;margin:40px;line-height:1.6}
            .header{text-align:center;border-bottom:2px solid #2ecc71;padding-bottom:20px;margin-bottom:30px}
            .metric-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:20px 0}
            .metric-box{border:1px solid #ddd;padding:15px;border-radius:8px;text-align:center}
            .positive{color:#2ecc71}.negative{color:#e74c3c}
            table{width:100%;border-collapse:collapse;margin:20px 0}
            th,td{padding:10px;border:1px solid #ddd;text-align:left}
            th{background:#f5f5f5}
          </style>
        </head>
        <body>
          <div class="header">
            <h1>üè† Property Investment Report</h1>
            <p>Generated on ${new Date().toLocaleDateString('en-CA')}</p>
            ${currentUser ? `<p>Prepared for: ${currentUser.name}</p>` : ''}
          </div>
          
          <h2>Property Overview</h2>
          <table>
            <tr><td>Purchase Price</td><td>${money(currentProperty.price)}</td></tr>
            <tr><td>Down Payment (${currentProperty.downPercent}%)</td><td>${money(currentProperty.downPayment)}</td></tr>
            <tr><td>CMHC Insurance</td><td>${money(currentProperty.cmhcInsurance)}</td></tr>
            <tr><td>Total Initial Investment</td><td><strong>${money(currentProperty.totalInitialInvestment)}</strong></td></tr>
          </table>
          
          <h2>Financial Performance</h2>
          <div class="metric-grid">
            <div class="metric-box">
              <h3>Monthly Cash Flow</h3>
              <div class="${currentProperty.netCashFlow >= 0 ? 'positive' : 'negative'}" style="font-size:1.5em;font-weight:bold">
                ${money(currentProperty.netCashFlow)}
              </div>
            </div>
            <div class="metric-box">
              <h3>Cap Rate</h3>
              <div style="font-size:1.5em;font-weight:bold">${pct(currentProperty.capRate)}</div>
            </div>
            <div class="metric-box">
              <h3>Cash-on-Cash Return</h3>
              <div style="font-size:1.5em;font-weight:bold">${pct(currentProperty.cashOnCash)}</div>
            </div>
            <div class="metric-box">
              <h3>Net Operating Income</h3>
              <div style="font-size:1.5em;font-weight:bold">${money(currentProperty.noi)}</div>
            </div>
          </div>
          
          <h2>Investment Recommendation</h2>
          <p><strong>Overall Assessment:</strong> ${
            currentProperty.netCashFlow >= 0 && currentProperty.capRate >= 4 && currentProperty.cashOnCash >= 8 ? 
            'Strong investment opportunity with positive cash flow and good returns.' :
            currentProperty.netCashFlow >= 0 ? 
            'Moderate investment with positive cash flow but lower returns.' :
            'Investment requires careful consideration due to negative cash flow.'
          }</p>
          
          <p style="font-size:12px;color:#666;margin-top:40px;">
            This report was generated by PropCheck. Please consult with a qualified financial advisor before making investment decisions.
          </p>
        </body>
        </html>
      `);
      reportWindow.print();
    };

    document.getElementById('portfolioReport').onclick = () => {
      if (savedProperties.length === 0) {
        alert('No saved properties to analyze. Save some properties first.');
        return;
      }
      
      const totalInvestment = savedProperties.reduce((sum, prop) => sum + prop.totalInitialInvestment, 0);
      const totalCashFlow = savedProperties.reduce((sum, prop) => sum + prop.netCashFlow, 0);
      const totalNOI = savedProperties.reduce((sum, prop) => sum + prop.noi, 0);
      const avgCapRate = savedProperties.reduce((sum, prop) => sum + prop.capRate, 0) / savedProperties.length;
      const portfolioCOC = totalInvestment ? (totalCashFlow * 12 / totalInvestment) * 100 : 0;
      
      alert(`Portfolio Summary:
      
Total Properties: ${savedProperties.length}
Total Investment: ${money(totalInvestment)}
Monthly Cash Flow: ${money(totalCashFlow)}
Annual NOI: ${money(totalNOI)}
Average Cap Rate: ${pct(avgCapRate)}
Portfolio Cash-on-Cash: ${pct(portfolioCOC)}`);
    };

    // Market data functionality - ORIGINAL
    document.getElementById('loadMarketData').onclick = () => {
      const city = document.getElementById('citySelect').value;
      const propType = document.getElementById('propertyType').value;
      
      // Simulate market data loading
      setTimeout(() => {
        alert(`Loading market data for ${city} ${propType} properties...`);
        gtag('event', 'load_market_data', {
          city: city,
          property_type: propType
        });
      }, 500);
    };

    // Expense breakdown for analysis page - ORIGINAL
    function updateExpenseBreakdown() {
      if (!currentProperty.price) {
        document.getElementById('expenseBreakdown').innerHTML = '<div class="alert alert-warning">Calculate a property first to see expense breakdown.</div>';
        return;
      }
      
      const monthlyTax = (currentProperty.annualTax || 0) / 12;
      const monthlyInsurance = (currentProperty.annualInsurance || 0) / 12;
      const managementFee = currentProperty.monthlyRent * (currentProperty.managementPercent || 0) / 100;
      const vacancyLoss = currentProperty.monthlyRent * (currentProperty.vacancyPercent || 0) / 100;
      const otherMonthly = currentProperty.otherMonthly || 0;
      
      const expenses = [
        {name: 'Mortgage Payment', amount: currentProperty.monthlyPayment, percent: 0},
        {name: 'Property Tax', amount: monthlyTax, percent: 0},
        {name: 'Insurance', amount: monthlyInsurance, percent: 0},
        {name: 'Management Fee', amount: managementFee, percent: currentProperty.managementPercent},
        {name: 'Vacancy Loss', amount: vacancyLoss, percent: currentProperty.vacancyPercent},
        {name: 'Other Expenses', amount: otherMonthly, percent: 0}
      ];
      
      const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      
      document.getElementById('expenseBreakdown').innerHTML = `
        <h4>Monthly Expense Breakdown</h4>
        <table class="comparison-table">
          <tr><th>Expense Category</th><th>Amount</th><th>% of Rent</th></tr>
          ${expenses.map(exp => `
            <tr>
              <td>${exp.name}</td>
              <td>${money(exp.amount)}</td>
              <td>${exp.percent ? pct(exp.percent) : pct((exp.amount / currentProperty.monthlyRent) * 100)}</td>
            </tr>
          `).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:bold;">
            <td>Total Expenses</td>
            <td>${money(totalExpenses)}</td>
            <td>${pct((totalExpenses / currentProperty.monthlyRent) * 100)}</td>
          </tr>
        </table>
        
        <div class="alert ${(totalExpenses / currentProperty.monthlyRent) < 0.75 ? 'alert-success' : 'alert-warning'}">
          <strong>Expense Ratio Analysis:</strong> 
          ${(totalExpenses / currentProperty.monthlyRent) < 0.75 ? 
            'Your expense ratio is healthy at under 75% of rental income.' :
            'Consider reducing expenses - current ratio is above recommended 75% threshold.'}
        </div>
      `;
    }

    // Update expense breakdown when switching to analysis page
    document.querySelector('[data-page="analysis"]').addEventListener('click', () => {
      setTimeout(updateExpenseBreakdown, 100);
    });

    // Update comparison table when switching to compare page  
    document.querySelector('[data-page="compare"]').addEventListener('click', () => {
      setTimeout(updateComparisonTable, 100);
    });

    // Update saved properties when switching to reports page
    document.querySelector('[data-page="reports"]').addEventListener('click', () => {
      setTimeout(updateSavedPropertiesList, 100);
    });

    // PWA functionality - ORIGINAL
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    
    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display='none';
          gtag('event', 'pwa_install');
        }
        deferredPrompt = null;
      }
    };

    // Initialize AdSense ads on page load
    window.addEventListener('load', () => {
      (adsbygoogle = window.adsbygoogle || []).push({});
    });
  </script>
</body>
</html>

</body>
</html>
