<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Canadian Real Estate Investment Tool</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FuYWRpYW4gUmVhbCBFc3RhdGUgVG9vbCIsInNob3J0X25hbWUiOiJSRSBUb29sIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmNWY1ZjUiLCJ0aGVtZV9jb2xvciI6IiMyZWNjNzEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0In0=">
    <meta name="theme-color" content="#2ecc71">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --primary-light: #a8e6cf;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --background: #f8f9fa;
            --surface: #ffffff;
            --surface-light: #f5f7fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border: #e0e6ed;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            min-height: 100vh;
            background: var(--background);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }

        .login-title {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Header */
        .app-header {
            background: var(--surface);
            box-shadow: var(--shadow);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            padding: 10px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs-inner {
            display: flex;
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 10px;
        }

        .nav-tab {
            background: var(--surface-light);
            border: 2px solid transparent;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        /* Content */
        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--surface-light);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-full {
            width: 100%;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Results */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .result-value {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary);
        }

        /* Property List */
        .property-item {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .property-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .property-address {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .property-type {
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--primary-light);
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .property-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* Alert Box */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs-inner {
                padding: 0 5px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .property-metrics {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .metric {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }
        }

        /* Hide scrollbar for nav-tabs */
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen page active">
            <div class="login-card">
                <div class="logo">🏠</div>
                <h1 class="login-title">Real Estate Calculator</h1>
                <p class="login-subtitle">Professional mortgage & investment analysis tool</p>
                
                <button class="btn btn-full" id="guestBtn" style="margin-bottom: 15px;">
                    Continue as Guest
                </button>
                
                <button class="btn btn-outline btn-full" id="googleBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="page">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <div class="app-title">
                        <span>🏠</span>
                        <span>RE Calculator</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="userName">Guest User</span>
                        <button class="btn" id="signOutBtn">Sign Out</button>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="nav-tabs">
                <div class="nav-tabs-inner">
                    <button class="nav-tab active" data-page="dashboard">Dashboard</button>
                    <button class="nav-tab" data-page="mortgage">Mortgage</button>
                    <button class="nav-tab" data-page="analysis">Analysis</button>
                    <button class="nav-tab" data-page="portfolio">Portfolio</button>
                    <button class="nav-tab" data-page="settings">Settings</button>
                </div>
            </nav>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statProperties">0</div>
                            <div class="stat-label">Properties</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statInvestment">$0</div>
                            <div class="stat-label">Investment</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCashflow">$0</div>
                            <div class="stat-label">Cash Flow</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statROI">0%</div>
                            <div class="stat-label">Avg ROI</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">💰 Quick Mortgage Calculator</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Purchase Price ($)</label>
                                <input type="number" id="quickPrice" placeholder="500000" value="500000">
                            </div>
                            <div class="form-group">
                                <label>Down Payment (%)</label>
                                <input type="number" id="quickDown" placeholder="20" value="20">
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (%)</label>
                                <input type="number" id="quickRate" step="0.01" placeholder="5.25" value="5.25">
                            </div>
                        </div>
                        <button class="btn btn-full" id="quickCalcBtn">Calculate Payment</button>
                        
                        <div id="quickResult" style="margin-top: 20px; display: none;">
                            <div class="result-row">
                                <span class="result-label">Monthly Payment</span>
                                <span class="result-value" id="quickPayment">$0</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">Total Mortgage</span>
                                <span class="result-value" id="quickMortgage">$0</span>
                            </div>
                        </div>
                    </div>

                    <!-- AdSense Ad Unit - Dashboard -->
                    <div class="card" style="background: transparent; box-shadow: none; border: none; padding: 10px;">
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-6166342215834701"
                             data-ad-slot="YOUR-AD-SLOT-ID-1"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>

                    <div class="card">
                        <h2 class="card-title">📊 Recent Properties</h2>
                        <div id="recentProperties">
                            <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No properties saved yet. Add your first property in the Analysis tab!</p>
                        </div>
                    </div>
                </div>

                <!-- Mortgage Calculator Page -->
                <div id="mortgage" class="page">
                    <div class="card">
                        <h2 class="card-title">🏦 Advanced Mortgage Calculator</h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Purchase Price ($)</label>
                                <input type="number" id="purchasePrice" placeholder="500000" value="500000">
                            </div>
                            <div class="form-group">
                                <label>Down Payment (%)</label>
                                <input type="number" id="downPayment" placeholder="20" min="5" max="100" value="20">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Interest Rate (%)</label>
                                <input type="number" id="interestRate" step="0.01" placeholder="5.25" value="5.25">
                            </div>
                            <div class="form-group">
                                <label>Amortization Period</label>
                                <select id="amortization">
                                    <option value="25">25 years</option>
                                    <option value="30">30 years</option>
                                    <option value="20">20 years</option>
                                    <option value="15">15 years</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Annual Property Tax ($)</label>
                                <input type="number" id="propertyTax" placeholder="6000" value="6000">
                            </div>
                            <div class="form-group">
                                <label>Annual Insurance ($)</label>
                                <input type="number" id="insurance" placeholder="1500" value="1500">
                            </div>
                        </div>
                        
                        <button class="btn btn-full" id="mortgageCalcBtn">Calculate Mortgage</button>
                    </div>
                    
                    <div id="mortgageResults" class="card" style="display: none;">
                        <h2 class="card-title">📈 Payment Breakdown</h2>
                        <div id="mortgageResultsContent"></div>
                        <div class="chart-container">
                            <canvas id="mortgageChart"></canvas>
                        </div>
                    </div>

                    <!-- AdSense Ad Unit - Mortgage -->
                    <div id="mortgageAd" class="card" style="background: transparent; box-shadow: none; border: none; padding: 10px; display: none;">
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-6166342215834701"
                             data-ad-slot="YOUR-AD-SLOT-ID-2"
                             data-ad-format="rectangle"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- Analysis Page -->
                <div id="analysis" class="page">
                    <div class="card">
                        <h2 class="card-title">🔍 Property Analysis</h2>
                        
                        <div class="form-group">
                            <label>Property Address</label>
                            <input type="text" id="propertyAddress" placeholder="123 Main Street, Toronto, ON">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Property Type</label>
                                <select id="propertyType">
                                    <option value="Single Family">Single Family</option>
                                    <option value="Condo">Condominium</option>
                                    <option value="Townhouse">Townhouse</option>
                                    <option value="Duplex">Duplex</option>
                                    <option value="Triplex">Triplex</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Purchase Price ($)</label>
                                <input type="number" id="analysisPrice" placeholder="500000" value="500000">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Rental Income ($)</label>
                                <input type="number" id="monthlyRent" placeholder="3000" value="3000">
                            </div>
                            <div class="form-group">
                                <label>Monthly Expenses ($)</label>
                                <input type="number" id="monthlyExpenses" placeholder="500" value="500">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Property Management (%)</label>
                                <input type="number" id="managementFee" placeholder="10" value="10">
                            </div>
                            <div class="form-group">
                                <label>Vacancy Rate (%)</label>
                                <input type="number" id="vacancyRate" placeholder="5" value="5">
                            </div>
                        </div>
                        
                        <button class="btn btn-full" id="analyzeBtn">Analyze Property</button>
                    </div>
                    
                    <div id="analysisResults" class="card" style="display: none;">
                        <h2 class="card-title">📊 Analysis Results</h2>
                        <div id="analysisContent"></div>
                        <button class="btn btn-secondary btn-full" id="savePropertyBtn" style="margin-top: 20px;">Save This Property</button>
                    </div>

                    <!-- AdSense Ad Unit - Analysis -->
                    <div id="analysisAd" class="card" style="background: transparent; box-shadow: none; border: none; padding: 10px; display: none;">
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-6166342215834701"
                             data-ad-slot="YOUR-AD-SLOT-ID-3"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- Portfolio Page -->
                <div id="portfolio" class="page">
                    <div class="card">
                        <h2 class="card-title">📁 My Portfolio</h2>
                        <div id="portfolioList">
                            <p style="color: var(--text-secondary); text-align: center; padding: 40px;">Your portfolio is empty. Analyze and save properties to build your portfolio!</p>
                        </div>
                    </div>

                    <!-- AdSense Ad Unit - Portfolio -->
                    <div class="card" style="background: transparent; box-shadow: none; border: none; padding: 10px;">
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-6166342215834701"
                             data-ad-slot="YOUR-AD-SLOT-ID-4"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings" class="page">
                    <div class="card">
                        <h2 class="card-title">⚙️ Settings</h2>
                        
                        <div class="form-group">
                            <label>Default Interest Rate (%)</label>
                            <input type="number" id="defaultRate" step="0.01" value="5.25">
                        </div>
                        
                        <div class="form-group">
                            <label>Default Down Payment (%)</label>
                            <input type="number" id="defaultDown" value="20">
                        </div>
                        
                        <div class="form-group">
                            <label>Default Amortization (years)</label>
                            <select id="defaultAmortization">
                                <option value="25">25 years</option>
                                <option value="30">30 years</option>
                                <option value="20">20 years</option>
                                <option value="15">15 years</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-full" id="saveSettingsBtn">Save Settings</button>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">👤 Account</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Signed in as: <strong id="userEmail">guest@local</strong>
                        </p>
                        <button class="btn btn-danger btn-full" id="clearDataBtn">Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let properties = [];
        let settings = {
            defaultRate: 5.25,
            defaultDown: 20,
            defaultAmortization: 25
        };
        let mortgageChart = null;
        let currentAnalysis = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Load saved data
            loadData();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function setupEventListeners() {
            // Login buttons
            const guestBtn = document.getElementById('guestBtn');
            const googleBtn = document.getElementById('googleBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            
            if (guestBtn) {
                guestBtn.addEventListener('click', continueAsGuest);
            }
            
            if (googleBtn) {
                googleBtn.addEventListener('click', signInWithGoogle);
            }
            
            if (signOutBtn) {
                signOutBtn.addEventListener('click', signOut);
            }
            
            // Navigation tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    if (pageId) {
                        showPage(pageId, this);
                    }
                });
            });
            
            // Calculator buttons
            const quickCalcBtn = document.getElementById('quickCalcBtn');
            if (quickCalcBtn) {
                quickCalcBtn.addEventListener('click', quickCalculate);
            }
            
            const mortgageCalcBtn = document.getElementById('mortgageCalcBtn');
            if (mortgageCalcBtn) {
                mortgageCalcBtn.addEventListener('click', calculateMortgage);
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', analyzeProperty);
            }
            
            const savePropertyBtn = document.getElementById('savePropertyBtn');
            if (savePropertyBtn) {
                savePropertyBtn.addEventListener('click', saveProperty);
            }
            
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
            
            const clearDataBtn = document.getElementById('clearDataBtn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', clearAllData);
            }
        }

        // Authentication Functions
        function signInWithGoogle() {
            // Simulate Google Sign-In
            currentUser = {
                name: 'Google User',
                email: 'user@gmail.com',
                isGuest: false
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
        }

        function continueAsGuest() {
            currentUser = {
                name: 'Guest User',
                email: 'guest@local',
                isGuest: true
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Reset to login screen
                document.getElementById('loginScreen').classList.add('active');
                document.getElementById('mainApp').classList.remove('active');
                
                // Reset all pages
                document.querySelectorAll('.page').forEach(page => {
                    if (page.id !== 'loginScreen') {
                        page.classList.remove('active');
                    }
                });
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('dashboard').classList.add('active');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            // Load settings
            applySettings();
            
            // Update dashboard
            updateDashboard();
        }

        // Navigation
        function showPage(pageId, tabElement) {
            // Hide all pages
            document.querySelectorAll('.content .page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            tabElement.classList.add('active');
            
            // Update content based on page
            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'portfolio') {
                displayPortfolio();
            }
        }

        // Quick Calculator
        function quickCalculate() {
            const price = parseFloat(document.getElementById('quickPrice').value) || 0;
            const downPercent = parseFloat(document.getElementById('quickDown').value) || 20;
            const rate = parseFloat(document.getElementById('quickRate').value) || 5.25;
            
            if (price === 0) {
                alert('Please enter a purchase price');
                return;
            }
            
            const downPayment = price * (downPercent / 100);
            const principal = price - downPayment;
            
            // Calculate CMHC if needed
            let cmhcRate = 0;
            if (downPercent < 20) {
                if (downPercent >= 15) cmhcRate = 2.8;
                else if (downPercent >= 10) cmhcRate = 3.1;
                else cmhcRate = 4.0;
            }
            
            const cmhcAmount = principal * (cmhcRate / 100);
            const totalMortgage = principal + cmhcAmount;
            
            const monthlyRate = rate / 100 / 12;
            const numPayments = 25 * 12;
            
            const payment = totalMortgage * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                           (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            document.getElementById('quickPayment').textContent = ' + payment.toFixed(2);
            document.getElementById('quickMortgage').textContent = ' + totalMortgage.toLocaleString();
            document.getElementById('quickResult').style.display = 'block';
        }

        // Mortgage Calculator
        function calculateMortgage() {
            const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const downPercent = parseFloat(document.getElementById('downPayment').value) || 20;
            const rate = parseFloat(document.getElementById('interestRate').value) || 5.25;
            const years = parseInt(document.getElementById('amortization').value) || 25;
            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            
            if (price === 0) {
                alert('Please enter a purchase price');
                return;
            }
            
            const downPayment = price * (downPercent / 100);
            const principal = price - downPayment;
            
            // Calculate CMHC
            let cmhcRate = 0;
            if (downPercent < 20) {
                if (downPercent >= 15) cmhcRate = 2.8;
                else if (downPercent >= 10) cmhcRate = 3.1;
                else cmhcRate = 4.0;
            }
            
            const cmhcAmount = principal * (cmhcRate / 100);
            const totalLoan = principal + cmhcAmount;
            
            const monthlyRate = rate / 100 / 12;
            const numPayments = years * 12;
            
            const payment = totalLoan * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                           (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            const monthlyTax = propertyTax / 12;
            const monthlyInsurance = insurance / 12;
            const totalPayment = payment + monthlyTax + monthlyInsurance;
            
            // Calculate total interest
            const totalInterest = (payment * numPayments) - totalLoan;
            
            // Display results
            const resultsHTML = `
                <div class="result-row">
                    <span class="result-label">Purchase Price</span>
                    <span class="result-value">${price.toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Down Payment (${downPercent}%)</span>
                    <span class="result-value">${downPayment.toLocaleString()}</span>
                </div>
                ${cmhcAmount > 0 ? `
                <div class="result-row">
                    <span class="result-label">CMHC Insurance</span>
                    <span class="result-value">${cmhcAmount.toLocaleString()}</span>
                </div>` : ''}
                <div class="result-row">
                    <span class="result-label">Total Mortgage</span>
                    <span class="result-value">${totalLoan.toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Monthly Principal & Interest</span>
                    <span class="result-value">${payment.toFixed(2)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Monthly Property Tax</span>
                    <span class="result-value">${monthlyTax.toFixed(2)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Monthly Insurance</span>
                    <span class="result-value">${monthlyInsurance.toFixed(2)}</span>
                </div>
                <div class="result-row" style="background: var(--primary-light); padding: 10px; border-radius: 8px; margin-top: 10px;">
                    <span class="result-label"><strong>Total Monthly Payment</strong></span>
                    <span class="result-value"><strong>${totalPayment.toFixed(2)}</strong></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Interest Paid</span>
                    <span class="result-value">${totalInterest.toLocaleString()}</span>
                </div>
            `;
            
            document.getElementById('mortgageResultsContent').innerHTML = resultsHTML;
            document.getElementById('mortgageResults').style.display = 'block';
            document.getElementById('mortgageAd').style.display = 'block';
            
            // Create chart
            createMortgageChart(payment, monthlyTax, monthlyInsurance);
        }

        function createMortgageChart(payment, tax, insurance) {
            const ctx = document.getElementById('mortgageChart').getContext('2d');
            
            if (mortgageChart) {
                mortgageChart.destroy();
            }
            
            mortgageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Principal & Interest', 'Property Tax', 'Insurance'],
                    datasets: [{
                        data: [payment, tax, insurance],
                        backgroundColor: ['#2ecc71', '#3498db', '#f39c12'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ':  + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Property Analysis
        function analyzeProperty() {
            const address = document.getElementById('propertyAddress').value.trim();
            const type = document.getElementById('propertyType').value;
            const price = parseFloat(document.getElementById('analysisPrice').value) || 0;
            const rent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const expenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
            const managementFee = parseFloat(document.getElementById('managementFee').value) || 0;
            const vacancy = parseFloat(document.getElementById('vacancyRate').value) || 5;
            
            if (!address || price === 0 || rent === 0) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Calculate metrics
            const managementCost = rent * (managementFee / 100);
            const effectiveRent = rent * (1 - vacancy / 100);
            const totalExpenses = expenses + managementCost;
            const netOperatingIncome = (effectiveRent - totalExpenses) * 12;
            const cashFlow = effectiveRent - totalExpenses;
            const capRate = (netOperatingIncome / price) * 100;
            const cashOnCash = (netOperatingIncome / (price * 0.2)) * 100; // Assuming 20% down
            const rentToPrice = (rent / price) * 100;
            
            // Store current analysis
            currentAnalysis = {
                address,
                type,
                price,
                rent,
                expenses,
                managementFee,
                vacancy,
                cashFlow,
                capRate,
                cashOnCash,
                noi: netOperatingIncome
            };
            
            const resultsHTML = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${cashFlow.toFixed(0)}</div>
                        <div class="stat-label">Monthly Cash Flow</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${capRate.toFixed(2)}%</div>
                        <div class="stat-label">Cap Rate</div>
                    </div>
                </div>
                
                <div class="result-row">
                    <span class="result-label">Effective Monthly Rent (after vacancy)</span>
                    <span class="result-value">${effectiveRent.toFixed(2)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Monthly Expenses</span>
                    <span class="result-value">${totalExpenses.toFixed(2)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Annual Net Operating Income</span>
                    <span class="result-value">${netOperatingIncome.toFixed(2)}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Cash-on-Cash Return</span>
                    <span class="result-value">${cashOnCash.toFixed(2)}%</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Rent-to-Price Ratio</span>
                    <span class="result-value">${rentToPrice.toFixed(3)}%</span>
                </div>
                
                ${capRate >= 6 ? 
                    '<div class="alert alert-success">✅ This property shows strong investment potential!</div>' :
                    '<div class="alert alert-error">⚠️ This property may have limited cash flow potential.</div>'
                }
            `;
            
            document.getElementById('analysisContent').innerHTML = resultsHTML;
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('analysisAd').style.display = 'block';
        }

        function saveProperty() {
            if (!currentAnalysis) {
                alert('Please analyze a property first');
                return;
            }
            
            const property = {
                ...currentAnalysis,
                id: Date.now(),
                savedDate: new Date().toISOString()
            };
            
            properties.push(property);
            saveData();
            alert('Property saved successfully!');
            updateDashboard();
        }

        // Portfolio Management
        function displayPortfolio() {
            const portfolioList = document.getElementById('portfolioList');
            
            if (properties.length === 0) {
                portfolioList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Your portfolio is empty. Analyze and save properties to build your portfolio!</p>';
                return;
            }
            
            let html = '';
            properties.forEach(property => {
                html += `
                    <div class="property-item">
                        <div class="property-header">
                            <div>
                                <div class="property-address">${property.address}</div>
                                <span class="property-type">${property.type}</span>
                            </div>
                            <button class="btn btn-danger" data-property-id="${property.id}" style="padding: 5px 15px; font-size: 12px;">Delete</button>
                        </div>
                        <div class="property-metrics">
                            <div class="metric">
                                <div class="metric-value">${property.price.toLocaleString()}</div>
                                <div class="metric-label">Price</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${property.cashFlow.toFixed(0)}</div>
                                <div class="metric-label">Cash Flow/mo</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${property.capRate.toFixed(2)}%</div>
                                <div class="metric-label">Cap Rate</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            portfolioList.innerHTML = html;
            
            // Add event listeners to delete buttons
            const deleteButtons = portfolioList.querySelectorAll('[data-property-id]');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const propertyId = parseInt(this.getAttribute('data-property-id'));
                    deleteProperty(propertyId);
                });
            });
        }

        function deleteProperty(id) {
            if (confirm('Are you sure you want to delete this property?')) {
                properties = properties.filter(p => p.id !== id);
                saveData();
                displayPortfolio();
                updateDashboard();
            }
        }

        // Dashboard
        function updateDashboard() {
            const totalProperties = properties.length;
            const totalInvestment = properties.reduce((sum, p) => sum + p.price, 0);
            const totalCashFlow = properties.reduce((sum, p) => sum + p.cashFlow, 0);
            const avgROI = totalProperties > 0 ? 
                properties.reduce((sum, p) => sum + p.cashOnCash, 0) / totalProperties : 0;
            
            document.getElementById('statProperties').textContent = totalProperties;
            document.getElementById('statInvestment').textContent = 
                totalInvestment > 0 ? ' + (totalInvestment / 1000000).toFixed(2) + 'M' : '$0';
            document.getElementById('statCashflow').textContent = 
                ' + totalCashFlow.toFixed(0);
            document.getElementById('statROI').textContent = 
                avgROI.toFixed(1) + '%';
            
            // Recent properties
            const recentProps = document.getElementById('recentProperties');
            if (properties.length === 0) {
                recentProps.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No properties saved yet. Add your first property in the Analysis tab!</p>';
            } else {
                let html = '';
                properties.slice(-3).reverse().forEach(property => {
                    html += `
                        <div class="property-item">
                            <div class="property-address">${property.address}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <span class="property-type">${property.type}</span>
                                <span style="color: var(--primary); font-weight: 600;">${property.cashFlow.toFixed(0)}/mo</span>
                            </div>
                        </div>
                    `;
                });
                recentProps.innerHTML = html;
            }
        }

        // Settings
        function saveSettings() {
            settings.defaultRate = parseFloat(document.getElementById('defaultRate').value) || 5.25;
            settings.defaultDown = parseFloat(document.getElementById('defaultDown').value) || 20;
            settings.defaultAmortization = parseInt(document.getElementById('defaultAmortization').value) || 25;
            
            localStorage.setItem('settings', JSON.stringify(settings));
            applySettings();
            alert('Settings saved successfully!');
        }

        function applySettings() {
            // Apply to quick calculator
            document.getElementById('quickRate').value = settings.defaultRate;
            document.getElementById('quickDown').value = settings.defaultDown;
            
            // Apply to mortgage calculator
            document.getElementById('interestRate').value = settings.defaultRate;
            document.getElementById('downPayment').value = settings.defaultDown;
            document.getElementById('amortization').value = settings.defaultAmortization;
            
            // Apply to settings page
            document.getElementById('defaultRate').value = settings.defaultRate;
            document.getElementById('defaultDown').value = settings.defaultDown;
            document.getElementById('defaultAmortization').value = settings.defaultAmortization;
        }

        // Data Management
        function saveData() {
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function loadData() {
            // Load properties
            const savedProperties = localStorage.getItem('properties');
            if (savedProperties) {
                properties = JSON.parse(savedProperties);
            }
            
            // Load settings
            const savedSettings = localStorage.getItem('settings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
        }

        function clearAllData() {
            if (confirm('This will delete all your saved properties and settings. Are you sure?')) {
                properties = [];
                localStorage.removeItem('properties');
                localStorage.removeItem('settings');
                localStorage.removeItem('currentUser');
                alert('All data has been cleared');
                location.reload();
            }
        }
    </script>
</body>
</html>