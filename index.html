<!DOCTYPE html>
<html>
<head>
  <title>Drive Test</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <h1>Google Drive Integration Test</h1>
  
  <div id="g_button_target"></div>
  
  <div id="g_id_onload"
       data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       style="display:none;"></div>
  
  <div id="status" style="margin:20px 0;padding:10px;background:#f0f0f0;"></div>
  
  <button id="testDrive" style="display:none;padding:10px;">Test Drive Access</button>

  <script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCNEg2v7riXUZ_UdjqpkGT56wzMkw-gRxs';
    let accessToken = null;
    
    function log(msg) {
      document.getElementById('status').innerHTML += msg + '<br>';
      console.log(msg);
    }
    
    function handleCredentialResponse(response) {
      log('✓ Signed in with Google');
      document.getElementById('testDrive').style.display = 'block';
    }
    
    window.handleCredentialResponse = handleCredentialResponse;
    
    window.onload = function() {
      setTimeout(() => {
        if (google?.accounts?.id) {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
          });
          
          google.accounts.id.renderButton(
            document.getElementById('g_button_target'),
            {theme: 'outline', size: 'large'}
          );
          log('✓ Google Sign-In ready');
        }
      }, 500);
    };
    
    document.getElementById('testDrive').onclick = async function() {
      log('Loading Drive API...');
      
      // Load GAPI
      await new Promise((resolve) => {
        gapi.load('client', resolve);
      });
      
      // Initialize GAPI
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
      });
      
      log('✓ Drive API loaded');
      
      // Request OAuth token
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: async (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          gapi.client.setToken({access_token: accessToken});
          log('✓ Got Drive access token');
          
          // Try to create folder
          try {
            log('Creating PropCheck folder...');
            
            const folderResponse = await gapi.client.drive.files.create({
              resource: {
                name: 'PropCheck',
                mimeType: 'application/vnd.google-apps.folder'
              },
              fields: 'id,name'
            });
            
            log('✓ Created folder with ID: ' + folderResponse.result.id);
            
            // Create test file in folder
            log('Creating test file...');
            
            const metadata = {
              name: 'test.json',
              parents: [folderResponse.result.id],
              mimeType: 'application/json'
            };
            
            const content = JSON.stringify({test: true, date: new Date()});
            
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            const multipartRequestBody =
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              content +
              close_delim;
            
            const fileResponse = await gapi.client.request({
              path: '/upload/drive/v3/files',
              method: 'POST',
              params: {uploadType: 'multipart'},
              headers: {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
              body: multipartRequestBody
            });
            
            log('✓ Created file with ID: ' + fileResponse.result.id);
            log('SUCCESS! Check your Google Drive for PropCheck folder');
            
          } catch (error) {
            log('✗ Error: ' + error.message);
            console.error(error);
          }
        }
      });
      
      tokenClient.requestAccessToken();
    };
  </script>
</body>
</html>