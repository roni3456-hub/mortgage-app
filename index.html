<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck ‚Äì RE Calculator & Underwriting Tool</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    /* Keeping all your CSS as-is */
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <main id="loginScreen" class="center-screen">
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
      <div class="login-card">
        <h1>üè† PropCheck</h1>
        <div class="subtitle">Fast Canadian property underwriting for real estate investors</div>
        
        <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
        
        <div style="margin:16px 0;color:var(--muted);font-size:14px;">or</div>
        
        <!-- Google Sign-In Button Container -->
        <div id="g_button_target" style="margin-top:10px;min-height:44px;"></div>
        
        <!-- Hidden elements for Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"></div>
      </div>
      
      <!-- PWA Install Button Below White Box -->
      <div style="margin-top:32px;text-align:center;">
        <button id="homeInstallBtn" class="btn btn-primary" style="font-size:18px;padding:16px 32px;background:var(--brand);border:none;box-shadow:0 4px 12px rgba(46,204,113,0.3);">
          üì± Download App
        </button>
        <div style="color:rgba(255,255,255,0.8);margin-top:8px;font-size:14px;">
          Install PropCheck for offline access
        </div>
      </div>
    </div>
  </main>

  <!-- MAIN APP -->
  <div id="mainApp" style="display:none;">
    <!-- (Keeping rest of your main app HTML as-is) -->
  </div>

  <script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    
    // Global state
    let currentProperty = {};
    let savedProperties = [];
    let currentUser = null;

    // Login functionality
    guestButton.onclick = () => { 
      loginScreen.style.display='none'; 
      mainApp.style.display='block';
      gtag('event', 'login', {method: 'guest'});
    };

    // Homepage PWA install button
    document.getElementById('homeInstallBtn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          gtag('event', 'pwa_install', {source: 'homepage'});
        }
        deferredPrompt = null;
      } else {
        alert('To install this app:\n\niOS: Tap Share ‚Üí Add to Home Screen\nAndroid: Tap menu ‚Üí Add to Home Screen\nDesktop: Look for install icon in address bar');
      }
    };

    function parseJwt(token){
      try{
        const base64Url=token.split('.')[1];
        const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
        const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }catch(e){return null;}
    }

    function handleCredentialResponse(response){
      const payload = parseJwt(response.credential);
      if(!payload) return;
      
      currentUser = payload;
      loginScreen.style.display='none';
      mainApp.style.display='block';
      userArea.style.display='flex';
      userAvatar.src = payload.picture || '';
      userName.textContent = payload.name;
      userEmail.textContent = payload.email;
      gtag('event', 'login', {method: 'google'});
    }
    window.handleCredentialResponse = handleCredentialResponse;

    window.onload = function(){
      function initGoogleSignIn() {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
          });

          google.accounts.id.renderButton(
            document.getElementById('g_button_target'),
            {
              theme: 'outline',
              size: 'large',
              width: 280,
              text: 'signin_with',
              shape: 'rectangular'
            }
          );
        } else {
          setTimeout(initGoogleSignIn, 300);
        }
      }

      initGoogleSignIn();

      (adsbygoogle = window.adsbygoogle || []).push({});
    }

    signOut.onclick=()=>{
      google.accounts.id.disableAutoSelect();
      userArea.style.display='none';
      loginScreen.style.display='flex';
      mainApp.style.display='none';
      currentUser = null;
      gtag('event', 'logout');
    };

    // (Keeping rest of your JavaScript code as-is)
  </script>
</body>
</html>
