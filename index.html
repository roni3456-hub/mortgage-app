<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PropCheck ‚Äì RE Calculator & Underwriting Tool</title>

  <!-- Tailwind CSS & JS PDF & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .brand-color {
      color: #2ecc71;
    }

    .bg-brand {
      background-color: #2ecc71;
    }

    .hover\:bg-brand-dark:hover {
      background-color: #27ae60;
    }

    #app-container.loading {
      display: none;
    }

    #loading-spinner {
      display: flex;
    }

    #loading-spinner.hidden {
      display: none;
    }

    .mobile-nav-item {
      @apply flex flex-col items-center p-2 rounded-lg text-gray-500 hover:bg-gray-100 transition-colors duration-200;
    }

    .mobile-nav-item.active {
      @apply text-gray-800 bg-gray-100 font-medium;
    }
  </style>
</head>

<body class="h-full bg-gray-50">
  <!-- Loading Spinner -->
  <div id="loading-spinner" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-brand-color"></div>
  </div>

  <!-- Main App Container -->
  <div id="app-container" class="min-h-full flex flex-col loading">
    <!-- Navbar -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center">
          <a href="#" class="flex-shrink-0 text-2xl font-bold text-gray-800">PropCheck</a>
        </div>
        <div class="flex items-center space-x-4">
          <span id="userIdDisplay" class="text-sm text-gray-500 hidden sm:block"></span>
          <button id="googleSignInBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-full font-medium hover:bg-gray-300 transition-colors duration-200 shadow-md hidden">Sign in with Google</button>
        </div>
      </nav>
      <div class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex space-x-4">
          <button id="navAddProperty" data-page="add" class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">Add Property</button>
          <button id="navAnalysis" data-page="analysis" class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">Analysis</button>
          <button id="navCompare" data-page="compare" class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">Compare</button>
          <button id="navMarketData" data-page="market" class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">Market Data</button>
          <button id="navSavedProperties" data-page="saved" class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">Saved Properties</button>
        </div>
      </div>
    </header>

    <main class="flex-1">
      <div id="page-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Page content will be injected here -->
      </div>
    </main>

    <!-- Mobile Navigation Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg sm:hidden">
      <div class="flex justify-around py-2">
        <button class="mobile-nav-item active" data-page="add">
          <div>üè†</div>
          <div class="text-xs">Add</div>
        </button>
        <button class="mobile-nav-item" data-page="analysis">
          <div>üìä</div>
          <div class="text-xs">Analysis</div>
        </button>
        <button class="mobile-nav-item" data-page="compare">
          <div>‚öñÔ∏è</div>
          <div class="text-xs">Compare</div>
        </button>
        <button class="mobile-nav-item" data-page="market">
          <div>üó∫Ô∏è</div>
          <div class="text-xs">Market</div>
        </button>
        <button class="mobile-nav-item" data-page="saved">
          <div>üíæ</div>
          <div class="text-xs">Saved</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Alert/Modal Box -->
  <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-80">
      <h3 id="modalTitle" class="text-lg font-bold text-gray-800"></h3>
      <p id="modalMessage" class="mt-2 text-sm text-gray-600"></p>
      <div class="mt-4 flex justify-end">
        <button id="modalOkBtn" class="bg-brand text-white px-4 py-2 rounded-full font-medium hover:bg-brand-dark">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, auth, db, userId;

    const appContainer = document.getElementById('app-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const pageContent = document.getElementById('page-content');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalOkBtn = document.getElementById('modalOkBtn');
    const googleSignInBtn = document.getElementById('googleSignInBtn');

    // Page navigation buttons
    const navButtons = document.querySelectorAll('nav button, .mobile-nav-item');

    /**
     * Replaces alert() with a custom modal box.
     * @param {string} title - The title of the modal.
     * @param {string} message - The message content.
     */
    function showAlert(title, message) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.classList.remove('hidden');
    }

    modalOkBtn.onclick = () => {
      modal.classList.add('hidden');
    };

    let savedProperties = [];

    function money(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function pct(rate) {
      return (rate * 100).toFixed(2) + '%';
    }

    /**
     * Renders the "Add Property" page.
     */
    function renderAddPropertyPage() {
      pageContent.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800">Add New Property</h2>
          <form id="property-form" class="mt-4 space-y-4">
            <div>
              <label for="address" class="block text-sm font-medium text-gray-700">Property Address</label>
              <input type="text" id="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand" required>
            </div>
            <div>
              <label for="purchasePrice" class="block text-sm font-medium text-gray-700">Purchase Price ($)</label>
              <input type="number" id="purchasePrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand" required>
            </div>
            <div>
              <label for="monthlyRent" class="block text-sm font-medium text-gray-700">Monthly Rent ($)</label>
              <input type="number" id="monthlyRent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand" required>
            </div>
            <div>
              <label for="monthlyExpenses" class="block text-sm font-medium text-gray-700">Monthly Expenses (Excluding Mortgage) ($)</label>
              <input type="number" id="monthlyExpenses" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand" required>
            </div>
            <div class="flex space-x-4">
              <button type="submit" id="save-btn" class="bg-brand text-white px-6 py-3 rounded-full font-bold hover:bg-brand-dark transition-colors duration-200 shadow-md flex-1">Save Property</button>
            </div>
          </form>
        </div>
      `;

      const propertyForm = document.getElementById('property-form');
      propertyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const address = document.getElementById('address').value;
        const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
        const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
        const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value);

        if (isNaN(purchasePrice) || isNaN(monthlyRent) || isNaN(monthlyExpenses)) {
          showAlert('Error', 'Please enter valid numbers for all financial fields.');
          return;
        }

        const newProperty = {
          address,
          purchasePrice,
          monthlyRent,
          monthlyExpenses,
          totalInvestment: purchasePrice,
          monthlyCashFlow: monthlyRent - monthlyExpenses,
          annualNOI: (monthlyRent - monthlyExpenses) * 12,
          capRate: (monthlyRent - monthlyExpenses) * 12 / purchasePrice,
          cashOnCash: (monthlyRent - monthlyExpenses) * 12 / purchasePrice
        };

        try {
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/properties`), newProperty);
          showAlert('Success', `Property "${address}" saved successfully!`);
          propertyForm.reset();
        } catch (e) {
          console.error("Error adding document: ", e);
          showAlert('Error', 'Failed to save property. Please try again.');
        }
      });
    }

    /**
     * Renders the saved properties list from Firestore data.
     */
    function renderSavedPropertiesPage() {
      pageContent.innerHTML = `
        <div class="bg-white rounded-lg shadow-md overflow-hidden p-6">
          <h2 class="text-2xl font-bold text-gray-800">Saved Properties</h2>
          <div id="properties-list" class="mt-4 space-y-4">
            ${savedProperties.length === 0 ? '<p class="text-gray-500">No properties saved yet. Add a new property to get started.</p>' : ''}
          </div>
        </div>
      `;

      const propertiesList = document.getElementById('properties-list');
      savedProperties.forEach(prop => {
        const propEl = document.createElement('div');
        propEl.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col sm:flex-row sm:justify-between items-start sm:items-center';
        propEl.innerHTML = `
          <div class="mb-2 sm:mb-0">
            <h3 class="font-bold text-lg">${prop.address}</h3>
            <p class="text-sm text-gray-600">Purchase Price: ${money(prop.purchasePrice)}</p>
            <p class="text-sm text-gray-600">Monthly Cash Flow: ${money(prop.monthlyCashFlow)}</p>
          </div>
          <div class="flex space-x-2">
            <button onclick="deleteProperty('${prop.id}')" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition-colors duration-200">Delete</button>
          </div>
        `;
        propertiesList.appendChild(propEl);
      });
    }

    /**
     * Renders the "Analysis" page.
     */
    function renderAnalysisPage() {
      if (savedProperties.length === 0) {
        pageContent.innerHTML = `<div class="bg-white rounded-lg shadow-md p-6"><p class="text-gray-500">Add some properties to see an analysis.</p></div>`;
        return;
      }

      const totalInvestment = savedProperties.reduce((sum, prop) => sum + prop.totalInvestment, 0);
      const totalCashFlow = savedProperties.reduce((sum, prop) => sum + prop.monthlyCashFlow, 0);
      const totalNOI = savedProperties.reduce((sum, prop) => sum + prop.annualNOI, 0);
      const avgCapRate = totalInvestment > 0 ? totalNOI / totalInvestment : 0;
      const portfolioCOC = totalInvestment > 0 ? totalCashFlow * 12 / totalInvestment : 0;

      pageContent.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800">Portfolio Analysis</h2>
          <div class="mt-4 space-y-4">
            <div class="bg-gray-100 p-4 rounded-lg">
              <h3 class="text-lg font-bold text-gray-800">Summary</h3>
              <p>Total Properties: ${savedProperties.length}</p>
              <p>Total Investment: ${money(totalInvestment)}</p>
              <p>Monthly Cash Flow: ${money(totalCashFlow)}</p>
              <p>Annual NOI: ${money(totalNOI)}</p>
              <p>Average Cap Rate: ${pct(avgCapRate)}</p>
              <p>Portfolio Cash-on-Cash: ${pct(portfolioCOC)}</p>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
              <h3 class="text-lg font-bold text-gray-800">Breakdown by Property</h3>
              <canvas id="analysisChart"></canvas>
            </div>
          </div>
        </div>
      `;

      const ctx = document.getElementById('analysisChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: savedProperties.map(p => p.address),
          datasets: [{
            label: 'Investment Breakdown',
            data: savedProperties.map(p => p.totalInvestment),
            backgroundColor: [
              '#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f1c40f', '#34495e',
            ],
            hoverOffset: 4
          }]
        },
      });
    }

    /**
     * Renders the "Compare" page.
     */
    function renderComparePage() {
      if (savedProperties.length < 2) {
        pageContent.innerHTML = `<div class="bg-white rounded-lg shadow-md p-6"><p class="text-gray-500">Add at least two properties to compare them.</p></div>`;
        return;
      }

      pageContent.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800">Compare Properties</h2>
          <div class="mt-4 flex flex-col space-y-4 sm:flex-row sm:space-x-4 sm:space-y-0">
            <select id="property1Select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand">
              ${savedProperties.map(p => `<option value="${p.id}">${p.address}</option>`).join('')}
            </select>
            <select id="property2Select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand">
              ${savedProperties.slice(1).map(p => `<option value="${p.id}">${p.address}</option>`).join('')}
            </select>
          </div>
          <div id="comparison-table" class="mt-4"></div>
        </div>
      `;

      const property1Select = document.getElementById('property1Select');
      const property2Select = document.getElementById('property2Select');
      const comparisonTable = document.getElementById('comparison-table');

      function updateComparison() {
        const p1 = savedProperties.find(p => p.id === property1Select.value);
        const p2 = savedProperties.find(p => p.id === property2Select.value);

        if (!p1 || !p2) return;

        comparisonTable.innerHTML = `
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Metric</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${p1.address}</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${p2.address}</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Purchase Price</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p1.purchasePrice)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p2.purchasePrice)}</td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Monthly Rent</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p1.monthlyRent)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p2.monthlyRent)}</td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Monthly Cash Flow</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p1.monthlyCashFlow)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${money(p2.monthlyCashFlow)}</td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Cap Rate</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pct(p1.capRate)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pct(p2.capRate)}</td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Cash-on-Cash</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pct(p1.cashOnCash)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pct(p2.cashOnCash)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
      property1Select.addEventListener('change', updateComparison);
      property2Select.addEventListener('change', updateComparison);
      updateComparison();
    }

    /**
     * Renders the "Market Data" page.
     */
    function renderMarketDataPage() {
      pageContent.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800">Market Data</h2>
          <div class="mt-4 space-y-4">
            <div>
              <label for="citySelect" class="block text-sm font-medium text-gray-700">City</label>
              <select id="citySelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand">
                <option value="New York">New York</option>
                <option value="San Francisco">San Francisco</option>
                <option value="Austin">Austin</option>
              </select>
            </div>
            <div>
              <label for="propertyType" class="block text-sm font-medium text-gray-700">Property Type</label>
              <select id="propertyType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand">
                <option value="Single Family">Single Family</option>
                <option value="Multi Family">Multi Family</option>
                <option value="Commercial">Commercial</option>
              </select>
            </div>
            <button id="loadMarketDataBtn" class="bg-brand text-white px-6 py-3 rounded-full font-bold hover:bg-brand-dark transition-colors duration-200 shadow-md">Load Data</button>
            <div id="marketDataResults" class="mt-4"></div>
          </div>
        </div>
      `;

      document.getElementById('loadMarketDataBtn').addEventListener('click', () => {
        const city = document.getElementById('citySelect').value;
        const propType = document.getElementById('propertyType').value;
        const resultsEl = document.getElementById('marketDataResults');
        resultsEl.innerHTML = `<p class="text-gray-500">Simulating market data for ${propType} properties in ${city}. This feature is not yet fully implemented.</p>`;
        showAlert('Coming Soon', `Loading market data for ${propType} properties in ${city}...`);
      });
    }

    /**
     * Deletes a property from Firestore.
     * @param {string} propertyId - The ID of the property to delete.
     */
    async function deleteProperty(propertyId) {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/properties/${propertyId}`));
        showAlert('Success', 'Property deleted successfully!');
      } catch (e) {
        console.error("Error deleting document: ", e);
        showAlert('Error', 'Failed to delete property. Please try again.');
      }
    }

    /**
     * Navigates to a specific page and updates the active button.
     * @param {string} pageName - The name of the page to navigate to.
     */
    function navigateTo(pageName) {
      document.querySelectorAll('[data-page]').forEach(btn => {
        btn.classList.remove('active', 'text-gray-800', 'bg-gray-100', 'font-medium');
        btn.classList.add('text-gray-600');
      });

      const activeBtn = document.querySelector(`[data-page="${pageName}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active', 'text-gray-800', 'bg-gray-100', 'font-medium');
        activeBtn.classList.remove('text-gray-600');
      }

      pageContent.dataset.page = pageName;
      switch (pageName) {
        case 'add':
          renderAddPropertyPage();
          break;
        case 'analysis':
          renderAnalysisPage();
          break;
        case 'compare':
          renderComparePage();
          break;
        case 'market':
          renderMarketDataPage();
          break;
        case 'saved':
          renderSavedPropertiesPage();
          break;
        default:
          renderAddPropertyPage();
          break;
      }
    }

    // --- Core App Initialization ---
    window.onload = () => {
      try {
        if (Object.keys(firebaseConfig).length === 0) {
          throw new Error("Firebase config is missing.");
        }

        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            userIdDisplay.textContent = `User ID: ${userId}`;
            userIdDisplay.classList.remove('hidden');
            googleSignInBtn.classList.add('hidden');
            console.log("User authenticated:", userId);

            loadingSpinner.classList.add('hidden');
            appContainer.classList.remove('loading');

            // Set up a real-time listener for the user's properties
            const propertiesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/properties`);
            onSnapshot(propertiesCollectionRef, (snapshot) => {
              savedProperties = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              navigateTo(pageContent.dataset.page || 'add');
            }, (error) => {
              console.error("Error listening to properties:", error);
            });
            navigateTo('add');
          } else {
            console.log("No user signed in. Attempting to sign in.");
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
            } else {
              googleSignInBtn.classList.remove('hidden');
              loadingSpinner.classList.add('hidden');
              appContainer.classList.remove('loading');
            }
          }
        });

      } catch (e) {
        console.error("Firebase initialization failed:", e);
        showAlert('Initialization Error', `Failed to initialize the app: ${e.message}`);
        loadingSpinner.classList.add('hidden');
        appContainer.classList.remove('loading');
      }
    };

    // --- Page Navigation Event Listeners ---
    navButtons.forEach(button => {
      button.addEventListener('click', () => {
        const pageName = button.getAttribute('data-page');
        navigateTo(pageName);
      });
    });

    // Make functions globally accessible for inline event handlers
    window.deleteProperty = deleteProperty;
  </script>
</body>

</html>

