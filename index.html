<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck ‚Äî RE Calculator & Underwriting Tool</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{--brand:#2ecc71;--muted:#7f8c8d;--card-bg:#ffffff;--page-bg-1:#667eea;--page-bg-2:#764ba2;--max-w:1100px;}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(135deg,var(--page-bg-1) 0%,var(--page-bg-2) 100%);color:#20323a;padding:24px}
    .center-screen{min-height:calc(100vh - 48px);display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:100%;max-width:420px;background:var(--card-bg);border-radius:16px;padding:28px;box-shadow:0 18px 40px rgba(2,6,23,0.25);text-align:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:15px}
    .btn-primary{background:var(--brand);color:#fff}
    .signOut,.installBtn{background:#fff;border:1px solid #ddd;color:#444;padding:8px 12px;border-radius:8px;cursor:pointer}
    #mainApp{display:none;min-height:100vh;background:#f6f8fa}
    .header{background:#fff;padding:18px;box-shadow:0 2px 10px rgba(2,6,23,0.06)}
    .container{max-width:var(--max-w);margin:22px auto;padding:0 18px}
    .card{background:#fff;border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    input{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6eef5;font-size:15px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.full{grid-column:1/-1}
    .result{background:#e8f8f5;padding:12px;border-radius:10px;margin-top:14px}
    .muted{color:var(--muted);font-size:0.95rem}.small{font-size:0.9rem}
    @media(max-width:700px){.grid{grid-template-columns:1fr}body{padding:12px}}
    .userInfo{display:flex;gap:12px;align-items:center}.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <main id="loginScreen" class="center-screen">
    <div class="login-card">
      <h1>üè† PropCheck</h1>
      <div class="subtitle">Fast Canadian property underwriting for real estate investors</div>
      <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
      <div style="margin-top:8px;">
        <div id="g_id_onload"
             data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
             data-auto_prompt="false"></div>
        <div id="g_button_target" style="margin-top:10px"></div>
      </div>
    </div>
  </main>

  <!-- APP -->
  <div id="mainApp">
    <div class="header">
      <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;color:var(--brand)">üè† PropCheck</h2>
        <div style="display:flex;gap:12px;align-items:center;">
          <button id="installBtn" class="installBtn" style="display:none;">‚ûï Install App</button>
          <div id="userArea" class="userInfo" style="display:none;">
            <img id="userAvatar" class="avatar" alt="">
            <div>
              <div id="userName" style="font-weight:700"></div>
              <div id="userEmail" class="muted small"></div>
            </div>
            <button id="signOut" class="signOut">Sign out</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <section class="card">
        <h3>Property Analysis</h3>
        <div class="grid">
          <div><label>Purchase Price ($)<input id="price" type="number"></label></div>
          <div><label>Down Payment (%)<input id="down" type="number" value="20"></label></div>
          <div><label>Interest Rate (%)<input id="rate" type="number" value="5"></label></div>
          <div><label>Amortization (years)<input id="term" type="number" value="25"></label></div>
          <div><label>Monthly Rent ($)<input id="rent" type="number"></label></div>
          <div><label>Monthly Expenses ($)<input id="expenses" type="number"></label></div>
        </div>
        <button id="calcButton" class="btn btn-primary" style="margin-top:12px">Calculate</button>
        <div id="results" class="result" style="display:none;">
          <p>Monthly Payment: <strong id="payment">$0</strong></p>
          <p>Cash Flow: <strong id="cashflow">$0</strong></p>
          <p>NOI (annual): <strong id="noi">$0</strong></p>
          <p>Cap Rate: <strong id="caprate">0%</strong></p>
          <p>Cash-on-Cash: <strong id="coc">N/A</strong></p>
        </div>
      </section>
    </div>
  </div>

  <script>
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';

    guestButton.onclick = () => { loginScreen.style.display='none'; mainApp.style.display='block'; };

    function parseJwt(token){try{const base64Url=token.split('.')[1];const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));return JSON.parse(json);}catch(e){return null;}}

    function handleCredentialResponse(r){
      const payload=parseJwt(r.credential);if(!payload)return;
      loginScreen.style.display='none';mainApp.style.display='block';
      userArea.style.display='flex';userAvatar.src=payload.picture||'';userName.textContent=payload.name;userEmail.textContent=payload.email;
    }

    window.onload=function(){
      if(google&&google.accounts&&google.accounts.id){
        google.accounts.id.initialize({client_id:CLIENT_ID,callback:handleCredentialResponse});
        google.accounts.id.renderButton(document.getElementById('g_button_target'),{theme:'outline',size:'large',width:'100%'});
      }
    }

    signOut.onclick=()=>{google.accounts.id.disableAutoSelect();userArea.style.display='none';loginScreen.style.display='flex';mainApp.style.display='none';};

    // Calculator
    function money(n){return '$'+Number(n).toFixed(2);}
    function pct(n){return Number(n).toFixed(2)+'%';}
    calcButton.onclick=()=>{
      const p=+price.value||0,d=+down.value||20,r=(+rate.value||0)/100/12,t=(+term.value||25)*12,rent=+window.rent.value||0,e=+expenses.value||0;
      const dp=p*d/100,loan=p-dp,n=loan>0?t:0;let pay=0;
      if(r===0)pay=loan/n;else pay=loan*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
      const cash=rent-pay-e,noi=(rent-e)*12,cap=p?noi/p*100:0,coc=dp?((cash*12)/dp*100):null;
      payment.textContent=money(pay);cashflow.textContent=money(cash);noi.textContent=money(noi);caprate.textContent=pct(cap);coc.textContent=coc?pct(coc):'N/A';
      results.style.display='block';
    };

    // PWA: Service Worker & Install Prompt
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') installBtn.style.display='none';
        deferredPrompt = null;
      }
    };
  </script>
</body>
</html>
