<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck ‚Äì RE Calculator & Underwriting Tool</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <!-- Google Identity Services and Google APIs Client Library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;--max-w:1200px;--danger:#e74c3c;
      --warning:#f39c12;--info:#3498db;--success:#2ecc71;--text:#2c3e50;
      --border:#e1e8ed;--shadow:0 6px 20px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
         background:linear-gradient(135deg,var(--page-bg-1) 0%,var(--page-bg-2) 100%);
         color:var(--text);min-height:100vh;}
    
    /* Login Styles */
    .center-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:100%;max-width:420px;background:var(--card-bg);border-radius:16px;padding:32px;
                box-shadow:0 18px 40px rgba(2,6,23,0.25);text-align:center}
    .login-card h1{color:var(--brand);margin:0 0 8px 0;font-size:2.2rem}
    .subtitle{color:var(--muted);margin-bottom:24px;font-size:1.1rem}
    
    /* Navigation */
    .nav{background:#fff;padding:0;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .nav-container{max-width:var(--max-w);margin:0 auto;padding:0 20px;display:flex;
                   justify-content:space-between;align-items:center;height:70px}
    .logo{color:var(--brand);font-size:1.8rem;font-weight:700;text-decoration:none}
    .nav-links{display:flex;gap:0;align-items:center}
    .nav-link{padding:12px 20px;text-decoration:none;color:var(--text);font-weight:500;
              border-radius:8px;transition:all 0.2s}
    .nav-link:hover,.nav-link.active{background:var(--brand);color:#fff}
    .user-menu{display:flex;gap:12px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    
    /* Main Content */
    .main{max-width:var(--max-w);margin:0 auto;padding:24px 20px;min-height:calc(100vh - 70px)}
    .page{display:none}.page.active{display:block}
    
    /* Components */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;
         border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:15px;transition:all 0.2s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-dark)}
    .btn-secondary{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-small{padding:8px 16px;font-size:14px}
    
    .card{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 20px 0;color:var(--text);font-size:1.3rem}
    
    .grid{display:grid;gap:16px}.grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}
    .full{grid-column:1/-1}
    
    .form-group{margin-bottom:16px}
    .form-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--text)}
    .form-group input,.form-group select{width:100%;padding:12px;border-radius:8px;
                                        border:1px solid var(--border);font-size:15px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--brand)}
    
    .result-card{background:linear-gradient(135deg,#e8f8f5 0%,#d5efdb 100%);
                 padding:20px;border-radius:12px;margin-top:20px}
    .metric{text-align:center;padding:16px}
    .metric-value{font-size:1.8rem;font-weight:700;color:var(--brand)}
    .metric-label{color:var(--muted);font-size:0.9rem;margin-top:4px}
    
    .alert{padding:16px;border-radius:8px;margin-bottom:20px}
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
    .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
    
    .tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:24px}
    .tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;
         font-weight:500;color:var(--muted)}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    
    .comparison-table{width:100%;border-collapse:collapse;margin-top:20px}
    .comparison-table th,.comparison-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    .comparison-table th{background:#f8f9fa;font-weight:600}
    
    @media(max-width:768px){
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
      .nav-links{display:none}
      .nav-container{padding:0 16px}
      .main{padding:16px}
      .card{padding:20px}
    }
    
    /* Mobile Menu */
    .mobile-menu{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;
                 box-shadow:0 -2px 10px rgba(0,0,0,0.1);padding:12px;z-index:1000}
    .mobile-nav{display:flex;justify-content:space-around}
    .mobile-nav-item{text-align:center;padding:8px;border-radius:8px;cursor:pointer;
                     color:var(--muted);font-size:12px;min-width:60px}
    .mobile-nav-item.active{color:var(--brand);background:#f0f9ff}
    
    @media(max-width:768px){
      .mobile-menu{display:block}
      .main{padding-bottom:80px}
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <main id="loginScreen" class="center-screen">
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
      <div class="login-card">
        <h1>üè† PropCheck</h1>
        <div class="subtitle">Fast Canadian property underwriting for real estate investors</div>
        
        <button id="guestButton" class="btn btn-primary">Continue as Guest</button>
        
        <div style="margin:16px 0;color:var(--muted);font-size:14px;">or</div>
        
        <!-- Google Sign-In Button Container -->
        <div id="g_button_target" style="margin-top:10px;min-height:44px;"></div>
        
        <!-- Hidden elements for Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"
             style="display:none;"></div>
      </div>
      
      <!-- PWA Install Button Below White Box -->
      <div style="margin-top:32px;text-align:center;">
        <button id="homeInstallBtn" class="btn btn-primary" style="font-size:18px;padding:16px 32px;background:var(--brand);border:none;box-shadow:0 4px 12px rgba(46,204,113,0.3);">
          üì± Download App
        </button>
        <div style="color:rgba(255,255,255,0.8);margin-top:8px;font-size:14px;">
          Install PropCheck for offline access
        </div>
      </div>
    </div>
  </main>

  <!-- MAIN APP -->
  <div id="mainApp" style="display:none;">
    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-container">
        <a href="#" class="logo">üè† PropCheck</a>
        <div class="nav-links">
          <a href="#" class="nav-link active" data-page="calculator">Calculator</a>
          <a href="#" class="nav-link" data-page="analysis">Analysis</a>
          <a href="#" class="nav-link" data-page="compare">Compare</a>
          <a href="#" class="nav-link" data-page="reports">Reports</a>
          <a href="#" class="nav-link" data-page="market">Market Data</a>
        </div>
        <div class="user-menu">
          <button id="installBtn" class="btn-secondary btn-small" style="display:none;">‚ûï Install</button>
          <div id="userArea" class="user-menu" style="display:none;">
            <img id="userAvatar" class="avatar" alt="">
            <div style="margin-right:12px;">
              <div id="userName" style="font-weight:600;font-size:14px;"></div>
              <div id="userEmail" style="color:var(--muted);font-size:12px;"></div>
            </div>
            <button id="signOut" class="btn-secondary btn-small">Sign out</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main">
      
      <!-- CALCULATOR PAGE -->
      <div id="calculatorPage" class="page active">
        <div class="card">
          <h3>üè† Property Calculator</h3>
          <div class="grid grid-2">
            <div class="form-group">
              <label>Purchase Price ($)</label>
              <input id="price" type="number" placeholder="e.g. 750000">
            </div>
            <div class="form-group">
              <label>Down Payment (%)</label>
              <input id="down" type="number" value="20" min="5" max="100">
            </div>
            <div class="form-group">
              <label>Interest Rate (%)</label>
              <input id="rate" type="number" value="5.5" step="0.1">
            </div>
            <div class="form-group">
              <label>Amortization (years)</label>
              <select id="term">
                <option value="25">25 years</option>
                <option value="30">30 years</option>
                <option value="20">20 years</option>
                <option value="15">15 years</option>
              </select>
            </div>
            <div class="form-group">
              <label>Monthly Rent ($)</label>
              <input id="rent" type="number" placeholder="e.g. 3200">
            </div>
            <div class="form-group">
              <label>Property Taxes (annual $)</label>
              <input id="propertyTax" type="number" placeholder="e.g. 8500">
            </div>
            <div class="form-group">
              <label>Insurance (annual $)</label>
              <input id="insurance" type="number" placeholder="e.g. 1200">
            </div>
            <div class="form-group">
              <label>Management Fee (%)</label>
              <input id="management" type="number" value="8" step="0.1">
            </div>
            <div class="form-group">
              <label>Vacancy Rate (%)</label>
              <input id="vacancy" type="number" value="5" step="0.1">
            </div>
            <div class="form-group">
              <label>Other Monthly Expenses ($)</label>
              <input id="otherExpenses" type="number" placeholder="e.g. 200">
            </div>
          </div>
          
          <div class="form-group" style="margin-top:20px;">
            <label>
              <input type="checkbox" id="cmhcRequired" style="width:auto;margin-right:8px;">
              CMHC Insurance Required (down payment < 20%)
            </label>
          </div>
          
          <button id="calcButton" class="btn btn-primary">Calculate Investment</button>
          
          <div id="results" class="result-card" style="display:none;">
            <div class="grid grid-4">
              <div class="metric">
                <div class="metric-value" id="payment">$0</div>
                <div class="metric-label">Monthly Payment</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="cashflow">$0</div>
                <div class="metric-label">Net Cash Flow</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="caprate">0%</div>
                <div class="metric-label">Cap Rate</div>
              </div>
              <div class="metric">
                <div class="metric-value" id="coc">0%</div>
                <div class="metric-label">Cash-on-Cash</div>
              </div>
            </div>
            
            <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
              <h4>Investment Summary</h4>
              <div class="grid grid-2">
                <div>
                  <strong>Initial Investment:</strong><br>
                  Down Payment: <span id="downPaymentAmount">$0</span><br>
                  CMHC Insurance: <span id="cmhcAmount">$0</span><br>
                  <strong>Total: <span id="totalInitial">$0</span></strong>
                </div>
                <div>
                  <strong>Annual Numbers:</strong><br>
                  Gross Rent: <span id="grossRent">$0</span><br>
                  Total Expenses: <span id="totalExpenses">$0</span><br>
                  Net Operating Income: <span id="noi">$0</span>
                </div>
              </div>
            </div>
            
            <button id="saveProperty" class="btn btn-secondary" style="margin-top:16px;">
              üíæ Save Property to Drive
            </button>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>
      </div>

      <!-- ANALYSIS PAGE -->
      <div id="analysisPage" class="page">
        <div class="card">
          <h3>üìä Stress Testing & Scenarios</h3>
          
          <div class="tabs">
            <div class="tab active" data-tab="rates">Interest Rates</div>
            <div class="tab" data-tab="rent">Rent Changes</div>
            <div class="tab" data-tab="expenses">Expense Impact</div>
          </div>
          
          <!-- Interest Rate Analysis -->
          <div id="ratesTab" class="tab-content">
            <p>Analyze how interest rate changes affect your investment:</p>
            <div class="grid grid-3">
              <div class="form-group">
                <label>Current Rate (%)</label>
                <input id="currentRate" type="number" value="5.5" step="0.1">
              </div>
              <div class="form-group">
                <label>Stress Test Rate (%)</label>
                <input id="stressRate" type="number" value="7.5" step="0.1">
              </div>
              <div class="form-group">
                <label>Renewal Period (years)</label>
                <select id="renewalPeriod">
                  <option value="1">1 year</option>
                  <option value="2">2 years</option>
                  <option value="3">3 years</option>
                  <option value="5" selected>5 years</option>
                </select>
              </div>
            </div>
            <button id="runStressTest" class="btn btn-primary">Run Stress Test</button>
            <div id="stressResults" style="display:none;margin-top:20px;"></div>
          </div>
          
          <!-- Rent Analysis -->
          <div id="rentTab" class="tab-content" style="display:none;">
            <p>Model different rental scenarios:</p>
            <div class="grid grid-2">
              <div class="form-group">
                <label>Annual Rent Increase (%)</label>
                <input id="rentIncrease" type="number" value="3" step="0.1">
              </div>
              <div class="form-group">
                <label>Projection Period (years)</label>
                <input id="projectionYears" type="number" value="10" min="1" max="30">
              </div>
            </div>
            <button id="runRentAnalysis" class="btn btn-primary">Analyze Rent Growth</button>
            <div id="rentResults" style="display:none;margin-top:20px;"></div>
          </div>
          
          <!-- Expense Analysis -->
          <div id="expenseTab" class="tab-content" style="display:none;">
            <p>Break down and optimize your expenses:</p>
            <div id="expenseBreakdown" style="margin-top:20px;"></div>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>

      <!-- COMPARE PAGE -->
      <div id="comparePage" class="page">
        <div class="card">
          <h3>‚öñÔ∏è Property Comparison</h3>
          <div style="margin-bottom:20px;">
            <button id="addProperty" class="btn btn-primary">+ Add Property</button>
            <button id="clearComparison" class="btn btn-secondary">Clear All</button>
          </div>
          
          <div id="comparisonContainer">
            <div class="alert alert-warning">
              Add properties from the calculator to compare them side-by-side.
            </div>
          </div>
        </div>
      </div>

      <!-- REPORTS PAGE -->
      <div id="reportsPage" class="page">
        <div class="card">
          <h3>üìã Investment Reports</h3>
          
          <div class="grid grid-2">
            <div class="card" style="margin:0;">
              <h4>Property Summary Report</h4>
              <p class="muted">Generate a comprehensive analysis report for lenders or partners.</p>
              <button id="generateSummary" class="btn btn-primary">Generate & Save HTML Report</button>
            </div>
            <div class="card" style="margin:0;">
              <h4>Portfolio Analysis</h4>
              <p class="muted">Analyze all your saved properties together.</p>
              <button id="portfolioReport" class="btn btn-primary">View Portfolio</button>
            </div>
          </div>
          
          <div id="savedProperties" class="card">
            <h4>Saved Properties</h4>
            <div id="propertiesList">
              <div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>
            </div>
            <button id="loadFromDrive" class="btn btn-secondary" style="margin-top:20px;">Load from Drive</button>
          </div>
        </div>

        <!-- AdSense Ad Unit -->
        <div style="text-align:center;margin:24px 0;">
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-6166342215834701"
               data-ad-slot="1234567890"
               data-ad-format="auto"></ins>
        </div>
      </div>

      <!-- MARKET DATA PAGE -->
      <div id="marketPage" class="page">
        <div class="card">
          <h3>üèôÔ∏è Market Intelligence</h3>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label>City/Region</label>
              <select id="citySelect">
                <option value="toronto">Toronto, ON</option>
                <option value="vancouver">Vancouver, BC</option>
                <option value="montreal">Montreal, QC</option>
                <option value="calgary">Calgary, AB</option>
                <option value="ottawa">Ottawa, ON</option>
                <option value="halifax">Halifax, NS</option>
              </select>
            </div>
            <div class="form-group">
              <label>Property Type</label>
              <select id="propertyTypeSelect">
                <option value="house">Detached House</option>
                <option value="condo">Condo</option>
                <option value="duplex">Duplex/Triplex</option>
              </select>
            </div>
          </div>
          <button id="getMarketData" class="btn btn-primary">Get Market Data</button>
          
          <div id="marketDataResults" style="margin-top:20px;">
            <div class="alert alert-info">Select a city and property type to get market data.</div>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- Mobile Navigation Menu -->
    <div class="mobile-menu">
      <div class="mobile-nav">
        <div class="mobile-nav-item active" data-page="calculator">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 12-4-4v3H3v2h14v3z"/></svg>
          <div style="margin-top:2px;">Calculator</div>
        </div>
        <div class="mobile-nav-item" data-page="analysis">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
          <div style="margin-top:2px;">Analysis</div>
        </div>
        <div class="mobile-nav-item" data-page="compare">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6m-3 12v-6m-4-2.5V11m-4 5.5v-3"/></svg>
          <div style="margin-top:2px;">Compare</div>
        </div>
        <div class="mobile-nav-item" data-page="reports">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          <div style="margin-top:2px;">Reports</div>
        </div>
        <div class="mobile-nav-item" data-page="market">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l-5 5 5 5 5-5z"/><path d="M12 12l-5 5 5 5 5-5z"/></svg>
          <div style="margin-top:2px;">Market</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Constants and state management
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    const userArea = document.getElementById('userArea');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const userAvatarEl = document.getElementById('userAvatar');
    const installBtn = document.getElementById('installBtn');
    const homeInstallBtn = document.getElementById('homeInstallBtn');

    const googleDriveClient = {
      apiKey: "YOUR_API_KEY",
      clientId: "539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com",
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      scope: "https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file",
    };

    let gapiLoaded = false;
    let gisLoaded = false;
    let gapiInited = false;
    let gisInited = false;
    let gapiClient;
    let gisClient;

    const savedProperties = [];
    const comparisonList = [];

    let currentProperty = {};

    // UI functions
    const showPage = (pageId) => {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.querySelector(`[data-page="${pageId.replace('Page', '')}"]`).classList.add('active');
      
      document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`.mobile-nav-item[data-page="${pageId.replace('Page', '')}"]`).classList.add('active');
    };

    const updateAuthUI = (user) => {
      if (user) {
        loginScreen.style.display = 'none';
        mainApp.style.display = 'block';
        userArea.style.display = 'flex';
        userNameEl.textContent = user.displayName || 'Guest User';
        userEmailEl.textContent = user.email || '';
        if (user.photoURL) {
          userAvatarEl.src = user.photoURL;
        }
      } else {
        loginScreen.style.display = 'flex';
        mainApp.style.display = 'none';
        userArea.style.display = 'none';
      }
    };

    const showAlert = (message, type = 'info') => {
      const alertContainer = document.createElement('div');
      alertContainer.className = `alert alert-${type}`;
      alertContainer.textContent = message;
      document.querySelector('.main').prepend(alertContainer);
      setTimeout(() => alertContainer.remove(), 5000);
    };

    const formatCurrency = (value) => {
      return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(value);
    };

    const formatPercent = (value) => {
      return new Intl.NumberFormat('en-CA', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(value / 100);
    };

    // Calculation logic
    const calculate = () => {
      const price = parseFloat(document.getElementById('price').value);
      const down = parseFloat(document.getElementById('down').value);
      const rate = parseFloat(document.getElementById('rate').value);
      const term = parseFloat(document.getElementById('term').value);
      const rent = parseFloat(document.getElementById('rent').value);
      const propertyTax = parseFloat(document.getElementById('propertyTax').value);
      const insurance = parseFloat(document.getElementById('insurance').value);
      const management = parseFloat(document.getElementById('management').value);
      const vacancy = parseFloat(document.getElementById('vacancy').value);
      const otherExpenses = parseFloat(document.getElementById('otherExpenses').value);

      if (isNaN(price) || isNaN(down) || isNaN(rate) || isNaN(term)) {
        document.getElementById('results').style.display = 'none';
        showAlert('Please fill in all required fields.', 'danger');
        return;
      }
      
      // Mortgage Calculation (Canadian style)
      const downPaymentAmount = price * (down / 100);
      let loanAmount = price - downPaymentAmount;

      // CMHC insurance
      let cmhcAmount = 0;
      if (document.getElementById('cmhcRequired').checked && down < 20) {
        const cmhcRate = getCMHCRate(down);
        cmhcAmount = loanAmount * cmhcRate;
        loanAmount += cmhcAmount;
      }

      const monthlyRate = (rate / 100) / 12;
      const numberOfPayments = term * 12;
      const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
      
      // Annual and Monthly Expenses
      const annualPropertyTax = propertyTax;
      const annualInsurance = insurance;
      const annualManagement = rent * 12 * (management / 100);
      const annualVacancy = rent * 12 * (vacancy / 100);
      const annualOther = otherExpenses * 12;
      
      const totalAnnualExpenses = annualPropertyTax + annualInsurance + annualManagement + annualVacancy + annualOther + (monthlyPayment * 12);
      const totalMonthlyExpenses = totalAnnualExpenses / 12;
      const grossAnnualRent = rent * 12;
      
      const noi = grossAnnualRent - (annualPropertyTax + annualInsurance + annualManagement + annualVacancy + annualOther);
      const capRate = (noi / price) * 100;
      const cashflow = grossAnnualRent - totalAnnualExpenses;
      const coc = (cashflow / downPaymentAmount) * 100;

      // Update UI with results
      document.getElementById('payment').textContent = formatCurrency(monthlyPayment);
      document.getElementById('cashflow').textContent = formatCurrency(cashflow / 12);
      document.getElementById('caprate').textContent = formatPercent(capRate);
      document.getElementById('coc').textContent = formatPercent(coc);
      document.getElementById('downPaymentAmount').textContent = formatCurrency(downPaymentAmount);
      document.getElementById('cmhcAmount').textContent = formatCurrency(cmhcAmount);
      document.getElementById('totalInitial').textContent = formatCurrency(downPaymentAmount + cmhcAmount);
      document.getElementById('grossRent').textContent = formatCurrency(grossAnnualRent);
      document.getElementById('totalExpenses').textContent = formatCurrency(totalAnnualExpenses);
      document.getElementById('noi').textContent = formatCurrency(noi);

      // Store results in currentProperty object
      currentProperty = {
        price, down, rate, term, rent, propertyTax, insurance, management, vacancy, otherExpenses,
        downPaymentAmount, cmhcAmount, monthlyPayment, totalInitial: downPaymentAmount + cmhcAmount,
        grossAnnualRent, totalAnnualExpenses, noi, capRate, coc, cashflow,
        name: `Property @ ${formatCurrency(price)}`
      };

      document.getElementById('results').style.display = 'block';
    };

    const getCMHCRate = (down) => {
      if (down >= 20) return 0;
      if (down >= 15) return 0.01;
      if (down >= 10) return 0.02;
      return 0.04;
    };
    
    // Google Drive Integration
    
    // Function to load the Google APIs client library
    const loadGapi = () => {
      return new Promise((resolve) => {
        gapi.load('client', () => {
          gapiLoaded = true;
          resolve();
        });
      });
    };
    
    // Function to initialize the Google Identity Services client
    const initGis = () => {
      return new Promise((resolve) => {
        gisClient = google.accounts.oauth2.initTokenClient({
          client_id: googleDriveClient.clientId,
          scope: googleDriveClient.scope,
          callback: (response) => {
            console.log('GIS callback response:', response);
            if (response.access_token) {
              gapi.client.setToken(response);
              gisInited = true;
            } else {
              showAlert('Failed to get access token from Google.', 'danger');
            }
            resolve();
          },
        });
        gisLoaded = true;
      });
    };
    
    // Auth flow
    window.handleCredentialResponse = async (response) => {
      console.log("Google Sign-in Response:", response);
      if (response.credential) {
        try {
          // This is a dummy user object. Replace with real auth logic.
          const user = {
            displayName: "Google User",
            email: "user@example.com",
            photoURL: "https://www.gstatic.com/images/branding/product/2x/avatar_circle_grey_512dp.png"
          };
          updateAuthUI(user);
          // GAPI and GIS initialization
          if (!gapiLoaded) await loadGapi();
          if (!gisLoaded) await initGis();
          if (!gapiInited) await gapi.client.init({}).then(() => gapiInited = true);
          if (gisClient) gisClient.requestAccessToken();
        } catch (error) {
          console.error("Authentication failed:", error);
          showAlert('Authentication failed. Please try again.', 'danger');
        }
      } else {
        showAlert('Google sign-in failed. Please try again.', 'danger');
      }
    };
    
    const signInAsGuest = () => {
      const user = { displayName: "Guest", photoURL: "https://placehold.co/40x40/cccccc/000000?text=G" };
      updateAuthUI(user);
      showAlert('Signed in as Guest. Drive functionality is disabled.', 'warning');
    };

    const signOut = () => {
      const auth2 = gapi.auth2.getAuthInstance();
      if (auth2) {
        auth2.signOut().then(() => {
          console.log('User signed out.');
        });
      }
      updateAuthUI(null);
      // Show Google button again
      google.accounts.id.renderButton(
        document.getElementById("g_button_target"),
        { theme: "outline", size: "large", text: "continue_with", width: "100%" }
      );
    };

    const getPropertiesFolder = async () => {
      try {
        const response = await gapi.client.drive.files.list({
          q: "name = 'PropCheck Properties' and mimeType = 'application/vnd.google-apps.folder' and 'appDataFolder' in parents",
          spaces: 'appDataFolder',
          fields: 'files(id)',
        });

        if (response.result.files.length > 0) {
          return response.result.files[0].id;
        } else {
          // Create folder if it doesn't exist
          const folderMetadata = {
            'name': 'PropCheck Properties',
            'mimeType': 'application/vnd.google-apps.folder',
            'parents': ['appDataFolder']
          };
          const createResponse = await gapi.client.drive.files.create({
            resource: folderMetadata,
            fields: 'id',
          });
          return createResponse.result.id;
        }
      } catch (err) {
        console.error('Error getting/creating folder:', err);
        showAlert('Error accessing Google Drive.', 'danger');
        return null;
      }
    };

    const uploadToDrive = async (fileName, fileBlob, mimeType) => {
      try {
        const folderId = await getPropertiesFolder();
        if (!folderId) return null;

        const fileMetadata = {
          'name': fileName,
          'mimeType': mimeType,
          'parents': [folderId]
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        form.append('file', fileBlob);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
          body: form
        });
        
        return await response.json();
      } catch (err) {
        console.error('Error uploading to Drive:', err);
        showAlert('Error saving to Google Drive.', 'danger');
        return null;
      }
    };

    const loadFromDrive = async () => {
      try {
        const folderId = await getPropertiesFolder();
        if (!folderId) return;

        const response = await gapi.client.drive.files.list({
          q: `'${folderId}' in parents and trashed=false`,
          spaces: 'appDataFolder',
          fields: 'files(id, name)',
        });
        
        const files = response.result.files;
        savedProperties.length = 0; // Clear existing list
        const propertiesListEl = document.getElementById('propertiesList');
        propertiesListEl.innerHTML = '';

        if (files.length === 0) {
          propertiesListEl.innerHTML = '<div class="alert alert-warning">No saved properties found in your Drive.</div>';
          return;
        }

        for (const file of files) {
          const fileResponse = await gapi.client.drive.files.get({
            fileId: file.id,
            alt: 'media'
          });
          const propertyData = JSON.parse(fileResponse.body);
          savedProperties.push(propertyData);
          
          const propertyEl = document.createElement('div');
          propertyEl.className = 'card';
          propertyEl.style.marginBottom = '10px';
          propertyEl.innerHTML = `
            <div>
              <strong>${propertyData.name || 'Untitled Property'}</strong>
              <div style="font-size:14px;color:var(--muted);">${formatCurrency(propertyData.price)} | Cap Rate: ${formatPercent(propertyData.capRate)}</div>
            </div>
            <div style="margin-top:10px;">
              <button class="btn btn-primary btn-small load-prop" data-id="${file.id}">Load</button>
              <button class="btn btn-secondary btn-small add-to-compare" data-id="${file.id}">Compare</button>
            </div>
          `;
          propertiesListEl.appendChild(propertyEl);
        }

        attachLoadAndCompareListeners();
        showAlert('Properties loaded from Google Drive.', 'success');
      } catch (err) {
        console.error('Error loading files:', err);
        showAlert('Error loading properties from Google Drive. Ensure you are signed in.', 'danger');
      }
    };

    const attachLoadAndCompareListeners = () => {
      document.querySelectorAll('.load-prop').forEach(btn => {
        btn.onclick = async (e) => {
          const fileId = e.target.dataset.id;
          const prop = savedProperties.find(p => p.id === fileId);
          if (prop) {
            // Load values back into calculator
            document.getElementById('price').value = prop.price;
            document.getElementById('down').value = prop.down;
            document.getElementById('rate').value = prop.rate;
            document.getElementById('term').value = prop.term;
            document.getElementById('rent').value = prop.rent;
            document.getElementById('propertyTax').value = prop.propertyTax;
            document.getElementById('insurance').value = prop.insurance;
            document.getElementById('management').value = prop.management;
            document.getElementById('vacancy').value = prop.vacancy;
            document.getElementById('otherExpenses').value = prop.otherExpenses;
            document.getElementById('cmhcRequired').checked = prop.cmhcAmount > 0;
            calculate();
            showAlert('Property loaded successfully!', 'success');
            showPage('calculatorPage');
          }
        };
      });

      document.querySelectorAll('.add-to-compare').forEach(btn => {
        btn.onclick = (e) => {
          const fileId = e.target.dataset.id;
          const prop = savedProperties.find(p => p.id === fileId);
          if (prop && !comparisonList.find(p => p.id === fileId)) {
            comparisonList.push(prop);
            updateComparisonTable();
            showAlert('Property added to comparison list.', 'success');
          } else {
            showAlert('Property is already in the comparison list.', 'warning');
          }
          showPage('comparePage');
        };
      });
    };

    const updateComparisonTable = () => {
      const container = document.getElementById('comparisonContainer');
      container.innerHTML = '';
      if (comparisonList.length === 0) {
        container.innerHTML = `
          <div class="alert alert-warning">
            Add properties from the calculator to compare them side-by-side.
          </div>
        `;
        return;
      }

      let tableHTML = `
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Metric</th>
              ${comparisonList.map(p => `<th>${p.name}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Purchase Price</td>
              ${comparisonList.map(p => `<td>${formatCurrency(p.price)}</td>`).join('')}
            </tr>
            <tr>
              <td>Monthly Cash Flow</td>
              ${comparisonList.map(p => `<td>${formatCurrency(p.cashflow / 12)}</td>`).join('')}
            </tr>
            <tr>
              <td>Cap Rate</td>
              ${comparisonList.map(p => `<td>${formatPercent(p.capRate)}</td>`).join('')}
            </tr>
            <tr>
              <td>Cash-on-Cash</td>
              ${comparisonList.map(p => `<td>${formatPercent(p.coc)}</td>`).join('')}
            </tr>
          </tbody>
        </table>
        <div style="margin-top:20px;">
          <button id="clearComparisonList" class="btn btn-danger">Clear List</button>
        </div>
      `;
      container.innerHTML = tableHTML;
      document.getElementById('clearComparisonList').onclick = () => {
        comparisonList.length = 0;
        updateComparisonTable();
      };
    };

    const updateSavedPropertiesList = () => {
      const propertiesListEl = document.getElementById('propertiesList');
      if (savedProperties.length === 0) {
        propertiesListEl.innerHTML = '<div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>';
      } else {
        propertiesListEl.innerHTML = '';
        savedProperties.forEach((prop, index) => {
          const propEl = document.createElement('div');
          propEl.className = 'card';
          propEl.style.marginBottom = '10px';
          propEl.innerHTML = `
            <div>
              <strong>${prop.name || `Property ${index + 1}`}</strong>
              <div style="font-size:14px;color:var(--muted);">${formatCurrency(prop.price)} | Cap Rate: ${formatPercent(prop.capRate)}</div>
            </div>
            <div style="margin-top:10px;">
              <button class="btn btn-primary btn-small load-prop" data-index="${index}">Load</button>
              <button class="btn btn-secondary btn-small add-to-compare" data-index="${index}">Compare</button>
            </div>
          `;
          propertiesListEl.appendChild(propEl);
        });
      }
    };
    
    // Event listeners
    document.getElementById('calcButton').onclick = calculate;
    document.getElementById('guestButton').onclick = signInAsGuest;
    document.getElementById('signOut').onclick = signOut;
    document.getElementById('saveProperty').onclick = () => {
      if (Object.keys(currentProperty).length === 0) {
        showAlert('Please calculate a property first.', 'danger');
        return;
      }
      
      const fileName = `${currentProperty.name || 'Property'}-${Date.now()}.json`;
      const blob = new Blob([JSON.stringify(currentProperty)], {type: 'application/json'});
      uploadToDrive(fileName, blob, 'application/json').then(file => {
        if (file && file.id) {
          showAlert('Property saved to Google Drive!', 'success');
          // Add a link to view the file in Drive
          const link = document.createElement('a');
            link.href = `https://drive.google.com/file/d/${file.id}/view`;
            link.target = '_blank';
            link.textContent = 'üìÇ View in Drive';
            link.className = 'btn btn-primary';
            link.style.marginTop = '10px';
            document.getElementById('results').appendChild(link);
        }
      });
    };

    document.getElementById('generateSummary').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const reportHTML = `<!DOCTYPE html><html><head><title>Property Report</title></head><body>${document.getElementById('results').innerHTML}</body></html>`;
      const blob = new Blob([reportHTML], {type: 'text/html'});
      const fileName = `${currentProperty.name || 'Property'}-Report.html`;
      
      uploadToDrive(fileName, blob, 'text/html').then(file => {
        if (file && file.id) {
          showAlert('Report saved to Google Drive!', 'success');
          const link = document.createElement('a');
          link.href = `https://drive.google.com/file/d/${file.id}/view`;
          link.target = '_blank';
          link.textContent = 'üìÇ View Report in Drive';
          link.className = 'btn btn-primary';
          link.style.display = 'inline-block';
          link.style.marginTop = '10px';
          document.getElementById('reportsPage').appendChild(link);
        }
      });
    };
    
    document.getElementById('loadFromDrive').onclick = loadFromDrive;

    // Tabs functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = (e) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.getElementById(`${e.target.dataset.tab}Tab`).style.display = 'block';
      };
    });
    
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        showPage(`${e.target.dataset.page}Page`);
      };
    });
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
      item.onclick = (e) => {
        e.preventDefault();
        showPage(`${e.target.dataset.page}Page`);
      };
    });

    // PWA functionality
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
      homeInstallBtn.style.display = 'block';
    });
    
    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display='none';
          gtag('event', 'pwa_install');
        }
        deferredPrompt = null;
      }
    };
    
    homeInstallBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          homeInstallBtn.style.display='none';
          gtag('event', 'pwa_install');
        }
        deferredPrompt = null;
      }
    };

    // Initialize AdSense ads on page load
    window.addEventListener('load', () => {
      (adsbygoogle = window.adsbygoogle || []).push({});
    });
  </script>
</body>
</html>
