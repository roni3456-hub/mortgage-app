<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck – RE Calculator & Underwriting Tool</title>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRQW949FW1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PRQW949FW1');
  </script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6166342215834701"
     crossorigin="anonymous"></script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <link rel="manifest" href="site.webmanifest" />
  <meta name="theme-color" content="#2ecc71" />

  <style>
    :root{
      --brand:#2ecc71;--brand-dark:#27ae60;--muted:#7f8c8d;--card-bg:#ffffff;
      --page-bg-1:#667eea;--page-bg-2:#764ba2;
      --font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      --border:#e0e0e0;--success:#28a745;--danger:#dc3545;--warning:#ffc107;
    }
    html,body{
      font-family:var(--font-family);background-color:var(--page-bg-1);
      background-image:linear-gradient(45deg, var(--page-bg-1) 0%, var(--page-bg-2) 100%);
      color:#2c3e50;margin:0;padding:0;height:100%;-webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;display:flex;flex-direction:column;
    }
    body.dark-mode{filter:invert(1)hue-rotate(180deg);background-color:#2c3e50;}
    body.dark-mode .app-card,body.dark-mode .nav-bar,body.dark-mode .mobile-nav{
      filter:invert(1)hue-rotate(180deg);
    }
    a{text-decoration:none;color:var(--brand);}
    h1,h2,h3,h4{color:#2c3e50;font-weight:700;}
    .container{max-width:960px;margin:0 auto;padding:16px;}
    .nav-bar{
      display:flex;justify-content:space-between;align-items:center;
      padding:16px;background-color:rgba(255,255,255,.9);backdrop-filter:blur(10px);
      box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000;
    }
    .logo-container{display:flex;align-items:center;}
    .logo-container .logo-icon{width:40px;height:40px;margin-right:10px;animation:rotate 10s linear infinite;}
    @keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    .nav-links{display:flex;gap:16px;}
    .nav-link{
      font-weight:bold;color:var(--muted);transition:color .2s;
      padding:8px 12px;border-radius:6px;
    }
    .nav-link.active, .nav-link:hover{
      color:var(--brand);background-color:rgba(46,204,113,.1);
    }
    .main-content{flex-grow:1;padding-bottom:80px;position:relative;}
    .page{display:none;animation:fade-in .5s ease-out;}
    .page.active{display:block;}
    @keyframes fade-in{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .app-card{
      background-color:var(--card-bg);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:24px;margin:24px 0;
    }
    .input-group{
      display:flex;flex-direction:column;margin-bottom:16px;
    }
    .input-group label{
      font-weight:bold;margin-bottom:6px;color:#2c3e50;
    }
    .input-group input, .input-group select{
      width:100%;padding:12px;border:1px solid var(--border);
      border-radius:8px;font-size:16px;
      transition:border-color .2s,box-shadow .2s;
    }
    .input-group input:focus, .input-group select:focus{
      border-color:var(--brand);outline:none;box-shadow:0 0 0 3px rgba(46,204,113,.3);
    }
    .btn{
      padding:12px 24px;border:none;border-radius:8px;cursor:pointer;
      font-size:16px;font-weight:bold;transition:background-color .2s,transform .1s;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn-primary{
      background-color:var(--brand);color:#ffffff;
    }
    .btn-primary:hover{background-color:var(--brand-dark);transform:translateY(-1px);}
    .btn-secondary{
      background-color:#ecf0f1;color:#34495e;
    }
    .btn-secondary:hover{background-color:#bdc3c7;transform:translateY(-1px);}
    .btn-danger{
      background-color:var(--danger);color:#fff;
    }
    .btn-danger:hover{background-color:#c0392b;transform:translateY(-1px);}
    .btn-small{padding:8px 16px;font-size:14px;border-radius:6px;}
    .results-section{margin-top:24px;display:none;padding:16px;border-radius:8px;background-color:#f8f9fa;border:1px solid var(--border);}
    .results-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:16px;margin-top:16px;
    }
    .metric{
      background-color:#ffffff;border:1px solid var(--border);
      padding:16px;border-radius:8px;text-align:center;
    }
    .metric-value{font-size:2em;font-weight:bold;color:var(--brand);}
    .metric-label{font-size:.9em;color:var(--muted);margin-top:4px;}
    .muted{color:var(--muted);}
    .grid{display:grid;gap:16px;}
    .grid-2{grid-template-columns:1fr 1fr;}
    .grid-3{grid-template-columns:1fr 1fr 1fr;}
    .grid-4{grid-template-columns:repeat(4,1fr);}
    @media(max-width:768px){
      .nav-bar .nav-links{display:none;}
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}
      .container{padding:8px;}
    }
    .mobile-nav{
      position:fixed;bottom:0;left:0;right:0;
      display:flex;justify-content:space-around;
      background-color:rgba(255,255,255,.95);backdrop-filter:blur(10px);
      box-shadow:0 -2px 10px rgba(0,0,0,.1);
      padding:8px 0;z-index:1000;
    }
    .mobile-nav-item{
      display:flex;flex-direction:column;align-items:center;
      text-align:center;color:var(--muted);transition:color .2s;
      padding:8px;border-radius:8px;
    }
    .mobile-nav-item.active,.mobile-nav-item:hover{color:var(--brand);}
    .mobile-nav-item .material-symbols-outlined{font-size:24px;}
    .alert{
      padding:16px;border-radius:8px;margin-top:16px;font-weight:bold;
    }
    .alert-warning{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba;}
    .alert-success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb;}
    .alert-danger{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
    .tab-nav{display:flex;gap:8px;margin-bottom:16px;}
    .tab{
      padding:10px 16px;cursor:pointer;background-color:#f1f3f4;
      border-radius:8px;font-weight:bold;
      transition:background-color .2s;
    }
    .tab.active{background-color:var(--brand);color:#fff;}
    .tab:hover{background-color:#e0e2e4;}
    .tab.active:hover{background-color:var(--brand);}
    .tab-content{display:none;}
    .comparison-table{width:100%;border-collapse:collapse;margin-top:16px;}
    .comparison-table th,.comparison-table td{
      padding:12px;border:1px solid var(--border);text-align:left;
    }
    .comparison-table th{background-color:#f5f5f5;}
    .login-container{
      display:flex;flex-direction:column;align-items:center;
      justify-content:center;height:100vh;
      background-color:var(--page-bg-1);
      background-image:linear-gradient(45deg, var(--page-bg-1) 0%, var(--page-bg-2) 100%);
    }
    .login-card{
      background-color:var(--card-bg);padding:40px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center;
      max-width:400px;
    }
    .user-profile{
      display:flex;align-items:center;gap:12px;
    }
    .user-profile img{
      width:40px;height:40px;border-radius:50%;
      border:2px solid var(--brand);
    }
    .user-profile .info{
      display:flex;flex-direction:column;
    }
    #google-button-container{
      margin-top:20px;
    }
  </style>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>
<body>
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <img src="https://propcheck.ca/favicon-32x32.png" alt="PropCheck Logo" style="width:50px;margin-bottom:20px;">
      <h2>Welcome to PropCheck</h2>
      <p>Sign in to save and manage your property calculations.</p>
      
      <div id="g_id_onload"
           data-client_id="539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      
      <div id="g_button_target"></div>
      
      <p style="margin:20px 0;">or</p>
      <button id="guestButton" class="btn btn-secondary">Continue as Guest</button>

      <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px;">
        <p style="margin:0;color:var(--muted);">Access all features as a guest, or install as a PWA</p>
        <button id="homeInstallBtn" class="btn btn-primary" style="margin-top:10px;display:none;">
          <span class="material-symbols-outlined">download</span> Install App
        </button>
      </div>
    </div>
  </div>

  <div id="mainApp" style="display:none;">
    <header class="nav-bar">
      <div class="logo-container">
        <img src="https://propcheck.ca/android-chrome-192x192.png" alt="PropCheck Logo" class="logo-icon">
        <h2 style="margin:0;font-weight:800;font-size:24px;">PropCheck</h2>
      </div>
      <nav class="nav-links">
        <a href="#" class="nav-link active" data-page="calculator">Calculator</a>
        <a href="#" class="nav-link" data-page="compare">Compare</a>
        <a href="#" class="nav-link" data-page="reports">Reports</a>
        <a href="#" class="nav-link" data-page="market">Market</a>
        <a href="#" class="nav-link" data-page="analysis">Analysis</a>
      </nav>
      <div id="userArea" class="user-profile" style="display:none;">
        <img id="userAvatar" src="" alt="User Avatar">
        <div class="info">
          <span id="userName" style="font-weight:bold;"></span>
          <span id="userEmail" class="muted" style="font-size:12px;"></span>
        </div>
        <button id="signOut" class="btn btn-danger btn-small">Sign Out</button>
      </div>
      <button id="installBtn" class="btn btn-primary btn-small" style="display:none;">
        <span class="material-symbols-outlined">download</span> Install
      </button>
    </header>

    <main class="container">
      <section id="calculatorPage" class="page active">
        <div class="app-card">
          <h3>Mortgage & Cash Flow Calculator</h3>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="price">Purchase Price ($)</label>
              <input type="number" id="price" placeholder="500,000" />
            </div>
            <div class="input-group">
              <label for="down">Down Payment (%)</label>
              <input type="number" id="down" value="20" min="0" max="100" />
            </div>
          </div>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="rate">Interest Rate (%)</label>
              <input type="number" id="rate" value="5" step="0.01" />
            </div>
            <div class="input-group">
              <label for="term">Amortization (Years)</label>
              <input type="number" id="term" value="25" min="5" max="30" />
            </div>
          </div>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="rent">Monthly Rent ($)</label>
              <input type="number" id="rent" placeholder="2,500" />
            </div>
            <div class="input-group">
              <label for="propertyTax">Annual Property Tax ($)</label>
              <input type="number" id="propertyTax" placeholder="3,000" />
            </div>
          </div>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="insurance">Annual Insurance ($)</label>
              <input type="number" id="insurance" placeholder="1,200" />
            </div>
            <div class="input-group">
              <label for="management">Property Management (%)</label>
              <input type="number" id="management" value="8" min="0" max="100" />
            </div>
          </div>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="vacancy">Vacancy Rate (%)</label>
              <input type="number" id="vacancy" value="5" min="0" max="100" />
            </div>
            <div class="input-group">
              <label for="otherExpenses">Other Monthly Expenses ($)</label>
              <input type="number" id="otherExpenses" value="0" />
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:16px;">
            <button id="calcButton" class="btn btn-primary">Calculate</button>
            <button id="saveProperty" class="btn btn-secondary">Save Property</button>
          </div>
        </div>

        <div id="results" class="app-card results-section">
          <div class="results-grid">
            <div class="metric">
              <div class="metric-value" id="payment">$0</div>
              <div class="metric-label">Monthly Mortgage</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="cashflow">$0</div>
              <div class="metric-label">Monthly Cash Flow</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="caprate">0%</div>
              <div class="metric-label">Cap Rate</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="coc">0%</div>
              <div class="metric-label">Cash-on-Cash</div>
            </div>
          </div>
        </div>
      </section>

      <section id="comparePage" class="page">
        <div class="app-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Compare Properties</h3>
            <div style="display:flex;gap:8px;">
              <button id="addProperty" class="btn btn-secondary btn-small">Add Property</button>
              <button id="clearComparison" class="btn btn-danger btn-small">Clear All</button>
            </div>
          </div>
          <div id="comparisonContainer">
            <div class="alert alert-warning">Add properties from the calculator to compare them side-by-side.</div>
          </div>
        </div>
      </section>

      <section id="reportsPage" class="page">
        <div class="app-card">
          <h3>Saved Properties</h3>
          <div id="propertiesList">
            <div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>
          </div>
          <hr style="margin:24px 0;border-top:1px solid var(--border);">
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <button id="generateSummary" class="btn btn-secondary">Generate Report</button>
            <button id="portfolioReport" class="btn btn-secondary">Portfolio Summary</button>
            <button id="saveToDriveBtn" class="btn btn-primary">Save to Drive</button>
          </div>
        </div>
      </section>

      <section id="marketPage" class="page">
        <div class="app-card">
          <h3>Market Analysis Tool</h3>
          <p class="muted">This tool provides quick access to relevant market data to help you with your analysis.</p>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="citySelect">City</label>
              <select id="citySelect">
                <option value="Toronto">Toronto</option>
                <option value="Vancouver">Vancouver</option>
                <option value="Montreal">Montreal</option>
                <option value="Calgary">Calgary</option>
              </select>
            </div>
            <div class="input-group">
              <label for="propertyType">Property Type</label>
              <select id="propertyType">
                <option value="condo">Condo</option>
                <option value="house">Detached House</option>
                <option value="duplex">Duplex</option>
              </select>
            </div>
          </div>
          <button id="loadMarketData" class="btn btn-primary">Load Market Data</button>
        </div>
      </section>

      <section id="analysisPage" class="page">
        <div class="app-card">
          <h3>Detailed Analysis</h3>
          <div class="tab-nav">
            <div class="tab active" data-tab="stress">Stress Test</div>
            <div class="tab" data-tab="rent">Rent Analysis</div>
            <div class="tab" data-tab="expenses">Expense Breakdown</div>
          </div>
          
          <div id="stressTab" class="tab-content" style="display:block;">
            <h4>Mortgage Stress Test</h4>
            <div class="grid grid-2">
              <div class="input-group">
                <label for="currentRate">Current Rate (%)</label>
                <input type="number" id="currentRate" value="5" step="0.01">
              </div>
              <div class="input-group">
                <label for="stressRate">Stress Rate (%)</label>
                <input type="number" id="stressRate" value="7" step="0.01">
              </div>
            </div>
            <div class="input-group">
              <label for="renewalPeriod">Renewal Period (Years)</label>
              <input type="number" id="renewalPeriod" value="5">
            </div>
            <button id="runStressTest" class="btn btn-primary">Run Stress Test</button>
            <div id="stressResults" class="results-section"></div>
          </div>
          
          <div id="rentTab" class="tab-content">
            <h4>Rent Growth Analysis</h4>
            <div class="grid grid-2">
              <div class="input-group">
                <label for="rentIncrease">Annual Rent Increase (%)</label>
                <input type="number" id="rentIncrease" value="3" step="0.1">
              </div>
              <div class="input-group">
                <label for="projectionYears">Projection Years</label>
                <input type="number" id="projectionYears" value="5">
              </div>
            </div>
            <button id="runRentAnalysis" class="btn btn-primary">Run Rent Analysis</button>
            <div id="rentResults" class="results-section"></div>
          </div>
          
          <div id="expensesTab" class="tab-content">
            <div id="expenseBreakdown">
              <div class="alert alert-warning">Calculate a property first to see expense breakdown.</div>
            </div>
          </div>
        </div>
      </section>

    </main>
    <nav class="mobile-nav">
      <a href="#" class="mobile-nav-item active" data-page="calculator">
        <span class="material-symbols-outlined">calculate</span> Calculator
      </a>
      <a href="#" class="mobile-nav-item" data-page="compare">
        <span class="material-symbols-outlined">compare</span> Compare
      </a>
      <a href="#" class="mobile-nav-item" data-page="reports">
        <span class="material-symbols-outlined">folder</span> Reports
      </a>
      <a href="#" class="mobile-nav-item" data-page="market">
        <span class="material-symbols-outlined">show_chart</span> Market
      </a>
      <a href="#" class="mobile-nav-item" data-page="analysis">
        <span class="material-symbols-outlined">analytics</span> Analysis
      </a>
    </nav>
  </div>

  <script>
    // Configuration for Google Identity Services
    const CLIENT_ID = '539986611116-pcmidtvp5sqip212fulevn5ig7cvcv5i.apps.googleusercontent.com';
    
    // Global state
    let currentProperty = {};
    let savedProperties = [];
    let currentUser = null;
    let tokenClient;
    let driveApiLoaded = false;
    let driveFolderId;

    // Login functionality
    guestButton.onclick = () => { 
      loginScreen.style.display='none'; 
      mainApp.style.display='block';
      gtag('event', 'login', {method: 'guest'});
    };

    // Homepage PWA install button
    document.getElementById('homeInstallBtn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          gtag('event', 'pwa_install', {source: 'homepage'});
        }
        deferredPrompt = null;
      } else {
        // Fallback for browsers that don't support install prompt
        alert('To install this app:\\n\\niOS: Tap Share → Add to Home Screen\\nAndroid: Tap menu → Add to Home Screen\\nDesktop: Look for install icon in address bar');
      }
    };

    function parseJwt(token){
      try{
        const base64Url=token.split('.')[1];
        const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
        const json=decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }catch(e){return null;}
    }

    function handleCredentialResponse(response){
      const payload = parseJwt(response.credential);
      if(!payload) return;
      
      currentUser = payload;
      loginScreen.style.display='none';
      mainApp.style.display='block';
      userArea.style.display='flex';
      userAvatar.src = payload.picture || '';
      userName.textContent = payload.name;
      userEmail.textContent = payload.email;
      gtag('event', 'login', {method: 'google'});
      
      // Initialize Google Drive API when user signs in
      initializeGapi();
      initializeGis();
    }
    
    // Google Drive API Functions
    function initializeGis() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile',
            callback: (resp) => {
              if (resp.error !== undefined) {
                console.error('Error with token client: ' + resp.error);
                return;
              }
              gapi.client.setToken(resp);
            },
        });
    }

    function initializeGapi() {
      gapi.load('client', loadDriveApi);
    }

    function loadDriveApi() {
      gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest')
        .then(() => {
          driveApiLoaded = true;
        })
        .catch(err => console.error('Error loading Drive API:', err));
    }
    
    async function savePropertyToDrive() {
      if (!driveApiLoaded) {
        alert('Google Drive API not loaded. Please try again after signing in.');
        return;
      }

      if (!gapi.client.getToken() || gapi.client.getToken().access_token === '') {
        // Request token if not already present
        tokenClient.requestAccessToken({prompt: ''});
        return;
      }

      const savedProperties = JSON.parse(localStorage.getItem('savedProperties')) || [];
      const content = JSON.stringify(savedProperties, null, 2);
      const fileName = 'PropCheck_Saved_Properties.json';

      if (!driveFolderId) {
        const folderName = 'PropCheck Properties';
        try {
          const listResponse = await gapi.client.drive.files.list({
            q: `name = '${folderName}' and mimeType = 'application/vnd.google-apps.folder' and 'root' in parents and trashed = false`,
            fields: 'files(id)',
          });
          
          if (listResponse.result.files.length > 0) {
            driveFolderId = listResponse.result.files[0].id;
          } else {
            const folderMetadata = {
              name: folderName,
              mimeType: 'application/vnd.google-apps.folder',
            };
            const createResponse = await gapi.client.drive.files.create({
              resource: folderMetadata,
              fields: 'id',
            });
            driveFolderId = createResponse.result.id;
          }
        } catch (error) {
          console.error('Error managing Google Drive folder:', error);
          alert('Error managing Google Drive folder. Please try again.');
          return;
        }
      }

      const fileMetadata = {
        name: fileName,
        parents: [driveFolderId],
      };

      try {
        const fileListResponse = await gapi.client.drive.files.list({
          q: `name = '${fileName}' and '${driveFolderId}' in parents and trashed = false`,
          fields: 'files(id)',
        });
        
        const fileId = fileListResponse.result.files[0]?.id;

        const multipart = new Blob([JSON.stringify(fileMetadata), '\n', content], {type: 'application/json'});
        
        if (fileId) {
          await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`,
            method: 'PATCH',
            body: multipart,
            headers: {'Content-Type': 'multipart/related; boundary="BOUNDARY"'},
          });
        } else {
          await gapi.client.request({
            path: 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            method: 'POST',
            body: multipart,
            headers: {'Content-Type': 'multipart/related; boundary="BOUNDARY"'},
          });
        }
        alert('Properties saved successfully to Google Drive!');
      } catch (error) {
        console.error('Error saving to Google Drive:', error);
        alert('Error saving properties to Google Drive. Please check your permissions.');
      }
    }
    
    // Make handleCredentialResponse available globally for Google to call
    window.handleCredentialResponse = handleCredentialResponse;

    window.onload = function(){
      // Wait a bit for Google library to load, then initialize
      setTimeout(function() {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse
          });
          
          google.accounts.id.renderButton(
            document.getElementById('g_button_target'),
            {
              theme: 'outline',
              size: 'large',
              width: 280,
              text: 'signin_with',
              shape: 'rectangular'
            }
          );
        } else {
          console.log('Google Sign-In library not loaded');
          // Fallback - show a manual button
          document.getElementById('g_button_target').innerHTML = '<button class="btn btn-primary" style="width:100%;margin-top:10px;" onclick="alert(\'Google Sign-In not available\')">Sign in with Google (Loading...)</button>';
        }
      }, 500);
      
      // Initialize AdSense
      (adsbygoogle = window.adsbygoogle || []).push({});
    }

    signOut.onclick=()=>{
      google.accounts.id.disableAutoSelect();
      userArea.style.display='none';
      loginScreen.style.display='flex';
      mainApp.style.display='none';
      currentUser = null;
      gtag('event', 'logout');
    };

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.mobile-nav-item').forEach(l => l.classList.remove('active'));
      
      document.getElementById(pageId + 'Page').classList.add('active');
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      document.querySelector(`.mobile-nav-item[data-page="${pageId}"]`).classList.add('active');
      
      gtag('event', 'page_view', {page_title: pageId});
    }

    document.querySelectorAll('[data-page]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      };
    });

    // Calculator functions
    function money(n){return '$'+Number(n).toLocaleString('en-CA', {minimumFractionDigits: 0, maximumFractionDigits: 0});}
    function pct(n){return Number(n).toFixed(2)+'%';}

    function calculateCMHC(price, downPercent) {
      if (downPercent >= 20) return 0;
      const loanAmount = price * (1 - downPercent/100);
      let rate;
      if (downPercent >= 15) rate = 0.028;
      else if (downPercent >= 10) rate = 0.031;
      else rate = 0.04;
      return loanAmount * rate;
    }

    calcButton.onclick = () => {
      const price = +document.getElementById('price').value || 0;
      const downPercent = +down.value || 20;
      const rate = (+document.getElementById('rate').value || 0) / 100 / 12;
      const term = (+document.getElementById('term').value || 25) * 12;
      const monthlyRent = +rent.value || 0;
      const annualTax = +propertyTax.value || 0;
      const annualInsurance = +insurance.value || 0;
      const managementPercent = +management.value || 0;
      const vacancyPercent = +vacancy.value || 0;
      const otherMonthly = +otherExpenses.value || 0;
      
      if (!price || !monthlyRent) {
        alert('Please enter at least the purchase price and monthly rent.');
        return;
      }
      
      // Calculations
      const downPayment = price * downPercent / 100;
      const cmhcInsurance = calculateCMHC(price, downPercent);
      const loanAmount = price - downPayment + cmhcInsurance;
      
      let monthlyPayment = 0;
      if (rate === 0) {
        monthlyPayment = loanAmount / term;
      } else {
        monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
      }
      
      // Monthly expenses
      const monthlyTax = annualTax / 12;
      const monthlyInsurance = annualInsurance / 12;
      const managementFee = monthlyRent * managementPercent / 100;
      const vacancyLoss = monthlyRent * vacancyPercent / 100;
      
      const totalMonthlyExpenses = monthlyPayment + monthlyTax + monthlyInsurance + managementFee + vacancyLoss + otherMonthly;
      const effectiveRent = monthlyRent - vacancyLoss;
      const netCashFlow = effectiveRent - totalMonthlyExpenses;
      
      // Annual calculations
      const grossAnnualRent = monthlyRent * 12;
      const effectiveAnnualRent = effectiveRent * 12;
      const annualExpenses = (monthlyTax + monthlyInsurance + managementFee + otherMonthly) * 12 + (monthlyRent * vacancyPercent / 100 * 12);
      const noi = effectiveAnnualRent - annualExpenses;
      const capRate = price ? (noi / price) * 100 : 0;
      const totalInitialInvestment = downPayment + cmhcInsurance;
      const cashOnCash = totalInitialInvestment ? (netCashFlow * 12 / totalInitialInvestment) * 100 : 0;
      
      // Store current calculation
      currentProperty = {
        price, downPercent, rate: +document.getElementById('rate').value, term: +document.getElementById('term').value,
        monthlyRent, annualTax, annualInsurance, managementPercent, vacancyPercent, otherMonthly,
        monthlyPayment, netCashFlow, noi, capRate, cashOnCash, totalInitialInvestment,
        downPayment, cmhcInsurance, timestamp: new Date()
      };
      
      // Display results
      payment.textContent = money(monthlyPayment);
      cashflow.textContent = money(netCashFlow);
      document.getElementById('caprate').textContent = pct(capRate);
      document.getElementById('coc').textContent = pct(cashOnCash);
      
      document.getElementById('downPaymentAmount').textContent = money(downPayment);
      document.getElementById('cmhcAmount').textContent = money(cmhcInsurance);
      document.getElementById('totalInitial').textContent = money(totalInitialInvestment);
      document.getElementById('grossRent').textContent = money(grossAnnualRent);
      document.getElementById('totalExpenses').textContent = money(annualExpenses);
      document.getElementById('noi').textContent = money(noi);
      
      results.style.display = 'block';
      
      // Color coding for cash flow
      cashflow.style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
      
      gtag('event', 'calculate_property', {
        value: price,
        currency: 'CAD'
      });
    };

    // CMHC checkbox handler
    document.getElementById('cmhcRequired').onchange = function() {
      const downPercent = +down.value || 20;
      this.checked = downPercent < 20;
      if (downPercent >= 20) this.checked = false;
    };

    down.oninput = function() {
      const downPercent = +this.value || 20;
      document.getElementById('cmhcRequired').checked = downPercent < 20;
    };

    // Save property functionality
    document.getElementById('saveProperty').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const name = prompt('Enter a name for this property:', `Property ${savedProperties.length + 1}`);
      if (name) {
        currentProperty.name = name;
        savedProperties.push({...currentProperty});
        updateSavedPropertiesList();
        alert('Property saved successfully!');
        gtag('event', 'save_property');
        
        // Call the new Google Drive save function
        savePropertyToDrive();
      }
    };

    function updateSavedPropertiesList() {
      const container = document.getElementById('propertiesList');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No saved properties yet. Calculate and save properties to see them here.</div>';
        return;
      }
      
      container.innerHTML = savedProperties.map((prop, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;">
          <div>
            <strong>${prop.name}</strong><br>
            <span class="muted">${money(prop.price)} • ${pct(prop.capRate)} cap • ${money(prop.netCashFlow)}/mo cash flow</span>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn-secondary btn-small" onclick="loadProperty(${i})">Load</button>
            <button class="btn-danger btn-small" onclick="deleteProperty(${i})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function loadProperty(index) {
      const prop = savedProperties[index];
      price.value = prop.price;
      down.value = prop.downPercent;
      document.getElementById('rate').value = prop.rate;
      document.getElementById('term').value = prop.term;
      rent.value = prop.monthlyRent;
      propertyTax.value = prop.annualTax;
      insurance.value = prop.annualInsurance;
      management.value = prop.managementPercent;
      vacancy.value = prop.vacancyPercent;
      otherExpenses.value = prop.otherMonthly;
      
      showPage('calculator');
      calcButton.click();
    }

    function deleteProperty(index) {
      if (confirm('Are you sure you want to delete this property?')) {
        savedProperties.splice(index, 1);
        updateSavedPropertiesList();
        updateComparisonTable();
      }
    }

    // Stress Testing
    document.getElementById('runStressTest').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const currentRate = +document.getElementById('currentRate').value / 100 / 12;
      const stressRate = +document.getElementById('stressRate').value / 100 / 12;
      const renewalYears = +document.getElementById('renewalPeriod').value;
      
      const price = currentProperty.price;
      const downPayment = currentProperty.downPayment;
      const loanAmount = price - downPayment + currentProperty.cmhcInsurance;
      const term = currentProperty.term * 12;
      
      // Calculate payments at different rates
      const currentPayment = loanAmount * (currentRate * Math.pow(1 + currentRate, term)) / (Math.pow(1 + currentRate, term) - 1);
      const stressPayment = loanAmount * (stressRate * Math.pow(1 + stressRate, term)) / (Math.pow(1 + stressRate, term) - 1);
      
      const paymentIncrease = stressPayment - currentPayment;
      const newCashFlow = currentProperty.netCashFlow - paymentIncrease;
      
      document.getElementById('stressResults').innerHTML = `
        <div class="grid grid-2">
          <div class="metric">
            <div class="metric-value">${money(currentPayment)}</div>
            <div class="metric-label">Current Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--danger)">${money(stressPayment)}</div>
            <div class="metric-label">Stress Test Payment</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:var(--warning)">${money(paymentIncrease)}</div>
            <div class="metric-label">Monthly Increase</div>
          </div>
          <div class="metric">
            <div class="metric-value" style="color:${newCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(newCashFlow)}</div>
            <div class="metric-label">New Cash Flow</div>
          </div>
        </div>
        <div class="alert ${newCashFlow >= 0 ? 'alert-success' : 'alert-danger'}" style="margin-top:16px;">
          ${newCashFlow >= 0 ? 
            '<strong>✅ Stress Test Passed:</strong> Property maintains positive cash flow even at higher rates.' :
            '<strong>⚠️ Stress Test Failed:</strong> Property would have negative cash flow at higher interest rates.'}
        </div>
      `;
      document.getElementById('stressResults').style.display = 'block';
    };

    // Rent Analysis
    document.getElementById('runRentAnalysis').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first.');
        return;
      }
      
      const annualIncrease = +document.getElementById('rentIncrease').value / 100;
      const years = +document.getElementById('projectionYears').value;
      const currentRent = currentProperty.monthlyRent;
      
      let projectionHTML = '<h4>Rent Growth Projection</h4><table class="comparison-table"><tr><th>Year</th><th>Monthly Rent</th><th>Annual Income</th><th>Cash Flow</th></tr>';
      
      for (let year = 0; year <= Math.min(years, 10); year++) {
        const projectedRent = currentRent * Math.pow(1 + annualIncrease, year);
        const annualIncome = projectedRent * 12;
        const projectedCashFlow = currentProperty.netCashFlow + (projectedRent - currentRent);
        
        projectionHTML += `<tr>
          <td>Year ${year}</td>
          <td>${money(projectedRent)}</td>
          <td>${money(annualIncome)}</td>
          <td style="color:${projectedCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'}">${money(projectedCashFlow)}</td>
        </tr>`;
      }
      projectionHTML += '</table>';
      
      document.getElementById('rentResults').innerHTML = projectionHTML;
      document.getElementById('rentResults').style.display = 'block';
    };

    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
      };
    });

    // Comparison functionality
    document.getElementById('addProperty').onclick = () => {
      if (!currentProperty.price) {
        alert('Please calculate a property first, then come back to add it to comparison.');
        return;
      }
      showPage('calculator');
    };

    function updateComparisonTable() {
      const container = document.getElementById('comparisonContainer');
      if (savedProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Add properties from the calculator to compare them side-by-side.</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="comparison-table">
