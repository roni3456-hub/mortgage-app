<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropCheck</title>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css"/>

  <!-- Drive client + your common UI -->
<script src="assets/js/config.js"></script>
<script src="assets/js/state.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="assets/js/drive.auth.helper.js"></script>
<script src="assets/js/drive.js"></script>
<script defer src="assets/js/common.js"></script>
</head>
<body>
 <!-- HEADER -->
<div class="nav">
  <div class="nav-container">
    <a class="logo" href="index.html" title="Back to Home">PropCheck</a>

    <div class="nav-links">
      <a class="nav-link" href="calculator.html">Calculator</a>
      <a class="nav-link" href="reports.html">Reports</a>
      <a class="nav-link" href="analysis.html">Analysis</a>
      <a class="nav-link" href="compare.html">Compare</a>
      <a class="nav-link" href="market.html">Market</a>
      <a class="nav-link active" href="qualification.html">Qualification</a>
      <a class="nav-link" href="multifamily-checklist.html">Multifamily Checklist</a>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      <span id="driveStatus" class="drive-chip" title="Drive save: local backup only">Guest</span>
      <button id="driveAuthBtn" class="btn btn-secondary" type="button">Sign in</button>
    </div>
  </div>
</div>

<body>
  <!-- NAV (text-only; emoji handled by common.js on the heading) -->
  

  <main class="main page-wrap">
    <div class="card">
      <!-- Legacy page title -->
      <h2>Mortgage Qualification Analysis</h2>

      <div class="info-banner" style="margin-top: 6px;">
        This calculator uses Canadian mortgage qualification rules including stress testing and proper treatment of lines of credit. You can use it even without a specific property to see your <b>maximum mortgage</b>.
      </div>

      <!-- Income Section -->
      <div style="margin-top: 18px;">
        <div class="section-title">Income Information</div>
        <div class="grid-3">
          <div class="form-group">
            <label>Annual Employment Income ($)</label>
            <input type="number" id="annualIncome" min="0" step="0.01" placeholder="e.g. 120000" />
          </div>
          <div class="form-group">
            <label>Other Income ($)</label>
            <input type="number" id="otherIncome" min="0" step="0.01" placeholder="e.g. 6000" />
          </div>
          <div class="form-group">
            <label>Co-borrower Income ($)</label>
            <input type="number" id="coIncome" min="0" step="0.01" placeholder="e.g. 90000" />
          </div>
        </div>
      </div>

      <!-- Rental Properties (Detailed v2) -->
      <div style="margin-top: 18px;">
        <div class="section-title">Rental Properties (Detailed)</div>
        <div class="subtle">Add properties if you want rental income considered. We add the <b>Net Used</b> sum to monthly income.</div>
        <div class="actions-row" style="margin-top: 8px;">
          <button class="btn btn-secondary" id="addRentBtn" type="button">+ Add Rental Property</button>
          <span class="pill" id="rentSummaryPill">0 properties · $0.00/mo net</span>
        </div>
        <table class="table" id="rentTable">
          <thead>
            <tr>
              <th style="width: 200px;">Property Name/Label</th>
              <th style="width: 130px;">Gross Rent ($/mo)</th>
              <th style="width: 110px;">Inclusion %</th>
              <th style="width: 130px;">Property Tax ($/mo)</th>
              <th style="width: 130px;">Condo/HOA ($/mo)</th>
              <th style="width: 130px;">Heating ($/mo)</th>
              <th style="width: 130px;">Net Used ($/mo)</th>
              <th style="width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="rentBody"></tbody>
        </table>
        <div id="rentError" class="error-text hidden"></div>
      </div>

      <!-- Debts Section -->
      <div style="margin-top: 18px;">
        <div class="section-title">Monthly Debt Obligations</div>
        <div class="grid-3">
          <div class="form-group">
            <label>Car Payment ($)</label>
            <input type="number" id="carPayment" min="0" step="0.01" placeholder="e.g. 450" />
          </div>
          <div class="form-group">
            <label>Credit Cards Min ($)</label>
            <input type="number" id="ccMin" min="0" step="0.01" placeholder="e.g. 75" />
          </div>
          <div class="form-group">
            <label>Student Loan ($)</label>
            <input type="number" id="studentLoan" min="0" step="0.01" placeholder="e.g. 0" />
          </div>
        </div>

        <!-- Housing Status (optional; only counted if filled) -->
        <div style="margin-top: 10px;">
          <div class="section-title">Housing Status (Optional)</div>
          <div class="grid-3">
            <div class="form-group">
              <label>Status</label>
              <select id="housingStatus">
                <option value="none">Not Applicable</option>
                <option value="rent">Renting</option>
                <option value="mortgage">Own with Mortgage</option>
                <option value="freeclear">Own Free &amp; Clear</option>
              </select>
              <small>Leave as “Not Applicable” if these don’t apply.</small>
            </div>
            <div class="form-group">
              <label>Current Rent ($/mo)</label>
              <input type="number" id="hsRent" min="0" step="0.01" placeholder="e.g. 1800" />
            </div>
            <div class="form-group">
              <label>Existing Mortgage P&amp;I ($/mo)</label>
              <input type="number" id="hsMortPI" min="0" step="0.01" placeholder="e.g. 1600" />
            </div>
          </div>
          <div class="grid-3" style="margin-top: 8px;">
            <div class="form-group">
              <label>Existing Property Tax ($/mo)</label>
              <input type="number" id="hsTax" min="0" step="0.01" placeholder="e.g. 300" />
            </div>
            <div class="form-group">
              <label>Existing Condo/HOA ($/mo)</label>
              <input type="number" id="hsCondo" min="0" step="0.01" placeholder="e.g. 0" />
            </div>
            <div class="form-group">
              <label>Existing Heating ($/mo)</label>
              <input type="number" id="hsHeat" min="0" step="0.01" placeholder="e.g. 150" />
            </div>
          </div>
          <div class="subtle">These are your <b>existing</b> housing costs and go to TDS. Optional—fill only what applies.</div>
        </div>

        <!-- Other obligations -->
        <div class="grid-3" style="margin-top: 10px;">
          <div class="form-group">
            <label>Personal/Installment Loans ($/mo)</label>
            <input type="number" id="otherLoans" min="0" step="0.01" placeholder="e.g. 200" />
          </div>
          <div class="form-group">
            <label>Alimony/Child Support ($/mo)</label>
            <input type="number" id="alimony" min="0" step="0.01" placeholder="e.g. 0" />
          </div>
          <div class="form-group">
            <label>Other Obligations ($/mo)</label>
            <input type="number" id="otherObl" min="0" step="0.01" placeholder="e.g. 0" />
          </div>
        </div>

        <div class="rules-callout" style="margin-top: 12px;">
          <b>Line of Credit Rules:</b>
          <ul style="margin: 6px 0 0 18px;">
            <li>Unsecured LOC with <b>limit &lt; $50,000</b>: use <b>3% of actual balance</b> (monthly).</li>
            <li>Unsecured LOC with <b>limit ≥ $50,000</b>: use <b>3% of full limit</b> (monthly).</li>
            <li>Secured HELOC: use <b>3% of full limit</b> (monthly), regardless of balance.</li>
          </ul>
        </div>

        <!-- LOC Table -->
        <div style="margin-top: 8px;">
          <div class="actions-row">
            <button class="btn btn-secondary" id="addLocBtn" type="button">+ Add Line of Credit</button>
            <span class="pill" id="locSummaryPill">0 LOCs · $0.00/mo derived</span>
          </div>
          <table class="table" id="locTable">
            <thead>
              <tr>
                <th style="width: 210px;">Account Name/Label</th>
                <th style="width: 150px;">Type</th>
                <th style="width: 150px;">Limit ($)</th>
                <th style="width: 150px;">Balance ($)</th>
                <th style="width: 150px;">Derived ($/mo)</th>
                <th style="width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="locBody"></tbody>
          </table>
          <div id="locError" class="error-text hidden"></div>
        </div>
      </div>

      <!-- Property Being Qualified (legacy section name) -->
      <div style="margin-top: 18px;">
        <div class="section-title">Property Being Qualified</div>
        <div class="grid-3">
          <div class="form-group">
            <label>Purchase Price ($)</label>
            <input type="number" id="purchasePrice" min="0" step="0.01" placeholder="e.g. 650000" />
          </div>
          <div class="form-group">
            <label>Down Payment ($)</label>
            <input type="number" id="downPayment" min="0" step="0.01" placeholder="e.g. 120000" />
          </div>
          <div class="form-group">
            <label>Interest Rate (%)</label>
            <input type="number" id="interestRate" min="0" step="0.01" placeholder="e.g. 5.5" value="5.5" />
          </div>
        </div>
        <div class="grid-3" style="margin-top: 8px;">
          <div class="form-group">
            <label>Property Tax (annual $)</label>
            <input type="number" id="propertyTaxAnnual" min="0" step="0.01" placeholder="e.g. 3600" />
          </div>
          <div class="form-group">
            <label>Heating (monthly $)</label>
            <input type="number" id="heatingMonthly" min="0" step="0.01" placeholder="e.g. 150" value="150" />
          </div>
          <div class="form-group">
            <label>Condo Fees (monthly $)</label>
            <input type="number" id="condoMonthly" min="0" step="0.01" placeholder="e.g. 0" value="0" />
          </div>
        </div>

        <div class="grid-3" style="margin-top: 8px;">
          <div class="form-group">
            <label>Credit Score</label>
            <input type="number" id="creditScore" min="0" step="1" placeholder="e.g. 720" />
            <small>Determines whether 39/44 or 35/42 thresholds are used.</small>
          </div>
        </div>
      </div>

      <!-- Analyze & Save -->
      <div class="actions" style="margin-top: 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn btn-primary" id="analyzeBtn" type="button">Analyze Qualification</button>
        <button class="btn btn-secondary" id="saveBtn" type="button">Save</button>
        <span id="saveStatus" class="save-status"></span>
      </div>

      <!-- Results -->
      <div id="results" class="result hidden" role="region" aria-live="polite" style="margin-top: 16px;">
        <div class="headline" id="headline">Max Mortgage You Qualify For: $0.00</div>
        <div style="margin-bottom: 8px;">
          <span class="badge" id="programBadge">Conventional (assumed)</span>
          <span class="badge" id="rateBadge">Stress rate: 0.00%</span>
          <span class="badge" id="limitBadge">Thresholds used: 39/44</span>
        </div>

        <div class="grid-3">
          <div class="derived">
            <b>Max Monthly P&amp;I Allowed:</b> <span id="piAllowed">$0.00</span><br />
            <small>(After shelter &amp; debts per GDS/TDS)</small>
          </div>
          <div class="derived">
            <b>Contract Payment (FYI):</b> <span id="pmtContract">$0.00</span><br />
            <b>Stress-Tested Payment (used in ratios):</b> <span id="pmtStress">$0.00</span>
          </div>
          <div class="derived">
            <b>GDS:</b> <span id="gdsPct">0.0%</span> &nbsp; <b>TDS:</b> <span id="tdsPct">0.0%</span><br />
            <small>Constraint: <span id="constraint">—</span></small>
          </div>
        </div>

        <div class="grid-3" style="margin-top: 10px;">
          <div class="derived">
            <b>Insured (25y) Comparison:</b> <span id="insuredAmt">$0.00</span><br />
            <small>Principal if amortization were 25 years @ contract rate.</small>
          </div>
          <div class="derived">
            <b>Conservative (Stress-Rate Principal, 30y):</b> <span id="stressAmt">$0.00</span><br />
            <small>Principal if we also priced the loan at the stress rate.</small>
          </div>
          <div class="derived">
            <b>LOC Derived Monthly (sum):</b> <span id="locSum">$0.00</span><br />
            <small>Computed using 3% rules by type/limit/balance.</small>
          </div>
        </div>

        <div id="tips" class="derived" style="margin-top: 10px;">
          <b>Tips:</b>
          <div id="tipsBody">Enter values and analyze to see optimization ideas.</div>
        </div>

        <div class="actions-row" style="margin-top: 12px;">
          <a class="btn btn-secondary" href="calculator.html">Go to Calculator</a>
          <a class="btn btn-secondary" href="reports.html">Generate Report</a>
        </div>
      </div>

      <div class="actions" style="margin-top: 14px;">
        <a class="btn btn-secondary" href="calculator.html">Back to Calculator</a>
      </div>
    </div>
  </main>

  <script>
    // ---------------------------
    // Persistence using PCState + optional Drive via PCDrive
    // ---------------------------
    const QUAL_NS = 'pc:qualification'; // local fallback key

    const Storage = {
      loadLocal() {
        try { const raw = localStorage.getItem(QUAL_NS); return raw ? JSON.parse(raw) : null; } catch { return null; }
      },
      saveLocal(obj) {
        try { localStorage.setItem(QUAL_NS, JSON.stringify(obj)); } catch {}
      },
      loadDeal() {
        try {
          const deal = (window.PCState && typeof PCState.getDeal === 'function') ? PCState.getDeal() : null;
          return (deal && deal.qualifications) ? deal.qualifications : null;
        } catch { return null; }
      },
      saveDeal(qual) {
        try {
          const get = window.PCState && typeof PCState.getDeal === 'function' ? PCState.getDeal() : null;
          const base = get && typeof get === 'object' ? get : {};
          const next = Object.assign({}, base, { qualifications: qual });
          if (window.PCState && typeof PCState.setDeal === 'function') PCState.setDeal(next);
          return next; // return merged deal for Drive
        } catch { return null; }
      }
    };

    // ---------------------------
    // Utilities
    // ---------------------------
    const $ = (id) => document.getElementById(id);
    const money = (n) => new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 2 }).format(isFinite(n) ? n : 0);
    const pct1 = (n) => `${(isFinite(n) ? (n * 100) : 0).toFixed(1)}%`;
    const toNum = (el) => { const v = parseFloat(el?.value ?? 0); return isFinite(v) ? v : 0; };
    const nn = (n) => (isFinite(n) && n > 0) ? n : 0;

    // Mortgage math
    function pmt(principal, annualRatePct, years) {
      const r = nn(annualRatePct) / 100 / 12;
      const n = years * 12;
      if (principal <= 0 || r <= 0 || n <= 0) return 0;
      const f = Math.pow(1 + r, n);
      return principal * r * f / (f - 1);
    }
    function principalFromPI(paymentMonthly, annualRatePct, years) {
      const r = nn(annualRatePct) / 100 / 12;
      const n = years * 12;
      if (paymentMonthly <= 0 || r <= 0 || n <= 0) return 0;
      const f = Math.pow(1 + r, n);
      return paymentMonthly * (f - 1) / (r * f);
    }
    function getStressRate(contractRate) {
      const mqr = (window.CONFIG && typeof window.CONFIG.MQR === 'number') ? window.CONFIG.MQR : (window.PC_CONFIG && PC_CONFIG.MQR) || 5.25;
      return Math.max(contractRate + 2, mqr);
    }
    function getThresholds(score) {
      if (isFinite(score) && score >= 680) return { gds: 0.39, tds: 0.44 };
      return { gds: 0.35, tds: 0.42 };
    }

    // LOC rules
    const LOC_TYPE_UNSEC = 'unsecured';
    const LOC_TYPE_SEC = 'secured';
    function computeLocMonthly(loc) {
      const limit = nn(parseFloat(loc.limit));
      const balance = nn(parseFloat(loc.balance));
      if (loc.type === LOC_TYPE_SEC) return 0.03 * limit;
      if (limit < 50000) return 0.03 * balance;
      return 0.03 * limit;
    }
    function summarizeLocs(locs) { return locs.reduce((a, r) => a + computeLocMonthly(r), 0); }

    // Rentals
    function computeRentNet(row) {
      const gross = nn(parseFloat(row.gross));
      const inclPct = nn(parseFloat(row.inclPct)) / 100; // 0..1
      const tax = nn(parseFloat(row.tax));
      const condo = nn(parseFloat(row.condo));
      const heat = nn(parseFloat(row.heat));
      const net = Math.max(0, gross * inclPct - (tax + condo + heat));
      return net;
    }
    function summarizeRentNet(rows) { return rows.reduce((a, r) => a + computeRentNet(r), 0); }

    // ---------------------------
    // Dynamic tables: LOC + Rentals
    // ---------------------------
    const locBody = $('locBody'), locPill = $('locSummaryPill'), locErr = $('locError');
    const rentBody = $('rentBody'), rentPill = $('rentSummaryPill'), rentErr = $('rentError');

    function newLocRow(data = { name: '', type: LOC_TYPE_UNSEC, limit: '', balance: '' }) {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const inName = document.createElement('input'); inName.type='text'; inName.placeholder='e.g. TD HELOC'; inName.value = data.name ?? '';
      tdName.appendChild(inName);

      const tdType = document.createElement('td');
      const sel = document.createElement('select');
      sel.innerHTML = `<option value="${LOC_TYPE_UNSEC}">Unsecured</option><option value="${LOC_TYPE_SEC}">Secured (HELOC)</option>`;
      sel.value = data.type || LOC_TYPE_UNSEC;
      tdType.appendChild(sel);

      const tdLimit = document.createElement('td');
      const inLimit = document.createElement('input'); inLimit.type='number'; inLimit.step='0.01'; inLimit.min='0'; inLimit.placeholder='Limit'; inLimit.value = data.limit ?? '';
      tdLimit.appendChild(inLimit);

      const tdBal = document.createElement('td');
      const inBal = document.createElement('input'); inBal.type='number'; inBal.step='0.01'; inBal.min='0'; inBal.placeholder='Balance'; inBal.value = data.balance ?? '';
      tdBal.appendChild(inBal);

      const tdDer = document.createElement('td');
      const out = document.createElement('span'); out.textContent = '$0.00'; tdDer.appendChild(out);

      const tdAct = document.createElement('td');
      const del = document.createElement('button'); del.className='btn btn-secondary'; del.type='button'; del.textContent='Remove';
      tdAct.appendChild(del);

      tr.append(tdName, tdType, tdLimit, tdBal, tdDer, tdAct);

      function refreshRow() {
        const typ = sel.value;
        if (typ === LOC_TYPE_SEC) { inBal.disabled = true; inBal.value = ''; } else { inBal.disabled = false; }
        const loc = { type: typ, limit: parseFloat(inLimit.value||0), balance: parseFloat(inBal.value||0) };
        let error = '';
        if (typ === LOC_TYPE_UNSEC && isFinite(loc.limit) && isFinite(loc.balance) && loc.balance > loc.limit) error = 'Unsecured LOC balance cannot exceed its limit.';
        locErr.textContent = error; locErr.classList.toggle('hidden', !error);
        out.textContent = money(computeLocMonthly(loc));
        refreshLocSummary();
      }

      [sel,inLimit,inBal,inName].forEach(el => el.addEventListener('input', refreshRow));
      del.addEventListener('click', () => { tr.remove(); refreshLocSummary(); });

      refreshRow();
      return tr;
    }

    function getLocRowsData() {
      const rows = [];
      for (const tr of Array.from(locBody.children)) {
        const [tdName, tdType, tdLimit, tdBal] = tr.children;
        rows.push({
          name: tdName.querySelector('input')?.value ?? '',
          type: tdType.querySelector('select')?.value ?? LOC_TYPE_UNSEC,
          limit: parseFloat(tdLimit.querySelector('input')?.value || 0),
          balance: (tdType.querySelector('select')?.value === LOC_TYPE_SEC) ? 0 : parseFloat(tdBal.querySelector('input')?.value || 0)
        });
      }
      return rows;
    }
    function refreshLocSummary() {
      const data = getLocRowsData();
      const sum = summarizeLocs(data);
      locPill.textContent = `${data.length} LOC${data.length===1?'':'s'} · ${money(sum)}/mo derived`;
      $('locSum').textContent = money(sum);
    }

    function newRentRow(data = { name:'', gross:'', inclPct:'80', tax:'', condo:'', heat:'' }) {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const inName = document.createElement('input'); inName.type='text'; inName.placeholder='e.g. 123 Main Upper'; inName.value=data.name??'';
      tdName.appendChild(inName);

      const tdGross = document.createElement('td');
      const inGross = document.createElement('input'); inGross.type='number'; inGross.step='0.01'; inGross.min='0'; inGross.placeholder='e.g. 2200'; inGross.value=data.gross??'';
      tdGross.appendChild(inGross);

      const tdIncl = document.createElement('td');
      const inIncl = document.createElement('input'); inIncl.type='number'; inIncl.step='1'; inIncl.min='0'; inIncl.max='100'; inIncl.placeholder='e.g. 80'; inIncl.value=data.inclPct??'80';
      tdIncl.appendChild(inIncl);

      const tdTax = document.createElement('td');
      const inTax = document.createElement('input'); inTax.type='number'; inTax.step='0.01'; inTax.min='0'; inTax.placeholder='e.g. 250'; inTax.value=data.tax??'';
      tdTax.appendChild(inTax);

      const tdCondo = document.createElement('td');
      const inCondo = document.createElement('input'); inCondo.type='number'; inCondo.step='0.01'; inCondo.min='0'; inCondo.placeholder='e.g. 0'; inCondo.value=data.condo??'';
      tdCondo.appendChild(inCondo);

      const tdHeat = document.createElement('td');
      const inHeat = document.createElement('input'); inHeat.type='number'; inHeat.step='0.01'; inHeat.min='0'; inHeat.placeholder='e.g. 150'; inHeat.value=data.heat??'';
      tdHeat.appendChild(inHeat);

      const tdNet = document.createElement('td');
      const outNet = document.createElement('span'); outNet.textContent='$0.00'; tdNet.appendChild(outNet);

      const tdAct = document.createElement('td');
      const del = document.createElement('button'); del.className='btn btn-secondary'; del.type='button'; del.textContent='Remove';
      tdAct.appendChild(del);

      tr.append(tdName, tdGross, tdIncl, tdTax, tdCondo, tdHeat, tdNet, tdAct);

      function refreshRow() {
        const row = {
          gross: parseFloat(inGross.value||0),
          inclPct: parseFloat(inIncl.value||0),
          tax: parseFloat(inTax.value||0),
          condo: parseFloat(inCondo.value||0),
          heat: parseFloat(inHeat.value||0)
        };
        outNet.textContent = money(computeRentNet(row));
        refreshRentSummary();
      }
      [inName,inGross,inIncl,inTax,inCondo,inHeat].forEach(el => el.addEventListener('input', refreshRow));
      del.addEventListener('click', () => { tr.remove(); refreshRentSummary(); });

      refreshRow();
      return tr;
    }

    function getRentRowsData() {
      const rows = [];
      for (const tr of Array.from(rentBody.children)) {
        const [tdName, tdGross, tdIncl, tdTax, tdCondo, tdHeat] = tr.children;
        rows.push({
          name: tdName.querySelector('input')?.value ?? '',
          gross: parseFloat(tdGross.querySelector('input')?.value || 0),
          inclPct: parseFloat(tdIncl.querySelector('input')?.value || 0),
          tax: parseFloat(tdTax.querySelector('input')?.value || 0),
          condo: parseFloat(tdCondo.querySelector('input')?.value || 0),
          heat: parseFloat(tdHeat.querySelector('input')?.value || 0)
        });
      }
      return rows;
    }
    function refreshRentSummary() {
      const data = getRentRowsData();
      const sum = summarizeRentNet(data);
      rentPill.textContent = `${data.length} propert${data.length===1?'y':'ies'} · ${money(sum)}/mo net`;
    }

    // Buttons
    $('addLocBtn').addEventListener('click', () => { locBody.appendChild(newLocRow()); refreshLocSummary(); });
    $('addRentBtn').addEventListener('click', () => { rentBody.appendChild(newRentRow()); refreshRentSummary(); });

    // ---------------------------
    // Main Analyze Logic
    // ---------------------------
    function analyze() {
      // Incomes
      const annualIncome = nn(toNum($('annualIncome')));
      const otherIncome = nn(toNum($('otherIncome')));
      const coIncome = nn(toNum($('coIncome')));

      // Rentals
      const rentRows = getRentRowsData();
      const rentalNetMonthly = summarizeRentNet(rentRows);

      // Debts
      const car = nn(toNum($('carPayment')));
      const ccMin = nn(toNum($('ccMin')));
      const student = nn(toNum($('studentLoan')));
      const otherLoans = nn(toNum($('otherLoans')));
      const alimony = nn(toNum($('alimony')));
      const otherObl = nn(toNum($('otherObl')));

      // Housing status debts (optional)
      const hs = $('housingStatus')?.value || 'none';
      const hsRent = nn(toNum($('hsRent')));
      const hsMortPI = nn(toNum($('hsMortPI')));
      const hsTax = nn(toNum($('hsTax')));
      const hsCondo = nn(toNum($('hsCondo')));
      const hsHeat = nn(toNum($('hsHeat')));
      let housingDebtsMonthly = 0;
      if (hs === 'rent') { housingDebtsMonthly += hsRent; }
      else if (hs === 'mortgage') { housingDebtsMonthly += hsMortPI + hsTax + hsCondo + hsHeat; }
      else if (hs === 'freeclear') { housingDebtsMonthly += hsTax + hsCondo + hsHeat; }

      // Subject property / rate / shelter (optional)
      const purchasePrice = nn(toNum($('purchasePrice')));
      const downPayment = nn(toNum($('downPayment')));
      const contractRate = nn(toNum($('interestRate'))) || 0;

      const taxAnnual = nn(toNum($('propertyTaxAnnual')));
      const heating = nn(toNum($('heatingMonthly'))) || 150;
      const condo = nn(toNum($('condoMonthly'))) || 0;

      const creditScore = nn(toNum($('creditScore')));

      // LOCs
      const locs = getLocRowsData();
      const locMonthly = summarizeLocs(locs);

      // Derived
      const incomeMonthly = (annualIncome + otherIncome + coIncome) / 12 + rentalNetMonthly; // add rental net
      const shelter = (taxAnnual / 12) + heating + condo; // subject property only
      const stressRate = getStressRate(contractRate);
      const thresholds = getThresholds(creditScore);

      // Allowed P&I
      const gdsAllowed = Math.max(0, incomeMonthly * thresholds.gds - shelter);
      const tdsOtherDebts = car + ccMin + student + locMonthly + otherLoans + alimony + otherObl + housingDebtsMonthly;
      const tdsAllowed = Math.max(0, incomeMonthly * thresholds.tds - shelter - tdsOtherDebts);
      const piAllowed = Math.min(gdsAllowed, tdsAllowed);

      // Principal conversions
      const principal30Contract = principalFromPI(piAllowed, contractRate, 30);
      const principal25Contract = principalFromPI(piAllowed, contractRate, 25);
      const principal30Stress = principalFromPI(piAllowed, stressRate, 30);

      // Payments at headline principal
      const pmtContract = pmt(principal30Contract, contractRate, 30);
      const pmtStress = pmt(principal30Contract, stressRate, 30);

      // Ratios
      const gdsPct = incomeMonthly > 0 ? ((pmtStress + shelter) / incomeMonthly) : 0;
      const tdsPct = incomeMonthly > 0 ? ((pmtStress + shelter + tdsOtherDebts) / incomeMonthly) : 0;
      const constraint = (gdsAllowed <= tdsAllowed) ? 'GDS' : 'TDS';

      // Program badge
      let program = 'Conventional (assumed)';
      if (purchasePrice > 0 && downPayment > 0) {
        const dpPct = downPayment / purchasePrice;
        program = (dpPct < 0.20) ? 'Insured' : 'Conventional';
      }

      const qualifies = piAllowed > 0;

      // UI
      $('results').classList.remove('hidden');
      $('results').classList.toggle('pass', qualifies);
      $('results').classList.toggle('fail', !qualifies);

      $('headline').textContent = `Max Mortgage You Qualify For: ${money(principal30Contract)}`;
      $('programBadge').textContent = program;
      $('rateBadge').textContent = `Stress rate: ${stressRate.toFixed(2)}%`;
      $('limitBadge').textContent = `Thresholds used: ${(thresholds.gds*100).toFixed(0)}/${(thresholds.tds*100).toFixed(0)}`;

      $('piAllowed').textContent = money(piAllowed);
      $('pmtContract').textContent = money(pmtContract);
      $('pmtStress').textContent = money(pmtStress);

      $('gdsPct').textContent = pct1(gdsPct);
      $('tdsPct').textContent = pct1(tdsPct);
      $('constraint').textContent = constraint;

      $('locSum').textContent = money(locMonthly);
      $('insuredAmt').textContent = money(principal25Contract);
      $('stressAmt').textContent = money(principal30Stress);

      // Tips
      const tips = [];
      if (!qualifies) {
        const needAtLeast = (constraint === 'GDS')
          ? Math.max(0, shelter - incomeMonthly * thresholds.gds) + 1e-6
          : Math.max(0, shelter + tdsOtherDebts - incomeMonthly * thresholds.tds) + 1e-6;

        if (constraint === 'TDS') {
          tips.push(`Reduce monthly debts by about ${money(needAtLeast)} to open up qualification room.`);
          if (locMonthly > 0) tips.push(`Pay down LOCs (especially unsecured) — every $1/month reduction increases allowed P&I by $1.`);
          if (housingDebtsMonthly > 0) tips.push(`Existing housing costs are impacting TDS; consider how they may change post-purchase.`);
        } else {
          tips.push(`Lower subject property shelter estimates by about ${money(needAtLeast)} (tax/heating/condo) or increase income to meet GDS.`);
        }
        tips.push(`Raising credit score to ≥680 uses 39/44 thresholds, which may help.`);
      } else {
        tips.push(`Your binding limit is ${constraint}. Lowering that side (debts or shelter) will raise your max mortgage.`);
        tips.push(`Try modeling a higher interest rate to see a conservative headline.`);
      }
      $('tipsBody').innerHTML = `<ul style="margin:6px 0 0 18px;">${tips.map(t => `<li>${t}</li>`).join('')}</ul>`;

      // Save snapshot automatically after analyze
      saveSnapshot();
    }

    // ---------------------------
    // Build current state payload
    // ---------------------------
    function currentState() {
      return {
        version: 2,
        // incomes
        income_annual: nn(toNum($('annualIncome'))),
        income_other_annual: nn(toNum($('otherIncome'))),
        income_coborrower_annual: nn(toNum($('coIncome'))),
        // rentals
        rental_items: getRentRowsData(),
        // debts
        debt_car_monthly: nn(toNum($('carPayment'))),
        debt_cc_min_monthly: nn(toNum($('ccMin'))),
        debt_student_monthly: nn(toNum($('studentLoan'))),
        debt_other_loans_monthly: nn(toNum($('otherLoans'))),
        debt_alimony_monthly: nn(toNum($('alimony'))),
        debt_other_monthly: nn(toNum($('otherObl'))),
        // housing status (existing)
        housing_status: $('housingStatus')?.value || 'none',
        housing_rent_monthly: nn(toNum($('hsRent'))),
        housing_mort_pi_monthly: nn(toNum($('hsMortPI'))),
        housing_tax_monthly: nn(toNum($('hsTax'))),
        housing_condo_monthly: nn(toNum($('hsCondo'))),
        housing_heat_monthly: nn(toNum($('hsHeat'))),
        // locs
        loc_items: getLocRowsData(),
        // subject property / shelter & rates
        purchase_price: nn(toNum($('purchasePrice'))),
        down_payment: nn(toNum($('downPayment'))),
        rate_contract_pct: nn(toNum($('interestRate'))),
        property_tax_annual: nn(toNum($('propertyTaxAnnual'))),
        heating_monthly: nn(toNum($('heatingMonthly'))),
        condo_fees_monthly: nn(toNum($('condoMonthly'))),
        // credit
        credit_score: nn(toNum($('creditScore'))),
        // config snapshot
        mqr_pct: (window.CONFIG && typeof window.CONFIG.MQR === 'number') ? window.CONFIG.MQR : (window.PC_CONFIG && PC_CONFIG.MQR) || 5.25
      };
    }

    function applyState(s) {
      if (!s) return;
      $('annualIncome').value = s.income_annual ?? '';
      $('otherIncome').value = s.income_other_annual ?? '';
      $('coIncome').value = s.income_coborrower_annual ?? '';

      // rentals
      rentBody.innerHTML = '';
      const rents = Array.isArray(s.rental_items) ? s.rental_items : [];
      for (const row of rents) rentBody.appendChild(newRentRow(row));
      refreshRentSummary();

      $('carPayment').value = s.debt_car_monthly ?? '';
      $('ccMin').value = s.debt_cc_min_monthly ?? '';
      $('studentLoan').value = s.debt_student_monthly ?? '';
      $('otherLoans').value = s.debt_other_loans_monthly ?? '';
      $('alimony').value = s.debt_alimony_monthly ?? '';
      $('otherObl').value = s.debt_other_monthly ?? '';

      $('housingStatus').value = s.housing_status ?? 'none';
      $('hsRent').value = s.housing_rent_monthly ?? '';
      $('hsMortPI').value = s.housing_mort_pi_monthly ?? '';
      $('hsTax').value = s.housing_tax_monthly ?? '';
      $('hsCondo').value = s.housing_condo_monthly ?? '';
      $('hsHeat').value = s.housing_heat_monthly ?? '';

      // locs
      locBody.innerHTML = '';
      const locs = Array.isArray(s.loc_items) ? s.loc_items : [];
      for (const row of locs) locBody.appendChild(newLocRow(row));
      refreshLocSummary();

      $('purchasePrice').value = s.purchase_price ?? '';
      $('downPayment').value = s.down_payment ?? '';
      $('interestRate').value = (s.rate_contract_pct ?? 5.5);
      $('propertyTaxAnnual').value = s.property_tax_annual ?? '';
      $('heatingMonthly').value = (s.heating_monthly ?? 150);
      $('condoMonthly').value = (s.condo_fees_monthly ?? 0);
      $('creditScore').value = s.credit_score ?? '';
    }

    // ---------------------------
    // Save logic (Deal first, Drive if possible; else local)
    // ---------------------------
    const saveStatusEl = $('saveStatus');

    function setSaveStatus(text) { saveStatusEl.textContent = text || ''; }

    function saveSnapshot() {
      const qual = currentState();
      // write into Deal
      const mergedDeal = Storage.saveDeal(qual);
      if (mergedDeal) setSaveStatus('Saved to Deal');
      else setSaveStatus('Saved locally');

      // local fallback always
      Storage.saveLocal(qual);
      return { qual, mergedDeal };
    }

    async function saveAll() {
      const { mergedDeal } = saveSnapshot();
      // Try Drive if available and user clicks Save
      if (mergedDeal && window.PCDrive && typeof PCDrive.saveDealToDrive === 'function') {
        try {
          setSaveStatus('Saving to Drive…');
          await PCDrive.saveDealToDrive(mergedDeal); // prompts for token if needed
          setSaveStatus('Saved to Drive');
        } catch (e) {
          setSaveStatus('Drive save failed — saved locally');
          console.error('Drive save failed:', e);
        }
      }
    }

    // ---------------------------
    // Bind buttons & auto-save
    // ---------------------------
    $('analyzeBtn').addEventListener('click', analyze);
    $('saveBtn').addEventListener('click', saveAll);

    // Auto-save on input changes (debounced)
    let saveTimer=null;
    function autoSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(()=>{ saveSnapshot(); }, 500); }
    [
      'annualIncome','otherIncome','coIncome',
      'carPayment','ccMin','studentLoan','otherLoans','alimony','otherObl',
      'housingStatus','hsRent','hsMortPI','hsTax','hsCondo','hsHeat',
      'purchasePrice','downPayment','interestRate','propertyTaxAnnual','heatingMonthly','condoMonthly',
      'creditScore'
    ].forEach(id => { const el=$(id); el && el.addEventListener('input', autoSave); });

    // Initial load: prefer Deal -> then local
    (function init(){
      const fromDeal = Storage.loadDeal();
      const fromLocal = Storage.loadLocal();
      applyState(fromDeal || fromLocal);
      refreshLocSummary();
      refreshRentSummary();
      setSaveStatus(window.PCState ? 'Deal ready (local backup enabled)' : 'Saving locally');
    })();
  </script>
    <!-- Silent Drive re-auth + chip updater + explicit sign-in/out -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // try silent rehydrate (no popup). If it fails, chip stays "Guest".
      PCDrive.autoInit();

      const chip = document.getElementById("driveStatus");
      const btn  = document.getElementById("driveAuthBtn");

      const apply = ({ ready, user }) => {
        if (chip) {
          chip.classList.toggle("ready", !!ready);
          if (!ready) { chip.textContent = "Guest"; chip.title = "Drive save: local backup only"; }
          else {
            const name = user?.displayName || user?.emailAddress || "Signed in";
            chip.textContent = name; chip.title = "Drive save: enabled";
          }
        }
        if (btn) btn.textContent = ready ? "Sign out" : "Sign in";
      };

      // initial + subscribe
      apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
      PCDrive.onStatus(apply);

      // explicit user-driven auth (no surprise popups elsewhere)
      if (btn) {
        btn.addEventListener("click", async () => {
          if (PCDrive.isReady()) {
            PCDrive.signOut();
            apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
            return;
          }
          try { await PCDrive.signIn(); }
          catch (e) { alert("Sign-in failed: " + (e?.message || e)); }
          apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
        });
      }
    });
  </script>
</body>
</html>

</body>
</html>
