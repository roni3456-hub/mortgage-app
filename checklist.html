<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropCheck ‚Äî Multifamily Checklist</title>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css"/>

  <!-- Config + State -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/state.js"></script>

  <!-- Google libraries -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <!-- Auth helper (must be before drive.js) -->
  <script src="assets/js/drive.auth.helper.js"></script>

  <!-- Drive + common UI -->
  <script src="assets/js/drive.js"></script>
  <script defer src="assets/js/common.js"></script>
</head>
<body>
  <!-- Header (same pattern as other pages) -->
  <div class="nav">
    <div class="nav-container">
      <a class="logo" href="index.html" title="Back to Home">PropCheck</a>

      <div class="nav-links">
        <a class="nav-link" href="calculator.html">Calculator</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="analysis.html">Analysis</a>
        <a class="nav-link" href="compare.html">Compare</a>
        <a class="nav-link" href="market.html">Market</a>
        <a class="nav-link" href="qualification.html">Qualification</a>
        <a class="nav-link active" href="checklist.html">Checklist</a>
      </div>

      <!-- Right side: Drive status + Sign-in/out -->
      <div style="display:flex; align-items:center; gap:10px;">
        <span id="driveStatus" class="drive-chip" title="Drive save: local backup only">Guest</span>
        <button id="driveAuthBtn" class="btn btn-secondary" type="button">Sign in</button>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="card">
      <h2>Multifamily Buying Checklist</h2>
      <p class="muted">Plan, diligence, finance, and close your multifamily purchase. Items auto-save locally; you can also save/load to a PropCheck Deal in Google Drive.</p>

      <!-- Toolbar -->
      <div class="actions" style="margin-top:10px">
        <button class="btn btn-primary" id="expandAll" type="button">Expand all</button>
        <button class="btn btn-secondary" id="collapseAll" type="button">Collapse all</button>
        <button class="btn btn-secondary" id="printBtn" type="button">Print / Save PDF</button>
        <button class="btn btn-secondary" id="exportJson" type="button">Export progress (JSON)</button>
        <button class="btn btn-secondary" id="saveDealBtn" type="button">Save to Deal (Drive)</button>
        <button class="btn btn-secondary" id="loadDealBtn" type="button">Load from Deal (Drive)</button>
        <button class="btn" id="resetBtn" type="button" style="border:1px solid var(--border)">Reset checklist</button>
        <span id="saveStatus" class="muted" style="margin-left:.5rem"></span>
      </div>

      <!-- Progress -->
      <div style="display:flex; align-items:center; gap:.6rem; margin-top:.75rem;">
        <meter id="meter" min="0" max="100" value="0" style="width:220px; height:12px;"></meter>
        <span class="muted"><b id="pct">0%</b> <span id="countText"></span></span>
      </div>
    </div>

    <!-- PHASES (uses standard cards + tables/styles.css) -->
    <div id="phases" class="grid">
      <!-- Phase 1 -->
      <div class="card">
        <details class="phase" open>
          <summary style="cursor:pointer; display:flex; gap:.6rem; align-items:center;">
            <span class="emoji hpad" aria-label="planning">üóÇÔ∏è</span>
            <span class="phase-title" style="font-weight:700">Phase 1: Pre-Acquisition Planning</span>
            <span class="muted">‚Äî goals, structure, borrowing capacity</span>
          </summary>
          <div class="list" style="margin-top:.6rem; border-top:1px dashed var(--border); padding-top:.6rem;">
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Define investment goals</b></label>
                <small class="muted">Cash flow, appreciation, value-add, tax, hold period, exit strategy.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Ownership & partners</b></label>
                <small class="muted">Personal, corp, LP/JV, roles and equity split, shareholder/JV agreement.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Financing readiness</b></label>
                <small class="muted">Pre-approval, proof of funds, down payment source, DSCR comfort range.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Target criteria & buy box</b></label>
                <small class="muted">Markets, unit count/mix, zoning, condition, cap/cash-on-cash targets.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
          </div>
        </details>
      </div>

      <!-- Phase 2 -->
      <div class="card">
        <details class="phase">
          <summary style="cursor:pointer; display:flex; gap:.6rem; align-items:center;">
            <span class="emoji hpad" aria-label="research">üìç</span>
            <span class="phase-title" style="font-weight:700">Phase 2: Market Research & Deal Sourcing</span>
            <span class="muted">‚Äî demand, vacancy, taxes, leads</span>
          </summary>
          <div class="list" style="margin-top:.6rem; border-top:1px dashed var(--border); padding-top:.6rem;">
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Market fundamentals</b></label>
                <small class="muted">Vacancy, rent trends, employment drivers, schools, transit, regulations.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Lead channels</b></label>
                <small class="muted">MLS/Realtor, LoopNet, brokers, wholesalers, PMs, off-market outreach.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Sales & rental comps</b></label>
                <small class="muted">Cap rates, $/door, $/sf, market rent by unit type, concessions.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
          </div>
        </details>
      </div>

      <!-- Phase 3 -->
      <div class="card">
        <details class="phase">
          <summary style="cursor:pointer; display:flex; gap:.6rem; align-items:center;">
            <span class="emoji hpad" aria-label="analysis">üìä</span>
            <span class="phase-title" style="font-weight:700">Phase 3: Property Analysis</span>
            <span class="muted">‚Äî rent roll, T12, NOI, cap rate</span>
          </summary>
          <div class="list" style="margin-top:.6rem; border-top:1px dashed var(--border); padding-top:.6rem;">
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Collect financials</b></label>
                <small class="muted">Rent roll, T12, utility bills, insurance, tax statements.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Underwrite quickly</b></label>
                <small class="muted">NOI, cap rate, DSCR, break-even occupancy, cash flow & CoC.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Value-add & CapEx</b></label>
                <small class="muted">Unit turns, exteriors, systems, safety, lease-up assumptions, contingency.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Physical walk-through</b></label>
                <small class="muted">Structure, roof, windows, plumbing/electrical, parking, amenities.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
          </div>
        </details>
      </div>

      <!-- Phase 4 -->
      <div class="card">
        <details class="phase">
          <summary style="cursor:pointer; display:flex; gap:.6rem; align-items:center;">
            <span class="emoji hpad" aria-label="offer">‚úçÔ∏è</span>
            <span class="phase-title" style="font-weight:700">Phase 4: Offer & Contract</span>
            <span class="muted">‚Äî terms, conditions, timelines</span>
          </summary>
          <div class="list" style="margin-top:.6rem; border-top:1px dashed var(--border); padding-top:.6rem;">
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>LOI / Offer terms</b></label>
                <small class="muted">Price, deposits, conditions (financing, inspection), closing date.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Due-diligence timeline</b></label>
                <small class="muted">Inspection window, document delivery, lender appraisal, re-trades.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
          </div>
        </details>
      </div>

      <!-- Phase 5 -->
      <div class="card">
        <details class="phase">
          <summary style="cursor:pointer; display:flex; gap:.6rem; align-items:center;">
            <span class="emoji hpad" aria-label="closing">üèÅ</span>
            <span class="phase-title" style="font-weight:700">Phase 5: Closing & Handover</span>
            <span class="muted">‚Äî funds, legal, possession</span>
          </summary>
          <div class="list" style="margin-top:.6rem; border-top:1px dashed var(--border); padding-top:.6rem;">
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Funding & lender conditions</b></label>
                <small class="muted">Final approval, insurance binder, lawyer trust, lender holdbacks.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
            <div class="item" style="display:grid; grid-template-columns:auto 1fr; gap:.7rem; padding:.5rem 0;">
              <input type="checkbox" data-i>
              <div>
                <label><b>Possession & handover</b></label>
                <small class="muted">Keys, meter reads, tenant notices, PM onboarding, reserves.</small>
                <textarea data-n placeholder="Notes‚Ä¶" class="form-input"></textarea>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>
  </main>

  <script>
    // --- Status chip + silent init (same as other pages) ---
    document.addEventListener("DOMContentLoaded", () => {
      PCDrive.autoInit();

      const chip = document.getElementById("driveStatus");
      const btn  = document.getElementById("driveAuthBtn");

      const apply = ({ ready, user }) => {
        if (chip) {
          chip.classList.toggle("ready", !!ready);
          if (!ready) { chip.textContent = "Guest"; chip.title = "Drive save: local backup only"; }
          else {
            const name = user?.displayName || user?.emailAddress || "Signed in";
            chip.textContent = name; chip.title = "Drive save: enabled";
          }
        }
        if (btn) btn.textContent = ready ? "Sign out" : "Sign in";
      };

      apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
      PCDrive.onStatus(apply);

      if (btn) {
        btn.addEventListener("click", async () => {
          if (PCDrive.isReady()) {
            PCDrive.signOut();
            apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
            return;
          }
          try { await PCDrive.signIn(); }
          catch (e) { alert("Sign-in failed: " + (e?.message || e)); }
          apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
        });
      }
    });

    // --- Checklist storage (local) ---
    const KEY = "pc:mfChecklist";
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function loadLocal(){
      try { const j = JSON.parse(localStorage.getItem(KEY)||"null"); return j||{}; } catch { return {}; }
    }
    function saveLocal(obj){
      try { localStorage.setItem(KEY, JSON.stringify(obj)); } catch {}
    }

    function snapshot(){
      const items = [];
      $$("#phases details.phase").forEach((ph, pi)=>{
        $$(".item", ph).forEach((row, ri)=>{
          const checked = $("input[type=checkbox][data-i]", row)?.checked || false;
          const note = $("[data-n]", row)?.value || "";
          items.push({ pi, ri, checked, note });
        });
      });
      return { items, updatedAt: new Date().toISOString() };
    }
    function hydrate(data){
      if (!data || !Array.isArray(data.items)) return;
      $$("#phases details.phase").forEach((ph, pi)=>{
        $$(".item", ph).forEach((row, ri)=>{
          const rec = data.items.find(x => x.pi===pi && x.ri===ri);
          if (!rec) return;
          const cb = $("input[type=checkbox][data-i]", row);
          const ta = $("[data-n]", row);
          if (cb) cb.checked = !!rec.checked;
          if (ta) ta.value = rec.note || "";
        });
      });
      updateProgress();
    }

    function updateProgress(){
      const all = $$("#phases input[type=checkbox][data-i]");
      const done = all.filter(cb => cb.checked).length;
      const pct = all.length ? Math.round((done / all.length) * 100) : 0;
      $("#meter").value = pct;
      $("#pct").textContent = pct + "%";
      $("#countText").textContent = `‚Äî ${done}/${all.length} completed`;
    }

    // init local state
    document.addEventListener("DOMContentLoaded", ()=>{
      hydrate(loadLocal());

      // listeners
      $$("#phases input[type=checkbox][data-i]").forEach(cb => cb.addEventListener("change", ()=>{
        updateProgress(); saveLocal(snapshot());
      }));
      $$("#phases [data-n]").forEach(ta => ta.addEventListener("input", ()=>{
        saveLocal(snapshot());
      }));

      // actions
      $("#expandAll").addEventListener("click", ()=> $$("#phases details.phase").forEach(d => d.open = true));
      $("#collapseAll").addEventListener("click", ()=> $$("#phases details.phase").forEach(d => d.open = false));
      $("#printBtn").addEventListener("click", ()=> window.print());
      $("#exportJson").addEventListener("click", ()=>{
        const data = snapshot();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "MultifamilyChecklist.json"; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      });
      $("#resetBtn").addEventListener("click", ()=>{
        if (!confirm("Reset all checkboxes and notes?")) return;
        localStorage.removeItem(KEY);
        $$("#phases input[type=checkbox][data-i]").forEach(cb => cb.checked = false);
        $$("#phases [data-n]").forEach(ta => ta.value = "");
        updateProgress();
      });

      // Drive actions (uses unified PCDrive/PCAuth)
      $("#saveDealBtn").addEventListener("click", async ()=>{
        try{
          const deal = Object.assign({}, (window.PCState?.getDeal?.()||{}), { checklist: snapshot() });
          const file = await PCDrive.saveDealToDrive(deal); // will prompt once if needed
          $("#saveStatus").textContent = "Saved to Drive: " + (file?.name || "Deal.json");
          setTimeout(()=>$("#saveStatus").textContent="", 4000);
        }catch(e){
          alert("Drive save failed: " + (e?.message || e));
        }
      });

      $("#loadDealBtn").addEventListener("click", async ()=>{
        if (!window.gapi || !gapi.client){ return alert("Drive client not ready yet."); }
        if (!PCDrive.isReady()) { return alert("Sign in with Google first."); }
        try{
          // Same picker pattern used on other pages
          const prop = await gapi.client.drive.files.list({ q:"name='PropCheck' and mimeType='application/vnd.google-apps.folder' and 'root' in parents and trashed=false", fields:"files(id,name)"});
          const propId = (prop.result.files||[])[0]?.id; if(!propId) return alert("No PropCheck folder yet.");
          const deals = await gapi.client.drive.files.list({ q:"name='Deals' and mimeType='application/vnd.google-apps.folder' and '"+propId+"' in parents and trashed=false", fields:"files(id,name)"});
          const dealsId = (deals.result.files||[])[0]?.id; if(!dealsId) return alert("No Deals folder yet.");
          const res = await gapi.client.drive.files.list({ q:"'"+dealsId+"' in parents and mimeType='application/json' and trashed=false", orderBy:"modifiedTime desc", pageSize:100, fields:"files(id,name,modifiedTime)"});
          const files = res.result.files||[]; if(!files.length) return alert("No saved deals found.");

          const list = files.map((f,i)=>`${i+1}. ${f.name}`).join('\n');
          const pick = prompt("Select a deal (enter number):\n\n"+list+"\n\n");
          const idx = Number((pick||'').trim()) - 1; if (!(idx>=0 && idx<files.length)) return;

          const file = files[idx];
          const content = await gapi.client.drive.files.get({ fileId:file.id, alt:"media" }).then(r=>r.body);
          const deal = JSON.parse(content);
          if (deal?.checklist) {
            hydrate(deal.checklist);
            saveLocal(deal.checklist);
            $("#saveStatus").textContent = "Loaded from Drive: " + (file?.name || "");
            setTimeout(()=>$("#saveStatus").textContent="", 4000);
          } else {
            alert("Selected deal has no checklist data.");
          }
        }catch(err){
          console.warn(err);
          alert("Load failed: " + (err?.message || err));
        }
      });
    });
  </script>
</body>
</html>

