<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PropCheck â€” Calculator</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <script src="assets/js/config.js"></script>
  <script src="assets/js/state.js"></script>

  <!-- Drive support -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="assets/js/drive.js"></script>
</head>
<body>
  <div class="nav">
    <div class="nav-container">
      <a class="logo" href="index.html">PropCheck</a>
      <div class="nav-links">
        <a href="calculator.html" class="nav-link active">Calculator</a>
        <a href="reports.html" class="nav-link">Report</a>
        <a href="analysis.html" class="nav-link">Analysis</a>
        <a href="compare.html" class="nav-link">Compare</a>
        <a href="market.html" class="nav-link">Market Data</a>
        <a href="qualification.html" class="nav-link">Qualification</a>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="card">
      <h3>Underwrite a Property</h3>

      <!-- Match original groups (common core set; extend anytime) -->
      <div class="grid grid-3">
        <div class="form-group">
          <label>Property Name</label>
          <input id="dealTitle" placeholder="e.g. 123 Main St">
        </div>
        <div class="form-group">
          <label>Purchase Price ($)</label>
          <input id="price" type="number" placeholder="750000">
        </div>
        <div class="form-group">
          <label>Monthly Rent ($)</label>
          <input id="rent" type="number" placeholder="2800">
        </div>
        <div class="form-group">
          <label>Down Payment (%)</label>
          <input id="down" type="number" value="20" min="5" max="100">
        </div>
        <div class="form-group">
          <label>Interest Rate (%)</label>
          <input id="rate" type="number" value="5.25" step="0.01">
        </div>
        <div class="form-group">
          <label>Amortization (years)</label>
          <select id="term">
            <option value="25">25 years</option>
            <option value="30">30 years</option>
            <option value="20">20 years</option>
            <option value="15">15 years</option>
          </select>
        </div>
        <div class="form-group">
          <label>Property Tax (annual $)</label>
          <input id="propertyTax" type="number" placeholder="3500">
        </div>
        <div class="form-group">
          <label>Insurance (annual $)</label>
          <input id="insurance" type="number" placeholder="1200">
        </div>
        <div class="form-group">
          <label>Management (% of rent)</label>
          <input id="management" type="number" placeholder="8">
        </div>
        <div class="form-group">
          <label>Vacancy (%)</label>
          <input id="vacancy" type="number" placeholder="3">
        </div>
        <div class="form-group">
          <label>Other Monthly Expenses ($)</label>
          <input id="otherExpenses" type="number" placeholder="150">
        </div>
        <div class="form-group">
          <label>CMHC Insurance Required?</label>
          <select id="cmhcRequired">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
          <small>Set to Yes if down payment &lt; 20% for insured mortgage.</small>
        </div>
      </div>

      <h4>Investment Summary</h4>
      <div class="grid grid-2">
        <div>
          <strong>Initial Investment:</strong><br>
          Down Payment: <span id="downPaymentAmount">$0</span><br>
          CMHC Insurance: <span id="cmhcAmount">$0</span><br>
          <strong>Total: <span id="totalInitial">$0</span></strong>
        </div>
        <div>
          <strong>Annual Numbers:</strong><br>
          Gross Rent: <span id="grossRent">$0</span><br>
          Total Expenses: <span id="totalExpenses">$0</span><br>
          Net Operating Income: <span id="noi">$0</span>
        </div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="saveBtn" class="btn btn-primary">ðŸ’¾ Save to Drive</button>
        <button id="loadBtn" class="btn btn-secondary">ðŸ“‚ Load from Drive</button>
      </div>
    </div>
  </main>

  <script>
    // Formatting
    const money = n => Number(n||0).toLocaleString('en-CA',{style:'currency',currency:'CAD',maximumFractionDigits:0});

    // Compute light summary (identical vibe)
    function recompute(){
      const price = +document.getElementById('price').value || 0;
      const downPct = (+document.getElementById('down').value || 0)/100;
      const rent = +document.getElementById('rent').value || 0;
      const tax = +document.getElementById('propertyTax').value || 0;
      const ins = +document.getElementById('insurance').value || 0;
      const mgmtPct = (+document.getElementById('management').value || 0)/100;
      const vacPct = (+document.getElementById('vacancy').value || 0)/100;
      const other = +document.getElementById('otherExpenses').value || 0;

      const down = price*downPct;
      const cmhc = 0; // plug your exact rule later if needed
      const gross = rent*12*(1-vacPct);
      const mgmt = rent*12*mgmtPct;
      const expenses = mgmt + tax + ins + (other*12);
      const noi = gross - expenses;

      document.getElementById('downPaymentAmount').textContent = money(down);
      document.getElementById('cmhcAmount').textContent = money(cmhc);
      document.getElementById('totalInitial').textContent = money(down+cmhc);
      document.getElementById('grossRent').textContent = money(gross);
      document.getElementById('totalExpenses').textContent = money(expenses);
      document.getElementById('noi').textContent = money(noi);
    }
    document.addEventListener('input', (e)=>{
      const ids = ['price','down','rent','propertyTax','insurance','management','vacancy','otherExpenses'];
      if (ids.includes(e.target.id)) recompute();
    });

    // State collect/hydrate (compatible keys)
    function collect(){
      return {
        title: (document.getElementById('dealTitle')?.value||'Property').trim(),
        price: +document.getElementById('price').value || 0,
        rent: +document.getElementById('rent').value || 0,
        propertyTax: +document.getElementById('propertyTax').value || 0,
        insurance: +document.getElementById('insurance').value || 0,
        management: +document.getElementById('management').value || 0,
        vacancy: +document.getElementById('vacancy').value || 0,
        otherExpenses: +document.getElementById('otherExpenses').value || 0,
        downPercent: +document.getElementById('down').value || 0,
        rate: +document.getElementById('rate').value || 0,
        term: +(document.getElementById('term')?.value||25),
        cmhcRequired: (document.getElementById('cmhcRequired')?.value||'no'),
        updatedAt: new Date().toISOString()
      };
    }
    function hydrate(d){
      if(!d) return;
      const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.value = v ?? ''; };
      set('dealTitle', d.title);
      set('price', d.price);
      set('rent', d.rent);
      set('propertyTax', d.propertyTax);
      set('insurance', d.insurance);
      set('management', d.management);
      set('vacancy', d.vacancy);
      set('otherExpenses', d.otherExpenses);
      set('down', d.downPercent);
      set('rate', d.rate);
      if (d.term) document.getElementById('term').value = String(d.term);
      if (d.cmhcRequired) document.getElementById('cmhcRequired').value = d.cmhcRequired;
      recompute();
    }

    // Local â†’ load
    hydrate(PCState.getDeal());
    recompute();

    // Save to Drive (with incremental consent). Also persists locally.
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const data = collect();
      if (!data.price && !data.rent){ alert('Add a price or rent first.'); return; }
      PCState.setDeal(data);
      try{
        const user = PCState.getUser();
        if (user?.mode === 'google' && window.PCDrive){
          const file = await PCDrive.saveDealToDrive(data);
          alert('Saved to Drive: ' + (file?.name || 'Deal.json'));
        } else {
          alert('Saved locally. (Sign in with Google to save to Drive.)');
        }
      }catch(err){
        console.warn(err);
        alert('Saved locally. Drive error: ' + (err?.message || err));
      }
    });

    // Load from Drive picker
    document.getElementById('loadBtn').addEventListener('click', async ()=>{
      if (!window.gapi || !gapi.client){ alert('Drive client not ready yet. Try again.'); return; }
      const user = PCState.getUser();
      if (!user || user.mode !== 'google'){ alert('Sign in with Google first.'); return; }

      try{
        // Ensure folders exist or list if they do
        const prop = await gapi.client.drive.files.list({
          q:"name='PropCheck' and mimeType='application/vnd.google-apps.folder' and 'root' in parents and trashed=false",
          fields:"files(id,name)"
        });
        const propId = (prop.result.files||[])[0]?.id;
        if (!propId) return alert("No PropCheck folder yet.");
        const deals = await gapi.client.drive.files.list({
          q:"name='Deals' and mimeType='application/vnd.google-apps.folder' and '"+propId+"' in parents and trashed=false",
          fields:"files(id,name)"
        });
        const dealsId = (deals.result.files||[])[0]?.id;
        if (!dealsId) return alert("No Deals folder yet.");

        const res = await gapi.client.drive.files.list({
          q:"'"+dealsId+"' in parents and mimeType='application/json' and trashed=false",
          orderBy:"modifiedTime desc",
          pageSize:100,
          fields:"files(id,name,modifiedTime)"
        });
        const files = res.result.files||[];
        if (!files.length) return alert("No saved deals found.");

        const list = files.map((f,i)=>`${i+1}. ${f.name}`).join('\n');
        const pick = prompt("Select a deal to load (enter number):\n\n"+list+"\n\n");
        const idx = Number((pick||'').trim()) - 1;
        if (!(idx>=0 && idx<files.length)) return;

        const file = files[idx];
        const content = await gapi.client.drive.files.get({ fileId:file.id, alt:"media" }).then(r=>r.body);
        const deal = JSON.parse(content);
        PCState.setDeal(deal);
        hydrate(deal);
        alert("Loaded: " + file.name);
      }catch(err){
        console.warn(err);
        alert("Load from Drive failed: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>

