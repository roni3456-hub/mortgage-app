<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropCheck â€” Calculator</title>

  <!-- App icons & PWA -->
  <link rel="manifest" href="site.webmanifest"/>
  <link rel="icon" href="assets/icons/icon-192.png" type="image/png"/>
  <meta name="theme-color" content="#2ecc71"/>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css"/>
<!-- Config + State -->
<script src="assets/js/config.js"></script>
<script src="assets/js/state.js"></script>

<!-- Google libraries -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>

<!-- Auth helper (MUST be before drive.js) -->
<script src="assets/js/drive.auth.helper.js"></script>

<!-- Drive client + your common UI -->
<script src="assets/js/drive.js"></script>
<script defer src="assets/js/common.js"></script>

</head>
<body>
  <!-- Nav -->
  <nav class="nav">
    <div class="nav-container">
      <a href="index.html" class="logo" title="Back to Home">PropCheck</a>

      <div class="nav-links">
        <a class="nav-link active" href="calculator.html">Calculator</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="analysis.html">Analysis</a>
        <a class="nav-link" href="compare.html">Compare</a>
        <a class="nav-link" href="market.html">Market</a>
        <a class="nav-link" href="qualification.html">Qualification</a>
      </div>

      <!-- Right side: Drive status + Sign-in/out -->
      <div style="display:flex; align-items:center; gap:10px;">
        <span id="driveStatus" class="drive-chip" title="Drive save: local backup only">Guest</span>
        <button id="driveAuthBtn" class="btn btn-secondary" type="button">Sign in</button>
      </div>
    </div>
  </nav>

  <main class="main">
    <div class="card">
      <h2 class="title">Underwriting Calculator</h2>
      <p class="subtitle">Enter assumptions below â€” metrics update automatically.</p>

      <div class="grid grid-3">
        <div class="form-group">
          <label for="title">Property Name</label>
          <input id="title" type="text" placeholder="e.g., 123 Main St, Toronto"/>
        </div>
        <div class="form-group">
          <label for="purchasePrice">Purchase Price ($)</label>
          <input id="purchasePrice" type="number" min="0" step="1000" value="500000"/>
        </div>
        <div class="form-group">
          <label for="downPaymentPct">Down Payment (%)</label>
          <input id="downPaymentPct" type="number" min="0" max="100" step="0.1" value="20"/>
        </div>

        <div class="form-group">
          <label for="interestRate">Interest Rate (%)</label>
          <input id="interestRate" type="number" min="0" step="0.01" value="5.50"/>
        </div>
        <div class="form-group">
          <label for="amortYears">Amortization (years)</label>
          <input id="amortYears" type="number" min="1" step="1" value="25"/>
        </div>
        <div class="form-group">
          <label for="rentMonthly">Gross Rent ($/mo)</label>
          <input id="rentMonthly" type="number" min="0" step="50" value="2500"/>
        </div>

        <div class="form-group">
          <label for="taxesAnnual">Taxes ($/yr)</label>
          <input id="taxesAnnual" type="number" min="0" step="100" value="3600"/>
        </div>
        <div class="form-group">
          <label for="insuranceAnnual">Insurance ($/yr)</label>
          <input id="insuranceAnnual" type="number" min="0" step="50" value="1200"/>
        </div>
        <div class="form-group">
          <label for="utilitiesMonthly">Utilities ($/mo)</label>
          <input id="utilitiesMonthly" type="number" min="0" step="25" value="200"/>
        </div>

        <div class="form-group">
          <label for="vacancyRate">Vacancy (%)</label>
          <input id="vacancyRate" type="number" min="0" max="100" step="0.5" value="3"/>
        </div>
        <div class="form-group">
          <label for="repairsPct">Repairs & Maintenance (% of rent)</label>
          <input id="repairsPct" type="number" min="0" max="100" step="0.5" value="5"/>
        </div>
        <div class="form-group">
          <label for="managementPct">Management (% of rent)</label>
          <input id="managementPct" type="number" min="0" max="100" step="0.5" value="8"/>
        </div>

        <div class="form-group">
          <label for="capexPct">CapEx (% of rent)</label>
          <input id="capexPct" type="number" min="0" max="100" step="0.5" value="5"/>
        </div>
        <div class="form-group">
          <label for="otherMonthly">Other Expenses ($/mo)</label>
          <input id="otherMonthly" type="number" min="0" step="25" value="0"/>
        </div>
        <div class="form-group">
          <label for="closingCosts">Closing Costs ($)</label>
          <input id="closingCosts" type="number" min="0" step="500" value="5000"/>
        </div>
      </div>

      <div class="actions">
        <button id="saveDriveBtn" class="btn btn-primary">ðŸ’¾ Save to Google Drive</button>
        <button id="loadDriveBtn" class="btn btn-secondary">ðŸ“‚ Load from Google Drive</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card">
      <h3 class="title">Key Metrics</h3>
      <div class="kpi-row">
        <div class="metric">
          <div class="metric-value" id="kpiCashFlow">$0</div>
          <div class="metric-label">Monthly Cash Flow</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="kpiNOI">$0</div>
          <div class="metric-label">NOI (Annual)</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="kpiCapRate">0%</div>
          <div class="metric-label">Cap Rate</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="kpiCOC">0%</div>
          <div class="metric-label">Cash-on-Cash</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="kpiDSCR">0.00</div>
          <div class="metric-label">DSCR</div>
        </div>
      </div>
    </div>

    <!-- Simple file picker for Drive loads -->
    <div id="drivePickerCard" class="card hidden">
      <h3 class="title">Load from Google Drive</h3>
      <p class="muted">Choose a saved deal from <strong>Drive â†’ PropCheck â†’ Deals</strong>.</p>
      <div class="form-group">
        <label for="driveFiles">Saved Files</label>
        <select id="driveFiles"></select>
      </div>
      <div class="actions">
        <button id="applyDriveBtn" class="btn btn-primary">Load Selected</button>
        <button id="cancelDriveBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </main>

  <script>
    // --------------- Calculator logic ---------------
    const $ = (id) => document.getElementById(id);
    const fields = [
      "title","purchasePrice","downPaymentPct","interestRate","amortYears","rentMonthly",
      "taxesAnnual","insuranceAnnual","utilitiesMonthly","vacancyRate","repairsPct",
      "managementPct","capexPct","otherMonthly","closingCosts"
    ];

    function valNum(id){ return parseFloat($(id).value || "0") || 0; }

    function formatMoney(n){ return Number(n||0).toLocaleString('en-CA',{style:'currency',currency:'CAD'}); }
    function pct(n){ return (n*100).toFixed(2) + "%"; }

    function monthlyPayment(principal, annualRatePct, years){
      if (principal <= 0) return 0;
      const r = (annualRatePct/100)/12;
      const n = years*12;
      if (r === 0) return principal/n;
      return principal * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1);
    }

    function recalc(){
      const price = valNum("purchasePrice");
      const dpPct = valNum("downPaymentPct")/100;
      const dp = price * dpPct;
      const loan = Math.max(0, price - dp);
      const rate = valNum("interestRate");
      const years = valNum("amortYears");

      const rent = valNum("rentMonthly");
      const taxes = valNum("taxesAnnual")/12;
      const ins = valNum("insuranceAnnual")/12;
      const utils = valNum("utilitiesMonthly");
      const vac = rent * (valNum("vacancyRate")/100);
      const repairs = rent * (valNum("repairsPct")/100);
      const mgmt = rent * (valNum("managementPct")/100);
      const capex = rent * (valNum("capexPct")/100);
      const other = valNum("otherMonthly");

      const pmi = monthlyPayment(loan, rate, years);
      const opExMonthly = taxes + ins + utils + vac + repairs + mgmt + capex + other;
      const noiAnnual = (rent - (vac + repairs + mgmt + capex + other)) * 12 - taxes - ins - utils*12; // rough NOI
      const cashFlow = (rent - opExMonthly) - pmi;

      const capRate = price>0 ? noiAnnual / price : 0;
      const cashInvested = dp + valNum("closingCosts");
      const coc = cashInvested>0 ? ((cashFlow*12)/cashInvested) : 0;
      const dscr = (pmi>0) ? ((rent - opExMonthly) / pmi) : 0;

      $("kpiCashFlow").textContent = formatMoney(cashFlow);
      $("kpiNOI").textContent = formatMoney(noiAnnual);
      $("kpiCapRate").textContent = pct(capRate);
      $("kpiCOC").textContent = pct(coc);
      $("kpiDSCR").textContent = dscr.toFixed(2);
    }

    fields.forEach(id => $(id).addEventListener("input", recalc));
    recalc();

    function collectDeal(){
      const o = {};
      fields.forEach(id => o[id] = $(id).value);
      // add derived outputs for convenience
      o.metrics = {
        cashFlowMonthly: $("kpiCashFlow").textContent,
        NOIAnnual: $("kpiNOI").textContent,
        capRate: $("kpiCapRate").textContent,
        cashOnCash: $("kpiCOC").textContent,
        dscr: $("kpiDSCR").textContent
      };
      return o;
    }

    // ---- NO automatic sign-in in handlers (no surprise popups) ----

    // --------------- Save to Drive ---------------
    document.getElementById("saveDriveBtn").addEventListener("click", async () => {
      try{
        if (!PCDrive.isReady()) return alert("Please click â€˜Sign inâ€™ (top-right) to enable Drive, then try again.");
        const deal = collectDeal();
        const res = await PCDrive.saveDealToDrive(deal);
        alert("âœ… Saved to Drive: " + (res?.name || "Deal JSON"));
      }catch(e){
        alert("âŒ " + (e?.message || e));
      }
    });

    // --------------- Load from Drive (simple picker) ---------------
    const pickerCard = document.getElementById("drivePickerCard");
    const filesSelect = document.getElementById("driveFiles");

    async function getFolderIdByName(name, parentId){
      const q =
        "name = '" + String(name).replace(/'/g, "\\'") +
        "' and mimeType = 'application/vnd.google-apps.folder' and '" +
        parentId + "' in parents and trashed = false";
      const resp = await gapi.client.drive.files.list({ q, fields: "files(id,name)"});
      const files = resp?.result?.files || [];
      if (files.length) return files[0].id;
      // Create if missing
      const created = await gapi.client.drive.files.create({
        resource: { name, mimeType: "application/vnd.google-apps.folder", parents:[parentId]},
        fields: "id"
      });
      return created?.result?.id;
    }

    async function waitForDriveClient(){
      // Wait until Drive discovery is available (drive.js loads it)
      await new Promise((resolve, reject)=>{
        const t0 = Date.now();
        (function poll(){
          if (window.gapi?.client?.drive?.files) return resolve();
          if (Date.now()-t0 > 10000) return reject(new Error("Drive client not ready"));
          setTimeout(poll, 50);
        })();
      });
    }

    async function listDeals(){
      if (!PCDrive.isReady()) return alert("Please click â€˜Sign inâ€™ (top-right) to enable Drive, then try again.");
      await waitForDriveClient();

      const propId = await getFolderIdByName("PropCheck", "root");
      const dealsId = await getFolderIdByName("Deals", propId);

      const resp = await gapi.client.drive.files.list({
        q: `'${dealsId}' in parents and trashed = false and mimeType = 'application/json'`,
        orderBy: "modifiedTime desc",
        pageSize: 50,
        fields: "files(id,name,modifiedTime)"
      });
      const files = resp?.result?.files || [];
      filesSelect.innerHTML = "";
      if (!files.length){
        const opt = document.createElement("option");
        opt.textContent = "No saved deals found";
        opt.value = "";
        filesSelect.appendChild(opt);
      }else{
        files.forEach(f=>{
          const opt = document.createElement("option");
          const dt = new Date(f.modifiedTime).toLocaleString();
          opt.value = f.id;
          opt.textContent = `${f.name}  â€”  ${dt}`;
          filesSelect.appendChild(opt);
        });
      }
    }

    async function loadSelectedFile(){
      const id = filesSelect.value;
      if (!id){ alert("No file selected."); return; }
      const resp = await gapi.client.drive.files.get({ fileId: id, alt: "media" });
      let data = resp?.body;
      if (!data && resp?.result) data = resp.result;
      if (typeof data === "string"){
        try{ data = JSON.parse(data); }catch(e){ alert("Could not parse JSON file."); return; }
      }
      fields.forEach(k=>{
        if (data[k] !== undefined) $(k).value = data[k];
      });
      recalc();
      pickerCard.classList.add("hidden");
      alert("âœ… Loaded from Drive.");
    }

    document.getElementById("loadDriveBtn").addEventListener("click", async ()=>{
      try{
        await listDeals();
        pickerCard.classList.remove("hidden");
        window.scrollTo({top: pickerCard.offsetTop - 10, behavior:"smooth"});
      }catch(e){
        alert("âŒ " + (e?.message || e));
      }
    });
    document.getElementById("applyDriveBtn").addEventListener("click", loadSelectedFile);
    document.getElementById("cancelDriveBtn").addEventListener("click", ()=> pickerCard.classList.add("hidden"));
  </script>

  <!-- Silent Drive re-auth + chip updater + explicit sign-in/out -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // try silent rehydrate (no popup). If it fails, chip stays "Guest".
      PCDrive.autoInit();

      // chip + button wiring
      const chip = document.getElementById("driveStatus");
      const btn  = document.getElementById("driveAuthBtn");

      const apply = ({ ready, user }) => {
        if (chip) {
          chip.classList.toggle("ready", !!ready);
          if (!ready) { chip.textContent = "Guest"; chip.title = "Drive save: local backup only"; }
          else {
            const name = user?.displayName || user?.emailAddress || "Signed in";
            chip.textContent = name; chip.title = "Drive save: enabled";
          }
        }
        if (btn) btn.textContent = ready ? "Sign out" : "Sign in";
      };

      // initial
      apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
      PCDrive.onStatus(apply);

      // explicit user-driven auth (no surprise popups elsewhere)
      if (btn) {
        btn.addEventListener("click", async () => {
          if (PCDrive.isReady()) {
            PCDrive.signOut();
            apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
            return;
          }
          try {
            await PCDrive.signIn();   // one-time consent; allowed to popup here
          } catch (e) {
            alert("Sign-in failed: " + (e?.message || e));
          }
          apply({ ready: PCDrive.isReady(), user: PCDrive.getUser() });
        });
      }
    });
  </script>
</body>
</html>



