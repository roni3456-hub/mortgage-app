<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropCheck — Multifamily Buying Checklist</title>
  <link rel="icon" href="assets/img/favicon.png"/>
  <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png"/>
  <link rel="stylesheet" href="assets/css/styles.css"/>

  <!-- PropCheck core assets (existing in V2 baseline) -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/common.js"></script>
  <script src="assets/js/state.js"></script>
  <script src="assets/js/drive.js"></script>

  <style>
    :root {
      --pc-brand: #0ea5e9;   /* sky-500 */
      --pc-muted: #475569;   /* slate-600 */
      --pc-border: #e2e8f0;  /* slate-200 */
      --pc-bg: #f8fafc;      /* slate-50 */
      --pc-card: #ffffff;
      --pc-accent: #22c55e; /* green-500 */
      --pc-danger: #ef4444; /* red-500 */
    }
    body { background: var(--pc-bg); }
    .wrap { max-width: 1100px; margin:0 auto; padding: 0 1rem; }
    .page-hero { padding: 1.6rem 0 .6rem; }
    .page-hero h1 { margin:0 0 .25rem; }
    .page-hero p { color: var(--pc-muted); margin:.25rem 0 0; }

    /* Toolbar */
    .tools { display:flex; flex-wrap:wrap; gap:.6rem; margin:1rem 0 1.25rem; }
    .btn { appearance:none; border:1px solid var(--pc-border); background:#fff; padding:.55rem .85rem; border-radius:10px; font-weight:600; cursor:pointer; text-decoration:none; }
    .btn.primary { background: var(--pc-brand); color:#fff; border-color:transparent; }
    .btn.accent { background: var(--pc-accent); color:#fff; border-color:transparent; }
    .btn.danger { background: var(--pc-danger); color:#fff; border-color:transparent; }

    /* Progress */
    .progress { display:flex; align-items:center; gap:.6rem; margin: .8rem 0 0; }
    .progress meter { width: 220px; height: 12px; }
    .progress .pct { font-weight:700; }

    /* Sections */
    .grid { display:grid; grid-template-columns: 1fr; gap: 1rem; }
    details.phase { background: var(--pc-card); border:1px solid var(--pc-border); border-radius:14px; padding:.85rem .95rem; }
    details.phase[open] { box-shadow: 0 10px 24px rgba(2,6,23,.06); }
    details.phase > summary { list-style:none; cursor:pointer; display:flex; align-items: center; gap:.6rem; }
    details.phase > summary::-webkit-details-marker { display:none; }
    .phase-title { font-weight:700; }
    .phase-sub { color: var(--pc-muted); font-size:.95rem; }

    .list { margin:.6rem 0 0; padding:.4rem 0 0; border-top:1px dashed var(--pc-border); }
    .item { display:grid; grid-template-columns:auto 1fr; align-items:start; gap:.7rem; padding:.5rem 0; }
    .item label { font-weight:600; }
    .item small { color: var(--pc-muted); display:block; margin-top:.15rem; }
    .item textarea { width:100%; min-height:54px; border:1px solid var(--pc-border); border-radius:10px; padding:.5rem .6rem; }

    .note { border-left:4px solid var(--pc-brand); background:#e0f2fe; padding:.8rem 1rem; border-radius:10px; }

    /* Print */
    @media print {
      header.site, .tools, .progress { display:none !important; }
      details.phase { box-shadow:none !important; }
    }
  </style>
</head>
<body>
  <!-- Header uses PropCheck's standard nav classes -->
  <header class="site">
    <div class="wrap">
      <div class="nav-links">
        <a class="nav-link" href="calculator.html">Calculator</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="analysis.html">Analysis</a>
        <a class="nav-link" href="compare.html">Compare</a>
        <a class="nav-link" href="market.html">Market</a>
        <a class="nav-link" href="qualification.html">Qualification</a>
        <a class="nav-link" href="multifamily-checklist.html">Multifamily Checklist</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="page-hero">
      <h1>Multifamily Buying Checklist</h1>
      <p>Plan, diligence, finance, and close your multifamily purchase. Checks and notes auto‑save locally; you can also save/load to a PropCheck Deal and sync to Drive on demand.</p>
      <div class="progress" aria-live="polite">
        <meter id="meter" min="0" max="100" value="0"></meter>
        <span class="pct" id="pct">0%</span>
        <span id="countText" class="phase-sub"></span>
      </div>
      <div class="tools">
        <button class="btn primary" id="expandAll" type="button">Expand all</button>
        <button class="btn" id="collapseAll" type="button">Collapse all</button>
        <button class="btn accent" id="printBtn" type="button">Print / Save PDF</button>
        <button class="btn" id="exportJson" type="button">Export progress (JSON)</button>
        <button class="btn" id="saveDealBtn" type="button">Save to Deal (Drive)</button>
        <button class="btn" id="loadDealBtn" type="button">Load from Deal</button>
        <button class="btn danger" id="resetBtn" type="button">Reset checklist</button>
        <span id="saveStatus" class="phase-sub" style="margin-left:.5rem"></span>
      </div>
      <p class="note">Tip: Click a phase to open it. Check items off as you go; notes fields print to PDF.</p>
    </section>

    <section class="grid" id="phases">
      <!-- PHASE 1: Pre‑Acquisition Planning -->
      <details class="phase" open>
        <summary>
          <span class="phase-title">Phase 1: Pre‑Acquisition Planning</span>
          <span class="phase-sub"> — goals, structure, borrowing capacity</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Define investment goals</label>
              <small>Cash flow, appreciation, value‑add, tax, hold period, exit strategy.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Ownership & partners</label>
              <small>Personal, corp, LP/JV, roles and equity split, shareholder/JV agreement.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Financing readiness</label>
              <small>Pre‑approval, proof of funds, down payment source, DSCR comfort range.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Target criteria & buy box</label>
              <small>Markets, unit count/mix, zoning, condition (turnkey vs value‑add), cap/cash‑on‑cash targets.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 2: Market & Sourcing -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 2: Market Research & Deal Sourcing</span>
          <span class="phase-sub"> — demand, vacancy, taxes, leads</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Market fundamentals</label>
              <small>Vacancy, rent trends, employment drivers, schools, transit, regulations.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Lead channels</label>
              <small>MLS/Realtor, LoopNet, brokers, wholesalers, PMs, off‑market outreach.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Sales & rental comps</label>
              <small>Cap rates, $/door, $/sf, market rent by unit type, concessions.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 3: Analysis -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 3: Property Analysis</span>
          <span class="phase-sub"> — rent roll, T12, NOI, cap rate</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Collect financials</label>
              <small>Rent roll, T12, utility bills, insurance, tax statements.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Underwrite quickly</label>
              <small>NOI, cap rate, DSCR, break‑even occupancy, cash flow & CoC.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Value‑add & CapEx</label>
              <small>Unit turns, exteriors, systems, safety, lease‑up assumptions, contingency.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Physical walk‑through</label>
              <small>Structure, roof, windows, plumbing/electrical, parking, amenities.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 4: Offer & Contract -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 4: Offer & Contract</span>
          <span class="phase-sub"> — conditions, documents</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Offer terms & price</label>
              <small>Financing/inspection/environmental conditions, timelines, deposits, closing date.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Request documents</label>
              <small>Leases, estoppels, rent roll, expense backup, maintenance logs, insurance claims history.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 5: Diligence -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 5: Due Diligence</span>
          <span class="phase-sub"> — verify everything</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Financial & legal</label>
              <small>Verify income/expenses, property taxes, zoning, permits, code compliance, rent control.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Inspections & reports</label>
              <small>Building inspector/engineer, pest/mold, appraisal, environmental (Phase I as needed).</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Insurance readiness</label>
              <small>Quotes for current and post‑renovation coverage; lender requirements.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 6: Financing & Closing -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 6: Financing & Closing</span>
          <span class="phase-sub"> — lender package, walkthrough, utilities</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Lender selection & package</label>
              <small>Conventional/insured/private; submit financials, leases, appraisal, rent roll.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Closing checklist</label>
              <small>Final walk‑through, estoppels, insurance bound, utility transfers, closing funds/adjustments.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>

      <!-- PHASE 7: Post‑Close -->
      <details class="phase">
        <summary>
          <span class="phase-title">Phase 7: Post‑Close & Operations</span>
          <span class="phase-sub"> — onboarding, bookkeeping, optimization</span>
        </summary>
        <div class="list">
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Tenant transition</label>
              <small>Notifications, payment setup, emergency contacts, maintenance requests flow.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Financial setup</label>
              <small>Dedicated account, bookkeeping, monthly reporting vs pro‑forma, CapEx tracker.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
          <div class="item">
            <input type="checkbox" data-i>
            <div>
              <label>Stabilize & improve</label>
              <small>Turnovers/renos, rent optimization, expense reductions, refi plan once stabilized.</small>
              <textarea data-n placeholder="Notes…"></textarea>
            </div>
          </div>
        </div>
      </details>
    </section>

    <footer class="wrap" style="margin:2rem 0 3rem; color:var(--pc-muted)">
      <p>
        Storage behavior: This page auto‑saves locally under <code>pc:mf_checklist</code>. Use <b>Save to Deal (Drive)</b> to merge into the current PropCheck Deal at
        <code>deal.checklists.multifamily</code> and attempt a Drive sync via <code>PCDrive.saveDealToDrive()</code>. If Drive is unavailable, your data still remains locally.
      </p>
    </footer>
  </main>

  <script>
  (function() {
    const KEY = 'pc:mf_checklist';
    const root = document.getElementById('phases');
    const meter = document.getElementById('meter');
    const pct = document.getElementById('pct');
    const countText = document.getElementById('countText');
    const statusEl = document.getElementById('saveStatus');

    function allInputs() { return Array.from(root.querySelectorAll('input[type="checkbox"][data-i]')); }
    function allNotes() { return Array.from(root.querySelectorAll('textarea[data-n]')); }

    function serialize() {
      return {
        checks: allInputs().map(el => (el.checked ? 1 : 0)),
        notes: allNotes().map(el => el.value),
        updatedAt: new Date().toISOString(),
        version: 1
      };
    }
    function hydrate(data) {
      if (!data) return;
      const checks = (data.checks || []), notes = (data.notes || []);
      allInputs().forEach((el, i) => el.checked = !!checks[i]);
      allNotes().forEach((el, i) => el.value = notes[i] || '');
      updateProgress();
    }

    function saveLocal() {
      try { localStorage.setItem(KEY, JSON.stringify(serialize())); } catch {}
      updateProgress();
    }
    function loadLocal() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        hydrate(JSON.parse(raw));
      } catch {}
      updateProgress();
    }

    function updateProgress() {
      const inputs = allInputs();
      const done = inputs.filter(el => el.checked).length;
      const total = inputs.length || 1;
      const val = Math.round(done * 100 / total);
      meter.value = val; pct.textContent = val + '%';
      countText.textContent = `(${done}/${total} items completed)`;
    }

    function expandAll(flag) {
      root.querySelectorAll('details.phase').forEach(d => d.open = !!flag);
    }

    // ---- Deal integration ----
    function saveToDeal() {
      const status = statusEl;
      try {
        const deal = (window.PCState && PCState.getDeal) ? PCState.getDeal() : null;
        if (!deal || !deal.id) { status.textContent = 'No active deal selected.'; return; }
        deal.checklists = deal.checklists || {};
        deal.checklists.multifamily = serialize();
        if (window.PCState && PCState.setDeal) PCState.setDeal(deal);
        status.textContent = 'Saving to Drive…';
        if (window.PCDrive && PCDrive.saveDealToDrive) {
          Promise.resolve(PCDrive.saveDealToDrive(deal))
            .then(() => status.textContent = 'Saved to Drive ✔')
            .catch(() => status.textContent = 'Saved locally; Drive sync failed');
        } else {
          status.textContent = 'Saved to current deal (local only)';
        }
      } catch (e) {
        status.textContent = 'Save error';
      }
    }

    function loadFromDeal() {
      const status = statusEl;
      try {
        const deal = (window.PCState && PCState.getDeal) ? PCState.getDeal() : null;
        if (!deal || !deal.id) { status.textContent = 'No active deal selected.'; return; }
        const data = deal.checklists && deal.checklists.multifamily;
        if (data) { hydrate(data); status.textContent = 'Loaded from current deal'; }
        else { status.textContent = 'No checklist found on deal'; }
      } catch (e) {
        status.textContent = 'Load error';
      }
    }

    // Event wiring
    root.addEventListener('change', (e) => {
      if (e.target.matches('input[type="checkbox"], textarea')) saveLocal();
    });
    document.getElementById('expandAll').addEventListener('click', () => expandAll(true));
    document.getElementById('collapseAll').addEventListener('click', () => expandAll(false));
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('Reset all checks and notes on this device?')) return;
      try { localStorage.removeItem(KEY); } catch {}
      root.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
      root.querySelectorAll('textarea').forEach(el => el.value = '');
      updateProgress();
      statusEl.textContent = '';
    });
    document.getElementById('exportJson').addEventListener('click', () => {
      const blob = new Blob([localStorage.getItem(KEY) || JSON.stringify(serialize(), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'propcheck-multifamily-checklist.json';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    });
    document.getElementById('saveDealBtn').addEventListener('click', saveToDeal);
    document.getElementById('loadDealBtn').addEventListener('click', loadFromDeal);

    // Init
    loadLocal();
    try {
      const d = (window.PCState && PCState.getDeal) ? PCState.getDeal() : null;
      if (d && d.checklists && d.checklists.multifamily) hydrate(d.checklists.multifamily);
    } catch {}
  })();
  </script>
</body>
</html>

